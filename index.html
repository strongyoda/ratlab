<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Rat Lab Manager Pro</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- Firebase v9 compat -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-sankey"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>
   
    
    <style>
        :root { 
            --navy: #1a237e; --green: #00c853; --red: #d32f2f; 
            --orange: #f57c00; --blue: #2c7be5; --gray: #9e9e9e;
            --bg: #f5f7fa; --white: #ffffff; 
        }
        body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg); color: #333; -webkit-tap-highlight-color: transparent; }
        
        #login-screen { display: flex; justify-content: center; align-items: center; height: 100vh; background: var(--navy); position: fixed; width: 100%; top: 0; z-index: 9999; }
        .login-box { background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 320px; text-align: center; }
        
        #main-app { display: none; }
        header { background: white; height: 60px; display: flex; align-items: center; padding: 0 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: fixed; width: 100%; top: 0; z-index: 100; box-sizing: border-box; }
        
        .menu-btn-box {
            display: flex; align-items: center; cursor: pointer; 
            background: #e8eaf6; padding: 8px 12px; border-radius: 8px; 
            margin-right: 10px; transition: 0.2s;
        }
        .menu-btn-box:active { background: #c5cae9; }
        .menu-btn-text { font-weight: bold; color: var(--navy); font-size: 0.9rem; margin-left: 5px; }

        nav { width: 260px; height: 100vh; background: var(--navy); position: fixed; top: 0; left: -260px; transition: 0.3s; z-index: 200; padding-top: 60px; }
        nav.open { left: 0; }
        .nav-item { display: flex; align-items: center; padding: 1rem 1.5rem; color: rgba(255,255,255,0.7); cursor: pointer; text-decoration: none; }
        .nav-item i { margin-right: 10px; }
        #overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 150; }

        main { padding: 80px 1rem 2rem; max-width: 1000px; margin: 0 auto; transition: max-width 0.3s; }
        .card { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 1rem; }
        
        .input-group { margin-bottom: 1rem; }
        .input-group label { display: block; font-size: 0.85rem; font-weight: bold; margin-bottom: 5px; color: var(--navy); }
        input, select, textarea { width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        .btn { width: 100%; padding: 1rem; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; color: white; transition: 0.2s; }
        .btn-green { background: var(--green); }
        .btn-blue { background: var(--blue); }
        .btn-red { background: var(--red); }
        .btn-small { width: auto; padding: 0.5rem 1rem; font-size: 0.9rem; }

        .rating-box { display: flex; gap: 5px; margin-top: 5px; }
        .rate-btn { flex: 1; padding: 12px 0; border: 1px solid #eee; background: white; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .rate-btn.active { background-color: var(--navy) !important; color: white !important; border-color: var(--navy) !important; }

        .cohort-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .d-day-badge { background: var(--blue); color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; white-space: nowrap; }
        
        .rat-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 10px; }
        
        .rat-badge { 
            display: flex; justify-content: center; align-items: center; 
            height: 40px; width: 40px; border-radius: 50%; font-weight: bold; font-size: 0.9rem; 
            cursor: pointer; transition: transform 0.1s; 
            background: white; border: 3px solid #eee; 
        }
        .status-normal { border-color: var(--green); color: var(--green); background: #e8f5e9; }
        .status-mild { border-color: var(--orange); color: var(--orange); background: #fff3e0; }
        .status-severe { border-color: var(--red); color: var(--red); background: #ffebee; }
        .status-dead { border-color: var(--gray); background: #eeeeee; color: var(--gray); text-decoration: line-through; }

        .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        .info-item { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; }
        .info-val { font-size: 1.2rem; font-weight: bold; color: var(--navy); }
        .chart-area { position: relative; height: 350px; width: 100%; margin-top: 20px; } /* ì°¨íŠ¸ ì˜ì—­ ë†’ì´ ì¦ê°€ */
        .section-title { font-size: 1.1rem; font-weight: bold; color: var(--navy); margin-bottom: 15px; border-left: 4px solid var(--green); padding-left: 10px; }

        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-top: 10px; white-space: nowrap; }
        th, td { border: 1px solid #eee; padding: 8px; text-align: center; }
        th { background: #f8f9fa; }
        
        #dose-res { margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; border-left: 5px solid var(--blue); }
        #dose-list { list-style: none; padding: 0; margin: 10px 0; font-size: 0.9rem; }
        #dose-list li { margin-bottom: 5px; border-bottom: 1px solid #eee; padding-bottom: 5px; display: flex; justify-content: space-between; }

        .tab-container { display: flex; margin-bottom: 15px; border-bottom: 1px solid #ddd; }
        .tab { padding: 10px 20px; cursor: pointer; color: #666; }
        .tab.active { border-bottom: 3px solid var(--navy); color: var(--navy); font-weight: bold; }
        .edit-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; }
        .edit-row span { flex: 1; }

        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid var(--navy); width: 20px; height: 20px; -webkit-animation: spin 2s linear infinite; animation: spin 2s linear infinite; display: inline-block; vertical-align: middle; margin-right: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .edit-table input { border: 1px solid #ddd; border-radius: 4px; padding: 5px; font-size: 0.85rem; width: 100%; box-sizing: border-box; }
        .edit-table td { padding: 5px; }
        .deleted-row { background-color: #ffebee !important; opacity: 0.5; text-decoration: line-through; }
        .del-btn { background: var(--red); color: white; border: none; border-radius: 4px; padding: 3px 8px; cursor: pointer; font-size: 0.7rem; }
        .add-row-btn { background: var(--navy); color: white; border: none; border-radius: 4px; padding: 5px 15px; margin-top: 5px; cursor: pointer; font-size: 0.8rem; display: inline-flex; align-items: center; }
        
        .co-memo-box { display: inline-flex; align-items: center; margin-left: 10px; font-size: 0.9rem; color: #555; font-weight: normal; }
        .co-memo-input { border: 1px solid #ccc; border-radius: 4px; padding: 4px 5px; width: 160px; font-size: 0.85rem; }
        .edit-icon { font-size: 1.1rem; cursor: pointer; color: var(--blue); margin-left: 8px; vertical-align: middle; padding: 5px; }
        .edit-icon:hover { color: var(--navy); background: #eee; border-radius: 50%; }
        .memo-text { font-style: italic; color: #666; margin-left: 5px; font-size: 0.85rem; }
        
        .mr-check-group { display: flex; align-items: center; flex-wrap: wrap; gap: 6px; margin-left: 20px; font-size: 0.8rem; background: #f1f3f5; padding: 4px 8px; border-radius: 6px; }
        .mr-check-group label { display: flex; align-items: center; cursor: pointer; margin-bottom: 0; color: #495057; font-weight: normal; }
        .mr-check-group input[type="checkbox"] { width: auto; margin: 0 3px 0 0; padding: 0; transform: scale(0.9); }

        .bp-rat-box {
            background: white; border: none; border-radius: 12px; padding: 20px;
            margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 6px solid #3498db;
        }
        .bp-rat-title {
            font-size: 18px; color: #3498db; border-bottom: 1px solid #eee;
            padding-bottom: 10px; margin-bottom: 15px; font-weight: bold;
        }
        .bp-toggle-btn {
            background: #3498db; color: white; border: none; padding: 5px 12px;
            border-radius: 4px; font-size: 12px; cursor: pointer; transition: background 0.2s;
        }
        .bp-toggle-btn:hover { background: #2980b9; }
        .bp-log-table {
            margin: 10px 0; font-size: 13px; background: #f9fafb !important;
            border: 1px solid #e2e8f0; width: 100%;
        }
        .bp-log-table th { background: #edf2f7; color: #4a5568; }
        .bp-controls label { font-weight: bold; margin-right: 15px; cursor: pointer; }

        .comp-grid { display: flex; gap: 10px; width: 100%; }
        .comp-col { flex: 1; min-width: 0; border: 1px solid #ddd; padding: 10px; border-radius: 8px; background: #fdfdfd; }

        /* COD Modal Styles */
        #cod-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; justify-content:center; align-items:center; }
        .cod-box { background:white; padding:20px; border-radius:12px; width:90%; max-width:400px; text-align:center; box-shadow:0 4px 20px rgba(0,0,0,0.2); }
        .cod-btn { width:100%; margin-bottom:10px; padding:12px; border-radius:8px; border:1px solid #eee; background:#f8f9fa; font-weight:bold; cursor:pointer; font-size:1rem; }
        .cod-btn:hover { background:#e3f2fd; color:var(--navy); }
        .cod-title { font-weight:bold; font-size:1.1rem; margin-bottom:15px; color:var(--navy); }
        .cod-step-container { display:none; }
        .cod-step-container.active { display:block; }

        /* ìˆ˜ì •ëœ í†µí•© í¸ì§‘ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .edit-container { background: #fff; padding: 20px; border-radius: 8px; border: 1px solid #ddd; margin-top: 15px; }
        .edit-section-title { font-size: 1rem; font-weight: bold; color: var(--navy); margin: 20px 0 10px; border-bottom: 2px solid #eee; padding-bottom: 5px; }

        .full-edit-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 0.9rem; }
        .full-edit-table th, .full-edit-table td { border: 1px solid #ddd; padding: 4px; text-align: center; }
        .full-edit-table th { background: #f1f3f5; color: #495057; }
        .full-edit-table input, .full-edit-table select, .full-edit-table textarea { 
            width: 100%; border: 1px solid transparent; background: transparent; 
            text-align: center; font-size: 0.9rem; padding: 5px; box-sizing: border-box; 
        }
        .full-edit-table input:focus, .full-edit-table select:focus, .full-edit-table textarea:focus { 
            border: 1px solid var(--blue); background: #fff; outline: none; 
        }
        .row-del { background-color: #ffebee !important; }
        .row-del input { text-decoration: line-through; color: #aaa; }

        .float-save-btn {
            position: fixed; bottom: 20px; right: 20px; width: auto; 
            padding: 15px 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
            z-index: 999; font-size: 1.1rem;
        }

        /* COD Checkbox Grid */
        .cod-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: left; margin-bottom: 15px; }
        .cod-option { display: flex; align-items: center; background: #f8f9fa; padding: 10px; border-radius: 6px; border: 1px solid #eee; cursor: pointer; }
        .cod-option input { width: auto; margin-right: 8px; transform: scale(1.2); }

        /* Legend Style ìˆ˜ì •: í°íŠ¸ ì¶•ì†Œ ë° ì¤„ë°”ê¿ˆ í—ˆìš© */
        .cod-legend-table { 
            width: 100%; 
            font-size: 0.75rem; /* ê¸€ì”¨ í¬ê¸° ì¶•ì†Œ */
            border-collapse: collapse; 
            table-layout: fixed; /* ì…€ ë„ˆë¹„ ê³ ì •ìœ¼ë¡œ ì¤„ë°”ê¿ˆ ìœ ë„ */
        }
        .cod-legend-table td { 
            padding: 3px; 
            border-bottom: 1px solid #eee; 
            white-space: normal; /* ì¤„ë°”ê¿ˆ í—ˆìš© */
            word-wrap: break-word; /* ê¸´ ë‹¨ì–´ ì¤„ë°”ê¿ˆ */
            vertical-align: middle;
        }
        /* ì»¬ëŸ¼ ë¹„ìœ¨ ì¡°ì • */
        .cod-legend-table td:nth-child(1) { width: 30%; }
        .cod-legend-table td:nth-child(2) { width: 30%; }
        .cod-legend-table td:nth-child(3) { width: 40%; }

        /* ë°ì´í„° í† ê¸€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .data-toggle-btn {
            display: block;
            width: 100%;
            background: #f1f3f5;
            color: #495057;
            border: none;
            padding: 8px 0;
            margin-top: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: bold;
            transition: 0.2s;
        }
        /* ... ê¸°ì¡´ ìŠ¤íƒ€ì¼ ... */

        /* ê°ì£¼ ë‚´ ìƒ‰ìƒ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .color-box {
            display: inline-block;
            width: 12px;
            height: 12px;
            margin-right: 5px;
            border-radius: 3px;
            vertical-align: middle;
            border: 1px solid rgba(0,0,0,0.1);
        }
        
        /* ... ê¸°ì¡´ ìŠ¤íƒ€ì¼ ... */
        .data-toggle-btn:hover { background: #e9ecef; }
        .data-detail-box { display: none; margin-top: 10px; border-top: 1px dashed #ddd; padding-top: 10px; }
        /* ë™í–¥ë¶„ì„ìš© ë¶„í•  ë ˆì´ì•„ì›ƒ */
        .trend-container { display: flex; gap: 20px; width: 100%; }
        .trend-half { flex: 1; min-width: 0; background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 10px; }
        @media (max-width: 768px) { .trend-container { flex-direction: column; } }
        
        .trend-opt-box { background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ddd; }
        .trend-row { display: flex; align-items: center; margin-bottom: 10px; }
        .trend-label { width: 100px; font-weight: bold; color: var(--navy); }
        /* [ì¶”ê°€] ë«ë“œ ìƒ˜í”Œ í‘œì‹œìš© ìŠ¤íƒ€ì¼ */
        .rat-wrapper {
            position: relative;
            display: inline-flex;
            justify-content: center;
            align-items: center;
        }

        .sample-indicator {
            position: absolute;
            top: -8px;       /* ë™ê·¸ë¼ë¯¸ ìœ„ìª½ìœ¼ë¡œ ì‚´ì§ ì˜¬ë¼ê°€ê²Œ */
            left: 50%;
            transform: translateX(-50%); /* ê°€ë¡œ ì¤‘ì•™ ì •ë ¬ */
            font-size: 16px;
            font-weight: 900;
            z-index: 10;
            text-shadow: 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff; /* ê¸€ì ì£¼ë³€ í°ìƒ‰ í…Œë‘ë¦¬ íš¨ê³¼ */
        }

        .sample-c { color: #2196f3; } /* íŒŒë€ìƒ‰ C (Cast) */
        .sample-h { color: #e91e63; } /* ë¶„í™ìƒ‰ H (Histology) */

    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="color:var(--navy)">LAB MANAGER</h2>
            <input type="text" id="uid" placeholder="ID" style="margin-bottom:10px">
            <input type="password" id="upw" placeholder="PW" style="margin-bottom:20px" onkeypress="if(event.key==='Enter') login()">
            <button class="btn btn-green" onclick="login()">LOGIN</button>
        </div>
    </div>

    <div id="main-app">
        <header>
            <div class="menu-btn-box" onclick="toggleMenu()">
                <i class="material-icons" style="color:var(--navy)">menu</i>
                <span class="menu-btn-text">MENU</span>
            </div>
            <span style="font-weight:700; color:var(--navy); font-size:1.1rem;">RAT LAB MANAGER</span>
        </header>
        <div id="overlay" onclick="toggleMenu()"></div>

        <nav id="sidebar">
            <div class="nav-item" onclick="go('dash')"><i class="material-icons">dashboard</i>ëŒ€ì‹œë³´ë“œ</div>
            <div class="nav-item" onclick="go('detail')"><i class="material-icons">search</i>ë«ë“œ ìƒì„¸ë³´ê¸°</div>
            <div class="nav-item" onclick="go('cohort')"><i class="material-icons">bar_chart</i>ì½”í˜¸íŠ¸ ë¶„ì„</div>
            <div class="nav-item" onclick="go('compare')"><i class="material-icons">compare_arrows</i>ì½”í˜¸íŠ¸ ë¹„êµ</div>
            <div class="nav-item" onclick="go('trend')"><i class="material-icons">trending_up</i>ì¡°ê±´ë¶„ì„</div>
            <div class="nav-item" onclick="openPptSetup()"><i class="material-icons">slideshow</i>í”„ë ˆì  í…Œì´ì…˜</div>
            <div class="nav-item" onclick="go('daily')"><i class="material-icons">edit_note</i>ë°ì¼ë¦¬ ì²´í¬</div>
            <div class="nav-item" onclick="go('add')"><i class="material-icons">add_circle</i>ì‹ ê·œ ë“±ë¡</div>
            <div class="nav-item" onclick="go('dose')"><i class="material-icons">science</i>íˆ¬ì•½ ê³„ì‚°ê¸°</div>
            <div class="nav-item" onclick="go('rec')"><i class="material-icons">monitor_weight</i>í˜ˆì••/ì²´ì¤‘ ê¸°ë¡</div>
            <div class="nav-item" onclick="go('bp')"><i class="material-icons">analytics</i>BP ê³„ì‚°ê¸°</div>
            <div class="nav-item" onclick="go('admin')"><i class="material-icons">admin_panel_settings</i>ë°ì´í„° ê´€ë¦¬</div>
            <div class="nav-item" onclick="location.reload()" style="margin-top:auto"><i class="material-icons">logout</i>ë¡œê·¸ì•„ì›ƒ</div>
        </nav>

        <main id="content"></main>
    </div>

    <div id="cod-modal">
        <div class="cod-box">
            
            <div id="cod-step-1" class="cod-step-container">
                <div class="cod-title">ì‚¬ë§ ì›ì¸ ë¶„ë¥˜ (1/3)</div>
                <button class="cod-btn" onclick="selectCodType('Neurological')">Neurological</button>
                <button class="cod-btn" onclick="selectCodType('Non-Neurological')">Non-Neurological</button>
                <button class="cod-btn" style="background:#ffebee; color:var(--red)" onclick="closeCod()">ì·¨ì†Œ</button>
            </div>

            <div id="cod-step-2-neuro" class="cod-step-container">
                <div class="cod-title">Aneurysm ì—¬ë¶€ (2/3)</div>
                <button class="cod-btn" onclick="selectCodAn('Aneurysm(O)')">Aneurysm (O)</button>
                <button class="cod-btn" onclick="selectCodAn('Aneurysm(X)')">Aneurysm (X)</button>
                <button class="cod-btn" style="background:#eee;" onclick="codBack(1)">ì´ì „</button>
            </div>

            <div id="cod-step-2-non-neuro" class="cod-step-container">
                <div class="cod-title">Non-Neurological ì›ì¸ (2/3)</div>
                <button class="cod-btn" onclick="selectCodNonNeuroCause('Unknown')">Unknown</button>
                <button class="cod-btn" onclick="selectCodNonNeuroCause('Surgical Failure')">Surgical Failure</button>
                <button class="cod-btn" onclick="selectCodNonNeuroCause('Sacrifice')">Sacrifice</button>
                <button class="cod-btn" style="background:#eee;" onclick="codBack(1)">ì´ì „</button>
            </div>

            <div id="cod-step-3" class="cod-step-container">
                <div class="cod-title">ì„¸ë¶€ ì›ì¸ ì„ íƒ (3/3)<br><span style="font-size:0.8rem; font-weight:normal;">ì¤‘ë³µ ì„ íƒ ê°€ëŠ¥</span></div>
                <div class="cod-grid" style="margin-bottom:20px;">
                    <label class="cod-option"><input type="checkbox" name="cod-check" value="SAH"> SAH</label>
                    <label class="cod-option"><input type="checkbox" name="cod-check" value="Infarction"> Infarction</label>
                    <label class="cod-option"><input type="checkbox" name="cod-check" value="Vasospasm"> Vasospasm</label>
                    <label class="cod-option"><input type="checkbox" name="cod-check" value="Sacrifice"> Sacrifice</label>
                    <label class="cod-option"><input type="checkbox" name="cod-check" value="Unknown"> Unknown</label>
                </div>
                
                <button class="cod-btn btn-blue" onclick="saveCodFinal()">ìµœì¢… ì €ì¥</button>
                <button class="cod-btn" style="background:#eee;" onclick="codBack('neuro-2')">ì´ì „</button>
            </div>

        </div>
    </div>

    <script>

        const firebaseConfig = {
            apiKey: "AIzaSyCOrTBAQZ4WgFTT5Qk96k0Z_aTTVjKKQeI",
            authDomain: "nidd-lab.firebaseapp.com",
            projectId: "nidd-lab",
            storageBucket: "nidd-lab.firebasestorage.app",
            messagingSenderId: "959472997584",
            appId: "1:959472997584:web:d749f452f2cfc25e3d3ad5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentScores = { act: 0, fur: 0, eye: 0 };
        let allBPData = [];
        let bpChartInstance = null; 
        let globalBpData = [];
        let allRatsForDetail = [];
        // [ì „ì—­ ë³€ìˆ˜ ì¶”ê°€] ë¶„ì„ëœ ë°ì´í„°ë¥¼ ì„ì‹œ ì €ì¥í•  ê³µê°„
        let currentAnalyzedData = {}; 
        // [ì¶”ê°€] ë°ì´í„° ì ˆì•½ì„ ìœ„í•œ ìºì‹œ ë³€ìˆ˜
        let cachedRatsList = null;      // ì¥ ëª©ë¡ ìºì‹œ
        let lastCacheTime = 0;          // ë§ˆì§€ë§‰ìœ¼ë¡œ ë¶ˆëŸ¬ì˜¨ ì‹œê°„
        const CACHE_DURATION = 1000 * 60 * 5; // 5ë¶„ ë™ì•ˆì€ ë‹¤ì‹œ ì•ˆ ë¶ˆëŸ¬ì˜´ (ì‹œê°„ ì¡°ì ˆ ê°€ëŠ¥)
        
        // COD Global States
        let codTargetDocId = null;  // For Detail Page (Direct DB Save)
        let codTargetInputId = null; // For Admin Page (Input Update only)
        let codTempData = { type: '', secondary: '', causes: [] };
        // [ì‹ ê·œ] ì°¨íŠ¸ ê°„ ë§ˆìš°ìŠ¤ ë™ê¸°í™”(Crosshair)ë¥¼ ìœ„í•œ ì „ì—­ ë³€ìˆ˜
        let syncChartsSbp = []; // SBP ì°¨íŠ¸ë“¤ ëª¨ìŒ
        let syncChartsWt = [];  // WT ì°¨íŠ¸ë“¤ ëª¨ìŒ
        let activeCrosshairValSbp = null; // í˜„ì¬ ë§ˆìš°ìŠ¤ê°€ ê°€ë¦¬í‚¤ëŠ” SBP ê°’
        let activeCrosshairValWt = null;  // í˜„ì¬ ë§ˆìš°ìŠ¤ê°€ ê°€ë¦¬í‚¤ëŠ” WT ê°’
        // [ìµœì¢…] ì‹­ìì„ (Crosshair) ê¸°ëŠ¥: Xì¶• ì—°ë™ + Yì¶• í‘œì‹œ + On/Off ì œì–´
        let activeCrosshairPoint = null; // í˜„ì¬ ë§ˆìš°ìŠ¤ ìœ„ì¹˜
        // [ìµœì¢… ë³´ì •] ê°€ì´ë“œì„  ë™ê¸°í™” + ë¼ë²¨ ì˜ë¦¼ ë°©ì§€ + Xì¶• ë¼ë²¨ ì¶”ê°€
        // [ì˜¤ë¥˜ í•´ê²°] Chart.instances ê°ì²´ ì²˜ë¦¬ ë° ë¼ë²¨ ì˜ë¦¼ ë°©ì§€ ë¡œì§
        // [ìµœì¢…] ê°€ë¡œì„ (Yì¶•) ìˆ˜ì¹˜ ê¸°ë°˜ ë™ê¸°í™” ë° íƒ€ì…ë³„ í•„í„°ë§
        let isCrosshairEnabled = true;
        let sharedXValue = null; 
        let sharedYValue = null; // ê³µìœ  ë°ì´í„° ìˆ˜ì¹˜(Y)
        let sourceSyncType = null; // sbp ë˜ëŠ” wt
        let activeChartId = null; 
        // [ì „ì—­ ìƒíƒœ] ê°œë³„ ë°ì´í„° í‘œì‹œ ì—¬ë¶€
        let isIndividualVisible = true;
        let activeCodRatId = null;

        // [ì¶”ê°€] ë°ì´í„° ë³€ê²½ ì‹œ í˜¸ì¶œí•  ìºì‹œ ì‚­ì œ í•¨ìˆ˜
        function clearRatsCache() {
            cachedRatsList = null;
            lastCacheTime = 0;
            console.log("â™»ï¸ ë°ì´í„° ë³€ê²½ ê°ì§€: ìºì‹œê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
        

        // ê°œë³„ ë°ì´í„°(Scatter ì ) On/Off í† ê¸€ í•¨ìˆ˜
        function toggleIndividual() {
            isIndividualVisible = !isIndividualVisible;
            const buttons = document.querySelectorAll('.indiv-toggle-btn');
            buttons.forEach(btn => {
                btn.innerHTML = isIndividualVisible ? 'ğŸ‘¥ ê°œë³„ì  ON' : 'ğŸ‘¥ ê°œë³„ì  OFF';
                btn.style.background = isIndividualVisible ? '#00c853' : '#ddd';
                btn.style.color = isIndividualVisible ? '#fff' : '#777';
            });

            // ëª¨ë“  ì°¨íŠ¸ì˜ ê°œë³„ ë°ì´í„°(scatter) ë°ì´í„°ì…‹ ìˆ¨ê¸°ê¸°/ë³´ì´ê¸°
            Object.values(Chart.instances).forEach(chart => {
                chart.data.datasets.forEach(ds => {
                    // ë°ì´í„°ì…‹ ë¼ë²¨ì´ë‚˜ íƒ€ì…ì„ í™•ì¸í•˜ì—¬ ê°œë³„ ë°ì´í„°ë§Œ ì œì–´
                    if (ds.type === 'scatter' || ds.label === 'Individual' || ds.label === 'Distribution') {
                        ds.hidden = !isIndividualVisible;
                    }
                });
                chart.update('none'); // ì• ë‹ˆë©”ì´ì…˜ ì—†ì´ ì¦‰ì‹œ ë°˜ì˜
            });
        }

        const syncCrosshairPlugin = {
            id: 'syncCrosshair',
            afterInit: (chart) => {
                const canvas = chart.canvas;
                const moveHandler = (e) => {
                    if (!isCrosshairEnabled) return;
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;

                    if (x >= chart.chartArea.left && x <= chart.chartArea.right &&
                        y >= chart.chartArea.top && y <= chart.chartArea.bottom) {
                        
                        // ë§ˆìš°ìŠ¤ê°€ ìœ„ì¹˜í•œ ê³³ì˜ ì‹¤ì œ ë°ì´í„° ê°’ì„ ì¶”ì¶œí•˜ì—¬ ê³µìœ 
                        sharedXValue = chart.scales.x.getValueForPixel(x);
                        sharedYValue = chart.scales.y.getValueForPixel(y);
                        sourceSyncType = chart._syncType; // í˜„ì¬ ì°¨íŠ¸ì˜ íƒ€ì… ì €ì¥
                        activeChartId = chart.id;

                        // ëª¨ë“  ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ê°±ì‹  ( v3+ ëŒ€ì‘ Object.values ì‚¬ìš© )
                        Object.values(Chart.instances).forEach(instance => {
                            instance.render({duration: 0}); 
                        });
                    }
                };

                const leaveHandler = () => {
                    sharedXValue = null; sharedYValue = null; sourceSyncType = null; activeChartId = null;
                    Object.values(Chart.instances).forEach(instance => instance.render({duration: 0}));
                };

                canvas.addEventListener('mousemove', moveHandler);
                canvas.addEventListener('mouseleave', leaveHandler);
            },
            
            afterDraw: (chart) => {
                if (!isCrosshairEnabled || sharedXValue === null) return;
                const {ctx, chartArea, scales} = chart;

                // 1. ì„¸ë¡œ ê°€ì´ë“œì„  (ëª¨ë“  ì°¨íŠ¸ ê³µí†µ)
                const xPix = scales.x.getPixelForValue(sharedXValue);
                if (xPix >= chartArea.left && xPix <= chartArea.right) {
                    ctx.save();
                    ctx.beginPath();
                    ctx.setLineDash([5, 5]); ctx.lineWidth = 1; ctx.strokeStyle = '#FFB300';
                    ctx.moveTo(xPix, chartArea.top); ctx.lineTo(xPix, chartArea.bottom);
                    ctx.stroke();

                    // Xì¶• í•˜ë‹¨ ë¼ë²¨ (POD í‘œì‹œ)
                    const xLabel = "POD " + Math.round(sharedXValue);
                    ctx.font = 'bold 11px sans-serif';
                    const xTW = ctx.measureText(xLabel).width;
                    ctx.fillStyle = '#FFB300';
                    ctx.fillRect(xPix - (xTW/2 + 5), chartArea.bottom + 2, xTW + 10, 18);
                    ctx.fillStyle = '#000'; ctx.textAlign = 'center';
                    ctx.fillText(xLabel, xPix, chartArea.bottom + 15);
                    ctx.restore();
                }

                // 2. ê°€ë¡œ ê°€ì´ë“œì„  (ë™ì¼í•œ íƒ€ì…ì˜ ì°¨íŠ¸ë¼ë¦¬ë§Œ ë™ê¸°í™”)
                // í˜ˆì••ì€ í˜ˆì••ë¼ë¦¬, ì²´ì¤‘ì€ ì²´ì¤‘ë¼ë¦¬ë§Œ ê°€ë¡œì„ ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.
                if (sharedYValue !== null && chart._syncType === sourceSyncType) {
                    const yPix = scales.y.getPixelForValue(sharedYValue);
                    if (yPix >= chartArea.top && yPix <= chartArea.bottom) {
                        ctx.save();
                        ctx.beginPath();
                        ctx.setLineDash([5, 5]); ctx.lineWidth = 1; ctx.strokeStyle = '#FFB300';
                        ctx.moveTo(chartArea.left, yPix); ctx.lineTo(chartArea.right, yPix);
                        ctx.stroke();

                        // Yì¶• ìˆ˜ì¹˜ ë¼ë²¨ (ì•ˆìª½ í‘œì‹œë¡œ ì˜ë¦¼ ë°©ì§€)
                        const label = Math.round(sharedYValue).toString();
                        ctx.font = 'bold 12px sans-serif';
                        const textWidth = ctx.measureText(label).width;
                        const boxWidth = textWidth + 14;
                        const boxX = chartArea.right - boxWidth - 5;
                        
                        ctx.fillStyle = '#FFB300';
                        ctx.fillRect(boxX, yPix - 11, boxWidth, 22);
                        ctx.fillStyle = '#000'; ctx.textAlign = 'center';
                        ctx.fillText(label, boxX + (boxWidth/2), yPix + 5);
                        ctx.restore();
                    }
                }
            }
        };

                // [ì‹ ê·œ] ì¥ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ìºì‹± ì ìš©ë¨ - ì½ê¸° íšŸìˆ˜ íšê¸°ì  ê°ì†Œ)
        async function getRatsWithCache(forceRefresh = false) {
            const now = Date.now();
            // 1. ìºì‹œê°€ ìˆê³ , 5ë¶„ì´ ì•ˆ ì§€ë‚¬ê³ , ê°•ì œ ìƒˆë¡œê³ ì¹¨ì´ ì•„ë‹ˆë©´ -> ì €ì¥ëœ ê±° ì”€ (ì½ê¸° 0íšŒ)
            if (cachedRatsList && (now - lastCacheTime < CACHE_DURATION) && !forceRefresh) {
                console.log("ğŸ’¾ ìºì‹œëœ ë°ì´í„° ì‚¬ìš© (Firestore ì½ê¸° ì ˆì•½)");
                return cachedRatsList;
            }

            // 2. ì•„ë‹ˆë©´ ì§„ì§œë¡œ ë¶ˆëŸ¬ì˜´ (ì½ê¸° ë°œìƒ)
            console.log("ğŸ”¥ Firestoreì—ì„œ ë°ì´í„° ë¡œë“œ ì¤‘...");
            const snap = await db.collection("rats").orderBy("ratId").get();
            
            // ê²°ê³¼ ë³€ìˆ˜ì— ì €ì¥
            cachedRatsList = [];
            snap.forEach(doc => cachedRatsList.push(doc.data()));
            lastCacheTime = now;
            
            return cachedRatsList;
        }

        function toggleCrosshair() {
            isCrosshairEnabled = !isCrosshairEnabled;
            const buttons = document.querySelectorAll('.crosshair-toggle-btn');
            buttons.forEach(btn => {
                btn.innerHTML = isCrosshairEnabled ? 'ğŸ¯ ê°€ì´ë“œì„  ON' : 'ğŸ¯ ê°€ì´ë“œì„  OFF';
                btn.style.background = isCrosshairEnabled ? '#FFD600' : '#ddd';
                btn.style.color = isCrosshairEnabled ? '#000' : '#777';
            });
            sharedXValue = null;
            Object.values(Chart.instances).forEach(c => c.render({duration: 0}));
        }

        async function login() {
            const id = document.getElementById('uid').value.trim();
            const pw = document.getElementById('upw').value;

            try {
                await firebase.auth().signInWithEmailAndPassword(id, pw);

                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                setTimeout(() => go('dash'), 50);
            } catch (e) {
                console.error(e);
                alert('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + (e && e.message ? e.message : e));
            }
        }



        function getTodayStr() {
            const now = new Date();
            const offset = now.getTimezoneOffset() * 60000;
            const kstDate = new Date(now.getTime() - offset);
            return kstDate.toISOString().split('T')[0];
        }

        function toggleMenu() {
            const nav = document.getElementById('sidebar');
            const ol = document.getElementById('overlay');
            nav.classList.toggle('open');
            ol.style.display = nav.classList.contains('open') ? 'block' : 'none';
        }

                // [1] ì „ì—­ ë³€ìˆ˜: ëª¨ë“  ì‹œì ì˜ POD(ìˆ˜ìˆ  í›„ ê²½ê³¼ì¼) ìˆ˜ì¹˜í™” ì •ì˜
        // Arrivalì„ -5ë¡œ ì„¤ì •í•˜ì—¬ D00(-1)ë³´ë‹¤ í™•ì‹¤íˆ ì•ì— ì˜¤ê²Œ í•¨
        const globalPodMap = {
            "Arrival": -5,   // ë°˜ì… (Induction í›¨ì”¬ ì „)
            "D00": -1,       // Baseline (ìˆ˜ìˆ  ì§ì „)
            "D0": 0,         // ìˆ˜ìˆ  ë‹¹ì¼ (ê¸°ì¤€ì  0)
            "D2": 2          // 2ì¼ì°¨
        };

        // W1 ~ W50 ìë™ ìƒì„± (7ì¼ ê°„ê²©)
        for(let i=1; i<=50; i++) {
            globalPodMap[`W${i}`] = i * 7; 
        }

        // [2] í—¬í¼ í•¨ìˆ˜: ë¼ë²¨ -> POD(ìˆ«ì) ë³€í™˜
        // ê·¸ë˜í”„ ê·¸ë¦´ ë•Œ ì´ í•¨ìˆ˜ë¥¼ í†µí•´ Xì¶• ì¢Œí‘œë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
       // [ìˆ˜ì •] ë¼ë²¨ -> POD ë³€í™˜ í—¬í¼ (ì‚¬ìš©ì ì„ íƒ ë¼ë²¨ ì ˆëŒ€ ìš°ì„ )
        function getPodForLabel(label, surgeryDate, recordDate) {
            // 1. [ì ˆëŒ€ ìš°ì„ ] ì‚¬ìš©ìê°€ ì„ íƒí•œ ì‹œì (Label)ì´ í‘œì¤€ ë§µì— ìˆìœ¼ë©´ ë¬´ì¡°ê±´ ê·¸ ìœ„ì¹˜ ì‚¬ìš©
            // ì˜ˆ: ì‹¤ì œë¡  9ì¼ì°¨ì— ìŸ€ì–´ë„ "W1"ì´ë¼ê³  ì…ë ¥í–ˆìœ¼ë©´ x=7 ìœ„ì¹˜ë¡œ ê°•ì œ ê³ ì •
            if (label && globalPodMap.hasOwnProperty(label)) {
                return globalPodMap[label];
            }
            
            // 2. í‘œì¤€ ì‹œì ì´ ì•„ë‹Œ ê²½ìš°(Manual ì…ë ¥ ë“±)ì—ë§Œ ì‹¤ì œ ë‚ ì§œ ì°¨ì´ ê³„ì‚°
            if (surgeryDate && recordDate) {
                return Math.floor((new Date(recordDate) - new Date(surgeryDate)) / (1000 * 60 * 60 * 24));
            }
            
            return null; // ê³„ì‚° ë¶ˆê°€
        }

        async function go(view, targetId = null) {
            const main = document.getElementById('content');
            if(document.getElementById('sidebar').classList.contains('open')) toggleMenu();

            // í™”ë©´ ë„ˆë¹„ ì„¤ì •
            if (view === 'compare' || view === 'trend') {
                main.style.maxWidth = '95%';
            } else {
                main.style.maxWidth = '1000px';
            }

            // 1. Condition Analysis (ì¡°ê±´ ë¶„ì„ - êµ¬ Trend Analysis)
            if (view === 'trend') {
                main.innerHTML = `
                <div class="card">
                    <h3>ğŸ”¬ ì¡°ê±´ ë¶„ì„ (Condition Analysis)</h3>
                    <div class="trend-opt-box">
                        <div style="font-weight:bold; color:var(--navy); margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px;">1. ì½”í˜¸íŠ¸ ì„ íƒ</div>
                        <div id="trend-cohort-list" style="display:flex; flex-wrap:wrap; gap:15px; margin-bottom:15px;">ë¡œë”© ì¤‘...</div>
                    </div>
                    
                    <div class="trend-opt-box">
                        <div style="font-weight:bold; color:var(--navy); margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:5px;">2. ë¶„ë¥˜ ê¸°ì¤€ ì„¤ì •</div>
                        
                        <div style="display:flex; flex-direction:column; gap:12px;">
                            
                            <div class="trend-row" style="display:flex; align-items:center; flex-wrap:nowrap;">
                                <label style="cursor:pointer; display:flex; align-items:center; margin-right:15px; min-width:140px;">
                                    <input type="radio" name="trend-crit" value="weight" checked onchange="toggleTrendInputs()" style="margin-right:8px;"> 
                                    <span style="font-weight:bold; white-space:nowrap;">ì²´ì¤‘(Weight) ê¸°ì¤€</span>
                                </label>
                                <div style="display:flex; align-items:center; flex-wrap:nowrap;">
                                    <select id="trend-wt-tp" style="width:auto; padding:4px; margin-right:5px;">
                                        <option value="D00">D00</option><option value="D0">D0</option><option value="D2">D2</option>
                                    </select>
                                    <input type="number" id="trend-wt-val" placeholder="ê¸°ì¤€ê°’" style="width:80px; padding:4px; margin-right:5px;"> 
                                    <span>g</span>
                                </div>
                            </div>

                            <div class="trend-row" style="display:flex; align-items:center; flex-wrap:nowrap;">
                                <label style="cursor:pointer; display:flex; align-items:center; margin-right:15px; min-width:140px;">
                                    <input type="radio" name="trend-crit" value="pod" onchange="toggleTrendInputs()" style="margin-right:8px;"> 
                                    <span style="font-weight:bold; white-space:nowrap;">ìˆ˜ëª…(POD) ê¸°ì¤€</span>
                                </label>
                                <div style="display:flex; align-items:center; flex-wrap:nowrap;">
                                    <span style="margin-right:5px; color:#666; font-size:0.9rem; white-space:nowrap;">POD</span>
                                    <input type="number" id="trend-pod-val" placeholder="ê¸°ì¤€ê°’" style="width:80px; padding:4px; margin-right:5px;" disabled> 
                                    <span>ì¼</span>
                                </div>
                            </div>

                            <div>
                                <div class="trend-row" style="display:flex; align-items:center; flex-wrap:nowrap;">
                                    <label style="cursor:pointer; display:flex; align-items:center; min-width:140px;">
                                        <input type="radio" name="trend-crit" value="cod" onchange="toggleTrendInputs()" style="margin-right:8px;"> 
                                        <span style="font-weight:bold; white-space:nowrap;">ì‚¬ë§ ì›ì¸(COD) í¬í•¨</span>
                                    </label>
                                </div>
                                
                                <div id="trend-cod-area" style="display:none; margin-top:8px; margin-left:24px; width:90%; background:#f8f9fa; border:1px solid #eee; padding:10px; border-radius:6px;">
                                    <div style="font-size:0.85rem; color:#555; margin-bottom:8px; line-height:1.4;">
                                        * ì½”í˜¸íŠ¸ë¥¼ ë¨¼ì € ì„ íƒí•˜ê³  <b>[ëª©ë¡ ê°±ì‹ ]</b>ì„ ëˆ„ë¥´ì„¸ìš”.<br>
                                        * ì„ íƒí•œ í‚¤ì›Œë“œê°€ <b>í•˜ë‚˜ë¼ë„ í¬í•¨ëœ</b> ê°œì²´ê°€ ê·¸ë£¹ Aë¡œ ë¶„ë¥˜ë©ë‹ˆë‹¤.
                                    </div>
                                    <button class="btn btn-blue btn-small" onclick="loadTrendCodList()" style="width:auto; padding:4px 10px; margin-bottom:10px;">ëª©ë¡ ê°±ì‹  (ì„ íƒëœ ì½”í˜¸íŠ¸)</button>
                                    <div id="trend-cod-list" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap:8px; max-height:150px; overflow-y:auto; background:white; padding:5px; border:1px solid #ddd; border-radius:4px;">
                                        <span style="color:#aaa; padding:5px;">ëª©ë¡ ê°±ì‹  í•„ìš”</span>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                    <label style="display:block; margin-bottom:15px; font-weight:bold; color:var(--navy); cursor:pointer;">
                        <input type="checkbox" id="trend-show-all" style="width:auto; margin-right:5px; transform:scale(1.2);"> ì „ì²´ íƒ€ì„ë¼ì¸ ë³´ê¸°
                    </label>
                    <button class="btn btn-blue" onclick="analyzeTrend()">ë¶„ì„ ì‹œì‘ (Split View)</button>
                </div>
                <div id="trend-res-area" class="trend-container"></div>`;
                renderCohortCheckboxes('trend-cohort-list');
                return;
            }

            // 2. Admin (ë°ì´í„° ê´€ë¦¬)
            if(view === 'admin') {
                const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
                if(pw !== '1234') { alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜"); return; }
                main.innerHTML = `
                <div class="card">
                    <h3>ğŸ›  ë°ì´í„° ê´€ë¦¬</h3>

                    <div style="text-align:right; margin-bottom:10px;">
                        <button id="btn-backup" class="btn btn-green btn-small" style="width:auto; background:#2c3e50;" onclick="backupAllData()">ğŸ’¾ ì „ì²´ ë°ì´í„° ë°±ì—…(JSON)</button>
                    </div>

                    <div class="tab-container">
                        <div id="adm-del" class="tab active" onclick="admTab('del')">ë°ì´í„° ì‚­ì œ</div>
                        <div id="adm-edit" class="tab" onclick="admTab('edit')">ë°ì´í„° ìˆ˜ì •</div>
                        <div id="adm-logs" class="tab" onclick="admTab('logs')">ë¡œê·¸ ì‚­ì œ</div>
                        <div id="adm-up" class="tab" onclick="admTab('up')">ì—…ë¡œë“œ(CSV)</div>
                        <div id="adm-ai" class="tab" onclick="admTab('ai')" style="background:#f3e5f5; color:#6a1b9a; font-weight:bold; border-bottom:3px solid #6a1b9a;">ğŸ¤– AI ë…¼ë¬¸ ì¶”ì¶œ</div>
                    </div>
                    
                    <div id="tab-del">
                        <div class="input-group">
                            <label>ê°œë³„ ë«ë“œ ì‚­ì œ (ID)</label>
                            <div style="display:flex; gap:10px;"><input type="text" id="del-id" placeholder="C1101"><button class="btn btn-red btn-small" onclick="deleteRat()">ì‚­ì œ</button></div>
                        </div>
                        <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
                        <div class="input-group">
                            <label>ì½”í˜¸íŠ¸ ì „ì²´ ì‚­ì œ (Cohort No)</label>
                            <div style="display:flex; gap:10px;"><input type="number" id="del-cohort" placeholder="11"><button class="btn btn-red btn-small" onclick="deleteCohort()">ì „ì²´ ì‚­ì œ</button></div>
                        </div>
                    </div>
                    
                    <div id="tab-edit" style="display:none;">
                        <div class="input-group">
                            <label>ë«ë“œ ID ê²€ìƒ‰ (ì „ì²´ ë°ì´í„° ìˆ˜ì •)</label>
                            <div style="display:flex; gap:10px;"><input type="text" id="edit-id" placeholder="C1101"><button class="btn btn-blue btn-small" onclick="searchForEdit()">ê²€ìƒ‰</button></div>
                        </div>
                        <div id="edit-result"></div>
                    </div>
                    
                    <div id="tab-logs" style="display:none;">
                        <div class="input-group">
                            <label>ë«ë“œ ID ê²€ìƒ‰ (ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸°)</label>
                            <div style="display:flex; gap:10px;"><input type="text" id="log-rat-id" placeholder="C1101"><button class="btn btn-blue btn-small" onclick="searchLogsDel()">ë¡œê·¸ ì¡°íšŒ</button></div>
                        </div>
                        <div id="log-del-result" style="margin-top:15px;"></div>
                    </div>

                    <div id="tab-up" style="display:none;">
                        <div style="background:#fff3e0; padding:15px; border-radius:8px; border:1px solid #ffcc80; margin-bottom:15px; font-size:0.9rem; line-height:1.5;">
                            <b>ğŸš¨ ì—‘ì…€ ì—…ë¡œë“œ ì£¼ì˜ì‚¬í•­</b><br>
                            1. ì—‘ì…€ ì²« ì¤„ í—¤ë” ëª…ì¹­ì„ ì •í™•íˆ ì¼ì¹˜ì‹œì¼œì£¼ì„¸ìš”. (Rat_ID í•„ìˆ˜)<br>
                            2. ë‚ ì§œëŠ” YYYY-MM-DD (ì˜ˆ: 2026-02-23) í˜•ì‹ìœ¼ë¡œ ì ì–´ì£¼ì„¸ìš”.<br>
                            3. ë©”ëª¨ ë€ì—ëŠ” ì ˆëŒ€ <b>ì‰¼í‘œ(,)</b>ë¥¼ ì“°ì§€ ë§ˆì„¸ìš”. ì—´ë ¤ìˆëŠ” íŒŒì¼ í˜•ì‹ ë¬¸ì œë¡œ ì—ëŸ¬ê°€ ë‚©ë‹ˆë‹¤.<br>
                            4. íŒŒì¼ì„ ë°˜ë“œì‹œ <b>[CSV UTF-8 (ì‰¼í‘œë¡œ ë¶„ë¦¬)]</b> í˜•ì‹ìœ¼ë¡œ ì €ì¥ í›„ ì˜¬ë ¤ì£¼ì„¸ìš”.
                        </div>
                        <div class="input-group">
                            <label>CSV íŒŒì¼ ì„ íƒ</label>
                            <input type="file" id="csv-upload-input" accept=".csv" onchange="parseRatUploadCSV(event)" style="border:2px dashed var(--navy); padding:15px; background:#f8f9fa;">
                        </div>
                        <div id="csv-preview-area" style="margin-top:15px; max-height: 400px; overflow-y:auto; font-size:0.85rem;"></div>
                        <button id="btn-save-csv" class="btn btn-green" style="margin-top:15px; display:none; width:100%; font-size:1.1rem; padding:12px;" onclick="saveCsvToDB()">ğŸš€ ê²€í†  ì™„ë£Œ: ë°ì´í„°ë² ì´ìŠ¤ì— ë®ì–´ì“°ê¸°</button>
                    </div>

                    <div id="tab-ai" style="display:none;">
                        <div style="background:#f3e5f5; padding:15px; border-radius:8px; border:1px solid #ce93d8; margin-bottom:15px; font-size:0.95rem; line-height:1.5; color:#4a148c;">
                            <b>ğŸ§  AI ë”¥ëŸ¬ë‹ & ë…¼ë¬¸ ì´ˆì•ˆ ì‘ì„±ìš© ë°ì´í„° ì¶”ì¶œê¸°</b><br>
                            - ì½”í˜¸íŠ¸ ì¡°ê±´(ë©”ëª¨), ê°œì²´ë³„ íƒ€ì„ë¼ì¸(ìˆ˜ìˆ /ì‚¬ë§/MR/ìƒ˜í”Œ ì±„ì·¨ì¼), í˜ˆì••/ì²´ì¤‘ ë³€í™”, ARE ë°œìƒ ì—¬ë¶€ê°€ AIê°€ ì½ê¸° ê°€ì¥ ì¢‹ì€ í˜•íƒœë¡œ ì •ë¦¬ë©ë‹ˆë‹¤.<br>
                            - ì¶”ì¶œëœ í…ìŠ¤íŠ¸ íŒŒì¼ì„ <b>Gemini, ChatGPT, Claude</b>ì— ì—…ë¡œë“œí•˜ê³  ë…¼ë¬¸ ì£¼ì œë‚˜ ì´ˆì•ˆ ì‘ì„±ì„ ì§€ì‹œí•˜ì„¸ìš”.
                        </div>
                        
                        <div style="display:flex; gap:10px; margin-top:20px;">
                            <button id="btn-extract-ai" class="btn" style="background:#8e24aa; color:white; font-size:1.1rem; padding:15px;" onclick="exportForAI()">ğŸ“„ AI í”„ë¡¬í”„íŠ¸ìš© í…ìŠ¤íŠ¸ ë°ì´í„° ì¶”ì¶œ ë° ë‹¤ìš´ë¡œë“œ</button>
                        </div>
                        <div id="ai-extract-status" style="margin-top:15px; font-weight:bold; color:var(--navy); text-align:center;"></div>
                    </div>

                </div>`;
                return;
            }


            // 3. Cohort Analysis (ì½”í˜¸íŠ¸ ë¶„ì„)
            if(view === 'cohort') {
                main.innerHTML = `
                <div class="card">
                    <h3>ğŸ“Š ì½”í˜¸íŠ¸ ë¶„ì„ (í†µí•© ë³´ê¸°)</h3>
                    <div id="co-check-list" style="display:flex; flex-wrap:wrap; gap:15px; margin-bottom:15px; padding:15px; background:#f8f9fa; border-radius:8px; border:1px solid #eee; max-height:150px; overflow-y:auto;">ë¡œë”© ì¤‘...</div>
                    <label style="display:block; margin-bottom:15px; font-weight:bold; color:var(--navy); cursor:pointer;">
                        <input type="checkbox" id="show-all-tp" style="width:auto; margin-right:5px; transform:scale(1.2);"> ì „ì²´ íƒ€ì„ë¼ì¸ ë³´ê¸°
                    </label>
                    <button class="btn btn-blue" onclick="loadCohortDetail()">ë¶„ì„ ì‹œì‘</button>
                </div>
                <div id="cohort-res"></div>`;
                await renderCohortCheckboxes('co-check-list');
                return;
            }
            
            // 4. Cohort Compare (ì½”í˜¸íŠ¸ ë¹„êµ)
            if (view === 'compare') {
                main.innerHTML = `
                <div class="card">
                    <h3>ğŸ”„ ì½”í˜¸íŠ¸ ë¹„êµ</h3>
                    <div class="tab-container">
                        <div id="cp-tab-ind" class="tab active" onclick="switchCompTab('ind')">ê°œë³„ ë¹„êµ</div>
                        <div id="cp-tab-grp" class="tab" onclick="switchCompTab('grp')">ê·¸ë£¹ ë¹„êµ</div>
                    </div>
                    <div id="cp-ui-ind">
                        <div id="comp-check-list" style="display:flex; flex-wrap:wrap; gap:15px; margin-bottom:15px; padding:15px; background:#f8f9fa; border-radius:8px; border:1px solid #eee; max-height:150px; overflow-y:auto;">ë¡œë”© ì¤‘...</div>
                        <label style="display:block; margin-bottom:15px; font-weight:bold; color:var(--navy); cursor:pointer;">
                            <input type="checkbox" id="comp-show-all-tp" style="width:auto; margin-right:5px; transform:scale(1.2);"> ì „ì²´ íƒ€ì„ë¼ì¸ ë³´ê¸°
                        </label>
                        <button class="btn btn-blue" onclick="loadCohortComparison()">ê°œë³„ ë¹„êµ ì‹œì‘</button>
                    </div>
                    <div id="cp-ui-grp" style="display:none;">
                        <div style="display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap;">
                            <div style="flex:1; min-width:200px; border:1px solid #ddd; padding:10px; border-radius:8px; background:#f8f9fa;">
                                <div style="font-weight:bold; color:var(--navy); border-bottom:1px solid #ddd; margin-bottom:5px; padding-bottom:5px;">Group A</div>
                                <div id="grp-list-a" style="max-height:150px; overflow-y:auto;"></div>
                            </div>
                            <div style="flex:1; min-width:200px; border:1px solid #ddd; padding:10px; border-radius:8px; background:#f8f9fa;">
                                <div style="font-weight:bold; color:var(--navy); border-bottom:1px solid #ddd; margin-bottom:5px; padding-bottom:5px;">Group B</div>
                                <div id="grp-list-b" style="max-height:150px; overflow-y:auto;"></div>
                            </div>
                            <div style="flex:1; min-width:200px; border:1px solid #ddd; padding:10px; border-radius:8px; background:#f8f9fa;">
                                <div style="font-weight:bold; color:var(--navy); border-bottom:1px solid #ddd; margin-bottom:5px; padding-bottom:5px;">Group C (Optional)</div>
                                <div id="grp-list-c" style="max-height:150px; overflow-y:auto;"></div>
                            </div>
                        </div>
                        <label style="display:block; margin-bottom:15px; font-weight:bold; color:var(--navy); cursor:pointer;">
                            <input type="checkbox" id="grp-show-all-tp" style="width:auto; margin-right:5px; transform:scale(1.2);"> ì „ì²´ íƒ€ì„ë¼ì¸ ë³´ê¸°
                        </label>
                        <button class="btn btn-blue" onclick="loadGroupComparison()">ê·¸ë£¹ ë¹„êµ ì‹œì‘</button>
                    </div>
                </div>
                <div id="comp-res-area" class="comp-grid"></div>`;
                await renderCohortCheckboxes('comp-check-list');
                await renderGroupSelectors();
                return;
            }

            // 5. Other Views
            if(view === 'dash') { main.innerHTML = `<div id="dash-container">ë¡œë”© ì¤‘...</div>`; loadDashboard(); }
            else if(view === 'detail') { 
                main.innerHTML = `
                <div class="card">
                    <h3>ë«ë“œ ìƒì„¸</h3>
                    <div style="display:flex; gap:10px;">
                        <div style="flex:1;">
                            <label style="font-size:0.85rem; font-weight:bold; color:var(--navy);">ì½”í˜¸íŠ¸ ì„ íƒ</label>
                            <select id="dt-cohort-sel" onchange="updateRatList()" style="width:100%; padding:10px;">
                                <option value="">ë¡œë”© ì¤‘...</option>
                            </select>
                        </div>
                        <div style="flex:1;">
                            <label style="font-size:0.85rem; font-weight:bold; color:var(--navy);">ë²ˆí˜¸(ID) ì„ íƒ</label>
                            <select id="dt-rat-sel" onchange="loadDetailData()" style="width:100%; padding:10px;">
                                <option value="">-</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="detail-view"></div>`; 
                await initDetailSelectors(targetId);
            }
            else if(view === 'daily') {
                currentScores = { act: 0, fur: 0, eye: 0 };
                main.innerHTML = `<div class="card"><h3>ë°ì¼ë¦¬ ì²´í¬</h3><div style="display:flex; gap:10px; margin-bottom:10px"><input type="number" id="dc-c" placeholder="C" oninput="mkId('dc')"><input type="number" id="dc-r" placeholder="N" oninput="mkId('dc')"></div><input type="text" id="dc-id" readonly style="background:#eee; margin-bottom:15px"><div class="input-group"><label>ë‚ ì§œ</label><input type="date" id="dc-date"></div>${['act','fur','eye'].map(k => `<div class="input-group"><label>${k.toUpperCase()}</label><div class="rating-box">${[1,2,3,4,5].map(n => `<button class="rate-btn" onclick="score('${k}', ${n}, this)">${n}</button>`).join('')}</div></div>`).join('')}<div id="score-res" class="status-box">ì„ íƒ í•„ìš”</div><textarea id="dc-note" rows="2" placeholder="ë©”ëª¨" style="margin-top:10px;"></textarea><div style="margin-top:10px;"><input type="checkbox" id="is-dead" style="width:auto;"> <label style="display:inline; color:var(--red);">ì‚¬ë§ ì‹œ ì²´í¬</label></div><button class="btn btn-green" onclick="saveDaily()" style="margin-top:15px;">ì €ì¥</button></div>`;
                document.getElementById('dc-date').value = getTodayStr();
            }
            else if(view === 'add') { 
                main.innerHTML = `<div class="card"><h3>ëŒ€ëŸ‰ ë“±ë¡</h3><div class="input-group"><label>ì½”í˜¸íŠ¸</label><input type="number" id="add-c"></div><div style="display:flex; gap:10px;"><input type="number" id="add-s" placeholder="ì‹œì‘"><input type="number" id="add-e" placeholder="ë"></div><div class="input-group" style="margin-top:10px;"><label>ë°˜ì…ì¼</label><input type="date" id="add-d"></div><button class="btn btn-green" onclick="saveBulk()">ë“±ë¡</button></div>`; 
                document.getElementById('add-d').value = getTodayStr(); 
            }
            else if(view === 'dose') { 
                main.innerHTML = `<div class="card"><h3>íˆ¬ì•½ ê³„ì‚°ê¸°</h3><input type="number" id="ds-c" placeholder="ì½”í˜¸íŠ¸" oninput="upDose()" style="margin-bottom:10px;"><table><thead><tr><th>ë²ˆ</th><th>WT(g)</th><th>ID</th></tr></thead><tbody>${Array.from({length:12},(_,i)=>`<tr><td><input type="number" class="dn" oninput="upDose()"></td><td><input type="number" class="dw"></td><td class="di">-</td></tr>`).join('')}</tbody></table><button class="btn btn-blue" onclick="saveDose()" style="margin-top:15px;">ê³„ì‚° ë° ì €ì¥</button><div id="dose-res" style="display:none;"></div></div>`; 
            }
            else if(view === 'rec') { 
                let timeOpts = `<option>Manual</option><option>Arrival</option><option>D00</option><option>D0</option><option>D2</option>`;
                for(let i=1; i<=30; i++) { timeOpts += `<option>W${i}</option>`; }
                main.innerHTML = `
                <div class="card">
                    <h3>í˜ˆì••/ì²´ì¤‘ ê¸°ë¡</h3>
                    <div style="display:flex; gap:10px;">
                        <input type="number" id="re-c" placeholder="C" oninput="mkId('re')">
                        <input type="number" id="re-r" placeholder="N" oninput="mkId('re')">
                    </div>
                    <input type="text" id="re-id" readonly style="background:#eee; margin:10px 0;">
                    <label style="font-size:0.8rem; font-weight:bold; color:var(--navy);">ì‹œì  ì„ íƒ</label>
                    <select id="re-tp" style="margin-bottom:10px;">${timeOpts}</select>
                    <input type="date" id="re-date" style="margin-top:5px;">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
                        <input type="number" id="re-s" placeholder="SBP" oninput="calM()">
                        <input type="number" id="re-d" placeholder="DBP" oninput="calM()">
                    </div>
                    <input type="number" id="re-m" placeholder="Mean" readonly style="background:#eee; margin-top:10px;">
                    <input type="number" id="re-w" placeholder="WT(g)" step="0.1" style="margin-top:10px;">
                    <button class="btn btn-green" onclick="saveRec()" style="margin-top:15px;">ì €ì¥</button>
                </div>`; 
                document.getElementById('re-date').value = getTodayStr(); 
            }
            else if(view === 'bp') { 
                main.innerHTML = `<div class="card"><h3>BP Analyzer (PC Ver.)</h3><div class="bp-controls" style="background:#f8f9fa; padding:15px; border-radius:8px; border:1px solid #eee;"><label><input type="radio" name="bp-mode" value="control" checked> Control</label><label style="margin-left:20px;"><input type="radio" name="bp-mode" value="induction"> Induction</label><br><input type="file" id="bp-file-input" accept=".csv" multiple style="margin-top:15px; width:100%; border:2px dashed #cbd5e0; padding:10px; box-sizing:border-box;"></div><div id="bp-output" style="margin-top:20px;"></div></div>`; 
                document.getElementById('bp-file-input').addEventListener('change', loadBPFiles); 
            }
        }

        // --- Group Comparison Helpers ---
        function switchCompTab(mode) {
            document.getElementById('cp-tab-ind').className = mode==='ind' ? 'tab active' : 'tab';
            document.getElementById('cp-tab-grp').className = mode==='grp' ? 'tab active' : 'tab';
            document.getElementById('cp-ui-ind').style.display = mode==='ind' ? 'block' : 'none';
            document.getElementById('cp-ui-grp').style.display = mode==='grp' ? 'block' : 'none';
        }

        async function renderGroupSelectors() {
            // [ë³€ê²½] ìºì‹œëœ ë°ì´í„° ì‚¬ìš©
            const ratsData = await getRatsWithCache();
            
            const cohorts = new Set();
            ratsData.forEach(d => cohorts.add(d.cohort));
            const sorted = Array.from(cohorts).sort((a,b)=>Number(b)-Number(a));
            
            const createList = (id) => {
                const con = document.getElementById(id);
                con.innerHTML = '';
                sorted.forEach(c => {
                    const div = document.createElement('div');
                    div.innerHTML = `<label style="cursor:pointer; display:block; padding:2px 0;"><input type="checkbox" value="${c}" style="width:auto; margin-right:5px;"> Cohort ${c}</label>`;
                    con.appendChild(div);
                });
            };
            createList('grp-list-a');
            createList('grp-list-b');
            createList('grp-list-c');
        }

        // [2] ê·¸ë£¹ ë¹„êµ ë¡œë”© í•¨ìˆ˜ (ì „ì—­ë³€ìˆ˜ ì´ˆê¸°í™” ì¶”ê°€)
        async function loadGroupComparison() {
            // 1. ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”
            compScatterCharts = {};
            compScatterDataCache = {};
            compFilterState = {};

            const getSelected = (id) => Array.from(document.querySelectorAll(`#${id} input:checked`)).map(cb => cb.value);
            const grpA = getSelected('grp-list-a');
            const grpB = getSelected('grp-list-b');
            const grpC = getSelected('grp-list-c');

            const activeGroups = [];
            if(grpA.length > 0) activeGroups.push({ name: 'Group A', cohorts: grpA });
            if(grpB.length > 0) activeGroups.push({ name: 'Group B', cohorts: grpB });
            if(grpC.length > 0) activeGroups.push({ name: 'Group C', cohorts: grpC });

            if(activeGroups.length < 2) return alert("ë¹„êµë¥¼ ìœ„í•´ ìµœì†Œ 2ê°œ ê·¸ë£¹ì— ì½”í˜¸íŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");

            const container = document.getElementById('comp-res-area');
            container.innerHTML = '<div class="loader"></div> ê·¸ë£¹ ë°ì´í„° ë²”ìœ„ ê³„ì‚° ì¤‘...';

            let globalLabels = [];
            let globalMaxSbp = 0;
            let globalMaxWt = 0;
            let globalMaxPod = 0;

            try {
                const allCohorts = [];
                activeGroups.forEach(g => allCohorts.push(...g.cohorts));
                const uniqueCohorts = [...new Set(allCohorts)];

                const ratPromises = uniqueCohorts.map(c => db.collection("rats").where("cohort", "==", c).get());
                const ratSnaps = await Promise.all(ratPromises);
                
                let allRatIds = [];
                let surgeryMap = {};

                ratSnaps.forEach(snap => {
                    snap.forEach(d => {
                        const r = d.data();
                        allRatIds.push(r.ratId);
                        if(r.surgeryDate) surgeryMap[r.ratId] = r.surgeryDate;
                        if(r.surgeryDate && r.deathDate) {
                            const pod = Math.floor((new Date(r.deathDate) - new Date(r.surgeryDate))/(1000*60*60*24));
                            if(pod > globalMaxPod) globalMaxPod = pod;
                        }
                    });
                });

                const measPromises = allRatIds.map(rid => db.collection("measurements").where("ratId", "==", rid).get());
                const measSnaps = await Promise.all(measPromises);

                const stdPodMap = globalPodMap;
                const tempColumns = [];
                const labelSet = new Set();
                const showAll = document.getElementById('grp-show-all-tp')?.checked;

                measSnaps.forEach((snap, idx) => {
                    const rid = allRatIds[idx];
                    const surgDate = surgeryMap[rid];
                    snap.forEach(doc => {
                        const d = doc.data();
                        if(d.sbp && d.sbp > globalMaxSbp) globalMaxSbp = d.sbp;
                        if(d.weight && d.weight > globalMaxWt) globalMaxWt = d.weight;
                        
                        if (d.timepoint && stdPodMap.hasOwnProperty(d.timepoint)) {
                            if (!labelSet.has(d.timepoint)) {
                                labelSet.add(d.timepoint);
                                tempColumns.push({ label: d.timepoint, sortVal: stdPodMap[d.timepoint] });
                            }
                        } else if (showAll && d.date && surgDate) {
                            if (!labelSet.has(d.date)) {
                                const diff = new Date(d.date) - new Date(surgDate);
                                const pod = Math.floor(diff / (1000 * 60 * 60 * 24));
                                labelSet.add(d.date);
                                tempColumns.push({ label: d.date, sortVal: pod });
                            }
                        }
                    });
                });

                tempColumns.sort((a,b) => a.sortVal - b.sortVal);
                globalLabels = tempColumns.map(c => c.label);

            } catch(e) { console.error("Group Scale Calc Error", e); }

            container.innerHTML = ''; 

            for(let i=0; i<activeGroups.length; i++) {
                const g = activeGroups[i];
                const colDiv = document.createElement('div');
                colDiv.className = 'comp-col';
                colDiv.id = `comp-res-grp-${i}`;
                colDiv.innerHTML = `<div class="loader"></div>`;
                container.appendChild(colDiv);
                
                const title = `${g.name} : Cohort ${g.cohorts.join(', ')}`;
                await runCohortAnalysis(g.cohorts, `comp-res-grp-${i}`, `_grp_${i}`, {
                    labels: globalLabels,
                    maxSbp: globalMaxSbp,
                    maxWt: globalMaxWt,
                    maxPod: globalMaxPod
                }, title);
            }
        }

        // ... [Existing renderCohortCheckboxes, initDetailSelectors, updateRatList ...]
        async function renderCohortCheckboxes(containerId) {
            // [ë³€ê²½] ë§¤ë²ˆ DBë¥¼ ì½ì§€ ì•Šê³  ìºì‹œ í•¨ìˆ˜ë¥¼ í†µí•´ ë°ì´í„° ê°€ì ¸ì˜´
            const ratsData = await getRatsWithCache();
            
            const cohorts = new Set();
            // [ë³€ê²½] ìŠ¤ëƒ…ìƒ·(forEach)ì´ ì•„ë‹ˆë¼ ë°°ì—´(forEach)ì„ ìˆœíšŒ
            ratsData.forEach(d => cohorts.add(d.cohort));
            
            const sorted = Array.from(cohorts).sort((a,b)=>Number(b)-Number(a));
            
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            if(sorted.length === 0) {
                container.innerHTML = 'ë°ì´í„° ì—†ìŒ';
            } else {
                sorted.forEach(c => {
                    const wrapper = document.createElement('div');
                    wrapper.innerHTML = `<label style="cursor:pointer; font-weight:bold; color:var(--navy); display:flex; align-items:center;"><input type="checkbox" class="co-checkbox" value="${c}" style="width:auto; margin-right:8px; transform:scale(1.2);">Cohort ${c}</label>`;
                    container.appendChild(wrapper);
                });
            }
        }

        async function initDetailSelectors(targetId) {
            try {
                // [ë³€ê²½] ìºì‹œëœ ë°ì´í„° ì‚¬ìš©
                const ratsData = await getRatsWithCache();
                
                // [ë³€ê²½] ì´ë¯¸ ë°°ì—´ í˜•íƒœì´ë¯€ë¡œ forEachë¡œ pushí•  í•„ìš” ì—†ì´ ë°”ë¡œ í• ë‹¹
                allRatsForDetail = ratsData; 
                
                const cohorts = new Set(allRatsForDetail.map(r => r.cohort));
                const sortedCohorts = Array.from(cohorts).sort((a,b) => Number(b) - Number(a));
                
                const cSel = document.getElementById('dt-cohort-sel');
                cSel.innerHTML = '<option value="">-- ì½”í˜¸íŠ¸ ì„ íƒ --</option>' + sortedCohorts.map(c => `<option value="${c}">Cohort ${c}</option>`).join('');
                
                if(targetId) {
                    const targetRat = allRatsForDetail.find(r => r.ratId === targetId);
                    if(targetRat) {
                        cSel.value = targetRat.cohort;
                        updateRatList(targetId);
                    }
                }
            } catch(e) { console.error(e); }
        }

        function updateRatList(preSelectId = null) {
            const cVal = document.getElementById('dt-cohort-sel').value;
            const rSel = document.getElementById('dt-rat-sel');
            if(!cVal) { rSel.innerHTML = '<option value="">-</option>'; return; }
            const filtered = allRatsForDetail.filter(r => r.cohort === cVal).sort((a,b) => a.ratId.localeCompare(b.ratId));
            rSel.innerHTML = '<option value="">-- ë²ˆí˜¸ ì„ íƒ --</option>' + filtered.map(r => {
                const deadMark = r.status === 'ì‚¬ë§' ? ' (ì‚¬ë§)' : '';
                return `<option value="${r.ratId}">${r.ratId}${deadMark}</option>`;
            }).join('');
            if(preSelectId) { rSel.value = preSelectId; loadDetailData(); }
        }

        // =========================================================
        //  COHORT ANALYSIS & CHART GENERATION (Hierarchical Pie)
        // =========================================================
        
        // Define Custom Color Palette for Clarity
        // [ìˆ˜ì •ë¨] ìƒ‰ìƒ íŒ”ë ˆíŠ¸: ëŒ€ë¹„ ê°•í™” ë° Aneurysm O/X êµ¬ë¶„ í™•ì‹¤í™”
        // [í•„ìˆ˜] COD ì°¨íŠ¸ ìƒ‰ìƒ ë§¤í•‘ (3ì°¨ ë¶„ë¥˜ ìƒ‰ìƒ í¬í•¨)
        const codColors = {
            // 1ì°¨ ë¶„ë¥˜
            "Neurological": "#1565C0",      // ì§„í•œ íŒŒë‘
            "Non-Neurological": "#D32F2F",  // ì§„í•œ ë¹¨ê°•
            "Unknown": "#424242",           // ì§„í•œ íšŒìƒ‰

            // 2ì°¨ ë¶„ë¥˜
            "Aneurysm(O)": "#C2185B",       // ì§„í•œ í•‘í¬
            "Aneurysm (O)": "#C2185B",
            "Aneurysm(X)": "#00897B",       // ì²­ë¡ìƒ‰
            "Aneurysm (X)": "#00897B",
            "Surgical Failure": "#F57C00",  // ì£¼í™©
            "Unknown (Sec)": "#E57373",     // ì—°í•œ ë¹¨ê°•
            "Sacrifice (Sec)": "#FFB300",   // í˜¸ë°•ìƒ‰

            // 3ì°¨ ë¶„ë¥˜ (Detail) - ì—¬ê¸°ê°€ íšŒìƒ‰ìœ¼ë¡œ ë‚˜ì˜¤ì§€ ì•Šë„ë¡ ì •ì˜
            "SAH": "#64B5F6",               // ë°ì€ íŒŒë‘
            "Infarction": "#26C6DA",        // ì‹œì•ˆ(Cyan)
            "Vasospasm": "#AB47BC",         // ë³´ë¼
            "Sacrifice": "#FFF176",         // ë…¸ë‘
            "Unknown (3rd)": "#EEEEEE",     // ì—°íšŒìƒ‰
            "None": "transparent"
        };

        // ì•½ì–´ ë§¤í•‘ (ê¸°ì¡´ ìœ ì§€)
        const codAbbrMap = {
            "Non-Neurological": "Non-Neuro",
            "Neurological": "Neuro",
            "Aneurysm(O)": "Aneurysm(O)", // ì•½ì–´ë„ ê·¸ëŒ€ë¡œ í‘œì‹œí•˜ì—¬ í˜¼ë™ ë°©ì§€
            "Aneurysm (O)": "Aneurysm(O)",
            "Aneurysm(X)": "Aneurysm(X)",
            "Aneurysm (X)": "Aneurysm(X)",
            "Infarction": "Infarc",
            "Vasospasm": "CVS",
            "Sacrifice": "Sacrifice",
            "Procedure related": "Proc. related",
            "Unknown": "Unknown",
            "None": "-"
        };
        // â–²â–²â–² [ì¶”ê°€ ë] â–²â–²â–²

        function toggleDetails(detailId, btnId) {
            const el = document.getElementById(detailId);
            const btn = document.getElementById(btnId);
            if(el.style.display === 'none') {
                el.style.display = 'block';
                btn.innerText = 'â–² ìƒì„¸ ë°ì´í„° ì ‘ê¸°';
                btn.classList.replace('btn-blue', 'btn-red');
            } else {
                el.style.display = 'none';
                btn.innerText = 'â–¼ ìƒì„¸ ë°ì´í„° ë³´ê¸° (Detail)';
                btn.classList.replace('btn-red', 'btn-blue');
            }
        }

        // ê°„ë‹¨í•œ í† ê¸€ í—¬í¼ í•¨ìˆ˜ (script íƒœê·¸ ë‚´ ì•„ë¬´ë°ë‚˜ ì¶”ê°€í•´ì£¼ì„¸ìš”)
        function toggleDisplay(id) {
            const el = document.getElementById(id);
            if(el.style.display === 'none' || el.style.display === '') {
                el.style.display = 'block';
            } else {
                el.style.display = 'none';
            }
        }

        async function loadCohortDetail() {
            const checkboxes = document.querySelectorAll('#co-check-list .co-checkbox:checked');
            if(checkboxes.length === 0) return alert("ë¶„ì„í•  ì½”í˜¸íŠ¸ë¥¼ í•˜ë‚˜ ì´ìƒ ì„ íƒí•˜ì„¸ìš”.");
            const selectedCohorts = Array.from(checkboxes).map(cb => cb.value);
            
            // ì½”í˜¸íŠ¸ ë¶„ì„ ì‹¤í–‰ (ìˆ˜ì •ëœ í•¨ìˆ˜ í˜¸ì¶œ)
            await runCohortAnalysis(selectedCohorts, 'cohort-res', '_main');
        }
        
        // [ì‹ ê·œ] ì°¨íŠ¸ ë°ì´í„° í‘œì‹œ/ìˆ¨ê¹€ í† ê¸€ í•¨ìˆ˜ (í…Œì´ë¸” ì²´í¬ë°•ìŠ¤ ì—°ë™)
        function toggleRatVisibility(chartId, ratId, isChecked) {
            const chart = Chart.getChart(chartId);
            if (!chart) return;

            // ìˆ¨ê²¨ì§„ ë«ë“œ ëª©ë¡ ê´€ë¦¬
            if (!chart._hiddenRats) chart._hiddenRats = new Set();
            
            if (isChecked) {
                chart._hiddenRats.delete(ratId);
            } else {
                chart._hiddenRats.add(ratId);
            }

            applyChartFilters(chart);
        }

        function toggleTimepointVisibility(chartId, pod, isChecked) {
            const chart = Chart.getChart(chartId);
            if (!chart) return;

            // ìˆ¨ê²¨ì§„ ì‹œì  ëª©ë¡ ê´€ë¦¬
            if (!chart._hiddenTimepoints) chart._hiddenTimepoints = new Set();

            if (isChecked) {
                chart._hiddenTimepoints.delete(pod);
            } else {
                chart._hiddenTimepoints.add(pod);
            }

            applyChartFilters(chart);
        }

        // [ê³µí†µ] í•„í„° ì ìš© ë¡œì§ (ê°œì²´ ìˆ¨ê¹€ + ì‹œì  ìˆ¨ê¹€ ë™ì‹œ ì ìš©)
        function applyChartFilters(chart) {
            chart.data.datasets.forEach(ds => {
                // ì›ë³¸ ë°ì´í„° ìºì‹± (ìµœì´ˆ 1íšŒ)
                if (!ds._originalData) {
                    ds._originalData = [...ds.data];
                }

                ds.data = ds._originalData.filter(d => {
                    // 1. ê°œì²´(Rat ID) í•„í„° í™•ì¸ (Individual ì ì—ë§Œ í•´ë‹¹)
                    if (d.rid && chart._hiddenRats && chart._hiddenRats.has(d.rid)) {
                        return false;
                    }

                    // 2. ì‹œì (Timepoint) í•„í„° í™•ì¸ (Average ì„ , Individual ì  ëª¨ë‘ í•´ë‹¹)
                    // ScatterëŠ” jitterê°€ ìˆìœ¼ë¯€ë¡œ ë°˜ì˜¬ë¦¼í•˜ì—¬ POD ë¹„êµ
                    const p = Math.round(d.x);
                    if (chart._hiddenTimepoints && chart._hiddenTimepoints.has(p)) {
                        return false;
                    }

                    return true;
                });
            });

            chart.update('none'); // ì• ë‹ˆë©”ì´ì…˜ ì—†ì´ ì¦‰ì‹œ ë°˜ì˜
        }

        

        // ============================================================
        // [2] ê°œë³„ ë¹„êµ í•¨ìˆ˜ (ë³µêµ¬ë¨)
        // ============================================================
        async function loadCohortComparison() {
            // 1. ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”
            compScatterCharts = {};
            compScatterDataCache = {};
            compFilterState = {};
            
            // [ì¶”ê°€] ë™ê¸°í™” ì°¨íŠ¸ ëª©ë¡ ì´ˆê¸°í™”
            syncChartsSbp = [];
            syncChartsWt = [];
            activeCrosshairValSbp = null;
            activeCrosshairValWt = null;

            const checkboxes = document.querySelectorAll('#comp-check-list .co-checkbox:checked');
            const selectedCohorts = Array.from(checkboxes).map(cb => cb.value);

            if(selectedCohorts.length < 2) return alert("ë¹„êµí•  ì½”í˜¸íŠ¸ë¥¼ 2ê°œ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.");

            const container = document.getElementById('comp-res-area');
            container.innerHTML = '<div class="loader"></div> ë°ì´í„° ë²”ìœ„ ê³„ì‚° ì¤‘...';

            try {
                const ratPromises = selectedCohorts.map(c => db.collection("rats").where("cohort", "==", c).get());
                const ratSnaps = await Promise.all(ratPromises);
                
                let allRats = [];
                ratSnaps.forEach(snap => snap.forEach(d => allRats.push(d.data())));

                const measPromises = allRats.map(r => db.collection("measurements").where("ratId", "==", r.ratId).get());
                const measSnaps = await Promise.all(measPromises);

                let globalMinX = 0, globalMaxX = 0, globalMaxSbp = 0, globalMaxWt = 0;
                const unionStandardTicks = new Set(); 

                measSnaps.forEach((snap, i) => {
                    const r = allRats[i];
                    snap.forEach(d => {
                        const v = d.data();
                        const pod = getPodForLabel(v.timepoint, r.surgeryDate, v.date);
                        
                        if (pod !== null) {
                            if (pod < globalMinX) globalMinX = pod;
                            if (pod > globalMaxX) globalMaxX = pod;
                        }
                        if (v.sbp && v.sbp > globalMaxSbp) globalMaxSbp = v.sbp;
                        if (v.weight && v.weight > globalMaxWt) globalMaxWt = v.weight;

                        if (v.timepoint && globalPodMap.hasOwnProperty(v.timepoint)) {
                            unionStandardTicks.add(v.timepoint);
                        }
                    });
                });

                const fixedOptions = {
                    minX: globalMinX - 2,
                    maxX: globalMaxX + 2,
                    maxSbp: globalMaxSbp,
                    maxWt: globalMaxWt,
                    standardTicks: Array.from(unionStandardTicks)
                };

                container.innerHTML = ''; 
                for(let i=0; i<selectedCohorts.length; i++) {
                    const c = selectedCohorts[i];
                    const divId = `comp-res-${c}`;
                    const colDiv = document.createElement('div');
                    colDiv.className = 'comp-col';
                    colDiv.id = divId;
                    container.appendChild(colDiv);
                    
                    await runCohortAnalysis([c], divId, `_comp_${c}`, fixedOptions, `Cohort ${c}`);
                }

            } catch(e) { 
                console.error("Comparison Error", e); 
                container.innerHTML = `<p style="color:red">ì˜¤ë¥˜: ${e.message}</p>`;
            }
        }

       
        function renderBpChart() {
            if (bpChartInstance) bpChartInstance.destroy();
            const showSbp = document.getElementById('chk-sbp').checked;
            const showWt = document.getElementById('chk-wt').checked;
            const ctx = document.getElementById('bpChart');
            const datasets = [];
            if (showSbp) { datasets.push({ label: 'SBP', data: globalBpData.map(d => d.sbp), borderColor: '#d32f2f', yAxisID: 'y', spanGaps: true }); }
            if (showWt) { datasets.push({ label: 'WT', data: globalBpData.map(d => d.wt), borderColor: '#00c853', yAxisID: 'y1', spanGaps: true }); }

            bpChartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: globalBpData.map(d => (d.label && d.label !== d.date) ? `${d.date} (${d.label})` : d.date), datasets: datasets },
                options: { maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, scales: { y: { position: 'left', display: showSbp }, y1: { position: 'right', display: showWt, grid: { drawOnChartArea: false } } } }
            });
        }

        async function checkRatValid(id) {
            try {
                const s = await db.collection("rats").where("ratId", "==", id).get();
                if (s.empty) { alert(`[${id}] ë“±ë¡ë˜ì§€ ì•Šì€ ë«ë“œì…ë‹ˆë‹¤.`); return null; }
                const data = s.docs[0].data();
                if (data.status === 'ì‚¬ë§') { alert(`[${id}] ì´ë¯¸ ì‚¬ë§í•œ ê°œì²´ì…ë‹ˆë‹¤. ë°ì´í„°ë¥¼ ì¶”ê°€/ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`); return null; }
                return s.docs[0];
            } catch(e) { console.error(e); alert("ë°ì´í„° í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"); return null; }
        }

        async function upDoseStart(did) {
            const doc = await db.collection("rats").doc(did).get();
            if(doc.exists) { const ratId = doc.data().ratId; if(!(await checkRatValid(ratId))) return; }
            await db.collection("rats").doc(did).update({ doseStartDate: document.getElementById('dose-start-d').value });
            alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); loadDetailData();
        }
        
        // [ì¶”ê°€] ìƒ˜í”Œ íƒ€ì… ì €ì¥ í•¨ìˆ˜
        // [ìˆ˜ì •] ìƒ˜í”Œ íƒ€ì… ì €ì¥ í•¨ìˆ˜ (ì‚¬ë§ ì—¬ë¶€ ì²´í¬ ë¡œì§ ì œê±°)
        async function upSampleType(did) {
            // 1. ì„ íƒëœ ê°’ ê°€ì ¸ì˜¤ê¸°
            const el = document.getElementById('sample-tp');
            if (!el) return; 
            const val = el.value;

            try {
                // 2. ë¬¸ì„œ ì°¸ì¡° ê°€ì ¸ì˜¤ê¸°
                const docRef = db.collection("rats").doc(did);
                const doc = await docRef.get();
                
                if (!doc.exists) {
                    alert("í•´ë‹¹ ë«ë“œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }

                // 3. (ì¤‘ìš”) ì‚¬ë§ ì—¬ë¶€ ì²´í¬(checkRatValid) ì—†ì´ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                await docRef.update({ sampleType: val });
                clearRatsCache();
                alert("ìƒ˜í”Œ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                loadDetailData(); // í™”ë©´ ê°±ì‹ 
            } catch(e) {
                console.error(e);
                alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.message);
            }
        }

        async function upSurg(did) { 
            const doc = await db.collection("rats").doc(did).get();
            if(doc.exists) { const ratId = doc.data().ratId; if(!(await checkRatValid(ratId))) return; }
            await db.collection("rats").doc(did).update({ surgeryDate: document.getElementById('surg-d').value }); 
            alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); loadDetailData(); 
        }

        function toggleDailyLog() { const t = document.getElementById('daily-detail-table'); t.style.display = t.style.display === 'none' ? 'block' : 'none'; }
        function toggleBpLog() { const t = document.getElementById('bp-detail-table'); t.style.display = t.style.display === 'none' ? 'block' : 'none'; }

        async function loadDashboard() { 
            try { 
                // ìºì‹œ í•¨ìˆ˜ ì‚¬ìš©
                const ratsData = await getRatsWithCache(); 
                
                if(ratsData.length === 0) { document.getElementById('dash-container').innerHTML = "<p>ë°ì´í„° ì—†ìŒ</p>"; return; } 
                
                const memoSnap = await db.collection("cohortNotes").get();
                const noteData = {};
                memoSnap.forEach(d => noteData[d.id] = d.data());

                const grp = {}; 
                // forEach ëŒ€ì‹  ë°°ì—´ ìˆœíšŒ ì‚¬ìš©
                ratsData.forEach(d => { 
                    if(!grp[d.cohort]) grp[d.cohort] = { rats: [], surg: d.surgeryDate || null }; 
                    grp[d.cohort].rats.push(d); 
                });
                
                let html = '<div style="width:100%; text-align:right; color:#666; font-size:0.85rem; margin-bottom:10px;"><i class="material-icons" style="font-size:1rem; vertical-align:text-bottom;">touch_app</i> ë«ë“œ ë²ˆí˜¸ë¥¼ ëˆ„ë¥´ë©´ ìƒì„¸ë³´ê¸°ë¡œ ì´ë™í•©ë‹ˆë‹¤.</div>'; 
                
                const sortedCohorts = Object.keys(grp).sort((a,b)=>Number(b)-Number(a));
                const allTimepoints = Object.keys(globalPodMap).sort((a,b) => globalPodMap[a] - globalPodMap[b]);

                sortedCohorts.forEach(c => { 
                    let podTag = `<span style="font-size:0.8rem; color:#888;">ìˆ˜ìˆ ì „</span>`; 
                    if(grp[c].surg) { 
                        const pod = Math.floor((new Date() - new Date(grp[c].surg))/(1000*60*60*24)); 
                        const w = Math.floor(pod/7), d=pod%7; 
                        podTag = `<span class="d-day-badge">W${w}+${d} (POD ${pod})</span>`; 
                    } 
                    
                    const cData = noteData[c] || {};
                    const currentMemo = cData.memo || "";
                    const mrChecks = cData.mrChecks || {}; 
                    const config = cData.mrConfig || ['D0','D2','W1','W4','W8','W12','W20'];
                    
                    // ë©”ëª¨ ì˜ì—­
                    const memoHtml = `<div class="co-memo-box"><i class="material-icons edit-icon" onclick="toggleCoMemo('${c}')">edit</i><span id="memo-txt-${c}" class="memo-text">${currentMemo || ''}</span><div id="memo-edit-area-${c}" style="display:none;"><input type="text" id="memo-inp-${c}" class="co-memo-input" value="${currentMemo}"><button class="btn-small btn-blue" style="padding:2px 8px; margin-left:5px;" onclick="saveCoMemo('${c}')">OK</button></div></div>`;
                    
                    // MR ì²´í¬ ì˜ì—­
                    let mrHtml = `<div class="mr-check-group" style="margin-left:0; margin-top:5px;"><span style="font-weight:bold; color:var(--navy); margin-right:4px;">MR:</span>`;
                    mrHtml += `<i class="material-icons" style="font-size:1.1rem; cursor:pointer; color:#7f8c8d; vertical-align:middle; margin-right:5px;" onclick="toggleMrConfig('${c}')" title="MR ì²´í¬ë¦¬ìŠ¤íŠ¸ ì„¤ì •">settings</i>`;
                    config.forEach(tp => {
                        const isChecked = mrChecks[tp] ? 'checked' : '';
                        mrHtml += `<label><input type="checkbox" onclick="toggleMr(event, '${c}', '${tp}')" ${isChecked}>${tp}</label>`;
                    });
                    mrHtml += `</div>`;

                    // ì„¤ì • íŒ¨ë„
                    const configPanel = `
                    <div id="mr-cfg-panel-${c}" style="display:none; width:100%; background:#fff; border:1px solid #ddd; padding:10px; margin-bottom:10px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                        <div style="font-weight:bold; color:var(--navy); font-size:0.9rem; margin-bottom:8px; border-bottom:1px solid #eee; padding-bottom:5px;">âš™ï¸ Cohort ${c} - MR ì‹œì  ì„¤ì •</div>
                        <div style="display:flex; flex-wrap:wrap; gap:8px; max-height:120px; overflow-y:auto; margin-bottom:10px;">
                            ${allTimepoints.map(tp => {
                                const checked = config.includes(tp) ? 'checked' : '';
                                return `<label style="font-size:0.85rem; cursor:pointer; background:#f8f9fa; padding:2px 6px; border-radius:4px; border:1px solid #eee;"><input type="checkbox" class="mr-cfg-chk-${c}" value="${tp}" ${checked} style="vertical-align:middle;"> ${tp}</label>`;
                            }).join('')}
                        </div>
                        <div style="text-align:right;">
                            <button class="btn btn-blue btn-small" style="width:auto; padding:4px 12px;" onclick="saveMrConfig('${c}')">ì €ì¥</button>
                            <button class="btn btn-red btn-small" style="width:auto; padding:4px 12px; background:#ccc; border:none;" onclick="toggleMrConfig('${c}')">ë‹«ê¸°</button>
                        </div>
                    </div>`;

                    html += `<div class="card">
                        <div class="cohort-header" style="display:block;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div style="display:flex; align-items:center; flex-wrap:wrap; gap:5px;">
                                    <span style="font-weight:bold; font-size:1.1rem; color:var(--navy);">Cohort ${c}</span>
                                    ${memoHtml}
                                </div>
                                ${podTag}
                            </div>
                            <div style="width:100%;">${mrHtml}</div>
                        </div>
                        ${configPanel}
                        <div class="rat-grid">`; 
                    
                    // ë«ë“œ ëª©ë¡ ìƒì„± (ìˆ˜ì •ëœ ë¶€ë¶„)
                    grp[c].rats.forEach(r => { 
                        let statusClass = 'rat-badge'; 
                        if(r.status === 'ì‚¬ë§') statusClass += ' status-dead'; 
                        else if(r.lastScore) { 
                            if(r.lastScore >= 13) statusClass += ' status-normal'; 
                            else if(r.lastScore >= 9) statusClass += ' status-mild'; 
                            else statusClass += ' status-severe'; 
                        } 

                        // [ì¤‘ìš”] ìƒ˜í”Œ ë§ˆí¬ ìƒì„± ë¶€ë¶„
                        let sampleMark = '';
                        if (r.sampleType === 'Cast') {
                            sampleMark = '<div class="sample-indicator sample-c">C</div>';
                        } else if (r.sampleType === 'Histology') {
                            sampleMark = '<div class="sample-indicator sample-h">H</div>';
                        }

                        html += `<div class="rat-wrapper">
                                    ${sampleMark}
                                    <div class="${statusClass}" onclick="goToDetail('${r.ratId}')">${r.num}</div>
                                </div>`; 
                    }); 
                    html += `</div></div>`; 
                }); 
                document.getElementById('dash-container').innerHTML = html; 
            } catch(e) { 
                console.error(e);
                document.getElementById('dash-container').innerHTML = `<p style="color:red">${e.message}</p>`; 
            } 
        }

        async function toggleMr(e, c, tp) {
            e.stopPropagation(); 
            if(!confirm(`[Cohort ${c}] ${tp} ì‹œì ì˜ MR ì´¬ì˜ ì—¬ë¶€ë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) { e.preventDefault(); return; }
            const val = e.target.checked;
            try { await db.collection("cohortNotes").doc(c).set({ mrChecks: { [tp]: val } }, { merge: true }); } catch(err) { console.error(err); alert("ì €ì¥ ì‹¤íŒ¨"); e.preventDefault(); }
        }

        function toggleCoMemo(c) {
            const txt = document.getElementById(`memo-txt-${c}`);
            const area = document.getElementById(`memo-edit-area-${c}`);
            if(area.style.display === 'none') { area.style.display = 'inline-block'; txt.style.display = 'none'; } else { area.style.display = 'none'; txt.style.display = 'inline-block'; }
        }

        async function saveCoMemo(c) {
            const val = document.getElementById(`memo-inp-${c}`).value;
            await db.collection("cohortNotes").doc(c).set({ memo: val }, { merge: true }); 
            document.getElementById(`memo-txt-${c}`).innerText = val;
            toggleCoMemo(c);
        }

        // MR ì„¤ì •ì°½ ì—´ê¸°/ë‹«ê¸°
        function toggleMrConfig(c) {
            const el = document.getElementById(`mr-cfg-panel-${c}`);
            if(el.style.display === 'none') {
                el.style.display = 'block';
            } else {
                el.style.display = 'none';
            }
        }

        // MR ì„¤ì • ì €ì¥
        async function saveMrConfig(c) {
        // [ìˆ˜ì •] ì (.)ì´ í¬í•¨ëœ ì½”í˜¸íŠ¸ ë²ˆí˜¸(ì˜ˆ: 7.5) ì˜¤ë¥˜ í•´ê²°ì„ ìœ„í•´ 
        // ë¶€ëª¨ ì»¨í…Œì´ë„ˆ(ID)ë¥¼ ë¨¼ì € ì°¾ê³  ê·¸ ì•ˆì˜ ì²´í¬ë°•ìŠ¤ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.
            const container = document.getElementById(`mr-cfg-panel-${c}`);
            if (!container) return; 

            const chks = container.querySelectorAll('input[type="checkbox"]:checked');
            const selected = Array.from(chks).map(cb => cb.value);
            
            if(selected.length === 0) { 
                if(!confirm("ì„ íƒëœ ì‹œì ì´ ì—†ìŠµë‹ˆë‹¤. ëª¨ë“  MR ì²´í¬ë°•ìŠ¤ë¥¼ ìˆ¨ê¸°ì‹œê² ìŠµë‹ˆê¹Œ?")) return; 
            }
            
            // ì •ë ¬ ë¡œì§ (ê¸°ì¡´ê³¼ ë™ì¼)
            selected.sort((a, b) => (globalPodMap[a] || 0) - (globalPodMap[b] || 0));
            
            try {
                await db.collection("cohortNotes").doc(String(c)).set({ mrConfig: selected }, { merge: true });
                alert("ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                loadDashboard();
            } catch(e) { 
                console.error(e); 
                alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message); 
            }
        }
        
        async function deleteRat() { const id=document.getElementById('del-id').value; if(!id||!confirm("ì‚­ì œ?"))return; (await db.collection("rats").where("ratId","==",id).get()).forEach(d=>d.ref.delete()); ["dailyLogs","doseLogs","measurements"].forEach(async c=>(await db.collection(c).where("ratId","==",id).get()).forEach(d=>d.ref.delete())); clearRatsCache(); alert("ì‚­ì œë¨"); }
        async function deleteCohort() { const c=document.getElementById('del-cohort').value; if(!c||!confirm("ì „ì²´ì‚­ì œ?"))return; (await db.collection("rats").where("cohort","==",c).get()).forEach(d=>d.ref.delete()); alert("ì‚­ì œë¨(ë¡œê·¸ì œì™¸)"); } 
        function goToDetail(ratId) { go('detail', ratId); }
        function score(k, n, btn) { btn.parentElement.querySelectorAll('.rate-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); currentScores[k] = n; const t = currentScores.act+currentScores.fur+currentScores.eye; document.getElementById('score-res').innerText=`ì´ì : ${t}ì `; }
        function mkId(p) { const c=document.getElementById(`${p}-c`).value, r=document.getElementById(`${p}-r`).value; if(c&&r) document.getElementById(`${p}-id`).value = `C${c.padStart(2,'0')}${r.padStart(2,'0')}`; }
        function calM() { const s=Number(document.getElementById('re-s').value), d=Number(document.getElementById('re-d').value); if(s&&d) document.getElementById('re-m').value = Math.round(d+(s-d)/3); }
        async function saveBulk() { const c=document.getElementById('add-c').value, s=Number(document.getElementById('add-s').value), e=Number(document.getElementById('add-e').value), d=document.getElementById('add-d').value; for(let i=s; i<=e; i++) { await db.collection("rats").add({ratId:`C${c.padStart(2,'0')}${String(i).padStart(2,'0')}`, cohort:c, num:String(i), arrivalDate:d, status:'ìƒì¡´'}); } clearRatsCache(); alert("ì™„ë£Œ"); }
        function upDose() { const ns=document.getElementsByClassName('dn'), c=document.getElementById('ds-c').value; for(let i=0; i<ns.length; i++) document.getElementsByClassName('di')[i].innerText = (c&&ns[i].value)?`C${c.padStart(2,'0')}${ns[i].value.padStart(2,'0')}`:'-'; }
        
        async function saveDaily() {
            const id = document.getElementById('dc-id').value;
            const date = document.getElementById('dc-date').value;
            if(!id || !date) return alert("IDì™€ ë‚ ì§œë¥¼ í™•ì¸í•˜ì„¸ìš”");
            if(!(await checkRatValid(id))) return;
            
            const note = document.getElementById('dc-note').value;
            const dead = document.getElementById('is-dead').checked;
            const total = currentScores.act + currentScores.fur + currentScores.eye;

            if (!dead && (currentScores.act === 0 || currentScores.fur === 0 || currentScores.eye === 0)) { 
                alert("Activity, Fur, Eye ì ìˆ˜ë¥¼ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”."); 
                return; 
            }
            
            try {
                // [ìˆ˜ì •] scores ì €ì¥ ì‹œ 'act'ë¥¼ 'activity'ë¡œ ëª…í™•í•˜ê²Œ ì €ì¥
                await db.collection("dailyLogs").add({ 
                    ratId: id, 
                    date: date, 
                    timestamp: new Date().toLocaleTimeString(), 
                    scores: { 
                        activity: currentScores.act, // ì—¬ê¸°ì„œ ë³€í™˜
                        fur: currentScores.fur, 
                        eye: currentScores.eye 
                    }, 
                    totalScore: total, 
                    note: note, 
                    createdAt: firebase.firestore.FieldValue.serverTimestamp() 
                });
                
                const rSnap = await db.collection("rats").where("ratId", "==", id).get();
                if(!rSnap.empty) { 
                    if(dead) { await rSnap.docs[0].ref.update({ status: 'ì‚¬ë§', deathDate: date }); } 
                    else { await rSnap.docs[0].ref.update({ lastScore: total }); } 
                }
                
                clearRatsCache();
                alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                document.getElementById('dc-note').value = '';
                document.getElementById('is-dead').checked = false;
            } catch(e) { console.error(e); alert("ì—ëŸ¬: " + e.message); }
        }

        async function saveDose() { 
            const c = document.getElementById('ds-c').value;
            const ws = document.getElementsByClassName('dw');
            const is = document.getElementsByClassName('di');
            
            let cnt = 0; let indivList = ''; let tMg = 0; let tVol = 0;
            try {
                for(let i=0; i<ws.length; i++) { 
                    if(ws[i].value && is[i].innerText!=='-') { 
                        const ratId = is[i].innerText;
                        if(!(await checkRatValid(ratId))) continue; 
                        const w = Number(ws[i].value); const mg = (w/1000)*4*1.15; const vol = mg/2.5;        
                        tMg += mg; tVol += vol; cnt++;
                        indivList += `<div style="padding:4px 0; border-bottom:1px solid #eee; display:flex; justify-content:space-between;"><span>${ratId}</span><span style="font-weight:bold;">${vol.toFixed(2)} ml</span></div>`;
                        await db.collection("doseLogs").add({ ratId:ratId, cohort:c, weight:w, doseMg:mg, volMl:vol, date:new Date().toISOString().split('T')[0] }); 
                    } 
                }
                if(cnt) {
                    const resBox = document.getElementById('dose-res');
                    resBox.style.display = 'block'; 
                    resBox.innerHTML = `<div style="margin-bottom:20px;"><h4 style="color:var(--navy); margin-bottom:10px;">ğŸ“Š ì˜¤ëŠ˜ ì†Œë¶„ ìš©ëŸ‰</h4><div style="background:white; padding:10px; border-radius:8px; border:1px solid #eee;">${indivList}</div></div><div style="background:#e8f5e9; padding:15px; border-radius:8px; border:1px solid #c8e6c9;"><h4 style="color:#2e7d32; margin:0 0 10px 0;">ğŸ§ª ì˜¤ëŠ˜ ì¤€ë¹„ëŸ‰</h4><div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>ì•½ë¬¼ ì´ëŸ‰:</span><b>${tMg.toFixed(2)} mg</b></div><div style="display:flex; justify-content:space-between;"><span>ìš©ì•¡ ì´ëŸ‰:</span><b>${tVol.toFixed(2)} ml</b></div></div>`;
                    alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } else { alert("ìœ íš¨í•œ ì…ë ¥ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); }
            } catch(e) { console.error(e); alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.message); }
        }
        
        async function saveRec() { 
            const id=document.getElementById('re-id').value; 
            if(!(await checkRatValid(id))) return;
            const sbp = Number(document.getElementById('re-s').value); const dbp = Number(document.getElementById('re-d').value); const mean = Number(document.getElementById('re-m').value); const wt = Number(document.getElementById('re-w').value);
            await db.collection("measurements").add({ ratId:id, sbp: sbp, dbp: dbp, mean: mean, weight: wt, date:document.getElementById('re-date').value, timepoint:document.getElementById('re-tp').value }); 
            alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); 
        }

        let bpAllData = [];
        function loadBPFiles(e) {
            bpAllData = [];
            const files = Array.from(e.target.files);
            const mode = document.querySelector('input[name="bp-mode"]:checked').value;
            let loaded = 0;
            files.forEach(file => { const reader = new FileReader(); reader.onload = () => { parseBPCSV(reader.result, file.name); loaded++; if (loaded === files.length) analyzeBP(mode); }; reader.readAsText(file); });
        }

        function parseBPCSV(text, filename) {
            const rows = text.trim().split("\n").map(r => r.split(","));
            const header = rows.shift();
            // í—¤ë” ê³µë°± ì œê±° í›„ ì¸ë±ìŠ¤ ì°¾ê¸° (ë” ì•ˆì „í•¨)
            const idx = n => header.findIndex(h => h && h.trim() === n);

            rows.forEach(r => {
                if (r.length < 5) return; 
                // ê°’ì˜ ì•ë’¤ ê³µë°±ì„ ì œê±°í•˜ê³  ë¹„êµ (í•µì‹¬ ìˆ˜ì •)
                bpAllData.push({ 
                    file: filename, 
                    time: r[idx("Time")], 
                    specimen: r[idx("Specimen Name")], 
                    regular: (r[idx("Regular Cycle")] || "").trim().toUpperCase() === "TRUE", 
                    accepted: (r[idx("Accepted")] || "").trim().toUpperCase() === "TRUE",
                    sbp: Number(r[idx("Systolic")]), 
                    dbp: Number(r[idx("Diastolic")]), 
                    mean: Number(r[idx("Mean")]), 
                    volume: Number(r[12] || r[idx("Volume")]) // Volume ì¸ë±ìŠ¤ ì•ˆì „ ì²˜ë¦¬
                });
            });
        }

        

        function analyzeBP(mode) {
            const output = document.getElementById("bp-output");
            output.innerHTML = "";
            const grouped = {};
            currentAnalyzedData = {}; // ì´ˆê¸°í™”

            // ë°ì´í„° ê·¸ë£¹í™”
            bpAllData.forEach(r => {
                const match = r.specimen.match(/\(([^)]+)\)/);
                const ratId = match ? match[1].trim() : r.specimen.trim();
                if (!grouped[ratId]) grouped[ratId] = {};
                if (!grouped[ratId][r.file]) grouped[ratId][r.file] = [];
                grouped[ratId][r.file].push(r);
            });

            // "ì„ íƒí•œ ê°’ ì €ì¥í•˜ê¸°" ë²„íŠ¼ ì¶”ê°€
            const actionDiv = document.createElement("div");
            actionDiv.innerHTML = `<button onclick="openBatchModal()" style="padding:10px 20px; background:#00c853; color:white; border:none; border-radius:4px; font-weight:bold; cursor:pointer; margin-bottom:20px;">âœ… ì„ íƒí•œ ê°’ DB ì €ì¥í•˜ê¸°</button>`;
            output.appendChild(actionDiv);

            Object.keys(grouped).sort().forEach(ratId => {
                const box = document.createElement("div");
                box.className = "bp-rat-box";
                box.innerHTML = `<div class="bp-rat-title">ğŸ€ ê°œì²´ ID: ${ratId}</div>`;
                const table = document.createElement("table");
                
                // [ë³€ê²½] ë§¨ ì•ì— 'ì„ íƒ' í—¤ë” ì¶”ê°€
                table.innerHTML = `<tr><th>ì„ íƒ</th><th>File</th><th>n</th><th>SBP</th><th>DBP</th><th>Mean</th><th>Volume</th><th>ìƒíƒœ</th></tr>`;

                Object.entries(grouped[ratId]).forEach(([file, rows], idx) => {
                    // 1. Regular & Accepted ì²´í¬ (ëŒ€ì†Œë¬¸ì ë¬´ì‹œ)
                    const valid = rows.filter(r => (String(r.regular).toUpperCase() === 'TRUE') && (String(r.accepted).toUpperCase() === 'TRUE'));
                    
                    let sbps = valid.map(r => r.sbp);
                    let maxSBP = sbps.length ? Math.max(...sbps) : 0;
                    let minSBP = sbps.length ? Math.min(...sbps) : 0;

                    const judged = rows.map(r => {
                        let reason = "âœ… Accepted";
                        // [ëŒ€ì†Œë¬¸ì ìˆ˜ì • ì ìš©ë¨]
                        const isReg = String(r.regular).toUpperCase() === 'TRUE';
                        const isAcc = String(r.accepted).toUpperCase() === 'TRUE';

                        if (!isReg || !isAcc) { reason = "âŒ Regular/Accepted"; } 
                        else if (sbps.length > 0 && r.sbp === maxSBP) { reason = "âŒ SBP = MAX"; } 
                        else if (sbps.length > 0 && r.sbp === minSBP) { reason = "âŒ SBP = MIN"; } 
                        else {
                            const diff = r.sbp - r.dbp;
                            if (mode === "control" && (diff < 20 || diff > 60)) reason = "âŒ Pulse diff";
                            if (mode === "induction" && (diff < 25 || diff > 80)) reason = "âŒ Pulse diff";
                        }
                        return { ...r, reason };
                    });

                    const passed = judged.filter(r => r.reason === "âœ… Accepted");
                    const avgFloor = key => Math.floor(passed.reduce((s, r) => s + r[key], 0) / passed.length);
                    
                    const nVal = passed.length;
                    const sbpVal = nVal > 0 ? avgFloor("sbp") : '-';
                    const dbpVal = nVal > 0 ? avgFloor("dbp") : '-';
                    const meanVal = nVal > 0 ? avgFloor("mean") : '-';
                    const volVal = nVal > 0 ? avgFloor("volume") : '-';

                    // ë°ì´í„°ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (ë‚˜ì¤‘ì— ì €ì¥ ë²„íŠ¼ ëˆ„ë¥¼ ë•Œ ì‚¬ìš©)
                    const rowId = `${ratId}__${idx}`; 
                    currentAnalyzedData[rowId] = {
                        ratId: ratId,
                        file: file,
                        sbp: sbpVal, dbp: dbpVal, mean: meanVal, volume: volVal,
                        date: rows[0].time.split(' ')[0], // ë‚ ì§œ ì¶”ì¶œ
                        originalRows: passed
                    };

                    // [ë³€ê²½] ë¼ë””ì˜¤ ë²„íŠ¼ ì¶”ê°€ (nameì„ ratIdë¡œ ë¬¶ì–´ì„œ ì¥ í•œ ë§ˆë¦¬ë‹¹ í•˜ë‚˜ë§Œ ì„ íƒë˜ê²Œ í•¨)
                    // ë°ì´í„°ê°€ ì—†ìœ¼ë©´(n=0) ì„ íƒ ë¶ˆê°€ëŠ¥í•˜ê²Œ disabled ì²˜ë¦¬
                    const radioHtml = nVal > 0 
                        ? `<input type="radio" name="bp_choice_${ratId}" value="${rowId}" style="transform:scale(1.5); cursor:pointer;">` 
                        : `<input type="radio" disabled>`;

                    const logId = `bp_log_${ratId.replace(/[^a-z0-9]/gi, '_')}_${idx}`;
                    
                    table.innerHTML += `
                        <tr>
                            <td style="text-align:center;">${radioHtml}</td>
                            <td style="color:#e67e22; font-weight:500;">${file}</td>
                            <td>${nVal > 0 ? nVal : `<span style="color:red">0</span>`}</td>
                            <td>${sbpVal}</td>
                            <td>${dbpVal}</td>
                            <td>${meanVal}</td>
                            <td>${volVal}</td>
                            <td><button class="bp-toggle-btn" onclick="toggleBPLog('${logId}')">ë¡œê·¸ í™•ì¸</button></td>
                        </tr>
                        <tr id="${logId}" style="display:none;">
                            <td colspan="8">
                                <table class="bp-log-table">
                                    <tr><th>Time</th><th>SBP</th><th>DBP</th><th>Mean</th><th>Volume</th><th>Reason</th></tr>
                                    ${judged.map(r => `<tr style="${r.reason!=='âœ… Accepted'?'color:#aaa':''}"><td>${r.time}</td><td>${r.sbp}</td><td>${r.dbp}</td><td>${r.mean}</td><td>${r.volume}</td><td>${r.reason}</td></tr>`).join("")}
                                </table>
                            </td>
                        </tr>`;
                });
                box.appendChild(table);
                output.appendChild(box);
            });
        }

        // ==========================================
        // [ìƒˆë¡œ ì¶”ê°€] ëª¨ë‹¬ ë° ì €ì¥ ê´€ë ¨ í•¨ìˆ˜ë“¤
        // ==========================================

        function openBatchModal() {
            // ì²´í¬ëœ í•­ëª© ê°€ì ¸ì˜¤ê¸°
            const inputs = document.querySelectorAll('input[type="radio"]:checked');
            if (inputs.length === 0) return alert("ì €ì¥í•  ë°ì´í„°ë¥¼ í•˜ë‚˜ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.");

            const tbody = document.getElementById("bpBatchList");
            tbody.innerHTML = "";

            // âœ… ì‹œì  ì˜µì…˜: Manual + D00 + D0 + D2 + W1~W12
            let timeOptions = `<option value="Manual">Manual</option>
                            <option value="D00">D00</option>
                            <option value="D0">D0</option>
                            <option value="D2">D2</option>`;
            for (let i = 1; i <= 12; i++) {
                timeOptions += `<option value="W${i}">W${i}</option>`;
            }

            inputs.forEach((input, idx) => {
                const data = currentAnalyzedData[input.value];
                if (!data) return;

                // Rat ID ìë™ í¬ë§·íŒ…: "C0504G1 - 4" -> "C0504"
                let formattedId = data.ratId;
                const idMatch = data.ratId.match(/C\d{4}/i);
                if (idMatch) formattedId = idMatch[0].toUpperCase();

                const row = `
                    <tr style="border-bottom:1px solid #eee;">
                        <td style="padding:10px; color:#888; font-size:13px;">${data.ratId}</td>
                        
                        <td style="padding:10px;">
                            <div style="font-weight:bold; color:#d32f2f;">SBP: ${data.sbp}</div>
                            <div style="font-size:12px;">DBP: ${data.dbp} / Mean: ${data.mean}</div>
                        </td>
                        
                        <td style="padding:10px;">
                            <input type="date" id="save_date_${idx}" value="${data.date}" style="padding:5px; border:1px solid #ddd; border-radius:4px;">
                        </td>
                        
                        <td style="padding:10px;">
                            <input type="text" id="save_id_${idx}" value="${formattedId}" 
                                style="padding:6px; width:120px; border:2px solid #00c853; border-radius:4px; font-weight:bold; font-size:14px;">
                        </td>
                        
                        <td style="padding:10px; display:flex; align-items:center; gap:5px;">
                            <select id="save_time_${idx}" style="padding:6px; border:1px solid #1a237e; border-radius:4px; font-weight:bold;">
                                <option value="">--ì„ íƒ--</option>
                                ${timeOptions}
                            </select>
                            <input type="text" id="save_time_manual_${idx}" placeholder="ì§ì ‘ì…ë ¥" 
                                style="padding:6px; width:80px; border:1px solid #ddd; border-radius:4px;">
                        </td>
                        
                        <input type="hidden" id="save_data_${idx}" value='${JSON.stringify(data)}'>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            // âœ… UX: ë“œë¡­ë‹¤ìš´ ì„ íƒ ì‹œ ì§ì ‘ì…ë ¥ ë¹„í™œì„±í™”, ì§ì ‘ì…ë ¥ íƒ€ì´í•‘ ì‹œ ë“œë¡­ë‹¤ìš´ ë¹„ìš°ê¸°
            inputs.forEach((_, idx) => {
                const sel = document.getElementById(`save_time_${idx}`);
                const manual = document.getElementById(`save_time_manual_${idx}`);
                if (!sel || !manual) return;

                const setManualEnabled = (enabled) => {
                    manual.disabled = !enabled;
                    manual.style.opacity = enabled ? "1" : "0.45";
                    manual.style.background = enabled ? "#fff" : "#f3f3f3";
                    manual.style.cursor = enabled ? "text" : "not-allowed";
                };

                // ì´ˆê¸° ìƒíƒœ: ë“œë¡­ë‹¤ìš´ì´ ë¹„ì–´ìˆìœ¼ë©´ ì§ì ‘ì…ë ¥ ON
                setManualEnabled(sel.value === '');

                sel.addEventListener('change', () => {
                    // ë“œë¡­ë‹¤ìš´ì—ì„œ ë­ë“  ì„ íƒí•˜ë©´(Manual í¬í•¨) -> ì§ì ‘ì…ë ¥ OFF + ì´ˆê¸°í™”
                    if (sel.value !== '') {
                        manual.value = '';
                        setManualEnabled(false);
                    } else {
                        // --ì„ íƒ-- ë¡œ ëŒì•„ê°€ë©´ -> ì§ì ‘ì…ë ¥ ON
                        setManualEnabled(true);
                        manual.focus();
                    }
                });

                manual.addEventListener('input', () => {
                    // ì§ì ‘ì…ë ¥ì— ë­”ê°€ ì“°ê¸° ì‹œì‘í•˜ë©´ -> ë“œë¡­ë‹¤ìš´ì€ ë¹„ì›€(--ì„ íƒ--)
                    const hasText = manual.value.trim().length > 0;
                    if (hasText && sel.value !== '') {
                        sel.value = '';
                        setManualEnabled(true);
                    }
                });
            });

            document.getElementById("bpBatchModal").style.display = "flex";
        }


        function closeBatchModal() {
            document.getElementById("bpBatchModal").style.display = "none";
        }

        async function saveBatchToDB() {
            const tbody = document.getElementById("bpBatchList");
            const rows = tbody.querySelectorAll("tr"); 
            const batchPromises = [];
            let savedCount = 0;

            if (rows.length === 0) return alert("ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

            if (!confirm(`${rows.length}ê±´ì˜ ë°ì´í„°ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê¸°ì¡´ ì‹œì ì— ë°ì´í„°ê°€ ìˆë‹¤ë©´ í˜ˆì•• ê°’ë§Œ í•©ì³ì§‘ë‹ˆë‹¤.)`)) return;

            for (const row of rows) {
                const idInput = row.querySelector('input[id^="save_id_"]');
                const dateInput = row.querySelector('input[id^="save_date_"]'); // ìƒˆ ë°ì´í„°ì¼ ë•Œë§Œ ì‚¬ìš©
                const timeSelect = row.querySelector('select[id^="save_time_"]');
                const timeManual = row.querySelector('input[id^="save_time_manual_"]');
                const hiddenData = row.querySelector('input[id^="save_data_"]');

                if (!idInput || !hiddenData) continue;

                const ratId = idInput.value.trim();
                const inputDate = dateInput.value; 
                const timepoint = (timeManual.value.trim()) || timeSelect.value;
                
                let sourceData;
                try { sourceData = JSON.parse(hiddenData.value); } catch (e) { continue; }

                if (!ratId) { alert(`Rat IDê°€ ë¹„ì–´ìˆëŠ” í–‰ì´ ìˆìŠµë‹ˆë‹¤.`); return; }
                if (!timepoint) { alert(`[${ratId}]ì˜ ì‹œì (Timepoint)ì„ ì„ íƒí•´ì£¼ì„¸ìš”.`); return; }

                // ---------------------------------------------------------
                // [í•µì‹¬ ë³€ê²½] ê¸°ì¡´ ë°ì´í„° í™•ì¸ í›„ ë³‘í•©(Merge) ë¡œì§
                // ---------------------------------------------------------
                const docRef = db.collection("measurements").where("ratId", "==", ratId).where("timepoint", "==", timepoint);
                
                const promise = docRef.get().then(async (snapshot) => {
                    if (!snapshot.empty) {
                        // [Case A] ì´ë¯¸ í•´ë‹¹ ì‹œì (timepoint)ì˜ ë°ì´í„°ê°€ ì¡´ì¬í•¨ -> ì—…ë°ì´íŠ¸ (Merge)
                        // ë‚ ì§œ(date)ëŠ” ê±´ë“œë¦¬ì§€ ì•Šê³ , í˜ˆì•• ë°ì´í„°ë§Œ ë®ì–´ì”Œì›€
                        const existingDoc = snapshot.docs[0]; // ì²« ë²ˆì§¸ ì¼ì¹˜ ë¬¸ì„œ ê°€ì ¸ì˜´
                        await db.collection("measurements").doc(existingDoc.id).update({
                            sbp: Number(sourceData.sbp),
                            dbp: Number(sourceData.dbp),
                            mean: Number(sourceData.mean),
                            // ê¸°ì¡´ì— ìˆë˜ weight, memo ë“±ì€ ê·¸ëŒ€ë¡œ ìœ ì§€ë¨
                            // dateë„ ì—…ë°ì´íŠ¸í•˜ì§€ ì•ŠìŒ (ê¸°ì¡´ ë‚ ì§œ ìœ ì§€)
                            timestamp: firebase.firestore.FieldValue.serverTimestamp() // ìˆ˜ì • ì‹œê°„ ê°±ì‹ 
                        });
                        console.log(`[Update] ${ratId} - ${timepoint} ë³‘í•© ì™„ë£Œ`);
                    } else {
                        // [Case B] í•´ë‹¹ ì‹œì  ë°ì´í„°ê°€ ì—†ìŒ -> ìƒˆë¡œ ìƒì„±
                        // ì´ë•ŒëŠ” ê¸°ì¤€ì´ ë  ë‚ ì§œê°€ í•„ìš”í•˜ë¯€ë¡œ ì…ë ¥ë°›ì€ ì¸¡ì •ì¼ì„ ì‚¬ìš©
                        await db.collection("measurements").add({
                            ratId: ratId,
                            timepoint: timepoint,
                            date: inputDate, // ìƒˆ ë°ì´í„°ì¼ ë•Œë§Œ ë‚ ì§œ ì €ì¥
                            sbp: Number(sourceData.sbp),
                            dbp: Number(sourceData.dbp),
                            mean: Number(sourceData.mean),
                            weight: null,
                            memo: `Batch upload from ${sourceData.file}`,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        console.log(`[Create] ${ratId} - ${timepoint} ì‹ ê·œ ìƒì„± ì™„ë£Œ`);
                    }
                    savedCount++;
                }).catch(err => {
                    console.error(`[Error] ${ratId} ì €ì¥ ì‹¤íŒ¨:`, err);
                });

                batchPromises.push(promise);
            }

            if (batchPromises.length === 0) return alert("ì²˜ë¦¬í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

            try {
                await Promise.all(batchPromises);
                alert(`ì´ ${savedCount}ê±´ì˜ ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!`);
                closeBatchModal();
                // location.reload(); // í•„ìš” ì‹œ ìƒˆë¡œê³ ì¹¨
            } catch (e) {
                console.error(e);
                alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }


        function toggleBPLog(id) { const el = document.getElementById(id); el.style.display = el.style.display === "none" ? "table-row" : "none"; }

        function admTab(mode) {
            // 1. ëª¨ë“  íƒ­ ë²„íŠ¼ì˜ í™œì„±í™”(active) ìƒíƒœ í•´ì œ
            document.querySelectorAll('.tab-container .tab').forEach(t => t.classList.remove('active'));
            
            // 2. í´ë¦­í•œ íƒ­ ë²„íŠ¼ë§Œ í™œì„±í™”
            const btn = document.getElementById('adm-' + mode);
            if(btn) btn.classList.add('active');
            
            // 3. ë‚´ìš© í™”ë©´ ìˆ¨ê¸°ê¸°/ë³´ì´ê¸° ì œì–´ (ì—¬ê¸°ì— 'up', 'ai'ê°€ ì¶”ê°€ë˜ì–´ì•¼ ê²¹ì¹˜ì§€ ì•ŠìŠµë‹ˆë‹¤)
            ['del', 'edit', 'logs', 'up', 'ai'].forEach(m => {
                const el = document.getElementById('tab-' + m);
                if(el) {
                    el.style.display = (m === mode) ? 'block' : 'none';
                }
            });
        }

        function uploadDailyLogs() {
            alert("CSV ì—…ë¡œë“œ ê¸°ëŠ¥ì€ í˜„ì¬ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤.");
        }


        // í–‰ ì‚­ì œ í‘œì‹œ í•¨ìˆ˜
        function markRowDel(btn) {
            const row = btn.closest('tr');
            if(row.classList.contains('row-del')) {
                row.classList.remove('row-del');
                btn.innerText = 'ì‚­ì œ';
                btn.style.background = 'var(--red)';
            } else {
                row.classList.add('row-del');
                btn.innerText = 'ë³µêµ¬';
                btn.style.background = 'gray';
            }
        }

        // í–‰ ì¶”ê°€ í•¨ìˆ˜
        function addTableRow(tbodyId) {
            const tbody = document.getElementById(tbodyId);
            const tr = document.createElement('tr');
            tr.dataset.isNew = "true"; // ì‹ ê·œ í–‰ í‘œì‹œ
            
            if(tbodyId === 'meas-tbody') {
                tr.dataset.coll = "measurements";
                tr.innerHTML = `
                    <td><input type="date" class="row-date" value="${getTodayStr()}"></td>
                    <td><input type="text" class="row-tp" placeholder="W1.."></td>
                    <td><input type="number" class="row-sbp" placeholder="SBP"></td>
                    <td><input type="number" class="row-dbp" placeholder="DBP"></td>
                    <td><input type="number" class="row-mean" placeholder="Mean"></td>
                    <td><input type="number" class="row-wt" placeholder="WT"></td>
                    <td><button class="del-btn" onclick="this.closest('tr').remove()">ì·¨ì†Œ</button></td>`;
            } else if(tbodyId === 'daily-tbody') {
                tr.dataset.coll = "dailyLogs";
                tr.innerHTML = `
                    <td><input type="date" class="row-date" value="${getTodayStr()}"></td>
                    <td><input type="number" class="row-act" value="0"></td>
                    <td><input type="number" class="row-fur" value="0"></td>
                    <td><input type="number" class="row-eye" value="0"></td>
                    <td><input type="text" class="row-note" placeholder="ë©”ëª¨"></td>
                    <td><button class="del-btn" onclick="this.closest('tr').remove()">ì·¨ì†Œ</button></td>`;
            }
            tbody.insertBefore(tr, tbody.firstChild);
        }

        async function saveTotalEdit(ratDocId) {
            if(!confirm("ëª¨ë“  ë³€ê²½ì‚¬í•­ì„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            
            const batch = db.batch();
            const ratRef = db.collection("rats").doc(ratDocId);
            
            // 1. ê¸°ë³¸ ì •ë³´ ì—…ë°ì´íŠ¸
            const codVal = document.getElementById('ed-cod-display').value;

            batch.update(ratRef, {
                status: document.getElementById('ed-status').value,
                codFull: codVal,
                arrivalDate: document.getElementById('ed-arrival').value,
                surgeryDate: document.getElementById('ed-surgery').value,
                doseStartDate: document.getElementById('ed-dose-start').value,
                deathDate: document.getElementById('ed-death').value
            });

            // 2. í…Œì´ë¸” ë°ì´í„° ì²˜ë¦¬ (Measurements & DailyLogs)
            const tables = ['meas-tbody', 'daily-tbody'];
            const ratIdStr = document.getElementById('edit-id').value; // í™”ë©´ ìƒë‹¨ ê²€ìƒ‰ì°½ì˜ ID ì‚¬ìš©

            tables.forEach(tbodyId => {
                const rows = document.querySelectorAll(`#${tbodyId} tr`);
                rows.forEach(row => {
                    const coll = row.dataset.coll;
                    const docId = row.dataset.id;
                    const isDel = row.classList.contains('row-del');
                    const isNew = row.dataset.isNew === "true";

                    // ê³µí†µ í•„ë“œ
                    const date = row.querySelector('.row-date').value;

                    if (isDel && !isNew) {
                        // ê¸°ì¡´ ë°ì´í„° ì‚­ì œ
                        const ref = db.collection(coll).doc(docId);
                        batch.delete(ref);
                    } else if (!isDel) {
                        // ë°ì´í„° êµ¬ì„±
                        let data = {};
                        if (coll === 'measurements') {
                            const sbp = row.querySelector('.row-sbp').value;
                            const dbp = row.querySelector('.row-dbp').value;
                            const mean = row.querySelector('.row-mean').value;
                            const wt = row.querySelector('.row-wt').value;
                            const tp = row.querySelector('.row-tp').value;
                            if(!date) return; // ë‚ ì§œ ì—†ìœ¼ë©´ ìŠ¤í‚µ
                            data = {
                                ratId: ratIdStr, date: date, timepoint: tp,
                                sbp: sbp ? Number(sbp) : null,
                                dbp: dbp ? Number(dbp) : null,
                                mean: mean ? Number(mean) : null,
                                weight: wt ? Number(wt) : null
                            };
                        } else if (coll === 'dailyLogs') {
                            const act = Number(row.querySelector('.row-act').value);
                            const fur = Number(row.querySelector('.row-fur').value);
                            const eye = Number(row.querySelector('.row-eye').value);
                            const note = row.querySelector('.row-note').value;
                            if(!date) return;
                            data = {
                                ratId: ratIdStr, date: date,
                                scores: { activity: act, fur: fur, eye: eye },
                                totalScore: act + fur + eye,
                                note: note
                            };
                        }

                        if (isNew) {
                            // ì‹ ê·œ ìƒì„±
                            const newRef = db.collection(coll).doc();
                            batch.set(newRef, data);
                        } else {
                            // ê¸°ì¡´ ì—…ë°ì´íŠ¸
                            const ref = db.collection(coll).doc(docId);
                            batch.update(ref, data);
                        }
                    }
                });
            });

            try {
                await batch.commit();
                clearRatsCache();
                alert("ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                searchForEdit(); // í™”ë©´ ê°±ì‹ 
            } catch(e) {
                console.error(e);
                alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.message);
            }
        }

        // ==============================================================
        //  COD Flow (3-Step Hierarchical Selection)
        // ==============================================================

        function openCodFlow(docId, inputId = null) {
            // Reset state
            codTargetDocId = docId;
            codTargetInputId = inputId;
            codTempData = { type: '', secondary: '', causes: [] };
            
            // Clear checks
            document.querySelectorAll('input[name="cod-check"]').forEach(cb => cb.checked = false);

            document.getElementById('cod-modal').style.display = 'flex';
            showCodStep(1);
        }

        function closeCod() {
            document.getElementById('cod-modal').style.display = 'none';
        }

        function showCodStep(step) {
            document.querySelectorAll('.cod-step-container').forEach(el => el.classList.remove('active'));
            // step can be '1', '2-neuro', '2-non-neuro', '3'
            document.getElementById(`cod-step-${step}`).classList.add('active');
        }

        function selectCodType(type) {
            codTempData.type = type;
            if(type === 'Neurological') {
                showCodStep('2-neuro');
            } else {
                showCodStep('2-non-neuro');
            }
        }

        // Neuro Path
        function selectCodAn(anStatus) {
            codTempData.secondary = anStatus;
            showCodStep(3);
        }

        // Non-Neuro Path
        function selectCodNonNeuroCause(cause) {
            // For Non-Neuro, secondary is the cause (Unknown or Surgical Failure or Sacrifice)
            codTempData.secondary = cause;
            // No Step 3. Save immediately.
            codTempData.causes = []; // Empty causes means no 3rd level
            saveCodFinal();
        }

        function codBack(toStep) {
            // toStep: 1, 'neuro-2', etc.
            if(toStep === 1) showCodStep(1);
            else if(toStep === 'neuro-2') showCodStep('2-neuro');
        }

        async function saveCodFinal() {
            // If Neuro path, collect checkboxes
            if(codTempData.type === 'Neurological') {
                const checkedBoxes = document.querySelectorAll('input[name="cod-check"]:checked');
                if(checkedBoxes.length === 0) return alert("í•˜ë‚˜ ì´ìƒì˜ ì„¸ë¶€ ì›ì¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                codTempData.causes = Array.from(checkedBoxes).map(cb => cb.value);
            }

            // Construct Final String
            let finalStr = `${codTempData.type}`;
            
            // Format: Type (Secondary) - Causes...
            if(codTempData.secondary) {
                finalStr += ` (${codTempData.secondary})`;
            }
            
            if(codTempData.causes.length > 0) {
                finalStr += ' - ' + codTempData.causes.join(', ');
            }

            // Save Logic
            if(codTargetInputId) {
                document.getElementById(codTargetInputId).value = finalStr;
                closeCod();
            } else if(codTargetDocId) {
                try {
                    await db.collection("rats").doc(codTargetDocId).update({ 
                        codFull: finalStr,
                        status: 'ì‚¬ë§', 
                        
                    });
                    alert(`ì €ì¥ë¨: ${finalStr}`);
                    closeCod();
                    loadDetailData(); 
                } catch(e) {
                    console.error(e);
                    alert("ì €ì¥ ì‹¤íŒ¨");
                }
            }
        }
    // --- ë¡œê·¸ ê´€ë¦¬(ì‚­ì œ) ê¸°ëŠ¥ í•¨ìˆ˜ë“¤ ---

        function admTab(mode) {
            // 1. ëª¨ë“  íƒ­ ë²„íŠ¼ì˜ í™œì„±í™”(active) ìƒíƒœ í•´ì œ
            document.querySelectorAll('.tab-container .tab').forEach(t => t.classList.remove('active'));
            
            // 2. í´ë¦­í•œ íƒ­ ë²„íŠ¼ë§Œ í™œì„±í™”
            const btn = document.getElementById('adm-' + mode);
            if(btn) btn.classList.add('active');
            
            // 3. ë‚´ìš© í™”ë©´ ìˆ¨ê¸°ê¸°/ë³´ì´ê¸° ì œì–´ (ì—¬ê¸°ì— 'up', 'ai'ê°€ ì¶”ê°€ë˜ì–´ì•¼ ê²¹ì¹˜ì§€ ì•ŠìŠµë‹ˆë‹¤)
            ['del', 'edit', 'logs', 'up', 'ai'].forEach(m => {
                const el = document.getElementById('tab-' + m);
                if(el) {
                    el.style.display = (m === mode) ? 'block' : 'none';
                }
            });
        }

        async function searchLogsDel() {
            const id = document.getElementById('log-rat-id').value.trim();
            if(!id) return alert("IDë¥¼ ì…ë ¥í•˜ì„¸ìš”");

            const resDiv = document.getElementById('log-del-result');
            resDiv.innerHTML = '<div class="loader"></div> ë¡œê·¸ ê²€ìƒ‰ ì¤‘...';

            try {
                // Daily Logsì™€ Dose Logsë¥¼ ë™ì‹œì— ì¡°íšŒ
                const [dSnap, dsSnap] = await Promise.all([
                    db.collection("dailyLogs").where("ratId", "==", id).orderBy("date", "desc").get(),
                    db.collection("doseLogs").where("ratId", "==", id).orderBy("date", "desc").get()
                ]);

                if(dSnap.empty && dsSnap.empty) {
                    resDiv.innerHTML = "<p>í•´ë‹¹ IDì˜ ë¡œê·¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
                    return;
                }

                let html = `<div style="text-align:right; margin-bottom:10px;">
                                <button class="btn btn-red btn-small" onclick="deleteSelectedLogs()">ì„ íƒ í•­ëª© ì‚­ì œí•˜ê¸°</button>
                            </div>`;

                // 1. Daily Logs Table
                if(!dSnap.empty) {
                    html += `<h4 style="margin-top:20px; color:var(--navy);">ğŸ“ ë°ì¼ë¦¬ ì²´í¬ ë¡œê·¸ (${dSnap.size}ê°œ)</h4>
                    <label style="font-size:0.85rem; cursor:pointer; display:block; margin-bottom:5px;">
                        <input type="checkbox" onchange="toggleAllLogs(this, 'chk-daily')"> ì „ì²´ ì„ íƒ
                    </label>
                    <div style="max-height:250px; overflow-y:auto; border:1px solid #eee;">
                        <table style="font-size:0.85rem;">
                            <thead><tr><th width="30">âœ”</th><th>ë‚ ì§œ</th><th>ì ìˆ˜</th><th>ë©”ëª¨</th></tr></thead>
                            <tbody>`;
                    dSnap.forEach(doc => {
                        const d = doc.data();
                        html += `<tr>
                            <td><input type="checkbox" class="chk-daily" value="${doc.id}" data-coll="dailyLogs"></td>
                            <td>${d.date}</td>
                            <td>${d.totalScore}</td>
                            <td>${d.note || '-'}</td>
                        </tr>`;
                    });
                    html += `</tbody></table></div>`;
                }

                // 2. Dose Logs Table
                if(!dsSnap.empty) {
                    html += `<h4 style="margin-top:20px; color:var(--navy);">ğŸ’Š íˆ¬ì•½ ê¸°ë¡ ë¡œê·¸ (${dsSnap.size}ê°œ)</h4>
                    <label style="font-size:0.85rem; cursor:pointer; display:block; margin-bottom:5px;">
                        <input type="checkbox" onchange="toggleAllLogs(this, 'chk-dose')"> ì „ì²´ ì„ íƒ
                    </label>
                    <div style="max-height:250px; overflow-y:auto; border:1px solid #eee;">
                        <table style="font-size:0.85rem;">
                            <thead><tr><th width="30">âœ”</th><th>ë‚ ì§œ</th><th>ì²´ì¤‘</th><th>ìš©ëŸ‰(ml)</th></tr></thead>
                            <tbody>`;
                    dsSnap.forEach(doc => {
                        const d = doc.data();
                        html += `<tr>
                            <td><input type="checkbox" class="chk-dose" value="${doc.id}" data-coll="doseLogs"></td>
                            <td>${d.date}</td>
                            <td>${d.weight}g</td>
                            <td>${d.volMl ? d.volMl.toFixed(2) : '-'}ml</td>
                        </tr>`;
                    });
                    html += `</tbody></table></div>`;
                }

                resDiv.innerHTML = html;

            } catch(e) {
                console.error(e);
                resDiv.innerHTML = `<p style="color:red">ì˜¤ë¥˜ ë°œìƒ: ${e.message}</p>`;
            }
        }

        function toggleAllLogs(source, targetClass) {
            const checkboxes = document.querySelectorAll('.' + targetClass);
            checkboxes.forEach(cb => cb.checked = source.checked);
        }

       
        // ============================================================
        //  ë™í–¥ ë¶„ì„ (Trend Analysis) - UI/UX ê°œì„  ìµœì¢… ë²„ì „
        //  (ìƒ‰ìƒ ëŒ€ë¹„ ê°•í™”, ë²„íŠ¼ í™œì„±í™” ë¡œì§, ê·¸ë˜í”„ ë†’ì´/ëˆˆê¸ˆ/í‰ê· ì„  ì¶”ê°€)
        // ============================================================

        // ì „ì—­ ë³€ìˆ˜: ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ë° ë°ì´í„° ìºì‹œ
        // ============================================================
        //  ë™í–¥ ë¶„ì„ (Trend Analysis) - ìƒ‰ìƒ í”½ìŠ¤ & í‰ê· ì„  ë¡œì§ ìˆ˜ì •
        // ============================================================

        // ì „ì—­ ë³€ìˆ˜
        // ============================================================
        //  ë™í–¥ ë¶„ì„ (Trend Analysis) - í•„í„° ë…ë¦½ & ì¶• ë™ê¸°í™” & 5ë‹¨ìœ„
        // ============================================================

        // ì „ì—­ ë³€ìˆ˜: ì°¨íŠ¸/ë°ì´í„° ìºì‹œ ë° í•„í„° ìƒíƒœ ê´€ë¦¬
        let trendScatterCharts = { low: null, high: null };
        let trendScatterDataCache = { low: [], high: [] };
        let trendTimepointsCache = []; 
        // [ì¶”ê°€] ê° ê·¸ë£¹ë³„ í˜„ì¬ í•„í„° ìƒíƒœ ì €ì¥ (ê¸°ë³¸ê°’ All)
        let trendFilterState = { low: 'All', high: 'All' };
        // [1ë‹¨ê³„] ë¹„êµ ë¶„ì„ìš© ì „ì—­ ë³€ìˆ˜ ì¶”ê°€ (ìŠ¤í¬ë¦½íŠ¸ ìƒë‹¨ ì „ì—­ë³€ìˆ˜ ëª¨ìŒ ìª½ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”)
        let compScatterCharts = {};      // ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ì €ì¥
        let compScatterDataCache = {};   // ì›ë³¸ ë°ì´í„° ì €ì¥
        let compFilterState = {};        // í•„í„° ìƒíƒœ ì €ì¥


        function toggleTrendInputs() {
            const mode = document.querySelector('input[name="trend-crit"]:checked').value;
            
            // Weight Inputs
            const isWt = (mode === 'weight');
            document.getElementById('trend-wt-tp').disabled = !isWt;
            document.getElementById('trend-wt-val').disabled = !isWt;
            
            // POD Inputs
            document.getElementById('trend-pod-val').disabled = (mode !== 'pod');

            // COD Area
            const codArea = document.getElementById('trend-cod-area');
            if(mode === 'cod') {
                codArea.style.display = 'block';
            } else {
                codArea.style.display = 'none';
            }
        }


        // [ì˜¤ë¥˜ ì™„ì „ í•´ê²°] Sankey ë‹¤ì´ì–´ê·¸ë¨ì´ êµ¬í˜• í…ìŠ¤íŠ¸ ë£°(Neurological)ì„ ë”°ë¥´ì§€ ì•Šê³ , 
        // ìµœì‹  cod í•„ë“œ(SAH ë“±)ì™€ are í•„ë“œ(O/X)ë§Œì„ ê¸°ë°˜ìœ¼ë¡œ ê·¸ë¦¬ë„ë¡ ì¬ì‘ì„±ëœ ì½”ë“œì…ë‹ˆë‹¤.
        function renderSankeyChart(ctxId, deadRats, colorsMap) {
            const ctx = document.getElementById(ctxId);
            if (!ctx) return;

            const flows = {}; 

            deadRats.forEach(r => {
                const cod = r.cod || extractLegacyCod(r.codFull) || "Unknown";
                const areFull = r.are || "Unknown";
                let areMain = areFull.split(' ')[0]; // 'O', 'X', 'ë¯¸í™•ì¸' (ê´„í˜¸ ì œê±°ìš©)

                // 1ì°¨ ì—°ê²°: All Dead -> COD (ì‚¬ë§ì›ì¸)
                flows[`Dead|${cod}`] = (flows[`Dead|${cod}`] || 0) + 1;
                
                // 2ì°¨ ì—°ê²°: COD -> ARE ì—¬ë¶€
                // Surgical Failure ë‚˜ Sacrifice ëŠ” ë³´í†µ AREì™€ ë¬´ê´€í•˜ë¯€ë¡œ ì œì™¸í•©ë‹ˆë‹¤.
                if(cod !== "Surgical Failure" && cod !== "Sacrifice" && cod !== "Unknown") {
                     flows[`${cod}|ARE: ${areMain}`] = (flows[`${cod}|ARE: ${areMain}`] || 0) + 1;
                }
            });

            const sankeyData = Object.keys(flows).map(key => {
                const [from, to] = key.split('|');
                return { from, to, flow: flows[key] };
            });

            const getNodeColor = (node) => {
                if (colorsMap && colorsMap[node]) return colorsMap[node];
                if (node.includes("ARE: O")) return "#d32f2f";
                if (node.includes("ARE: X")) return "#1565C0";
                return '#bdbdbd';
            };

            if (window._sankeyCharts && window._sankeyCharts[ctxId]) {
                try { window._sankeyCharts[ctxId].destroy(); } catch(e) {}
            }
            if (!window._sankeyCharts) window._sankeyCharts = {};

            window._sankeyCharts[ctxId] = new Chart(ctx, {
                type: 'sankey',
                data: {
                    datasets: [{
                        data: sankeyData,
                        colorFrom: (c) => getNodeColor(c.dataset.data[c.dataIndex].from),
                        colorTo: (c) => getNodeColor(c.dataset.data[c.dataIndex].to),
                        borderWidth: 0,
                        labels: sankeyData.reduce((acc, cur) => { acc[cur.from] = cur.from; acc[cur.to] = cur.to; return acc; }, {})
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        // [ì˜¤ë¥˜ ì™„ì „ í•´ê²°] ì¡°ê±´ ë¶„ì„ì˜ COD ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ë•Œ, 
        // í…ìŠ¤íŠ¸ë¥¼ ìë¥´ì§€ ì•Šê³  ìƒˆ ë°ì´í„° êµ¬ì¡°(cod, are)ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
        async function loadTrendCodList() {
            const checkboxes = document.querySelectorAll('#trend-cohort-list .co-checkbox:checked');
            if (checkboxes.length === 0) return alert("ë¶„ì„í•  ì½”í˜¸íŠ¸ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
            const selectedCohorts = Array.from(checkboxes).map(cb => cb.value);

            const container = document.getElementById('trend-cod-list');
            container.innerHTML = '<div class="loader"></div> ë°ì´í„° ë¶„ì„ ì¤‘...';

            try {
                const promises = selectedCohorts.map(c => db.collection("rats").where("cohort", "==", c).get());
                const snaps = await Promise.all(promises);
                
                const codSet = new Set();
                const areSet = new Set();

                snaps.forEach(snap => {
                    snap.forEach(doc => {
                        const r = doc.data();
                        if(r.status === 'ì‚¬ë§') {
                            const c = r.cod || extractLegacyCod(r.codFull);
                            const a = r.are ? `ARE: ${r.are.split(' ')[0]}` : null;
                            if(c && c !== "Unknown") codSet.add(c);
                            if(a && a !== "ARE: ë¯¸í™•ì¸") areSet.add(a);
                        }
                    });
                });

                container.innerHTML = '';
                if(codSet.size === 0 && areSet.size === 0) {
                    container.innerHTML = '<span style="padding:10px; color:#999;">ê¸°ë¡ëœ ì‚¬ë§ ì›ì¸ì´ ì—†ìŠµë‹ˆë‹¤.</span>';
                    return;
                }

                const createSection = (title, set, color) => {
                    if(set.size === 0) return;
                    const wrap = document.createElement('div');
                    wrap.style.marginBottom = "10px"; wrap.style.padding = "5px"; wrap.style.borderBottom = "1px dashed #eee";
                    wrap.innerHTML = `<div><span style="font-size:0.8rem; font-weight:bold; color:${color}; margin-right:5px;">â— ${title}</span></div>`;

                    const box = document.createElement('div');
                    box.style.cssText = 'display:flex; flex-wrap:wrap; gap:8px; margin-top:5px;';

                    Array.from(set).sort().forEach(val => {
                        const label = document.createElement('label');
                        label.style.cssText = 'display:flex; align-items:center; font-size:0.85rem; cursor:pointer; background:#fff; padding:2px 6px; border-radius:4px; border:1px solid #ddd;';
                        label.innerHTML = `<input type="checkbox" class="trend-cod-chk" value="${val}" style="margin-right:4px;"> ${val}`;
                        box.appendChild(label);
                    });
                    wrap.appendChild(box);
                    container.appendChild(wrap);
                };

                createSection("ì‚¬ë§ ì›ì¸ (COD)", codSet, "var(--navy)");
                createSection("ARE ë°œìƒ ì—¬ë¶€", areSet, "var(--red)");

            } catch(e) {
                console.error(e);
                container.innerHTML = '<span style="color:red">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</span>';
            }
        }

        // [ì˜¤ë¥˜ ì™„ì „ í•´ê²°] ì„ íƒëœ CODë‚˜ AREê°€ ì‹¤ì œ ë«ë“œì˜ ë°ì´í„°ì— ì •í™•íˆ ë“¤ì–´ë§ëŠ”ì§€ íŒë‹¨í•©ë‹ˆë‹¤.
        async function analyzeTrend() {
            const checkboxes = document.querySelectorAll('#trend-cohort-list .co-checkbox:checked');
            if (checkboxes.length === 0) return alert("ë¶„ì„í•  ì½”í˜¸íŠ¸ë¥¼ í•˜ë‚˜ ì´ìƒ ì„ íƒí•˜ì„¸ìš”.");
            const selectedCohorts = Array.from(checkboxes).map(cb => cb.value);

            const mode = document.querySelector('input[name="trend-crit"]:checked').value;
            let criteriaVal = 0, criteriaTp = '', selectedCods = [];

            if (mode === 'weight') {
                criteriaTp = document.getElementById('trend-wt-tp').value;
                const val = document.getElementById('trend-wt-val').value;
                if (!val) return alert("ì²´ì¤‘ ê¸°ì¤€ê°’(g)ì„ ì…ë ¥í•˜ì„¸ìš”.");
                criteriaVal = Number(val);
            } else if (mode === 'pod') {
                const val = document.getElementById('trend-pod-val').value;
                if (!val) return alert("POD ê¸°ì¤€ê°’(ì¼)ì„ ì…ë ¥í•˜ì„¸ìš”.");
                criteriaVal = Number(val);
            } else if (mode === 'cod') {
                const codChks = document.querySelectorAll('.trend-cod-chk:checked');
                if(codChks.length === 0) return alert("í•˜ë‚˜ ì´ìƒì˜ ì¡°ê±´ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                selectedCods = Array.from(codChks).map(c => c.value);
            }

            const container = document.getElementById('trend-res-area');
            container.innerHTML = '<div class="loader"></div> ë°ì´í„° ë¶„ì„ ì¤‘...';

            trendScatterCharts = { low: null, high: null };
            trendScatterDataCache = { low: [], high: [] };
            trendTimepointsCache = [];
            trendFilterState = { low: 'All', high: 'All' }; 

            try {
                const ratPromises = selectedCohorts.map(c => db.collection("rats").where("cohort", "==", c).get());
                const ratSnaps = await Promise.all(ratPromises);
                let allRats = [], allRatIds = []; const surgeryMap = {};

                ratSnaps.forEach(snap => {
                    snap.forEach(d => {
                        const r = d.data();
                        allRats.push(r); allRatIds.push(r.ratId);
                        if(r.surgeryDate) surgeryMap[r.ratId] = r.surgeryDate;
                    });
                });

                if (allRats.length === 0) { container.innerHTML = "í•´ë‹¹ ì½”í˜¸íŠ¸ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."; return; }

                const measPromises = allRatIds.map(rid => db.collection("measurements").where("ratId", "==", rid).get());
                const measSnaps = await Promise.all(measPromises);

                let globalMaxSbp = 0, globalMaxWt = 0, globalMaxPod = 0;
                const stdPodMap = globalPodMap, tempColumns = [], labelSet = new Set();
                const showAll = document.getElementById('trend-show-all')?.checked;
                const measMap = {}; 

                measSnaps.forEach((snap, idx) => {
                    const rid = allRatIds[idx];
                    const surgDate = surgeryMap[rid];
                    if(!measMap[rid]) measMap[rid] = {};

                    snap.forEach(doc => {
                        const d = doc.data();
                        if(d.timepoint) measMap[rid][d.timepoint] = d.weight;
                        measMap[rid][d.date] = d.weight; 

                        if(d.sbp && d.sbp > globalMaxSbp) globalMaxSbp = d.sbp;
                        if(d.weight && d.weight > globalMaxWt) globalMaxWt = d.weight;
                        if(surgDate && d.date) {
                             const p = Math.floor((new Date(d.date) - new Date(surgDate))/(1000*60*60*24));
                             if(p > globalMaxPod) globalMaxPod = p;
                        }

                        if (d.timepoint && stdPodMap.hasOwnProperty(d.timepoint)) {
                            if (!labelSet.has(d.timepoint)) { labelSet.add(d.timepoint); tempColumns.push({ label: d.timepoint, sortVal: stdPodMap[d.timepoint] }); }
                        } else if (showAll && d.date && surgDate) {
                            if (!labelSet.has(d.date)) {
                                const pod = Math.floor((new Date(d.date) - new Date(surgDate)) / (1000 * 60 * 60 * 24));
                                labelSet.add(d.date); tempColumns.push({ label: d.date, sortVal: pod });
                            }
                        }
                    });
                });

                tempColumns.sort((a,b) => a.sortVal - b.sortVal);
                const globalLabels = tempColumns.map(c => c.label);
                trendTimepointsCache = globalLabels;

                let groupTarget = [], groupControl = [];
                
                if (mode === 'cod') {
                    allRats.forEach(r => {
                        const myCod = r.cod || extractLegacyCod(r.codFull);
                        const myAre = r.are ? `ARE: ${r.are.split(' ')[0]}` : '';

                        // ì„ íƒëœ í‚¤ì›Œë“œ ì¤‘ CODì™€ ARE ì¤‘ í•˜ë‚˜ë¼ë„ ì •í™•íˆ ì¼ì¹˜í•˜ë©´ í¬í•¨
                        const hasCause = selectedCods.some(key => {
                            if(key.startsWith('ARE:')) return myAre === key;
                            return myCod === key;
                        });
                        
                        if (hasCause) groupTarget.push(r);
                        else groupControl.push(r);
                    });
                } else if (mode === 'pod') {
                    allRats.forEach(r => {
                        if (r.surgeryDate) {
                            const endDate = r.deathDate ? new Date(r.deathDate) : new Date();
                            const pod = Math.floor((endDate - new Date(r.surgeryDate)) / (1000 * 60 * 60 * 24));
                            if (pod < criteriaVal) groupTarget.push(r);
                            else groupControl.push(r);
                        }
                    });
                } else { 
                    allRats.forEach(r => {
                        let w = measMap[r.ratId]?.[criteriaTp];
                        if (w !== undefined) {
                            if (w < criteriaVal) groupTarget.push(r);
                            else groupControl.push(r);
                        }
                    });
                }

                container.innerHTML = '';
                const splitBox = document.createElement('div');
                splitBox.className = 'trend-container';
                container.appendChild(splitBox);

                const divA = document.createElement('div'); divA.className = 'trend-half'; divA.id = 'trend-res-low'; splitBox.appendChild(divA);
                const divB = document.createElement('div'); divB.className = 'trend-half'; divB.id = 'trend-res-high'; splitBox.appendChild(divB);

                const fixedOptions = { labels: globalLabels, maxSbp: globalMaxSbp, maxWt: globalMaxWt, maxPod: globalMaxPod, mode: mode };

                let titleA = '', titleB = '';
                if(mode === 'cod') {
                    const keysStr = selectedCods.length > 3 ? `${selectedCods.slice(0,3).join(', ')}...` : selectedCods.join(', ');
                    titleA = `Condition: [${keysStr}] (n=${groupTarget.length})`;
                    titleB = `Control: ë¯¸í¬í•¨ (n=${groupControl.length})`;
                } else {
                    const critText = mode === 'weight' ? `${criteriaTp} ì²´ì¤‘` : `POD`;
                    titleA = `${critText} < ${criteriaVal} (n=${groupTarget.length})`;
                    titleB = `${critText} â‰¥ ${criteriaVal} (n=${groupControl.length})`;
                }

                await runRatListAnalysis(groupTarget, 'trend-res-low', '_tr_low', titleA, fixedOptions, 'low');
                await runRatListAnalysis(groupControl, 'trend-res-high', '_tr_high', titleB, fixedOptions, 'high');

            } catch (e) { console.error(e); container.innerHTML = `<p style="color:red">ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${e.message}</p>`; }
        }
        
        async function runCohortAnalysis(targetCohorts, targetDivId, uniqueSuffix = '', fixedOptions = null, customTitle = null) {
            const resDiv = document.getElementById(targetDivId);

            let headerHtml = '';
            if (customTitle) {
                headerHtml = `<div style="position:sticky; top:60px; z-index:80; background:#fff; padding:10px; border-bottom:2px solid var(--navy); margin-bottom:15px; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                    <span style="font-weight:bold; color:var(--navy); font-size:1rem;">${customTitle}</span>
                </div>`;
            }
            resDiv.innerHTML = headerHtml + `<div class="loader"></div> ë°ì´í„° ë¶„ì„ ì¤‘...`;

            try {
                const ratPromises = targetCohorts.map(c => db.collection("rats").where("cohort", "==", c).get());
                const ratSnaps = await Promise.all(ratPromises);
                let rats = [];
                const ratInfoMap = {};

                ratSnaps.forEach(snap => { snap.forEach(d => { const r = d.data(); rats.push(r); ratInfoMap[r.ratId] = r; }); });
                if (rats.length === 0) { resDiv.innerHTML = "ë°ì´í„° ì—†ìŒ"; return; }

                const deadRats = rats.filter(r => r.status === "ì‚¬ë§");
                rats.sort((a, b) => a.ratId.localeCompare(b.ratId));
                const ratIds = rats.map(r => r.ratId);

                const promises = ratIds.map(rid => db.collection("measurements").where("ratId", "==", rid).get());
                const snapshots = await Promise.all(promises);

                const scatterDataWt = [], scatterDataSbp = [];
                const existTicksWt = new Set(), existTicksSbp = new Set();
                const tickLabelMap = {};
                let maxDataPod = 0, minWt = 9999, maxWt = 0, minSbp = 9999, maxSbp = 0;

                snapshots.forEach((snap, idx) => {
                    const r = rats[idx], rid = r.ratId;
                    snap.forEach(doc => {
                        const d = doc.data();
                        let labelText = d.timepoint;
                        if (!labelText || labelText === 'Manual') labelText = d.date;
                        const pod = getPodForLabel(d.timepoint, r.surgeryDate, d.date);
                        if ((d.timepoint === 'Manual' || !d.timepoint) && pod !== null) labelText = `D${pod}`;
                        if (pod !== null) {
                            if (pod > maxDataPod) maxDataPod = pod;
                            const jitter = (Math.random() - 0.5) * 0.4;
                            if (d.weight) { scatterDataWt.push({ x: pod + jitter, y: d.weight, rid: rid, label: labelText }); existTicksWt.add(pod); if (d.weight < minWt) minWt = d.weight; if (d.weight > maxWt) maxWt = d.weight; }
                            if (d.sbp) { scatterDataSbp.push({ x: pod + jitter, y: d.sbp, rid: rid, label: labelText }); existTicksSbp.add(pod); if (d.sbp < minSbp) minSbp = d.sbp; if (d.sbp > maxSbp) maxSbp = d.sbp; }
                            if (!tickLabelMap[pod] || globalPodMap.hasOwnProperty(labelText)) tickLabelMap[pod] = labelText;
                        }
                    });
                });

                const standardKeys = Object.keys(globalPodMap).filter(k => k === 'Arrival' || k === 'D00' || k === 'D0' || k === 'D2' || k.startsWith('W'));
                standardKeys.forEach(k => { tickLabelMap[globalPodMap[k]] = k; });

                const arrivalPod = globalPodMap["Arrival"];
                const podToLabel = (pod) => pod <= arrivalPod ? "Arrival" : (tickLabelMap[pod] || `D${pod}`);

                const getRangeX = (ticksSet) => { if (ticksSet.size === 0) return { min: arrivalPod, max: 14 }; const arr = Array.from(ticksSet).sort((a, b) => a - b); const minVal = (arr[0] < arrivalPod) ? (arr[0] - 2) : arrivalPod; return { min: minVal, max: arr[arr.length - 1] + 2 }; };
                const rangeWtX = fixedOptions ? { min: fixedOptions.minX, max: fixedOptions.maxX } : getRangeX(existTicksWt);
                const rangeSbpX = fixedOptions ? { min: fixedOptions.minX, max: fixedOptions.maxX } : getRangeX(existTicksSbp);

                const calcYRange = (minVal, maxVal, defaultMin, defaultMax) => { if (minVal === 9999) return { min: defaultMin, max: defaultMax }; const diff = maxVal - minVal; const padding = diff === 0 ? 50 : diff * 0.3; let finalMin = minVal - padding; let finalMax = maxVal + padding; if (finalMin < 0) finalMin = 0; return { min: finalMin, max: finalMax }; };
                const rangeWtY = calcYRange(minWt, maxWt, 0, 500);
                const rangeSbpY = calcYRange(minSbp, maxSbp, 0, 250);

                const avgsWt = {}, avgsSbp = {};
                const calcAvg = (dataset, targetObj, isInt) => { const map = {}; dataset.forEach(p => { const roundedX = Math.round(p.x); if (!map[roundedX]) map[roundedX] = { sum: 0, cnt: 0 }; map[roundedX].sum += p.y; map[roundedX].cnt++; }); Object.keys(map).forEach(x => { targetObj[x] = isInt ? Math.round(map[x].sum / map[x].cnt) : (map[x].sum / map[x].cnt).toFixed(1); }); };
                calcAvg(scatterDataWt, avgsWt, false); calcAvg(scatterDataSbp, avgsSbp, true);

                const avgLineWt = Object.keys(avgsWt).map(pod => ({ x: Number(pod), y: avgsWt[pod] })).sort((a, b) => a.x - b.x);
                const avgLineSbp = Object.keys(avgsSbp).map(pod => ({ x: Number(pod), y: avgsSbp[pod] })).sort((a, b) => a.x - b.x);

                // --- ë°ì´í„° ë° UI ìƒì„± ì‹œì‘ ---
                let surgAgeSum = 0, surgAgeCnt = 0;
                let smpHist = 0, smpCast = 0, smpFail = 0;
                const mrStats = {}; 
                const podDaysMap = { 'D00': -1, 'D0': 0, 'D2': 2, 'W1': 7, 'W2': 14, 'W3': 21, 'W4': 28, 'W5': 35, 'W6': 42, 'W7': 49, 'W8': 56, 'W9': 63, 'W10': 70, 'W11': 77, 'W12': 84 };

                // ìƒ˜í”Œ ìƒì„¸ ëª¨ë‹¬ HTML ìƒì„±
                let sampleModalRows = '';

                rats.forEach(r => {
                    if(r.sampleType === 'Histology') smpHist++;
                    else if(r.sampleType === 'Cast') smpCast++;
                    else if(r.sampleType === 'Fail') smpFail++;

                    // ìƒ˜í”Œ íŒì—…ì„ ìœ„í•œ ë°ì´í„° íŒŒì‹± (+ MR ëŒ€ë¹„ ê²½ê³¼ì¼)
                    let mrDiffStr = '-';
                    if(r.sampleDate && r.mrDates && r.mrDates.length > 0) {
                        const validMr = r.mrDates.filter(m => m.date).sort((a,b) => new Date(a.date) - new Date(b.date));
                        if(validMr.length > 0) {
                            const lastMr = validMr[validMr.length - 1];
                            const diff = Math.round((new Date(r.sampleDate) - new Date(lastMr.date)) / (1000*60*60*24));
                            mrDiffStr = diff >= 0 ? `+${diff}` : `${diff}`;
                        }
                    }
                    
                    sampleModalRows += `
                        <tr style="border-bottom:1px solid #eee;">
                            <td style="padding:8px; text-align:center;">${r.ratId} <span style="font-size:0.75rem; color:${r.status==='ìƒì¡´'?'green':'red'};">(${r.status})</span></td>
                            <td style="padding:8px; text-align:center;">
                                <span style="color:${r.sampleType==='Fail'?'red':'var(--navy)'}; font-weight:bold;">${r.sampleType||'-'}</span>
                            </td>
                            <td style="padding:8px; text-align:center;">${r.sampleDate||'-'}</td>
                            <td style="padding:8px; text-align:center; color:#e65100; font-weight:bold;">${mrDiffStr !== '-' ? mrDiffStr + 'ì¼' : '-'}</td>
                            <td style="padding:8px;">${r.sampleMemo||''}</td>
                        </tr>
                    `;

                    if(r.arrivalDate && r.surgeryDate) {
                        const arrAge = r.arrivalAge ? Number(r.arrivalAge) : 6;
                        const diff = new Date(r.surgeryDate) - new Date(r.arrivalDate);
                        const surgAge = arrAge + (diff / (1000*60*60*24*7));
                        surgAgeSum += surgAge;
                        surgAgeCnt++;
                    }

                    if(r.surgeryDate && r.mrDates) {
                        const surgDt = new Date(r.surgeryDate);
                        r.mrDates.forEach(mr => {
                            if(mr.timepoint === 'Death') return;
                            const expDays = podDaysMap[mr.timepoint];
                            if(expDays !== undefined && mr.date) {
                                const actDays = (new Date(mr.date) - surgDt) / (1000*60*60*24);
                                const dev = actDays - expDays;
                                if(!mrStats[mr.timepoint]) mrStats[mr.timepoint] = { sum:0, cnt:0 };
                                mrStats[mr.timepoint].sum += dev;
                                mrStats[mr.timepoint].cnt++;
                            }
                        });
                    }
                });

                const avgSurgAge = surgAgeCnt > 0 ? (surgAgeSum/surgAgeCnt).toFixed(1) : '-';
                const mrKeys = Object.keys(mrStats).sort((a,b) => podDaysMap[a] - podDaysMap[b]);
                const mrHtml = mrKeys.length === 0 ? '<span style="color:#888;">ë°ì´í„° ì—†ìŒ</span>' : mrKeys.map(k => {
                    const avgDev = (mrStats[k].sum / mrStats[k].cnt).toFixed(1);
                    const devStr = avgDev > 0 ? `+${avgDev}` : avgDev;
                    return `<span style="background:#e3f2fd; padding:3px 8px; border-radius:4px; font-size:0.85rem;"><b>${k}</b>: ${devStr}ì¼ (n=${mrStats[k].cnt})</span>`;
                }).join('');

                let surgFailN = 0, areO = 0, areX = 0, areMicro = 0, areMacro = 0, areUnk = 0;
                rats.forEach(r => {
                    const cod = r.cod || extractLegacyCod(r.codFull) || '';
                    if (cod === 'Surgical Failure') surgFailN++;
                    
                    if (r.are) {
                        if (r.are.startsWith('O')) {
                            areO++;
                            if(r.are.includes('micro')) areMicro++;
                            else if(r.are.includes('macro')) areMacro++;
                            else areUnk++;
                        } else if (r.are === 'X') {
                            areX++;
                        }
                    }
                });
                
                const totalN = rats.length;
                const validN = totalN - surgFailN;
                const rateTotal = totalN > 0 ? ((areO / totalN) * 100).toFixed(1) : 0;
                const rateValid = validN > 0 ? ((areO / validN) * 100).toFixed(1) : 0;

                let finalHtml = headerHtml;

                // ìƒ˜í”Œ ìƒì„¸ ëª¨ë‹¬ ì¶”ê°€
                finalHtml += `
                <div id="sample-modal-${uniqueSuffix}" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; justify-content:center; align-items:center;">
                    <div style="background:white; padding:20px; border-radius:12px; width:95%; max-width:700px; max-height:85vh; overflow-y:auto; box-shadow:0 10px 30px rgba(0,0,0,0.3);">
                        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid var(--navy); padding-bottom:10px; margin-bottom:15px;">
                            <h3 style="margin:0; color:var(--navy);">ğŸ”¬ ìƒ˜í”Œ íšë“ ìƒì„¸ ë‚´ì—­ (ì´ ${rats.length}ë§ˆë¦¬)</h3>
                            <button class="btn-red btn-small" onclick="document.getElementById('sample-modal-${uniqueSuffix}').style.display='none'">ë‹«ê¸° âœ–</button>
                        </div>
                        <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
                            <thead>
                                <tr style="background:#f5f5f5; text-align:center;">
                                    <th style="padding:8px;">Rat ID</th>
                                    <th style="padding:8px;">ì¢…ë¥˜</th>
                                    <th style="padding:8px;">ì±„ì·¨ì¼</th>
                                    <th style="padding:8px;">ë§ˆì§€ë§‰ MR ê¸°ì¤€</th>
                                    <th style="padding:8px;">ë©”ëª¨</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sampleModalRows || '<tr><td colspan="5" style="text-align:center; padding:15px;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>`;

                finalHtml += `
                <div class="card" style="border-left:5px solid #00c853;">
                    <h4 style="margin-top:0; color:var(--navy);">ğŸ“‹ ê¸°ë³¸ ì •ë³´ ìš”ì•½</h4>
                    <div class="info-grid" style="grid-template-columns: repeat(2, 1fr); margin-bottom:10px;">
                        <div class="info-item"><b>í‰ê·  ìˆ˜ìˆ  ì£¼ë ¹</b><br><span style="color:var(--navy); font-size:1.2rem;">${avgSurgAge} ì£¼</span></div>
                        <div class="info-item" style="cursor:pointer; background:#fff3e0; border:1px solid #ffcc80;" onclick="document.getElementById('sample-modal-${uniqueSuffix}').style.display='flex'">
                            <b>íšë“ ìƒ˜í”Œ ìˆ˜</b> <span style="font-size:0.75rem; color:var(--red);">(í´ë¦­í•˜ì—¬ ìƒì„¸í™•ì¸)</span><br>
                            <span style="font-size:0.9rem;">Histology: <b>${smpHist}</b> / Cast: <b>${smpCast}</b> / Fail: <b>${smpFail}</b></span>
                        </div>
                    </div>
                    <div style="background:#f8f9fa; padding:10px; border-radius:6px; border:1px solid #eee;">
                        <b style="font-size:0.9rem; color:var(--navy);">ğŸ“· MR ì´¬ì˜ í¸ì°¨ (ìˆ˜ìˆ ì¼ ê¸°ì¤€)</b>
                        <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:5px;">${mrHtml}</div>
                    </div>
                </div>`;

                finalHtml += `
                <div class="card" style="border-left:5px solid #9c27b0;">
                    <h4 style="margin-top:0; margin-bottom:10px; color:var(--navy);">ğŸ§  ARE ë°œìƒë¥ </h4>
                    <div style="text-align:right; margin-bottom:15px;">
                        <select id="are-filter-${uniqueSuffix}" style="padding:4px 8px; border-radius:4px; border:1px solid #1a237e;"
                            data-total="${totalN}" data-valid="${validN}" data-o="${areO}" data-micro="${areMicro}" data-macro="${areMacro}" data-unk="${areUnk}"
                            onchange="updateAreBar(this, '${uniqueSuffix}')">
                            <option value="all">ì „ì²´ ARE (O)</option>
                            <option value="micro">micro</option>
                            <option value="macro">macro</option>
                            <option value="ë¯¸í™•ì¸">ë¯¸í™•ì¸</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <div style="display:flex; justify-content:space-between; font-size:0.85rem; margin-bottom:5px; color:#555;">
                            <span>ì „ì²´ ê¸°ì¤€ (Total N = ${totalN})</span>
                            <span id="are-text-total-${uniqueSuffix}" style="font-weight:bold; color:#333;">${areO} / ${totalN} (${rateTotal}%)</span>
                        </div>
                        <div style="width:100%; background:#e0e0e0; height:14px; border-radius:7px; overflow:hidden;">
                            <div id="are-bar-total-${uniqueSuffix}" style="width:${rateTotal}%; background:#1565C0; height:100%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                    <div>
                        <div style="display:flex; justify-content:space-between; font-size:0.85rem; margin-bottom:5px; color:#555;">
                            <span>Surgical Failure ì œì™¸ (Valid N = ${validN})</span>
                            <span id="are-text-valid-${uniqueSuffix}" style="font-weight:bold; color:#333;">${areO} / ${validN} (${rateValid}%)</span>
                        </div>
                        <div style="width:100%; background:#e0e0e0; height:14px; border-radius:7px; overflow:hidden;">
                            <div id="are-bar-valid-${uniqueSuffix}" style="width:${rateValid}%; background:#F57C00; height:100%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                </div>`;

                const sChartId = `survChart${uniqueSuffix}`, sTableId = `survTable${uniqueSuffix}`;
                const codChartId = `codChart${uniqueSuffix}`, areChartId = `areChart${uniqueSuffix}`;
                const bpChartId = `coChartSbp${uniqueSuffix}`, bpTableId = `coTableSbp${uniqueSuffix}`;
                const wtChartId = `coChartWt${uniqueSuffix}`, wtTableId = `coTableWt${uniqueSuffix}`;
                const chartHeight = "500px";

                if (deadRats.length > 0) {
                    let survTable = `<table><tr><th>ID</th><th>ì‚¬ë§ì¼</th><th>ì‹œì </th></tr>`;
                    deadRats.forEach(r => {
                        const pod = r.surgeryDate && r.deathDate ? Math.floor((new Date(r.deathDate) - new Date(r.surgeryDate)) / (1000 * 60 * 60 * 24)) : '?';
                        const displayCod = r.cod || extractLegacyCod(r.codFull) || 'ë¯¸ê¸°ë¡';
                        survTable += `<tr><td>${r.ratId}</td><td>${r.deathDate || '-'}</td><td>POD ${pod}<br><span style="font-size:0.8em; color:gray">${displayCod}</span></td></tr>`;
                    });
                    survTable += `</table>`;
                    
                    finalHtml += `
                    <div class="card" style="border-left:5px solid var(--red)">
                        <h4>âš°ï¸ ì‚¬ë§ ë¶„ì„ (${deadRats.length}) - ìƒì¡´ìœ¨ (ì£¼ë ¹ ê¸°ì¤€)</h4>
                        <div class="chart-area" style="height:250px;"><canvas id="${sChartId}"></canvas></div>
                        <button class="data-toggle-btn" onclick="toggleDisplay('${sTableId}')">â–¼ ìƒì„¸ ë°ì´í„°</button>
                        <div id="${sTableId}" class="data-detail-box">${survTable}</div>
                        
                        <div style="display:flex; gap:20px; margin-top:30px; border-top:1px solid #eee; padding-top:20px; flex-wrap:wrap;">
                            <div style="flex:1; min-width:250px; text-align:center;">
                                <h5 style="color:var(--navy); margin-bottom:10px;">ì‚¬ë§ ì›ì¸ (COD) ë¹„ìœ¨</h5>
                                <div style="height:220px;"><canvas id="${codChartId}"></canvas></div>
                            </div>
                            <div style="flex:1; min-width:250px; text-align:center;">
                                <h5 style="color:var(--navy); margin-bottom:10px;">ì „ì²´ ARE ë¹„ìœ¨ (O/X)</h5>
                                <div style="height:220px;"><canvas id="${areChartId}"></canvas></div>
                            </div>
                        </div>
                    </div>`;
                }

                const controlPanel = `<div style="display:flex; align-items:center; gap:10px;"><button class="crosshair-toggle-btn" onclick="toggleCrosshair()" style="padding:4px 8px; border:none; border-radius:4px; font-size:0.75rem; cursor:pointer; background:${isCrosshairEnabled ? '#FFD600' : '#ddd'}; color:${isCrosshairEnabled ? '#000' : '#777'}; transition:0.2s; font-weight:bold;">${isCrosshairEnabled ? 'ğŸ¯ ê°€ì´ë“œì„  ON' : 'ğŸ¯ ê°€ì´ë“œì„  OFF'}</button><button class="indiv-toggle-btn" onclick="toggleIndividual()" style="padding:4px 8px; border:none; border-radius:4px; font-size:0.75rem; cursor:pointer; background:${isIndividualVisible ? '#00c853' : '#ddd'}; color:${isIndividualVisible ? '#fff' : '#777'}; transition:0.2s; font-weight:bold;">${isIndividualVisible ? 'ğŸ‘¥ ê°œë³„ì  ON' : 'ğŸ‘¥ ê°œë³„ì  OFF'}</button><span style="font-size:0.75rem; color:#fff; background:#555; padding:4px 8px; border-radius:4px; cursor:pointer;" onclick="Chart.getChart('${bpChartId}').resetZoom(); Chart.getChart('${wtChartId}').resetZoom();">ğŸ–±ï¸ ì¤Œ ì´ˆê¸°í™”</span></div>`;
                const sortedTicksSbp = Array.from(existTicksSbp).sort((a, b) => a - b);
                let bpTableHeaders = `<th style="width:40px;">Show</th><th>ID</th>` + sortedTicksSbp.map(pod => `<th style="min-width:60px; text-align:center; padding:5px;"><label style="cursor:pointer; display:flex; flex-direction:column; align-items:center;"><input type="checkbox" checked onchange="toggleTimepointVisibility('${bpChartId}', ${pod}, this.checked)" style="transform:scale(1.1); margin-bottom:4px;"><span style="line-height:1;">${podToLabel(pod)}</span></label></th>`).join('');
                let bpTable = `<div style="overflow-x:auto;"><table><tr>${bpTableHeaders}</tr>`;
                const avgSbpRow = sortedTicksSbp.map(pod => avgsSbp[pod] || '-');
                ratIds.forEach(id => { const rInfo = ratInfoMap[id]; const rData = scatterDataSbp.filter(d => d.rid === id); bpTable += `<tr><td style="text-align:center;"><input type="checkbox" checked onchange="toggleRatVisibility('${bpChartId}', '${id}', this.checked)" style="transform:scale(1.2); cursor:pointer;"></td><td>${rInfo.status === 'ì‚¬ë§' ? 'ğŸ’€' : 'ğŸŸ¢'} ${id}</td>`; sortedTicksSbp.forEach(pod => { const match = rData.find(d => Math.abs(d.x - pod) < 0.5); bpTable += `<td>${match ? match.y : '-'}</td>`; }); bpTable += `</tr>`; });
                bpTable += `<tr style="background:#e3f2fd; font-weight:bold;"><td>-</td><td>AVG</td>${avgSbpRow.map(v => `<td>${v}</td>`).join('')}</tr></table></div>`;
                finalHtml += `<div class="card"><div style="display:flex; justify-content:space-between; align-items:center;"><h4>ğŸ©¸ í˜ˆì•• (SBP)</h4>${controlPanel}</div><div class="chart-area" style="height:${chartHeight}"><canvas id="${bpChartId}"></canvas></div><button class="data-toggle-btn" onclick="toggleDisplay('${bpTableId}')">â–¼ ìƒì„¸ ë°ì´í„°</button><div id="${bpTableId}" class="data-detail-box">${bpTable}</div></div>`;

                const sortedTicksWt = Array.from(existTicksWt).sort((a, b) => a - b);
                let wtTableHeaders = `<th style="width:40px;">Show</th><th>ID</th>` + sortedTicksWt.map(pod => `<th style="min-width:60px; text-align:center; padding:5px;"><label style="cursor:pointer; display:flex; flex-direction:column; align-items:center;"><input type="checkbox" checked onchange="toggleTimepointVisibility('${wtChartId}', ${pod}, this.checked)" style="transform:scale(1.1); margin-bottom:4px;"><span style="line-height:1;">${podToLabel(pod)}</span></label></th>`).join('');
                let wtTable = `<div style="overflow-x:auto;"><table><tr>${wtTableHeaders}</tr>`;
                const avgWtRow = sortedTicksWt.map(pod => avgsWt[pod] || '-');
                ratIds.forEach(id => { const rInfo = ratInfoMap[id]; const rData = scatterDataWt.filter(d => d.rid === id); wtTable += `<tr><td style="text-align:center;"><input type="checkbox" checked onchange="toggleRatVisibility('${wtChartId}', '${id}', this.checked)" style="transform:scale(1.2); cursor:pointer;"></td><td>${rInfo.status === 'ì‚¬ë§' ? 'ğŸ’€' : 'ğŸŸ¢'} ${id}</td>`; sortedTicksWt.forEach(pod => { const match = rData.find(d => Math.abs(d.x - pod) < 0.5); wtTable += `<td>${match ? match.y : '-'}</td>`; }); wtTable += `</tr>`; });
                wtTable += `<tr style="background:#e8f5e9; font-weight:bold;"><td>-</td><td>AVG</td>${avgWtRow.map(v => `<td>${v}</td>`).join('')}</tr></table></div>`;
                finalHtml += `<div class="card"><div style="display:flex; justify-content:space-between; align-items:center;"><h4>âš–ï¸ ì²´ì¤‘ (Weight)</h4>${controlPanel}</div><div class="chart-area" style="height:${chartHeight}"><canvas id="${wtChartId}"></canvas></div><button class="data-toggle-btn" onclick="toggleDisplay('${wtTableId}')">â–¼ ìƒì„¸ ë°ì´í„°</button><div id="${wtTableId}" class="data-detail-box">${wtTable}</div></div>`;

                resDiv.innerHTML = finalHtml;

                if (deadRats.length > 0) {
                    let minAge = 999, maxAge = 0; const deathByAge = {};
                    rats.forEach(r => {
                        const arrAge = r.arrivalAge ? Number(r.arrivalAge) : 6; let endAge = arrAge;
                        if(r.status === 'ì‚¬ë§' && r.deathDate && r.arrivalDate) { endAge = arrAge + ((new Date(r.deathDate) - new Date(r.arrivalDate)) / (1000*60*60*24*7)); const w = Math.floor(endAge); deathByAge[w] = (deathByAge[w] || 0) + 1; }
                        else if (r.arrivalDate) { endAge = arrAge + ((new Date() - new Date(r.arrivalDate)) / (1000*60*60*24*7)); }
                        if(endAge < minAge) minAge = Math.floor(endAge); if(endAge > maxAge) maxAge = Math.ceil(endAge);
                    });
                    if(minAge === 999) minAge = 6;
                    const survLabels = [], survData = []; let currentAlive = rats.length;
                    for (let w = minAge; w <= maxAge; w++) { survLabels.push(`${w}ì£¼ë ¹`); if (deathByAge[w]) currentAlive -= deathByAge[w]; survData.push((currentAlive / rats.length) * 100); }
                    new Chart(document.getElementById(sChartId), { type: 'line', data: { labels: survLabels, datasets: [{ label: 'Survival Rate (%)', data: survData, borderColor: '#333', backgroundColor: 'rgba(0,0,0,0.1)', fill: true, stepper: true }] }, options: { maintainAspectRatio: false, scales: { y: { min: 0, max: 100 } } } });

                    const codCounts = {}; deadRats.forEach(r => { const cod = r.cod || extractLegacyCod(r.codFull) || 'Unknown'; codCounts[cod] = (codCounts[cod] || 0) + 1; });
                    const areCountsObj = { 'O':0, 'X':0, 'ë¯¸ê¸°ë¡':0 }; rats.forEach(r => { const areMain = r.are ? r.are.split(' ')[0] : 'ë¯¸ê¸°ë¡'; if(['O','X'].includes(areMain)) areCountsObj[areMain]++; else areCountsObj['ë¯¸ê¸°ë¡']++; });
                    const dOpt = { maintainAspectRatio: false, plugins: { legend: { position: 'right' }, tooltip: { callbacks: { label: (ctx) => { const total = ctx.dataset.data.reduce((a,b)=>a+b,0); return `${ctx.label}: ${ctx.raw} (${((ctx.raw/total)*100).toFixed(1)}%)`; } } } } };
                    new Chart(document.getElementById(codChartId), { type: 'doughnut', data: { labels: Object.keys(codCounts), datasets: [{ data: Object.values(codCounts), backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#C9CBCF'] }] }, options: dOpt });
                    new Chart(document.getElementById(areChartId), { type: 'doughnut', data: { labels: Object.keys(areCountsObj), datasets: [{ data: Object.values(areCountsObj), backgroundColor: ['#1565C0', '#4CAF50', '#9E9E9E'] }] }, options: dOpt });
                }

                const getStandardPodsInRange = (minX, maxX) => { const pods = []; ["Arrival", "D00", "D0", "D2"].forEach(k => { const v = globalPodMap[k]; if (v >= minX && v <= maxX) pods.push(v); }); for (let i = 1; i <= 12; i++) { const k = `W${i}`; const v = globalPodMap[k]; if (v >= minX && v <= maxX) pods.push(v); } pods.sort((a, b) => a - b); return Array.from(new Set(pods)); };
                const buildLinearTicks = (minX, maxX, step) => { const ticks = []; const start = Math.ceil(minX); const end = Math.floor(maxX); for (let v = start; v <= end; v += step) ticks.push(v); return ticks; };
                const createChartOptions = (minX, maxX, minY, maxY) => ({ maintainAspectRatio: false, layout: { padding: { right: 10, bottom: 28 } }, scales: { x: { type: 'linear', min: minX, max: maxX, afterBuildTicks: (scale) => { const range = scale.max - scale.min; if (range > 70) { scale.ticks = getStandardPodsInRange(scale.min, scale.max).map(v => ({ value: v })); return; } const ticks = buildLinearTicks(scale.min, scale.max, range > 30 ? 2 : 1); getStandardPodsInRange(scale.min, scale.max).forEach(v => ticks.push(v)); ticks.sort((a, b) => a - b); scale.ticks = Array.from(new Set(ticks)).map(v => ({ value: v })); }, ticks: { minRotation: 90, maxRotation: 90, autoSkip: false, callback: function (value) { return podToLabel(value); } }, grid: { color: (ctx) => tickLabelMap[ctx.tick.value] ? '#ddd' : '#f5f5f5' } }, y: { min: minY, max: maxY, ticks: { maxTicksLimit: 16 } } }, plugins: { zoom: { zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'xy' }, pan: { enabled: true, mode: 'xy', threshold: 10 }, limits: { x: { min: arrivalPod, max: maxX + 50 }, y: { min: 0, max: maxY + 200 } } }, tooltip: { enabled: true, callbacks: { title: (items) => { if (!items || !items.length) return ''; const it = items[0]; const pod = Math.round(it.parsed.x); if (it.dataset && it.dataset.label === 'Average') return podToLabel(pod); return (it.raw && it.raw.label) ? it.raw.label : podToLabel(pod); } } } } });

                const wtOpts = createChartOptions(rangeWtX.min, rangeWtX.max, rangeWtY.min, rangeWtY.max);
                const wtChart = new Chart(document.getElementById(wtChartId), { type: 'scatter', data: { datasets: [{ type: 'line', label: 'Average', data: avgLineWt, borderColor: '#00c853', borderWidth: 2, tension: 0.1, pointRadius: 3 }, { type: 'scatter', label: 'Individual', data: scatterDataWt, backgroundColor: 'rgba(0, 200, 83, 0.3)', pointRadius: 3, hidden: !isIndividualVisible }] }, options: wtOpts, plugins: [syncCrosshairPlugin] });
                document.getElementById(wtChartId).ondblclick = () => wtChart.resetZoom();

                const bpOpts = createChartOptions(rangeSbpX.min, rangeSbpX.max, rangeSbpY.min, rangeSbpY.max);
                const bpChart = new Chart(document.getElementById(bpChartId), { type: 'scatter', data: { datasets: [{ type: 'line', label: 'Average', data: avgLineSbp, borderColor: '#d32f2f', borderWidth: 2, tension: 0.1 }, { type: 'scatter', label: 'Individual', data: scatterDataSbp, backgroundColor: 'rgba(211, 47, 47, 0.3)', pointRadius: 3, hidden: !isIndividualVisible }] }, options: bpOpts, plugins: [syncCrosshairPlugin] });
                document.getElementById(bpChartId).ondblclick = () => bpChart.resetZoom();

                const enableCompareSync = (uniqueSuffix && (uniqueSuffix.includes('_comp_') || uniqueSuffix.includes('_grp_')));
                wtChart._syncType = 'wt'; bpChart._syncType = 'sbp';

                if (enableCompareSync) {
                    syncChartsWt = syncChartsWt.filter(c => c && !c._destroyed); syncChartsSbp = syncChartsSbp.filter(c => c && !c._destroyed);
                    if (!syncChartsWt.includes(wtChart)) syncChartsWt.push(wtChart);
                    if (!syncChartsSbp.includes(bpChart)) syncChartsSbp.push(bpChart);
                    let __zoomSyncLock = false;
                    function syncZoomPeers(source, peers) { if (__zoomSyncLock) return; __zoomSyncLock = true; const sx = source.scales.x; const sy = source.scales.y; peers.forEach(t => { if (!t || t === source || t._destroyed) return; if (t._syncType !== source._syncType) return; t.options.scales.x.min = sx.min; t.options.scales.x.max = sx.max; t.options.scales.y.min = sy.min; t.options.scales.y.max = sy.max; t.update('none'); }); __zoomSyncLock = false; }
                    wtChart.options.plugins.zoom.zoom.onZoomComplete = ({ chart }) => syncZoomPeers(chart, syncChartsWt); wtChart.options.plugins.zoom.pan.onPanComplete   = ({ chart }) => syncZoomPeers(chart, syncChartsWt);
                    bpChart.options.plugins.zoom.zoom.onZoomComplete = ({ chart }) => syncZoomPeers(chart, syncChartsSbp); bpChart.options.plugins.zoom.pan.onPanComplete   = ({ chart }) => syncZoomPeers(chart, syncChartsSbp);
                    wtChart.update('none'); bpChart.update('none');
                }
            } catch (e) { console.error(e); resDiv.innerHTML = `<p style="color:red">ì˜¤ë¥˜: ${e.message}</p>`; }
        }

        async function runRatListAnalysis(ratDataList, targetDivId, uniqueSuffix, customTitle, fixedOptions, groupKey) {
            const resDiv = document.getElementById(targetDivId);
            const headerHtml = `<div style="position:sticky; top:60px; z-index:90; background:#f8f9fa; padding:10px; border-bottom:2px solid var(--navy); margin-bottom:15px; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,0.1);"><span style="font-weight:bold; color:var(--navy); font-size:1rem;">${customTitle}</span></div>`;
            if (!ratDataList || ratDataList.length === 0) { resDiv.innerHTML = headerHtml + `<div style="padding:20px; text-align:center; color:#777;">í•´ë‹¹ ê·¸ë£¹ì— í¬í•¨ëœ ê°œì²´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`; return; }
            resDiv.innerHTML = headerHtml + `<div class="loader"></div> ë¡œë”© ì¤‘...`;

            try {
                const deadRats = ratDataList.filter(r => r.status === "ì‚¬ë§");
                ratDataList.sort((a, b) => a.ratId.localeCompare(b.ratId));
                const ratIds = ratDataList.map(r => r.ratId);
                const ratInfoMap = {}; ratDataList.forEach(r => ratInfoMap[r.ratId] = r);

                const promises = ratIds.map(rid => db.collection("measurements").where("ratId", "==", rid).get());
                const snapshots = await Promise.all(promises);

                const scatterDataWt = [], scatterDataSbp = [];
                const existTicksWt = new Set(), existTicksSbp = new Set();
                const tickLabelMap = {};
                let minWt = 9999, maxWt = 0, minSbp = 9999, maxSbp = 0, maxDataPod = 0;

                snapshots.forEach((snap, idx) => {
                    const r = ratDataList[idx], rid = r.ratId;
                    snap.forEach(doc => {
                        const d = doc.data();
                        let labelText = d.timepoint;
                        if (!labelText || labelText === 'Manual') labelText = d.date;
                        const pod = getPodForLabel(d.timepoint, r.surgeryDate, d.date);
                        if ((d.timepoint === 'Manual' || !d.timepoint) && pod !== null) labelText = `D${pod}`;
                        if (pod !== null) {
                            if (pod > maxDataPod) maxDataPod = pod;
                            const jitter = (Math.random() - 0.5) * 0.4;
                            if (d.weight) { scatterDataWt.push({ x: pod + jitter, y: d.weight, rid: rid, label: labelText }); existTicksWt.add(pod); if (d.weight < minWt) minWt = d.weight; if (d.weight > maxWt) maxWt = d.weight; }
                            if (d.sbp) { scatterDataSbp.push({ x: pod + jitter, y: d.sbp, rid: rid, label: labelText }); existTicksSbp.add(pod); if (d.sbp < minSbp) minSbp = d.sbp; if (d.sbp > maxSbp) maxSbp = d.sbp; }
                            if (!tickLabelMap[pod] || globalPodMap.hasOwnProperty(labelText)) tickLabelMap[pod] = labelText;
                        }
                    });
                });

                const standardKeys = Object.keys(globalPodMap).filter(k => k === 'Arrival' || k === 'D00' || k === 'D0' || k === 'D2' || k.startsWith('W'));
                standardKeys.forEach(k => { tickLabelMap[globalPodMap[k]] = k; });
                const arrivalPod = globalPodMap["Arrival"];
                const podToLabel = (pod) => pod <= arrivalPod ? "Arrival" : (tickLabelMap[pod] || `D${pod}`);
                const getRangeX = (ticksSet) => { if (ticksSet.size === 0) return { min: arrivalPod, max: 14 }; const arr = Array.from(ticksSet).sort((a, b) => a - b); const minVal = (arr[0] < arrivalPod) ? (arr[0] - 2) : arrivalPod; return { min: minVal, max: arr[arr.length - 1] + 2 }; };
                const rangeWtX = getRangeX(existTicksWt); const rangeSbpX = getRangeX(existTicksSbp);
                const calcYRange = (minVal, maxVal, defaultMin, defaultMax) => { if (minVal === 9999) return { min: defaultMin, max: defaultMax }; const diff = maxVal - minVal; const padding = diff === 0 ? 50 : diff * 0.3; let finalMin = minVal - padding; let finalMax = maxVal + padding; if (finalMin < 0) finalMin = 0; return { min: finalMin, max: finalMax }; };
                const rangeWtY = (fixedOptions && fixedOptions.maxWt) ? { min: 0, max: fixedOptions.maxWt + 50 } : calcYRange(minWt, maxWt, 0, 500);
                const rangeSbpY = (fixedOptions && fixedOptions.maxSbp) ? { min: 0, max: fixedOptions.maxSbp + 20 } : calcYRange(minSbp, maxSbp, 0, 250);

                const avgsWt = {}, avgsSbp = {};
                const calcAvg = (dataset, targetObj, isInt) => { const map = {}; dataset.forEach(p => { const roundedX = Math.round(p.x); if (!map[roundedX]) map[roundedX] = { sum: 0, cnt: 0 }; map[roundedX].sum += p.y; map[roundedX].cnt++; }); Object.keys(map).forEach(x => { targetObj[x] = isInt ? Math.round(map[x].sum / map[x].cnt) : (map[x].sum / map[x].cnt).toFixed(1); }); };
                calcAvg(scatterDataWt, avgsWt, false); calcAvg(scatterDataSbp, avgsSbp, true);
                const avgLineWt = Object.keys(avgsWt).map(pod => ({ x: Number(pod), y: avgsWt[pod] })).sort((a, b) => a.x - b.x);
                const avgLineSbp = Object.keys(avgsSbp).map(pod => ({ x: Number(pod), y: avgsSbp[pod] })).sort((a, b) => a.x - b.x);

                // --- UI ë° ë°ì´í„° íŒŒì‹± ---
                let surgAgeSum = 0, surgAgeCnt = 0;
                let smpHist = 0, smpCast = 0, smpFail = 0;
                const mrStats = {}; 
                const podDaysMap = { 'D00': -1, 'D0': 0, 'D2': 2, 'W1': 7, 'W2': 14, 'W3': 21, 'W4': 28, 'W5': 35, 'W6': 42, 'W7': 49, 'W8': 56, 'W9': 63, 'W10': 70, 'W11': 77, 'W12': 84 };

                let sampleModalRows = '';

                ratDataList.forEach(r => {
                    if(r.sampleType === 'Histology') smpHist++;
                    else if(r.sampleType === 'Cast') smpCast++;
                    else if(r.sampleType === 'Fail') smpFail++;

                    let mrDiffStr = '-';
                    if(r.sampleDate && r.mrDates && r.mrDates.length > 0) {
                        const validMr = r.mrDates.filter(m => m.date).sort((a,b) => new Date(a.date) - new Date(b.date));
                        if(validMr.length > 0) {
                            const lastMr = validMr[validMr.length - 1];
                            const diff = Math.round((new Date(r.sampleDate) - new Date(lastMr.date)) / (1000*60*60*24));
                            mrDiffStr = diff >= 0 ? `+${diff}` : `${diff}`;
                        }
                    }
                    
                    sampleModalRows += `
                        <tr style="border-bottom:1px solid #eee;">
                            <td style="padding:8px; text-align:center;">${r.ratId} <span style="font-size:0.75rem; color:${r.status==='ìƒì¡´'?'green':'red'};">(${r.status})</span></td>
                            <td style="padding:8px; text-align:center;">
                                <span style="color:${r.sampleType==='Fail'?'red':'var(--navy)'}; font-weight:bold;">${r.sampleType||'-'}</span>
                            </td>
                            <td style="padding:8px; text-align:center;">${r.sampleDate||'-'}</td>
                            <td style="padding:8px; text-align:center; color:#e65100; font-weight:bold;">${mrDiffStr !== '-' ? mrDiffStr + 'ì¼' : '-'}</td>
                            <td style="padding:8px;">${r.sampleMemo||''}</td>
                        </tr>
                    `;

                    if(r.arrivalDate && r.surgeryDate) {
                        const arrAge = r.arrivalAge ? Number(r.arrivalAge) : 6;
                        const diff = new Date(r.surgeryDate) - new Date(r.arrivalDate);
                        const surgAge = arrAge + (diff / (1000*60*60*24*7));
                        surgAgeSum += surgAge;
                        surgAgeCnt++;
                    }

                    if(r.surgeryDate && r.mrDates) {
                        const surgDt = new Date(r.surgeryDate);
                        r.mrDates.forEach(mr => {
                            if(mr.timepoint === 'Death') return;
                            const expDays = podDaysMap[mr.timepoint];
                            if(expDays !== undefined && mr.date) {
                                const actDays = (new Date(mr.date) - surgDt) / (1000*60*60*24);
                                const dev = actDays - expDays;
                                if(!mrStats[mr.timepoint]) mrStats[mr.timepoint] = { sum:0, cnt:0 };
                                mrStats[mr.timepoint].sum += dev;
                                mrStats[mr.timepoint].cnt++;
                            }
                        });
                    }
                });

                const avgSurgAge = surgAgeCnt > 0 ? (surgAgeSum/surgAgeCnt).toFixed(1) : '-';
                const mrKeys = Object.keys(mrStats).sort((a,b) => podDaysMap[a] - podDaysMap[b]);
                const mrHtml = mrKeys.length === 0 ? '<span style="color:#888;">ë°ì´í„° ì—†ìŒ</span>' : mrKeys.map(k => {
                    const avgDev = (mrStats[k].sum / mrStats[k].cnt).toFixed(1);
                    const devStr = avgDev > 0 ? `+${avgDev}` : avgDev;
                    return `<span style="background:#e3f2fd; padding:3px 8px; border-radius:4px; font-size:0.85rem;"><b>${k}</b>: ${devStr}ì¼ (n=${mrStats[k].cnt})</span>`;
                }).join('');

                let surgFailN = 0, areO = 0, areX = 0, areMicro = 0, areMacro = 0, areUnk = 0;
                ratDataList.forEach(r => {
                    const cod = r.cod || extractLegacyCod(r.codFull) || '';
                    if (cod === 'Surgical Failure') surgFailN++;
                    if (r.are) {
                        if (r.are.startsWith('O')) { areO++; if(r.are.includes('micro')) areMicro++; else if(r.are.includes('macro')) areMacro++; else areUnk++; } 
                        else if (r.are === 'X') { areX++; }
                    }
                });
                
                const totalN = ratDataList.length;
                const validN = totalN - surgFailN;
                const rateTotal = totalN > 0 ? ((areO / totalN) * 100).toFixed(1) : 0;
                const rateValid = validN > 0 ? ((areO / validN) * 100).toFixed(1) : 0;

                let finalHtml = headerHtml;

                // ìƒ˜í”Œ ìƒì„¸ ëª¨ë‹¬ ì¶”ê°€
                finalHtml += `
                <div id="sample-modal-${uniqueSuffix}" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; justify-content:center; align-items:center;">
                    <div style="background:white; padding:20px; border-radius:12px; width:95%; max-width:700px; max-height:85vh; overflow-y:auto; box-shadow:0 10px 30px rgba(0,0,0,0.3);">
                        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid var(--navy); padding-bottom:10px; margin-bottom:15px;">
                            <h3 style="margin:0; color:var(--navy);">ğŸ”¬ ìƒ˜í”Œ íšë“ ìƒì„¸ ë‚´ì—­ (ì´ ${ratDataList.length}ë§ˆë¦¬)</h3>
                            <button class="btn-red btn-small" onclick="document.getElementById('sample-modal-${uniqueSuffix}').style.display='none'">ë‹«ê¸° âœ–</button>
                        </div>
                        <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
                            <thead>
                                <tr style="background:#f5f5f5; text-align:center;">
                                    <th style="padding:8px;">Rat ID</th>
                                    <th style="padding:8px;">ì¢…ë¥˜</th>
                                    <th style="padding:8px;">ì±„ì·¨ì¼</th>
                                    <th style="padding:8px;">ë§ˆì§€ë§‰ MR ê¸°ì¤€</th>
                                    <th style="padding:8px;">ë©”ëª¨</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sampleModalRows || '<tr><td colspan="5" style="text-align:center; padding:15px;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>`;

                finalHtml += `
                <div class="card" style="border-left:5px solid #00c853;">
                    <h4 style="margin-top:0; color:var(--navy);">ğŸ“‹ ê¸°ë³¸ ì •ë³´ ìš”ì•½</h4>
                    <div class="info-grid" style="grid-template-columns: repeat(2, 1fr); margin-bottom:10px;">
                        <div class="info-item"><b>í‰ê·  ìˆ˜ìˆ  ì£¼ë ¹</b><br><span style="color:var(--navy); font-size:1.2rem;">${avgSurgAge} ì£¼</span></div>
                        <div class="info-item" style="cursor:pointer; background:#fff3e0; border:1px solid #ffcc80;" onclick="document.getElementById('sample-modal-${uniqueSuffix}').style.display='flex'">
                            <b>íšë“ ìƒ˜í”Œ ìˆ˜</b> <span style="font-size:0.75rem; color:var(--red);">(í´ë¦­í•˜ì—¬ ìƒì„¸í™•ì¸)</span><br>
                            <span style="font-size:0.9rem;">Histology: <b>${smpHist}</b> / Cast: <b>${smpCast}</b> / Fail: <b>${smpFail}</b></span>
                        </div>
                    </div>
                    <div style="background:#f8f9fa; padding:10px; border-radius:6px; border:1px solid #eee;">
                        <b style="font-size:0.9rem; color:var(--navy);">ğŸ“· MR ì´¬ì˜ í¸ì°¨ (ìˆ˜ìˆ ì¼ ê¸°ì¤€)</b>
                        <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:5px;">${mrHtml}</div>
                    </div>
                </div>`;

                finalHtml += `
                <div class="card" style="border-left:5px solid #9c27b0;">
                    <h4 style="margin-top:0; margin-bottom:10px; color:var(--navy);">ğŸ§  ARE ë°œìƒë¥ </h4>
                    <div style="text-align:right; margin-bottom:15px;">
                        <select id="are-filter-${uniqueSuffix}" style="padding:4px 8px; border-radius:4px; border:1px solid #1a237e;"
                            data-total="${totalN}" data-valid="${validN}" data-o="${areO}" data-micro="${areMicro}" data-macro="${areMacro}" data-unk="${areUnk}"
                            onchange="updateAreBar(this, '${uniqueSuffix}')">
                            <option value="all">ì „ì²´ ARE (O)</option>
                            <option value="micro">micro</option>
                            <option value="macro">macro</option>
                            <option value="ë¯¸í™•ì¸">ë¯¸í™•ì¸</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <div style="display:flex; justify-content:space-between; font-size:0.85rem; margin-bottom:5px; color:#555;">
                            <span>ì „ì²´ ê¸°ì¤€ (Total N = ${totalN})</span>
                            <span id="are-text-total-${uniqueSuffix}" style="font-weight:bold; color:#333;">${areO} / ${totalN} (${rateTotal}%)</span>
                        </div>
                        <div style="width:100%; background:#e0e0e0; height:14px; border-radius:7px; overflow:hidden;">
                            <div id="are-bar-total-${uniqueSuffix}" style="width:${rateTotal}%; background:#1565C0; height:100%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                    <div>
                        <div style="display:flex; justify-content:space-between; font-size:0.85rem; margin-bottom:5px; color:#555;">
                            <span>Surgical Failure ì œì™¸ (Valid N = ${validN})</span>
                            <span id="are-text-valid-${uniqueSuffix}" style="font-weight:bold; color:#333;">${areO} / ${validN} (${rateValid}%)</span>
                        </div>
                        <div style="width:100%; background:#e0e0e0; height:14px; border-radius:7px; overflow:hidden;">
                            <div id="are-bar-valid-${uniqueSuffix}" style="width:${rateValid}%; background:#F57C00; height:100%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                </div>`;

                const sChartId = `survChart${uniqueSuffix}`, sTableId = `survTable${uniqueSuffix}`;
                const codChartId = `codChart${uniqueSuffix}`, areChartId = `areChart${uniqueSuffix}`;
                const bpChartId = `coChartSbp${uniqueSuffix}`, bpTableId = `coTableSbp${uniqueSuffix}`;
                const wtChartId = `coChartWt${uniqueSuffix}`, wtTableId = `coTableWt${uniqueSuffix}`;
                const chartHeight = "500px";

                if (deadRats.length > 0) {
                    let survTable = `<table><tr><th>ID</th><th>ì‚¬ë§ì¼</th><th>ì‹œì </th></tr>`;
                    deadRats.forEach(r => { const pod = r.surgeryDate && r.deathDate ? Math.floor((new Date(r.deathDate) - new Date(r.surgeryDate)) / (1000 * 60 * 60 * 24)) : '?'; const displayCod = r.cod || extractLegacyCod(r.codFull) || 'ë¯¸ê¸°ë¡'; survTable += `<tr><td>${r.ratId}</td><td>${r.deathDate || '-'}</td><td>POD ${pod}<br><span style="font-size:0.8em; color:gray">${displayCod}</span></td></tr>`; });
                    survTable += `</table>`;
                    finalHtml += `<div class="card" style="border-left:5px solid var(--red)"><h4>âš°ï¸ ì‚¬ë§ ë¶„ì„ (${deadRats.length}) - ìƒì¡´ìœ¨ (ì£¼ë ¹ ê¸°ì¤€)</h4><div class="chart-area" style="height:250px;"><canvas id="${sChartId}"></canvas></div><button class="data-toggle-btn" onclick="toggleDisplay('${sTableId}')">â–¼ ìƒì„¸ ë°ì´í„°</button><div id="${sTableId}" class="data-detail-box">${survTable}</div><div style="display:flex; gap:20px; margin-top:30px; border-top:1px solid #eee; padding-top:20px; flex-wrap:wrap;"><div style="flex:1; min-width:250px; text-align:center;"><h5 style="color:var(--navy); margin-bottom:10px;">ì‚¬ë§ ì›ì¸ (COD) ë¹„ìœ¨</h5><div style="height:220px;"><canvas id="${codChartId}"></canvas></div></div><div style="flex:1; min-width:250px; text-align:center;"><h5 style="color:var(--navy); margin-bottom:10px;">ì „ì²´ ARE ë¹„ìœ¨ (O/X)</h5><div style="height:220px;"><canvas id="${areChartId}"></canvas></div></div></div></div>`;
                }

                const controlPanel = `<div style="display:flex; align-items:center; gap:10px;"><button class="crosshair-toggle-btn" onclick="toggleCrosshair()" style="padding:4px 8px; border:none; border-radius:4px; font-size:0.75rem; cursor:pointer; background:${isCrosshairEnabled ? '#FFD600' : '#ddd'}; color:${isCrosshairEnabled ? '#000' : '#777'}; transition:0.2s; font-weight:bold;">${isCrosshairEnabled ? 'ğŸ¯ ê°€ì´ë“œì„  ON' : 'ğŸ¯ ê°€ì´ë“œì„  OFF'}</button><button class="indiv-toggle-btn" onclick="toggleIndividual()" style="padding:4px 8px; border:none; border-radius:4px; font-size:0.75rem; cursor:pointer; background:${isIndividualVisible ? '#00c853' : '#ddd'}; color:${isIndividualVisible ? '#fff' : '#777'}; transition:0.2s; font-weight:bold;">${isIndividualVisible ? 'ğŸ‘¥ ê°œë³„ì  ON' : 'ğŸ‘¥ ê°œë³„ì  OFF'}</button><span style="font-size:0.75rem; color:#fff; background:#555; padding:4px 8px; border-radius:4px; cursor:pointer;" onclick="Chart.getChart('${bpChartId}').resetZoom(); Chart.getChart('${wtChartId}').resetZoom();">ğŸ–±ï¸ ì¤Œ ì´ˆê¸°í™”</span></div>`;
                const sortedTicksSbp = Array.from(existTicksSbp).sort((a, b) => a - b);
                let bpTableHeaders = `<th style="width:40px;">Show</th><th>ID</th>` + sortedTicksSbp.map(pod => `<th style="min-width:60px; text-align:center; padding:5px;"><label style="cursor:pointer; display:flex; flex-direction:column; align-items:center;"><input type="checkbox" checked onchange="toggleTimepointVisibility('${bpChartId}', ${pod}, this.checked)" style="transform:scale(1.1); margin-bottom:4px;"><span style="line-height:1;">${podToLabel(pod)}</span></label></th>`).join('');
                let bpTable = `<div style="overflow-x:auto;"><table><tr>${bpTableHeaders}</tr>`;
                const avgSbpRow = sortedTicksSbp.map(pod => avgsSbp[pod] || '-');
                ratIds.forEach(id => { const rInfo = ratInfoMap[id]; const rData = scatterDataSbp.filter(d => d.rid === id); bpTable += `<tr><td style="text-align:center;"><input type="checkbox" checked onchange="toggleRatVisibility('${bpChartId}', '${id}', this.checked)" style="transform:scale(1.2); cursor:pointer;"></td><td>${rInfo.status === 'ì‚¬ë§' ? 'ğŸ’€' : 'ğŸŸ¢'} ${id}</td>`; sortedTicksSbp.forEach(pod => { const match = rData.find(d => Math.abs(d.x - pod) < 0.5); bpTable += `<td>${match ? match.y : '-'}</td>`; }); bpTable += `</tr>`; });
                bpTable += `<tr style="background:#e3f2fd; font-weight:bold;"><td>-</td><td>AVG</td>${avgSbpRow.map(v => `<td>${v}</td>`).join('')}</tr></table></div>`;
                finalHtml += `<div class="card"><div style="display:flex; justify-content:space-between; align-items:center;"><h4>ğŸ©¸ í˜ˆì•• (SBP)</h4>${controlPanel}</div><div class="chart-area" style="height:${chartHeight}"><canvas id="${bpChartId}"></canvas></div><button class="data-toggle-btn" onclick="toggleDisplay('${bpTableId}')">â–¼ ìƒì„¸ ë°ì´í„°</button><div id="${bpTableId}" class="data-detail-box">${bpTable}</div></div>`;

                const sortedTicksWt = Array.from(existTicksWt).sort((a, b) => a - b);
                let wtTableHeaders = `<th style="width:40px;">Show</th><th>ID</th>` + sortedTicksWt.map(pod => `<th style="min-width:60px; text-align:center; padding:5px;"><label style="cursor:pointer; display:flex; flex-direction:column; align-items:center;"><input type="checkbox" checked onchange="toggleTimepointVisibility('${wtChartId}', ${pod}, this.checked)" style="transform:scale(1.1); margin-bottom:4px;"><span style="line-height:1;">${podToLabel(pod)}</span></label></th>`).join('');
                let wtTable = `<div style="overflow-x:auto;"><table><tr>${wtTableHeaders}</tr>`;
                const avgWtRow = sortedTicksWt.map(pod => avgsWt[pod] || '-');
                ratIds.forEach(id => { const rInfo = ratInfoMap[id]; const rData = scatterDataWt.filter(d => d.rid === id); wtTable += `<tr><td style="text-align:center;"><input type="checkbox" checked onchange="toggleRatVisibility('${wtChartId}', '${id}', this.checked)" style="transform:scale(1.2); cursor:pointer;"></td><td>${rInfo.status === 'ì‚¬ë§' ? 'ğŸ’€' : 'ğŸŸ¢'} ${id}</td>`; sortedTicksWt.forEach(pod => { const match = rData.find(d => Math.abs(d.x - pod) < 0.5); wtTable += `<td>${match ? match.y : '-'}</td>`; }); wtTable += `</tr>`; });
                wtTable += `<tr style="background:#e8f5e9; font-weight:bold;"><td>-</td><td>AVG</td>${avgWtRow.map(v => `<td>${v}</td>`).join('')}</tr></table></div>`;
                finalHtml += `<div class="card"><div style="display:flex; justify-content:space-between; align-items:center;"><h4>âš–ï¸ ì²´ì¤‘ (Weight)</h4>${controlPanel}</div><div class="chart-area" style="height:${chartHeight}"><canvas id="${wtChartId}"></canvas></div><button class="data-toggle-btn" onclick="toggleDisplay('${wtTableId}')">â–¼ ìƒì„¸ ë°ì´í„°</button><div id="${wtTableId}" class="data-detail-box">${wtTable}</div></div>`;

                resDiv.innerHTML = finalHtml;

                if (deadRats.length > 0) {
                    let minAge = 999, maxAge = 0; const deathByAge = {};
                    ratDataList.forEach(r => {
                        const arrAge = r.arrivalAge ? Number(r.arrivalAge) : 6; let endAge = arrAge;
                        if(r.status === 'ì‚¬ë§' && r.deathDate && r.arrivalDate) { endAge = arrAge + ((new Date(r.deathDate) - new Date(r.arrivalDate)) / (1000*60*60*24*7)); const w = Math.floor(endAge); deathByAge[w] = (deathByAge[w] || 0) + 1; }
                        else if (r.arrivalDate) { endAge = arrAge + ((new Date() - new Date(r.arrivalDate)) / (1000*60*60*24*7)); }
                        if(endAge < minAge) minAge = Math.floor(endAge); if(endAge > maxAge) maxAge = Math.ceil(endAge);
                    });
                    if(minAge === 999) minAge = 6;
                    const survLabels = [], survData = []; let currentAlive = ratDataList.length;
                    for (let w = minAge; w <= maxAge; w++) { survLabels.push(`${w}ì£¼ë ¹`); if (deathByAge[w]) currentAlive -= deathByAge[w]; survData.push((currentAlive / ratDataList.length) * 100); }
                    new Chart(document.getElementById(sChartId), { type: 'line', data: { labels: survLabels, datasets: [{ label: 'Survival Rate (%)', data: survData, borderColor: '#333', backgroundColor: 'rgba(0,0,0,0.1)', fill: true, stepper: true }] }, options: { maintainAspectRatio: false, scales: { y: { min: 0, max: 100 } } } });

                    const codCounts = {}; deadRats.forEach(r => { const cod = r.cod || extractLegacyCod(r.codFull) || 'Unknown'; codCounts[cod] = (codCounts[cod] || 0) + 1; });
                    const areCountsObj = { 'O':0, 'X':0, 'ë¯¸ê¸°ë¡':0 }; ratDataList.forEach(r => { const areMain = r.are ? r.are.split(' ')[0] : 'ë¯¸ê¸°ë¡'; if(['O','X'].includes(areMain)) areCountsObj[areMain]++; else areCountsObj['ë¯¸ê¸°ë¡']++; });
                    const dOpt = { maintainAspectRatio: false, plugins: { legend: { position: 'right' }, tooltip: { callbacks: { label: (ctx) => { const total = ctx.dataset.data.reduce((a,b)=>a+b,0); return `${ctx.label}: ${ctx.raw} (${((ctx.raw/total)*100).toFixed(1)}%)`; } } } } };
                    new Chart(document.getElementById(codChartId), { type: 'doughnut', data: { labels: Object.keys(codCounts), datasets: [{ data: Object.values(codCounts), backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#C9CBCF'] }] }, options: dOpt });
                    new Chart(document.getElementById(areChartId), { type: 'doughnut', data: { labels: Object.keys(areCountsObj), datasets: [{ data: Object.values(areCountsObj), backgroundColor: ['#1565C0', '#4CAF50', '#9E9E9E'] }] }, options: dOpt });
                }

                const getStandardPodsInRange = (minX, maxX) => { const pods = []; ["Arrival", "D00", "D0", "D2"].forEach(k => { const v = globalPodMap[k]; if (v >= minX && v <= maxX) pods.push(v); }); for (let i = 1; i <= 12; i++) { const k = `W${i}`; const v = globalPodMap[k]; if (v >= minX && v <= maxX) pods.push(v); } pods.sort((a, b) => a - b); return Array.from(new Set(pods)); };
                const buildLinearTicks = (minX, maxX, step) => { const ticks = []; const start = Math.ceil(minX); const end = Math.floor(maxX); for (let v = start; v <= end; v += step) ticks.push(v); return ticks; };
                const createChartOptions = (minX, maxX, minY, maxY) => ({ maintainAspectRatio: false, layout: { padding: { right: 10, bottom: 28 } }, scales: { x: { type: 'linear', min: minX, max: maxX, afterBuildTicks: (scale) => { const range = scale.max - scale.min; if (range > 70) { scale.ticks = getStandardPodsInRange(scale.min, scale.max).map(v => ({ value: v })); return; } const ticks = buildLinearTicks(scale.min, scale.max, range > 30 ? 2 : 1); getStandardPodsInRange(scale.min, scale.max).forEach(v => ticks.push(v)); ticks.sort((a, b) => a - b); scale.ticks = Array.from(new Set(ticks)).map(v => ({ value: v })); }, ticks: { minRotation: 90, maxRotation: 90, autoSkip: false, callback: function (value) { return podToLabel(value); } }, grid: { color: (ctx) => tickLabelMap[ctx.tick.value] ? '#ddd' : '#f5f5f5' } }, y: { min: minY, max: maxY, ticks: { maxTicksLimit: 16 } } }, plugins: { zoom: { zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'xy' }, pan: { enabled: true, mode: 'xy', threshold: 10 }, limits: { x: { min: arrivalPod, max: maxX + 50 }, y: { min: 0, max: maxY + 200 } } }, tooltip: { enabled: true, callbacks: { title: (items) => { if (!items || !items.length) return ''; const it = items[0]; const pod = Math.round(it.parsed.x); if (it.dataset && it.dataset.label === 'Average') return podToLabel(pod); return (it.raw && it.raw.label) ? it.raw.label : podToLabel(pod); } } } } });

                const wtOpts = createChartOptions(rangeWtX.min, rangeWtX.max, rangeWtY.min, rangeWtY.max);
                const wtChart = new Chart(document.getElementById(wtChartId), { type: 'scatter', data: { datasets: [{ type: 'line', label: 'Average', data: avgLineWt, borderColor: '#00c853', borderWidth: 2, tension: 0.1, pointRadius: 3 }, { type: 'scatter', label: 'Individual', data: scatterDataWt, backgroundColor: 'rgba(0, 200, 83, 0.3)', pointRadius: 3, hidden: !isIndividualVisible }] }, options: wtOpts, plugins: [syncCrosshairPlugin] });
                document.getElementById(wtChartId).ondblclick = () => wtChart.resetZoom();

                const bpOpts = createChartOptions(rangeSbpX.min, rangeSbpX.max, rangeSbpY.min, rangeSbpY.max);
                const bpChart = new Chart(document.getElementById(bpChartId), { type: 'scatter', data: { datasets: [{ type: 'line', label: 'Average', data: avgLineSbp, borderColor: '#d32f2f', borderWidth: 2, tension: 0.1 }, { type: 'scatter', label: 'Individual', data: scatterDataSbp, backgroundColor: 'rgba(211, 47, 47, 0.3)', pointRadius: 3, hidden: !isIndividualVisible }] }, options: bpOpts, plugins: [syncCrosshairPlugin] });
                document.getElementById(bpChartId).ondblclick = () => bpChart.resetZoom();

                wtChart._syncType = 'wt'; bpChart._syncType = 'sbp'; wtChart._syncScope = 'trend'; bpChart._syncScope = 'trend';
                syncChartsWt = syncChartsWt.filter(c => c && !c._destroyed); syncChartsSbp = syncChartsSbp.filter(c => c && !c._destroyed);
                if (!syncChartsWt.includes(wtChart)) syncChartsWt.push(wtChart);
                if (!syncChartsSbp.includes(bpChart)) syncChartsSbp.push(bpChart);
                let __zoomSyncLock = false;
                function syncZoomPeers(source, peers) { if (__zoomSyncLock) return; __zoomSyncLock = true; const sx = source.scales.x; const sy = source.scales.y; peers.forEach(t => { if (!t || t === source || t._destroyed) return; if (t._syncType !== source._syncType) return; if (t._syncScope !== source._syncScope) return; t.options.scales.x.min = sx.min; t.options.scales.x.max = sx.max; t.options.scales.y.min = sy.min; t.options.scales.y.max = sy.max; t.update('none'); }); __zoomSyncLock = false; }
                wtChart.options.plugins.zoom.zoom.onZoomComplete = ({ chart }) => syncZoomPeers(chart, syncChartsWt); wtChart.options.plugins.zoom.pan.onPanComplete   = ({ chart }) => syncZoomPeers(chart, syncChartsWt);
                bpChart.options.plugins.zoom.zoom.onZoomComplete = ({ chart }) => syncZoomPeers(chart, syncChartsSbp); bpChart.options.plugins.zoom.pan.onPanComplete   = ({ chart }) => syncZoomPeers(chart, syncChartsSbp);
                wtChart.update('none'); bpChart.update('none');

            } catch (e) { console.error(e); resDiv.innerHTML = headerHtml + `<p style="color:red">ì˜¤ë¥˜ ë°œìƒ: ${e.message}</p>`; }
        }
        
        // [2] ë™í–¥ë¶„ì„ìš© Scatter ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateTrendScatter(filterTp, groupKey) {
            // 1. í•´ë‹¹ ê·¸ë£¹ì˜ í•„í„° ìƒíƒœ ì—…ë°ì´íŠ¸
            trendFilterState[groupKey] = filterTp;

            // 2. ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            const btns = document.querySelectorAll(`.trend-filter-btn-${groupKey}`);
            btns.forEach(b => {
                b.classList.remove('btn-blue');
                b.classList.add('btn-white');
                b.style.border = '1px solid #ccc';
            });
            const activeBtn = document.getElementById(`btn-trend-${groupKey}-${filterTp}`);
            if(activeBtn) {
                activeBtn.classList.remove('btn-white');
                activeBtn.classList.add('btn-blue');
                activeBtn.style.border = 'none';
            }

            // 3. ì¶• í†µì¼ (Low/High MinMax ê³„ì‚°)
            let combinedData = [];
            ['low', 'high'].forEach(key => {
                const currentFilter = trendFilterState[key];
                const cache = trendScatterDataCache[key];
                if(cache) {
                    const filtered = (currentFilter === 'All') ? cache : cache.filter(pt => pt.tp === currentFilter);
                    combinedData = combinedData.concat(filtered);
                }
            });

            let maxW = 0, minW = 9999;
            if (combinedData.length > 0) {
                combinedData.forEach(p => { 
                    if (p.y > maxW) maxW = p.y; 
                    if (p.y < minW) minW = p.y; 
                });
            } else { maxW = 500; minW = 0; }

            const yMax = maxW + 10;
            const yMin = Math.max(0, minW - 10);

            // 4. ì°¨íŠ¸ ì—…ë°ì´íŠ¸
            ['low', 'high'].forEach(key => {
                const chart = trendScatterCharts[key];
                const cache = trendScatterDataCache[key];
                const currentFilter = trendFilterState[key];
                
                if(!chart || !cache) return;

                const filteredData = (currentFilter === 'All') ? cache : cache.filter(pt => pt.tp === currentFilter);
                chart.data.datasets[0].data = filteredData;

                if (currentFilter === 'All') {
                    chart.data.datasets[1].data = [];
                    chart.options.scales.x.min = -0.5;
                    chart.options.scales.x.max = trendTimepointsCache.length - 0.5;
                } else {
                    if (filteredData.length > 0) {
                        const sum = filteredData.reduce((acc, cur) => acc + cur.y, 0);
                        const avg = sum / filteredData.length;
                        const idx = trendTimepointsCache.indexOf(currentFilter);
                        const minX = idx - 0.5, maxX = idx + 0.5;
                        chart.data.datasets[1].data = [{ x: minX, y: avg }, { x: maxX, y: avg }];
                        chart.options.scales.x.min = minX;
                        chart.options.scales.x.max = maxX;
                    } else {
                        chart.data.datasets[1].data = [];
                    }
                }
                chart.options.scales.y.max = yMax;
                chart.options.scales.y.min = yMin;
                chart.update();
            });
        }

        // [3ë‹¨ê³„] ë¹„êµ ë¶„ì„ìš© Scatter ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ì¶”ê°€
        // [3] ë¹„êµ ë¶„ì„ìš© Scatter ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (Yì¶• ìŠ¤ì¼€ì¼ ë™ê¸°í™” ë° 5ë‹¨ìœ„ ì ìš©)
        // [ìˆ˜ì •] ì½”í˜¸íŠ¸ ë²ˆí˜¸ì— ì (.)ì´ ìˆì–´ë„ ì•ˆì „í•˜ê²Œ ì‘ë™í•˜ë„ë¡ 
    // í´ë˜ìŠ¤ ëŒ€ì‹  'ID' ì†ì„± ê²€ìƒ‰([id^=...])ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
    function updateCompScatter(filterTp, uniqueSuffix) {
        // 1. í˜„ì¬ ì°¨íŠ¸ì˜ í•„í„° ìƒíƒœ ì—…ë°ì´íŠ¸
        compFilterState[uniqueSuffix] = filterTp;

        // 2. ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ (ìˆ˜ì •ëœ ë¶€ë¶„)
        // ê¸°ì¡´: document.querySelectorAll('.comp-filter-btn-' + uniqueSuffix) -> ì (.) ì˜¤ë¥˜ ë°œìƒ ê°€ëŠ¥
        // ë³€ê²½: idê°€ 'btn-comp-SUFFIX-'ë¡œ ì‹œì‘í•˜ëŠ” ëª¨ë“  ìš”ì†Œë¥¼ ì°¾ìŒ -> ì•ˆì „í•¨
        const btns = document.querySelectorAll(`[id^="btn-comp-${uniqueSuffix}-"]`);
        
        btns.forEach(b => {
            b.classList.remove('btn-blue');
            b.classList.add('btn-white');
            b.style.border = '1px solid #ccc';
        });
        
        const activeBtn = document.getElementById(`btn-comp-${uniqueSuffix}-${filterTp}`);
        if(activeBtn) {
            activeBtn.classList.remove('btn-white');
            activeBtn.classList.add('btn-blue');
            activeBtn.style.border = 'none';
        }

        // 3. ë°ì´í„° í†µí•© ë° ìŠ¤ì¼€ì¼ ê³„ì‚° (ê¸°ì¡´ ë¡œì§ ë™ì¼)
        let combinedData = [];
        Object.keys(compScatterDataCache).forEach(key => {
            const cache = compScatterDataCache[key];
            const currentFilter = compFilterState[key] || 'All'; 
            const filtered = (currentFilter === 'All') ? cache : cache.filter(pt => pt.tp === currentFilter);
            combinedData = combinedData.concat(filtered);
        });

        let maxW = 0;
        let minW = 9999;
        if (combinedData.length > 0) {
            combinedData.forEach(p => { 
                if (p.y > maxW) maxW = p.y; 
                if (p.y < minW) minW = p.y; 
            });
        } else { maxW = 500; minW = 0; }
        
        const yMax = Math.ceil((maxW + 10) / 5) * 5; 
        const yMin = Math.max(0, Math.floor((minW - 10) / 5) * 5);

        // 4. ì°¨íŠ¸ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ ë¡œì§ ë™ì¼)
        Object.keys(compScatterCharts).forEach(key => {
            const chart = compScatterCharts[key];
            const cache = compScatterDataCache[key];
            const currentFilter = compFilterState[key] || 'All';

            if(!chart || !cache) return;

            const filteredData = (currentFilter === 'All') ? cache : cache.filter(pt => pt.tp === currentFilter);
            chart.data.datasets[0].data = filteredData;

            const labels = chart.customLabels || [];
            if (currentFilter === 'All') {
                 chart.data.datasets[1].data = [];
                 chart.options.scales.x.min = -0.5;
                 chart.options.scales.x.max = labels.length - 0.5;
            } else {
                 if(filteredData.length > 0) {
                     const sum = filteredData.reduce((acc, cur) => acc + cur.y, 0);
                     const avg = sum / filteredData.length;
                     const idx = labels.indexOf(currentFilter);
                     const minX = idx - 0.5;
                     const maxX = idx + 0.5;
                     
                     chart.data.datasets[1].data = [{ x: minX, y: avg }, { x: maxX, y: avg }];
                     chart.options.scales.x.min = minX;
                     chart.options.scales.x.max = maxX;
                 } else {
                     chart.data.datasets[1].data = [];
                 }
            }

            chart.options.scales.y.max = yMax;
            chart.options.scales.y.min = yMin;
            chart.options.scales.y.ticks.stepSize = 5; 

            chart.update();
        });
    }
        
        // [ìˆ˜ì •] ê°œë³„ í•„í„° ì—…ë°ì´íŠ¸ ë° ì¶• ë™ê¸°í™”
        function updateTrendScatter(filterTp, groupKey) {
            // 1. í•´ë‹¹ ê·¸ë£¹ì˜ í•„í„° ìƒíƒœ ì—…ë°ì´íŠ¸
            trendFilterState[groupKey] = filterTp;

            // 2. í•´ë‹¹ ê·¸ë£¹ì˜ ë²„íŠ¼ ìŠ¤íƒ€ì¼ë§Œ ì—…ë°ì´íŠ¸
            const btns = document.querySelectorAll(`.trend-filter-btn-${groupKey}`);
            btns.forEach(b => {
                b.classList.remove('btn-blue');
                b.classList.add('btn-white');
                b.style.border = '1px solid #ccc';
            });
            const activeBtn = document.getElementById(`btn-trend-${groupKey}-${filterTp}`);
            if(activeBtn) {
                activeBtn.classList.remove('btn-white');
                activeBtn.classList.add('btn-blue');
                activeBtn.style.border = 'none';
            }

            // 3. ì¶• í†µì¼ì„ ìœ„í•´ Lowì™€ High ì–‘ìª½ì˜ í˜„ì¬ í‘œì‹œ ë°ì´í„°(í•„í„° ì ìš©ë¨)ë¥¼ ëª¨ë‘ ê°€ì ¸ì™€ì„œ Min/Max ê³„ì‚°
            let combinedData = [];
            
            ['low', 'high'].forEach(key => {
                const currentFilter = trendFilterState[key];
                const cache = trendScatterDataCache[key];
                if(cache) {
                    const filtered = (currentFilter === 'All') ? cache : cache.filter(pt => pt.tp === currentFilter);
                    combinedData = combinedData.concat(filtered);
                }
            });

            // í†µí•© Yì¶• ë²”ìœ„ ê³„ì‚°
            let maxW = 0;
            let minW = 9999;
            if (combinedData.length > 0) {
                combinedData.forEach(p => { 
                    if (p.y > maxW) maxW = p.y; 
                    if (p.y < minW) minW = p.y; 
                });
            } else { maxW = 500; minW = 0; }

            const yMax = maxW + 10;
            const yMin = Math.max(0, minW - 10);

            // 4. Low/High ì°¨íŠ¸ ê°ê° ì—…ë°ì´íŠ¸ (ê°ìì˜ í•„í„° ìƒíƒœì— ë§ì¶° ë°ì´í„° ê°±ì‹ í•˜ë˜, ì¶•ì€ ìœ„ì—ì„œ ê³„ì‚°í•œ ê°’ìœ¼ë¡œ í†µì¼)
            ['low', 'high'].forEach(key => {
                const chart = trendScatterCharts[key];
                const cache = trendScatterDataCache[key];
                const currentFilter = trendFilterState[key];
                
                if(!chart || !cache) return;

                const filteredData = (currentFilter === 'All') ? cache : cache.filter(pt => pt.tp === currentFilter);
                
                // ë°ì´í„° ì—…ë°ì´íŠ¸
                chart.data.datasets[0].data = filteredData;

                // í‰ê· ì„  (ê°€ë¡œ ì§ì„ )
                if (currentFilter === 'All') {
                    chart.data.datasets[1].data = [];
                    chart.options.scales.x.min = -0.5;
                    chart.options.scales.x.max = trendTimepointsCache.length - 0.5;
                } else {
                    if (filteredData.length > 0) {
                        const sum = filteredData.reduce((acc, cur) => acc + cur.y, 0);
                        const avg = sum / filteredData.length;
                        const idx = trendTimepointsCache.indexOf(currentFilter);
                        const minX = idx - 0.5;
                        const maxX = idx + 0.5;
                        chart.data.datasets[1].data = [{ x: minX, y: avg }, { x: maxX, y: avg }];
                        chart.options.scales.x.min = minX;
                        chart.options.scales.x.max = maxX;
                    } else {
                        chart.data.datasets[1].data = [];
                    }
                }

                // Yì¶• ì—…ë°ì´íŠ¸ (ë™ê¸°í™”ëœ ê°’ ì ìš© + 5ë‹¨ìœ„)
                chart.options.scales.y.max = yMax;
                chart.options.scales.y.min = yMin;
                chart.options.scales.y.ticks.stepSize = 5; // 5ë‹¨ìœ„ ë³´ì¥

                chart.update();
            });
        }
        
        async function deleteSelectedLogs() {
            const dailies = document.querySelectorAll('.chk-daily:checked');
            const doses = document.querySelectorAll('.chk-dose:checked');
            const total = dailies.length + doses.length;

            if(total === 0) return alert("ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            if(!confirm(`ì´ ${total}ê°œì˜ ë¡œê·¸ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì‚­ì œ í›„ ë³µêµ¬ ë¶ˆê°€)`)) return;

            const batch = db.batch();
            let count = 0;

            // Firestore Batch Limit is 500. ê°„ë‹¨í•œ ì²˜ë¦¬ë¥¼ ìœ„í•´ 500ê°œ ë¯¸ë§Œ ê°€ì •.
            // ë§Œì•½ 500ê°œê°€ ë„˜ìœ¼ë©´ ë‚˜ëˆ ì„œ ì²˜ë¦¬í•´ì•¼ í•˜ì§€ë§Œ, ì¼ë°˜ì ì¸ ì‚¬ìš© íŒ¨í„´ìƒ ì´ì •ë„ë©´ ì¶©ë¶„í•©ë‹ˆë‹¤.
            
            dailies.forEach(cb => {
                const ref = db.collection("dailyLogs").doc(cb.value);
                batch.delete(ref);
                count++;
            });

            doses.forEach(cb => {
                const ref = db.collection("doseLogs").doc(cb.value);
                batch.delete(ref);
                count++;
            });

            try {
                await batch.commit();
                alert(`${count}ê°œì˜ ë¡œê·¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                searchLogsDel(); // ëª©ë¡ ê°±ì‹ 
            } catch(e) {
                console.error(e);
                alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.message);
            }
        }   

        // [ë°ì´í„° ë°±ì—… ê¸°ëŠ¥] ëª¨ë“  ë°ì´í„°ë¥¼ JSON íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ
        async function backupAllData() {
            if(!confirm("ì „ì²´ ë°ì´í„°ë¥¼ ë°±ì—…(ë‹¤ìš´ë¡œë“œ) í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në°ì´í„° ì–‘ì— ë”°ë¼ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")) return;
            
            const backupBtn = document.getElementById('btn-backup');
            const originalText = backupBtn.innerText;
            backupBtn.innerText = "ë°ì´í„° ìˆ˜ì§‘ ì¤‘...";
            backupBtn.disabled = true;

            try {
                const collections = ["rats", "measurements", "dailyLogs", "doseLogs", "cohortNotes"];
                const allData = {};

                // ëª¨ë“  ì»¬ë ‰ì…˜ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                for (const col of collections) {
                    const snapshot = await db.collection(col).get();
                    allData[col] = [];
                    snapshot.forEach(doc => {
                        allData[col].push({ _id: doc.id, ...doc.data() });
                    });
                }

                // ë‚ ì§œ ê¸°ë°˜ íŒŒì¼ëª… ìƒì„±
                const today = new Date();
                const dateStr = today.getFullYear() + "-" + (today.getMonth()+1) + "-" + today.getDate();
                const fileName = `RAT_LAB_BACKUP_${dateStr}.json`;

                // JSON íŒŒì¼ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ ë§í¬ íŠ¸ë¦¬ê±°
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allData, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", fileName);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();

                alert("ë°±ì—… íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.\nPCì— ì•ˆì „í•˜ê²Œ ë³´ê´€í•˜ì„¸ìš”.");
            } catch (e) {
                console.error(e);
                alert("ë°±ì—… ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.message);
            } finally {
                backupBtn.innerText = originalText;
                backupBtn.disabled = false;
            }
        } 

        // ==========================================
        //  ì‹ ê·œ ë°ì´í„° í•„ë“œ ì œì–´ í•¨ìˆ˜ (ë°˜ì…ì£¼ë ¹, OVX, MR, ìƒ˜í”Œ)
        // ==========================================
        
        async function upArrivalAge(did) {
            const val = document.getElementById('arr-age').value;
            try {
                await db.collection("rats").doc(did).update({ arrivalAge: Number(val) });
                clearRatsCache(); 
                alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); 
                loadDetailData();
            } catch(e) { console.error(e); alert("ì˜¤ë¥˜: " + e.message); }
        }

        async function upOvx(did) {
            const val = document.getElementById('ovx-d').value;
            try {
                await db.collection("rats").doc(did).update({ ovxDate: val });
                clearRatsCache(); 
                alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); 
                loadDetailData();
            } catch(e) { console.error(e); alert("ì˜¤ë¥˜: " + e.message); }
        }

        function extractLegacyCod(fullStr) {
            if(!fullStr || fullStr === 'ë¯¸ê¸°ë¡') return 'Unknown';
            const lower = fullStr.toLowerCase();
            
            // 1. í•µì‹¬ 3ì°¨ ì›ì¸ í‚¤ì›Œë“œë¥¼ 'ë¨¼ì €' ì°¾ì•„ì„œ ìµœìš°ì„ ìœ¼ë¡œ ë¹¼ëƒ…ë‹ˆë‹¤.
            if(lower.includes('sah') || lower.includes('subarachnoid')) return 'SAH';
            if(lower.includes('infarction')) return 'Infarction';
            if(lower.includes('vasospasm')) return 'Vasospasm';
            if(lower.includes('sacrifice')) return 'Sacrifice';
            if(lower.includes('surgical failure')) return 'Surgical Failure';
            
            // 2. ë§Œì•½ SAH ë“±ì´ ì—†ê³ , 'None-neurological'ì´ ì•„ë‹Œ 
            // ìˆœìˆ˜ 'Neurological' (ìˆ˜ìˆ  ì‹¤íŒ¨ ë“±)ë§Œ ì í˜€ìˆì„ ê²½ìš°ì—ë§Œ Surgical Failureë¡œ ë¶„ë¥˜
            if(lower.includes('neurological') && !lower.includes('none-neurological')) {
                return 'Surgical Failure';
            }
            
            return 'Unknown';
        }

        async function upSampleInfo(did) {
            const tp = document.getElementById('sample-tp').value;
            const dt = document.getElementById('sample-d').value;
            const memo = document.getElementById('sample-memo').value;
            try {
                await db.collection("rats").doc(did).update({ sampleType: tp, sampleDate: dt, sampleMemo: memo });
                clearRatsCache(); 
                alert("ìƒ˜í”Œ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); 
                loadDetailData();
            } catch(e) { console.error(e); alert("ì˜¤ë¥˜: " + e.message); }
        }

        async function addMrDate(did) {
            const tp = document.getElementById('new-mr-tp').value;
            const dt = document.getElementById('new-mr-d').value;
            if(!dt) return alert("ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.");
            
            try {
                const docRef = db.collection("rats").doc(did);
                const doc = await docRef.get();
                const arr = doc.data().mrDates || [];
                arr.push({ timepoint: tp, date: dt });
                
                // ì‹œê°„ ìˆœì„œ ì •ë ¬(ì„ íƒ ì‚¬í•­ì´ì§€ë§Œ ë³´ê¸° í¸í•˜ê²Œ)
                arr.sort((a,b) => new Date(a.date) - new Date(b.date));
                
                await docRef.update({ mrDates: arr });
                clearRatsCache(); 
                loadDetailData();
            } catch(e) { console.error(e); alert("ì˜¤ë¥˜: " + e.message); }
        }

        async function removeMrDate(did, idx) {
            if(!confirm("í•´ë‹¹ MR ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            try {
                const docRef = db.collection("rats").doc(did);
                const doc = await docRef.get();
                const arr = doc.data().mrDates || [];
                arr.splice(idx, 1);
                await docRef.update({ mrDates: arr });
                clearRatsCache(); 
                loadDetailData();
            } catch(e) { console.error(e); alert("ì˜¤ë¥˜: " + e.message); }
        }
        
        async function loadDetailData() {
            const id = document.getElementById('dt-rat-sel').value;
            const view = document.getElementById('detail-view');
            if(!id) return; 
            view.innerHTML = "ë¡œë”© ì¤‘...";
            
            try {
                const rSnap = await db.collection("rats").where("ratId", "==", id).get();
                if(rSnap.empty) { view.innerHTML = "ë“±ë¡ë˜ì§€ ì•ŠìŒ"; return; }
                const rat = rSnap.docs[0].data();
                const docId = rSnap.docs[0].id;
                
                let baseDate = new Date();
                if(rat.status === 'ì‚¬ë§' && rat.deathDate) { baseDate = new Date(rat.deathDate); }
                const dPlus = rat.arrivalDate ? Math.floor((baseDate - new Date(rat.arrivalDate))/(1000*60*60*24)) : '-';
                const pod = rat.surgeryDate ? Math.floor((baseDate - new Date(rat.surgeryDate))/(1000*60*60*24)) : '-';
                
                const arrivalAgeNum = rat.arrivalAge ? Number(rat.arrivalAge) : 6;
                let ageAtSurgStr = '-';
                if(rat.arrivalDate && rat.surgeryDate) {
                    const diffTime = new Date(rat.surgeryDate).getTime() - new Date(rat.arrivalDate).getTime();
                    const calcAge = arrivalAgeNum + (diffTime / (1000 * 60 * 60 * 24 * 7));
                    ageAtSurgStr = calcAge > 0 ? calcAge.toFixed(1) : '-';
                }

                let deathInfo = '';
                if(rat.status === 'ì‚¬ë§') {
                    const displayCod = rat.cod || (rat.codFull ? extractLegacyCod(rat.codFull) : 'ë¯¸ê¸°ë¡');
                    const displayAre = rat.are || 'ë¯¸ê¸°ë¡';
                    deathInfo = `<div class="info-item" style="grid-column: span 2; color:var(--red); border:1px solid var(--red); background:#ffebee;">
                        <b>ì‚¬ë§: ${rat.deathDate||'ë‚ ì§œë¯¸ìƒ'} (POD ${pod})</b>
                        <button class="btn-red btn-small" style="float:right; padding:2px 8px;" onclick="openSimpleCod('${docId}', '${displayCod}', '${displayAre}')">ì›ì¸ ê¸°ë¡</button>
                        <br><span style="font-size:0.9rem; color:#d32f2f; font-weight:bold;">COD: ${displayCod} / ARE: ${displayAre}</span>
                    </div>`;
                }

                let doseInfo = '';
                if(rat.doseStartDate) {
                    const doseDay = Math.floor((baseDate - new Date(rat.doseStartDate))/(1000*60*60*24));
                    doseInfo = `<div class="info-item"><b>Day ${doseDay}</b><br>íˆ¬ì•½ ì‹œì‘(${rat.doseStartDate})</div>`;
                } else { doseInfo = `<div class="info-item" style="color:#ccc;">-</div>`; }

                const mrOpts = ['D00','D0','D2','W1','W2','W3','W4','W5','W6','W7','W8','W9','W10','W11','W12','Death'];

                // --- ê°¤ëŸ¬ë¦¬ ë‚ ì§œ/ì‹œì  ì •ë ¬ ë° HTML ìƒì„± ---
                let photos = rat.photos || [];
                const tpWeight = { 'D00':-1, 'D0':0, 'D2':2, 'W1':7, 'W2':14, 'W3':21, 'W4':28, 'W5':35, 'W6':42, 'W7':49, 'W8':56, 'W9':63, 'W10':70, 'W11':77, 'W12':84, 'none':9999 };

                photos.sort((a, b) => {
                    // 1ìˆœìœ„: ì§€ì •ëœ ë‚ ì§œ(photoDate) ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
                    if (a.photoDate && b.photoDate && a.photoDate !== b.photoDate) {
                        return new Date(a.photoDate) - new Date(b.photoDate);
                    }
                    // 2ìˆœìœ„: ì‹œì (timepoint) ê°€ì¤‘ì¹˜ ì •ë ¬
                    const wA = (a.timepoint && tpWeight[a.timepoint] !== undefined) ? tpWeight[a.timepoint] : 9999;
                    const wB = (b.timepoint && tpWeight[b.timepoint] !== undefined) ? tpWeight[b.timepoint] : 9999;
                    if (wA !== wB) return wA - wB;
                    // 3ìˆœìœ„: ì—…ë¡œë“œ íƒ€ì„ìŠ¤íƒ¬í”„
                    return new Date(a.timestamp || 0) - new Date(b.timestamp || 0);
                });

                const photoHtml = photos.length > 0 ? photos.map(p => {
                    let rMarkHtml = '';
                    if (p.rMark && p.rMark !== 'none') {
                        let posStyle = '';
                        if (p.rMark === 'right') posStyle = 'top:50%; right:5px; transform:translateY(-50%);';
                        if (p.rMark === 'left') posStyle = 'top:50%; left:5px; transform:translateY(-50%);';
                        if (p.rMark === 'top') posStyle = 'top:5px; left:50%; transform:translateX(-50%);';
                        if (p.rMark === 'bottom') posStyle = 'bottom:25px; left:50%; transform:translateX(-50%);';
                        rMarkHtml = `<div style="position:absolute; ${posStyle} font-weight:900; color:#ffeb3b; text-shadow:1px 1px 3px #000; font-size:1.1rem; pointer-events:none;">R</div>`;
                    }
                    
                    // ë‚ ì§œ + ì‹œì  ì¡°í•© ë°°ì§€
                    let tpBadgeText = '';
                    if (p.photoDate) tpBadgeText += p.photoDate;
                    if (p.timepoint && p.timepoint !== 'none') tpBadgeText += (tpBadgeText ? ' ' : '') + `[${p.timepoint}]`;

                    let tpBadge = '';
                    if (tpBadgeText) {
                        tpBadge = `<div style="position:absolute; top:5px; left:5px; background:rgba(26,35,126,0.9); color:white; padding:2px 6px; border-radius:4px; font-size:0.75rem; font-weight:bold; box-shadow:0 1px 3px rgba(0,0,0,0.3); pointer-events:none; z-index:5;">${tpBadgeText}</div>`;
                    }

                    return `
                    <div style="position:relative; width:130px; height:130px; border:1px solid #ddd; border-radius:8px; overflow:hidden; background:#000; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                        <img src="${p.url}" draggable="false" style="width:100%; height:100%; object-fit:cover; cursor:pointer; user-select:none; -webkit-user-drag:none;" onclick="openPhotoViewer('${p.url}', '${p.memo||''}')">
                        ${tpBadge}
                        ${rMarkHtml}
                        <button onclick="deletePhoto('${docId}', '${encodeURIComponent(JSON.stringify(p))}')" style="position:absolute; top:5px; right:5px; background:rgba(211,47,47,0.8); color:white; border:none; border-radius:50%; width:24px; height:24px; font-size:12px; cursor:pointer; display:flex; align-items:center; justify-content:center; z-index:10;">âœ–</button>
                        <div style="position:absolute; bottom:0; left:0; width:100%; background:rgba(0,0,0,0.7); color:white; font-size:0.75rem; padding:4px; text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; box-sizing:border-box; z-index:5;">${p.memo||'ë©”ëª¨ì—†ìŒ'}</div>
                    </div>`;
                }).join('') : '<div style="color:#888; font-size:0.85rem; padding:10px;">ë“±ë¡ëœ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.</div>';

                // --- í™”ë©´ UI ì¡°í•© ---
                view.innerHTML = `
                    <div class="card">
                        <div style="display:flex; justify-content:space-between;">
                            <h3>${id}</h3><span style="color:${rat.status==='ìƒì¡´'?'green':'red'}">${rat.status}</span>
                        </div>
                        <div class="info-grid">
                            <div class="info-item"><b>D+${dPlus}</b><br>ë°˜ì… í›„<br><span style="font-size:0.8rem; color:#666;">${rat.arrivalDate||'-'} (${arrivalAgeNum}ì£¼ë ¹)</span></div>
                            <div class="info-item"><b>POD ${pod}</b><br>ìˆ˜ìˆ  í›„<br><span style="font-size:0.8rem; color:#666; font-weight:bold;">ìˆ˜ìˆ  ì‹œ: ì•½ ${ageAtSurgStr}ì£¼ë ¹</span></div>
                            ${deathInfo}
                            ${doseInfo}
                        </div>
                        
                        <div style="display:flex; flex-direction:column; gap:10px; margin-top:15px; padding:12px; background:#f8f9fa; border-radius:8px; border:1px solid #eee;">
                            <div style="display:flex; gap:15px; flex-wrap:wrap; align-items:center;">
                                <div style="display:flex; align-items:center; gap:6px;">
                                    <label style="font-size:0.8rem; margin-right:0; font-weight:bold; color:var(--navy);">ë°˜ì…ì£¼ë ¹</label>
                                    <select id="arr-age" style="width:70px; padding:4px;">
                                        ${[5,6,7,8,9,10].map(v=>`<option value="${v}" ${arrivalAgeNum===v?'selected':''}>${v}ì£¼</option>`).join('')}
                                    </select>
                                    <button class="btn-small" onclick="upArrivalAge('${docId}')">ì €ì¥</button>
                                </div>
                                <div style="display:flex; align-items:center; gap:6px;">
                                    <label style="font-size:0.8rem; margin-right:0; font-weight:bold; color:var(--navy);">OVXì¼ì</label>
                                    <input type="date" id="ovx-d" value="${rat.ovxDate||''}" style="width:130px; padding:4px 6px;">
                                    <button class="btn-small" onclick="upOvx('${docId}')">ì €ì¥</button>
                                </div>
                            </div>
                            <div style="display:flex; gap:15px; flex-wrap:wrap; align-items:center;">
                                <div style="display:flex; align-items:center; gap:6px;">
                                    <label style="font-size:0.8rem; margin-right:0; font-weight:bold; color:var(--navy);">ìˆ˜ìˆ ì¼ì</label>
                                    <input type="date" id="surg-d" value="${rat.surgeryDate||''}" style="width:130px; padding:4px 6px;">
                                    <button class="btn-small" onclick="upSurg('${docId}')">ì €ì¥</button>
                                </div>
                                <div style="display:flex; align-items:center; gap:6px;">
                                    <label style="font-size:0.8rem; margin-right:0; font-weight:bold; color:var(--navy);">íˆ¬ì•½ì‹œì‘</label>
                                    <input type="date" id="dose-start-d" value="${rat.doseStartDate||''}" style="width:130px; padding:4px 6px;">
                                    <button class="btn-small" onclick="upDoseStart('${docId}')">ì €ì¥</button>
                                </div>
                            </div>
                            
                            <div style="display:flex; align-items:center; gap:6px; background:#e3f2fd; padding:8px; border-radius:6px; border:1px solid #bbdefb; flex-wrap:wrap;">
                                <label style="font-size:0.8rem; margin-right:0; font-weight:bold; color:var(--navy);">ì–»ì€ ìƒ˜í”Œ</label>
                                <select id="sample-tp" style="width:100px; padding:4px;">
                                    <option value="">-</option>
                                    <option value="Histology" ${rat.sampleType==='Histology'?'selected':''}>Histology</option>
                                    <option value="Cast" ${rat.sampleType==='Cast'?'selected':''}>Cast</option>
                                    <option value="Fail" ${rat.sampleType==='Fail'?'selected':''}>ëª»í•¨</option>
                                </select>
                                <input type="date" id="sample-d" value="${rat.sampleDate||''}" style="width:130px; padding:4px;">
                                <input type="text" id="sample-memo" value="${rat.sampleMemo||''}" placeholder="ë©”ëª¨ (ì˜ˆ: ì¡°ì§ì†ìƒ)" style="flex:1; min-width:150px; padding:4px;">
                                <button class="btn-small btn-blue" onclick="upSampleInfo('${docId}')">ì €ì¥</button>
                            </div>

                            <div style="background:#fff; border:1px solid #ddd; padding:10px; border-radius:6px;">
                                <div style="font-size:0.85rem; font-weight:bold; color:var(--navy); margin-bottom:8px;">ğŸ“· MR ì´¬ì˜ ì´ë ¥</div>
                                <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px;">
                                    ${(rat.mrDates || []).map((mr, idx) => `
                                        <span style="background:#f1f3f5; border:1px solid #ccc; padding:3px 8px; border-radius:4px; font-size:0.85rem; display:inline-flex; align-items:center; gap:5px;">
                                            <b>${mr.timepoint}</b>: ${mr.date} 
                                            <i class="material-icons" style="font-size:1.1rem; color:var(--red); cursor:pointer;" onclick="removeMrDate('${docId}', ${idx})">cancel</i>
                                        </span>
                                    `).join('')}
                                    ${(!rat.mrDates || rat.mrDates.length === 0) ? '<span style="font-size:0.8rem; color:#888;">ê¸°ë¡ëœ MRì´ ì—†ìŠµë‹ˆë‹¤.</span>' : ''}
                                </div>
                                <div style="display:flex; gap:6px; align-items:center; border-top:1px dashed #eee; padding-top:8px;">
                                    <select id="new-mr-tp" style="width:90px; padding:4px; font-size:0.85rem;">
                                        ${mrOpts.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                                    </select>
                                    <input type="date" id="new-mr-d" value="${getTodayStr()}" style="width:130px; padding:4px; font-size:0.85rem;">
                                    <button class="btn-small btn-green" onclick="addMrDate('${docId}')" style="padding:4px 10px; font-size:0.85rem;">+ ì¶”ê°€</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h4 style="color:var(--navy); margin-top:0;">ğŸ–¼ï¸ ì‚¬ì§„ ë° ê²°ê³¼ ê¸°ë¡</h4>
                        
                        <div id="photo-dropzone-${docId}" 
                             style="border: 2px dashed #1a237e; border-radius: 8px; padding: 20px; text-align: center; background: #f8f9fa; cursor: pointer; margin-bottom:15px; transition: 0.2s;" 
                             ondragover="event.preventDefault(); this.style.background='#e3f2fd'; this.style.borderColor='#00c853';" 
                             ondragleave="this.style.background='#f8f9fa'; this.style.borderColor='#1a237e';" 
                             ondrop="handlePhotoDrop(event, '${docId}')" 
                             onclick="document.getElementById('photo-upload-input-${docId}').click()">
                            <div style="font-size:2rem; margin-bottom:10px;">ğŸ“¸</div>
                            <div style="font-weight:bold; color:#333;">ì—¬ê¸°ë¡œ ì‚¬ì§„ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”</div>
                            <div style="font-size:0.85rem; color:#666; margin-top:5px;">(Ctrl+V ë³µì‚¬/ë¶™ì—¬ë„£ê¸°ë„ ì§€ì›í•©ë‹ˆë‹¤. <b>ì—¬ëŸ¬ ì¥ ì„ íƒ ê°€ëŠ¥</b>)</div>
                            <input type="file" id="photo-upload-input-${docId}" accept="image/*" multiple style="display:none;" onchange="handlePhotoSelect(event, '${docId}')">
                        </div>
                        
                        <div id="photo-staging-area-${docId}" style="display:none; margin-bottom:15px; background:#fff; border:1px solid #ddd; border-radius:8px; padding:15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid var(--navy); padding-bottom:8px; margin-bottom:10px;">
                                <h5 style="margin:0; color:var(--navy);">ğŸ“¤ ì—…ë¡œë“œ ëŒ€ê¸° ëª©ë¡ (ê°œë³„ ì„¤ì • í›„ ì—…ë¡œë“œ)</h5>
                            </div>
                            <div id="photo-staging-list-${docId}" style="display:flex; flex-direction:column; gap:10px; max-height:400px; overflow-y:auto; margin-bottom:10px; padding-right:5px;"></div>
                            <button id="photo-upload-all-btn-${docId}" class="btn btn-green" onclick="uploadAllStagedPhotos('${docId}')" style="width:100%; font-size:1rem; padding:10px; font-weight:bold;">ğŸš€ ì¤€ë¹„ëœ ì‚¬ì§„ ëª¨ë‘ ì—…ë¡œë“œ</button>
                        </div>

                        <div id="photo-gallery" style="display:flex; gap:15px; flex-wrap:wrap;">
                            ${photoHtml}
                        </div>
                    </div>

                    <div class="card"><h4>ë°ì¼ë¦¬</h4><div class="chart-area"><canvas id="dailyChart"></canvas></div>
                    <div style="margin-top:10px; text-align:center;"><button class="btn btn-blue btn-small" onclick="toggleDailyLog()">Detail â–¼</button></div>
                    <div id="daily-detail-table" style="display:none; margin-top:10px;"></div></div>
                    
                    <div class="card">
                        <h4>í˜ˆì••/ì²´ì¤‘</h4>
                        <div style="display:flex; justify-content:center; align-items:center; gap:15px; margin-bottom:10px; background:#f8f9fa; padding:8px; border-radius:8px;">
                            <label style="cursor:pointer; display:flex; align-items:center; font-weight:bold; color:var(--red);"><input type="checkbox" id="chk-sbp" checked onchange="renderBpChart()" style="margin-right:5px; width:auto; transform:scale(1.2);"> SBP</label>
                            <label style="cursor:pointer; display:flex; align-items:center; font-weight:bold; color:var(--green);"><input type="checkbox" id="chk-wt" checked onchange="renderBpChart()" style="margin-right:5px; width:auto; transform:scale(1.2);"> Weight</label>
                        </div>
                        <div class="chart-area"><canvas id="bpChart"></canvas></div>
                        <div style="margin-top:10px; text-align:center;"><button class="btn btn-blue btn-small" onclick="toggleBpLog()">Detail â–¼</button></div>
                        <div id="bp-detail-table" style="display:none; margin-top:10px;"></div>
                    </div>

                    <div class="card"><h4>íˆ¬ì•½ ì´ë ¥</h4><div id="dose-logs"></div></div>
                    <div class="card"><h4>ê¸°ë¡ ë¡œê·¸</h4><div id="rec-logs"></div></div>`;

                // ê¸°ì¡´ ì°¨íŠ¸ ê·¸ë¦¬ê¸° ë¡œì§ ë“±ë“± (ìƒëµ ì—†ì´ ìœ ì§€)
                const logs = await db.collection("dailyLogs").where("ratId", "==", id).get();
                let processedLogs = [];
                logs.forEach(doc => {
                    let v = doc.data();
                    let dStr = v.date.trim();
                    if(dStr.includes('.')) { const parts = dStr.split('.').map(s => s.trim()); if(parts.length >= 3) dStr = `${parts[0]}-${parts[1].padStart(2,'0')}-${parts[2].padStart(2,'0')}`; }
                    v.cleanDate = dStr;
                    processedLogs.push(v);
                });
                processedLogs.sort((a, b) => new Date(a.cleanDate) - new Date(b.cleanDate));
                
                const uniqueMap = {};
                processedLogs.forEach(log => { uniqueMap[log.cleanDate] = log; });
                const finalLogs = Object.values(uniqueMap).sort((a, b) => new Date(a.cleanDate) - new Date(b.cleanDate));
                const dLab=[], dVal=[], dNotes=[], pStyles=[], pSizes=[], pColors=[];
                let tableHtml = `<table><tr><th>ë‚ ì§œ</th><th>ì‹œê°„</th><th>Act</th><th>Fur</th><th>Eye</th><th>ì´ì </th><th>ë©”ëª¨</th></tr>`;
                finalLogs.forEach(v => { 
                    dLab.push(v.cleanDate); dVal.push(v.totalScore); 
                    if(v.note && v.note.trim()) { dNotes.push(v.note); pStyles.push('rectRot'); pSizes.push(8); pColors.push('#fdd835'); } 
                    else { dNotes.push(null); pStyles.push('circle'); pSizes.push(3); pColors.push('#1a237e'); }
                    const actScore = (v.scores.activity !== undefined) ? v.scores.activity : (v.scores.act || 0);
                    tableHtml += `<tr><td>${v.cleanDate}</td><td>${v.timestamp || '-'}</td><td>${actScore}</td><td>${v.scores.fur}</td><td>${v.scores.eye}</td><td>${v.totalScore}</td><td style="text-align:left; max-width:200px; white-space:normal;">${v.note || ''}</td></tr>`;
                });
                tableHtml += `</table>`;
                document.getElementById('daily-detail-table').innerHTML = tableHtml;
                if(dVal.length) new Chart(document.getElementById('dailyChart'), { 
                    type:'line', data:{ labels: dLab, datasets:[{ label:'Score', data: dVal, borderColor:'#1a237e', pointStyle: pStyles, pointRadius: pSizes, pointBackgroundColor: pColors, pointBorderColor: pColors }] }, 
                    options:{ maintainAspectRatio:false, scales: { y: { min: 0, max: 17, ticks: { stepSize: 1 } } }, plugins:{ tooltip:{ callbacks:{ footer: (ti) => { const n = dNotes[ti[0].dataIndex]; if(!n) return ''; return ['ğŸ“ ë©”ëª¨:', ...n.match(/.{1,20}/g)]; } } } } } 
                });

                const ms = await db.collection("measurements").where("ratId", "==", id).get();
                const ds = await db.collection("doseLogs").where("ratId", "==", id).get();
                const dataMap = {};
                ms.forEach(doc => {
                    const v = doc.data();
                    const date = v.date;
                    if (!dataMap[date]) dataMap[date] = { date: date, label: v.timepoint || date, sbp: null, dbp: null, mean: null, wt: null };
                    if (v.sbp) dataMap[date].sbp = v.sbp;
                    if (v.dbp) dataMap[date].dbp = v.dbp;
                    if (v.mean) dataMap[date].mean = v.mean;
                    if (v.weight) dataMap[date].wt = v.weight;
                    if (v.timepoint && !dataMap[date].label.includes('W') && v.timepoint.includes('W')) dataMap[date].label = v.timepoint; 
                });
                ds.forEach(doc => {
                    const v = doc.data();
                    const date = v.date;
                    if (!dataMap[date]) dataMap[date] = { date: date, label: date, sbp: null, dbp: null, mean: null, wt: null };
                    if (v.weight) dataMap[date].wt = v.weight;
                });
                globalBpData = Object.values(dataMap).sort((a,b) => new Date(a.date) - new Date(b.date));
                renderBpChart(); 

                let bpTable = '<table><tr><th>ë‚ ì§œ</th><th>ì‹œì </th><th>SBP</th><th>DBP</th><th>Mean</th><th>WT</th></tr>';
                [...globalBpData].reverse().forEach(v => { bpTable += `<tr><td>${v.date}</td><td>${v.label}</td><td>${v.sbp||'-'}</td><td>${v.dbp||'-'}</td><td>${v.mean||'-'}</td><td>${v.wt||'-'}</td></tr>`; });
                bpTable += '</table>';
                document.getElementById('bp-detail-table').innerHTML = bpTable;

                let dHtml='<table><tr><th>ë‚ ì§œ</th><th>WT(g)</th><th>Drug(mg)</th><th>Vol(ml)</th></tr>';
                const revDs = ds.docs.sort((a,b)=>new Date(b.data().date)-new Date(a.data().date));
                if(revDs.length) { revDs.slice(0,5).forEach(d=>{const v=d.data(); const mg=v.doseMg?v.doseMg:((v.weight/1000)*4*1.15).toFixed(3); dHtml+=`<tr><td>${v.date}</td><td>${v.weight}</td><td>${Number(mg).toFixed(2)}</td><td>${v.volMl.toFixed(2)}</td></tr>`;}); document.getElementById('dose-logs').innerHTML=dHtml+'</table>'; }
                else document.getElementById('dose-logs').innerHTML='ë°ì´í„° ì—†ìŒ';

                let rHtml='<table><tr><th>ë‚ ì§œ</th><th>ì‹œì </th><th>SBP</th><th>WT</th></tr>';
                const sortedMs = ms.docs.map(d=>d.data()).sort((a,b)=>new Date(b.date)-new Date(a.date));
                sortedMs.slice(0,5).forEach(v=>{rHtml+=`<tr><td>${v.date}</td><td>${v.timepoint||'-'}</td><td>${v.sbp||'-'}</td><td>${v.weight||'-'}</td></tr>`;});
                document.getElementById('rec-logs').innerHTML = rHtml+'</table>';

            } catch(e) { console.error(e); }
        }

        async function searchForEdit() {
            const id = document.getElementById('edit-id').value.trim();
            if(!id) return alert("IDë¥¼ ì…ë ¥í•˜ì„¸ìš”");
            const resDiv = document.getElementById('edit-result');
            resDiv.innerHTML = '<div class="loader"></div> ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
            try {
                const ratQ = db.collection("rats").where("ratId", "==", id).get();
                const dailyQ = db.collection("dailyLogs").where("ratId", "==", id).orderBy("date").get();
                const measQ = db.collection("measurements").where("ratId", "==", id).orderBy("date").get();
                const [rSnap, dSnap, mSnap] = await Promise.all([ratQ, dailyQ, measQ]);
                if(rSnap.empty) { resDiv.innerHTML = "í•´ë‹¹ IDì˜ ë«ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."; return; }
                const ratDoc = rSnap.docs[0];
                const rData = ratDoc.data();
                
                const currentCod = rData.cod || extractLegacyCod(rData.codFull);
                const currentAre = rData.are || '';
                let areMain = currentAre.split(' ')[0] || '';
                let areSub = currentAre.split(' ')[1] ? currentAre.split(' ')[1].replace(/[()]/g, '') : '';
                const mrOpts = ['D00','D0','D2','W1','W2','W3','W4','W5','W6','W7','W8','W9','W10','W11','W12','Death'];

                let html = `
                <div class="edit-container">
                    <h3 style="color:var(--navy); border-bottom:2px solid var(--navy); padding-bottom:10px;">ğŸ“ í†µí•© ë°ì´í„° ìˆ˜ì • (${rData.ratId})</h3>
                    <div class="edit-section-title">ê¸°ë³¸ ì •ë³´</div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div class="input-group"><label>ìƒíƒœ</label><select id="ed-status" style="padding:5px;"><option value="ìƒì¡´" ${rData.status==='ìƒì¡´'?'selected':''}>ìƒì¡´</option><option value="ì‚¬ë§" ${rData.status==='ì‚¬ë§'?'selected':''}>ì‚¬ë§</option></select></div>
                        <div class="input-group">
                            <label>ì‚¬ë§ ì›ì¸ (COD)</label>
                            <select id="ed-cod" style="padding:5px;">
                                <option value="">-</option>
                                ${['SAH', 'Infarction', 'Vasospasm', 'Sacrifice', 'Surgical Failure', 'Unknown'].map(c => `<option value="${c}" ${currentCod===c?'selected':''}>${c}</option>`).join('')}
                            </select>
                        </div>
                        <div class="input-group">
                            <label>ARE ìœ ë¬´</label>
                            <div style="display:flex; gap:5px;">
                                <select id="ed-are-main" style="padding:5px; flex:1;" onchange="document.getElementById('ed-are-sub').style.display = this.value==='O' ? 'block' : 'none';">
                                    <option value="">-</option>
                                    <option value="O" ${areMain==='O'?'selected':''}>O</option>
                                    <option value="X" ${areMain==='X'?'selected':''}>X</option>
                                </select>
                                <select id="ed-are-sub" style="padding:5px; flex:1; display:${areMain==='O'?'block':'none'};">
                                    <option value="ë¯¸í™•ì¸" ${areSub==='ë¯¸í™•ì¸'?'selected':''}>ë¯¸í™•ì¸</option>
                                    <option value="micro" ${areSub==='micro'?'selected':''}>micro</option>
                                    <option value="macro" ${areSub==='macro'?'selected':''}>macro</option>
                                </select>
                            </div>
                        </div>
                        <div class="input-group"><label>ì‚¬ë§ì¼</label><input type="date" id="ed-death" value="${rData.deathDate||''}"></div>
                        <div class="input-group"><label>ë°˜ì…ì¼</label><input type="date" id="ed-arrival" value="${rData.arrivalDate||''}"></div>
                        <div class="input-group"><label>ìˆ˜ìˆ ì¼</label><input type="date" id="ed-surgery" value="${rData.surgeryDate||''}"></div>
                        <div class="input-group"><label>íˆ¬ì•½ì‹œì‘ì¼</label><input type="date" id="ed-dose-start" value="${rData.doseStartDate||''}"></div>
                        <div class="input-group">
                            <label>ë°˜ì…ì£¼ë ¹</label>
                            <select id="ed-arrival-age" style="padding:5px;">
                                ${[5,6,7,8,9,10].map(v => `<option value="${v}" ${(rData.arrivalAge||6)==v?'selected':''}>${v}ì£¼</option>`).join('')}
                            </select>
                        </div>
                        <div class="input-group"><label>OVXì¼ì</label><input type="date" id="ed-ovx" value="${rData.ovxDate||''}"></div>
                        
                        <div class="input-group" style="grid-column: span 2;">
                            <label>ìƒ˜í”Œ (ì¢…ë¥˜ & ë‚ ì§œ & ë©”ëª¨)</label>
                            <div style="display:flex; gap:5px; flex-wrap:wrap;">
                                <select id="ed-sample-tp" style="padding:5px; width:100px;">
                                    <option value="">-</option>
                                    <option value="Histology" ${rData.sampleType==='Histology'?'selected':''}>Histology</option>
                                    <option value="Cast" ${rData.sampleType==='Cast'?'selected':''}>Cast</option>
                                    <option value="Fail" ${rData.sampleType==='Fail'?'selected':''}>ëª»í•¨</option>
                                </select>
                                <input type="date" id="ed-sample-date" value="${rData.sampleDate||''}" style="padding:5px; width:130px;">
                                <input type="text" id="ed-sample-memo" value="${rData.sampleMemo||''}" placeholder="ìƒ˜í”Œ íŠ¹ì´ì‚¬í•­ ë©”ëª¨" style="padding:5px; flex:1; min-width:150px;">
                            </div>
                        </div>
                        
                        <div class="input-group" style="grid-column: span 2;">
                            <label>MR ì´¬ì˜ ì´ë ¥</label>
                            <div id="ed-mr-list" style="background:#f8f9fa; padding:10px; border-radius:6px; border:1px solid #ddd;">
                                ${(rData.mrDates || []).map(mr => `
                                    <div class="ed-mr-row" style="display:flex; gap:5px; margin-bottom:5px;">
                                        <select class="ed-mr-tp" style="width:100px; padding:5px;">
                                            ${mrOpts.map(opt => `<option value="${opt}" ${mr.timepoint===opt?'selected':''}>${opt}</option>`).join('')}
                                        </select>
                                        <input type="date" class="ed-mr-dt" value="${mr.date}" style="padding:5px;">
                                        <button class="btn-red btn-small" onclick="this.parentElement.remove()">X</button>
                                    </div>
                                `).join('')}
                            </div>
                            <button class="btn-small btn-blue" onclick="addEdMrRow()" style="margin-top:5px;">+ MR ì¶”ê°€</button>
                        </div>
                    </div>

                    <div class="edit-section-title">í˜ˆì••/ì²´ì¤‘ <button class="btn btn-blue btn-small" style="float:right;" onclick="addTableRow('meas-tbody')">+ ì¶”ê°€</button></div>
                    <table class="full-edit-table"><thead><tr><th>ë‚ ì§œ</th><th>ì‹œì </th><th>SBP</th><th>DBP</th><th>Mean</th><th>WT</th><th>ì‚­ì œ</th></tr></thead><tbody id="meas-tbody">`;
                
                mSnap.forEach(doc => {
                    const d = doc.data();
                    html += `<tr data-id="${doc.id}" data-coll="measurements"><td><input type="date" class="row-date" value="${d.date}"></td><td><input type="text" class="row-tp" value="${d.timepoint||''}"></td><td><input type="number" class="row-sbp" value="${d.sbp||''}"></td><td><input type="number" class="row-dbp" value="${d.dbp||''}"></td><td><input type="number" class="row-mean" value="${d.mean||''}"></td><td><input type="number" class="row-wt" value="${d.weight||''}"></td><td><button class="del-btn" onclick="markRowDel(this)">ì‚­ì œ</button></td></tr>`;
                });
                html += `</tbody></table><div class="edit-section-title">ë°ì¼ë¦¬ ì²´í¬ <button class="btn btn-blue btn-small" style="float:right;" onclick="addTableRow('daily-tbody')">+ ì¶”ê°€</button></div><table class="full-edit-table"><thead><tr><th>ë‚ ì§œ</th><th>Act</th><th>Fur</th><th>Eye</th><th>Memo</th><th>ì‚­ì œ</th></tr></thead><tbody id="daily-tbody">`;
                dSnap.forEach(doc => {
                    const d = doc.data();
                    const actVal = (d.scores?.activity !== undefined) ? d.scores.activity : (d.scores?.act || 0);
                    html += `<tr data-id="${doc.id}" data-coll="dailyLogs"><td><input type="date" class="row-date" value="${d.date}"></td><td><input type="number" class="row-act" value="${actVal}" style="width:40px"></td><td><input type="number" class="row-fur" value="${d.scores?.fur||0}" style="width:40px"></td><td><input type="number" class="row-eye" value="${d.scores?.eye||0}" style="width:40px"></td><td><input type="text" class="row-note" value="${d.note||''}"></td><td><button class="del-btn" onclick="markRowDel(this)">ì‚­ì œ</button></td></tr>`;
                });
                html += `</tbody></table><div style="height:60px;"></div> <button class="btn btn-green float-save-btn" onclick="saveTotalEdit('${ratDoc.id}')">ğŸ’¾ ì „ì²´ ì €ì¥</button></div>`;
                resDiv.innerHTML = html;
            } catch(e) { console.error(e); resDiv.innerHTML = `<p style="color:red">ì˜¤ë¥˜: ${e.message}</p>`; }
        }

        async function saveTotalEdit(ratDocId) {
            if(!confirm("ëª¨ë“  ë³€ê²½ì‚¬í•­ì„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            
            const batch = db.batch();
            const ratRef = db.collection("rats").doc(ratDocId);
            
            const mrRows = document.querySelectorAll('.ed-mr-row');
            const mrDatesArr = [];
            mrRows.forEach(row => {
                const tp = row.querySelector('.ed-mr-tp').value;
                const dt = row.querySelector('.ed-mr-dt').value;
                if(tp && dt) mrDatesArr.push({ timepoint: tp, date: dt });
            });

            const codVal = document.getElementById('ed-cod').value;
            const areMain = document.getElementById('ed-are-main').value;
            const areSub = document.getElementById('ed-are-sub').value;
            const areVal = areMain === 'O' ? `O (${areSub})` : (areMain === 'X' ? 'X' : '');

            batch.update(ratRef, {
                status: document.getElementById('ed-status').value,
                cod: codVal,
                are: areVal,
                codFull: `${codVal} / ARE: ${areVal}`, 
                arrivalDate: document.getElementById('ed-arrival').value,
                surgeryDate: document.getElementById('ed-surgery').value,
                doseStartDate: document.getElementById('ed-dose-start').value,
                deathDate: document.getElementById('ed-death').value,
                arrivalAge: Number(document.getElementById('ed-arrival-age').value),
                ovxDate: document.getElementById('ed-ovx').value,
                sampleType: document.getElementById('ed-sample-tp').value,
                sampleDate: document.getElementById('ed-sample-date').value,
                sampleMemo: document.getElementById('ed-sample-memo').value,
                mrDates: mrDatesArr
            });

            const tables = ['meas-tbody', 'daily-tbody'];
            const ratIdStr = document.getElementById('edit-id').value; 

            tables.forEach(tbodyId => {
                const rows = document.querySelectorAll(`#${tbodyId} tr`);
                rows.forEach(row => {
                    const coll = row.dataset.coll;
                    const docId = row.dataset.id;
                    const isDel = row.classList.contains('row-del');
                    const isNew = row.dataset.isNew === "true";
                    const date = row.querySelector('.row-date').value;

                    if (isDel && !isNew) {
                        const ref = db.collection(coll).doc(docId);
                        batch.delete(ref);
                    } else if (!isDel) {
                        let data = {};
                        if (coll === 'measurements') {
                            const sbp = row.querySelector('.row-sbp').value;
                            const dbp = row.querySelector('.row-dbp').value;
                            const mean = row.querySelector('.row-mean').value;
                            const wt = row.querySelector('.row-wt').value;
                            const tp = row.querySelector('.row-tp').value;
                            if(!date) return; 
                            data = {
                                ratId: ratIdStr, date: date, timepoint: tp,
                                sbp: sbp ? Number(sbp) : null,
                                dbp: dbp ? Number(dbp) : null,
                                mean: mean ? Number(mean) : null,
                                weight: wt ? Number(wt) : null
                            };
                        } else if (coll === 'dailyLogs') {
                            const act = Number(row.querySelector('.row-act').value);
                            const fur = Number(row.querySelector('.row-fur').value);
                            const eye = Number(row.querySelector('.row-eye').value);
                            const note = row.querySelector('.row-note').value;
                            if(!date) return;
                            data = {
                                ratId: ratIdStr, date: date,
                                scores: { activity: act, fur: fur, eye: eye },
                                totalScore: act + fur + eye,
                                note: note
                            };
                        }

                        if (isNew) {
                            const newRef = db.collection(coll).doc();
                            batch.set(newRef, data);
                        } else {
                            const ref = db.collection(coll).doc(docId);
                            batch.update(ref, data);
                        }
                    }
                });
            });

            try {
                await batch.commit();
                clearRatsCache();
                alert("ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                searchForEdit(); 
            } catch(e) {
                console.error(e);
                alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.message);
            }
        }

        function addEdMrRow() {
            const con = document.getElementById('ed-mr-list');
            const div = document.createElement('div');
            div.className = 'ed-mr-row';
            div.style.cssText = 'display:flex; gap:5px; margin-bottom:5px;';
            const opts = ['D00','D0','D2','W1','W2','W3','W4','W5','W6','W7','W8','W9','W10','W11','W12','Death']
                .map(opt => `<option value="${opt}">${opt}</option>`).join('');
            div.innerHTML = `<select class="ed-mr-tp" style="width:100px; padding:5px;">${opts}</select><input type="date" class="ed-mr-dt" style="padding:5px;"><button class="btn-red btn-small" onclick="this.parentElement.remove()">X</button>`;
            con.appendChild(div);
        }

       
        function openSimpleCod(docId, currentCod, currentAre) {
            activeCodRatId = docId;
            document.getElementById('modal-cod').value = currentCod && currentCod !== 'ë¯¸ê¸°ë¡' ? currentCod : '';
            
            let main = '', sub = 'ë¯¸í™•ì¸';
            if(currentAre && currentAre !== 'ë¯¸ê¸°ë¡') {
                main = currentAre.split(' ')[0];
                const s = currentAre.split(' ')[1];
                if(s) sub = s.replace(/[()]/g, '');
            }
            document.getElementById('modal-are-main').value = main;
            document.getElementById('modal-are-sub').value = sub;
            document.getElementById('modal-are-sub').style.display = main === 'O' ? 'block' : 'none';
            
            document.getElementById('simple-cod-modal').style.display = 'flex';
        }

        async function saveSimpleCod() {
            const cod = document.getElementById('modal-cod').value;
            const areMain = document.getElementById('modal-are-main').value;
            const areSub = document.getElementById('modal-are-sub').value;
            
            if(!cod || !areMain) return alert("CODì™€ AREë¥¼ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.");
            
            const areStr = areMain === 'O' ? `O (${areSub})` : 'X';
            
            try {
                await db.collection("rats").doc(activeCodRatId).update({
                    cod: cod,
                    are: areStr,
                    codFull: `${cod} / ARE: ${areStr}` // êµ¬ë²„ì „ ì°¨íŠ¸ í•˜ìœ„ í˜¸í™˜ì„ ìœ„í•´ í…ìŠ¤íŠ¸ë¡œ í•©ì³ì„œ ìœ ì§€
                });
                alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                document.getElementById('simple-cod-modal').style.display = 'none';
                clearRatsCache();
                loadDetailData();
            } catch(e) {
                console.error(e);
                alert("ì˜¤ë¥˜: " + e.message);
            }
        }

        // ==========================================
        //  ARE ì„œë¸Œíƒ€ì… ë³€ê²½ ì»¨íŠ¸ë¡¤ëŸ¬ (ë™ì  ì°¨íŠ¸/ë°” ì—…ë°ì´íŠ¸)
        // ==========================================
        function updateAreBar(selectEl, suffix) {
            const mode = selectEl.value; // 'all', 'micro', 'macro', 'ë¯¸í™•ì¸'
            const totalN = Number(selectEl.dataset.total);
            const validN = Number(selectEl.dataset.valid);
            let targetCount = 0;
            
            if(mode === 'all') targetCount = Number(selectEl.dataset.o);
            else if(mode === 'micro') targetCount = Number(selectEl.dataset.micro);
            else if(mode === 'macro') targetCount = Number(selectEl.dataset.macro);
            else if(mode === 'ë¯¸í™•ì¸') targetCount = Number(selectEl.dataset.unk);

            const rateTotal = totalN > 0 ? ((targetCount / totalN) * 100).toFixed(1) : 0;
            const rateValid = validN > 0 ? ((targetCount / validN) * 100).toFixed(1) : 0;

            document.getElementById(`are-text-total-${suffix}`).innerText = `${targetCount} / ${totalN} (${rateTotal}%)`;
            document.getElementById(`are-bar-total-${suffix}`).style.width = `${rateTotal}%`;
            document.getElementById(`are-text-valid-${suffix}`).innerText = `${targetCount} / ${validN} (${rateValid}%)`;
            document.getElementById(`are-bar-valid-${suffix}`).style.width = `${rateValid}%`;
        }

        // ==========================================
        //  ë©€í‹° ì´ë¯¸ì§€ ì—…ë¡œë“œ, ì‹œì  ì„¤ì •, ë·°ì–´ í†µí•© ì œì–´ ë¡œì§
        // ==========================================
        function compressImage(file, rMark = 'none') {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width, height = img.height;
                        const maxDim = 1280;

                        if (width > maxDim || height > maxDim) {
                            if (width > height) { height = Math.round((height *= maxDim / width)); width = maxDim; }
                            else { width = Math.round((width *= maxDim / height)); height = maxDim; }
                        }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        if (rMark && rMark !== 'none') {
                            const fontSize = Math.max(40, Math.floor(Math.min(width, height) * 0.08));
                            ctx.font = `900 ${fontSize}px Arial`;
                            ctx.fillStyle = '#ffeb3b'; 
                            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                            ctx.shadowColor = 'rgba(0, 0, 0, 0.9)'; ctx.shadowBlur = 8;
                            ctx.shadowOffsetX = 3; ctx.shadowOffsetY = 3;

                            let x = width / 2, y = height / 2; const padding = fontSize;
                            if (rMark === 'right') x = width - padding;
                            else if (rMark === 'left') x = padding;
                            else if (rMark === 'top') y = padding;
                            else if (rMark === 'bottom') y = height - padding;
                            ctx.fillText('R', x, y);
                        }
                        canvas.toBlob((blob) => resolve(blob), 'image/jpeg', 0.8);
                    };
                    img.src = event.target.result;
                };
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        let stagedPhotos = []; 
        window.currentRatDocId = null; 

        const observer = new MutationObserver(() => {
            const dropzone = document.querySelector('[id^="photo-dropzone-"]');
            if(dropzone) window.currentRatDocId = dropzone.id.replace('photo-dropzone-', '');
            else { window.currentRatDocId = null; stagedPhotos = []; }
        });
        observer.observe(document.body, { childList: true, subtree: true });

        window.addEventListener('paste', e => {
            if(e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
            if(!window.currentRatDocId) return;
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            const files = [];
            for (let index in items) {
                const item = items[index];
                if (item.kind === 'file' && item.type.startsWith('image/')) files.push(item.getAsFile());
            }
            if(files.length > 0) { e.preventDefault(); addFilesToStage(files, window.currentRatDocId); }
        });

        function handlePhotoSelect(e, docId) { addFilesToStage(e.target.files, docId); e.target.value = ''; }
        function handlePhotoDrop(e, docId) {
            e.preventDefault();
            document.getElementById(`photo-dropzone-${docId}`).style.background = '#f8f9fa';
            document.getElementById(`photo-dropzone-${docId}`).style.borderColor = '#1a237e';
            addFilesToStage(e.dataTransfer.files, docId);
        }

        function addFilesToStage(files, docId) {
            let added = false;
            for(let i=0; i<files.length; i++) {
                if(files[i].type.startsWith('image/')) {
                    stagedPhotos.push({ id: 'stage_' + Date.now() + '_' + i, file: files[i], url: URL.createObjectURL(files[i]) });
                    added = true;
                }
            }
            if(added) renderStagingArea(docId);
        }

        function removeStagedPhoto(id, docId) { stagedPhotos = stagedPhotos.filter(p => p.id !== id); renderStagingArea(docId); }

        function renderStagingArea(docId) {
            const area = document.getElementById(`photo-staging-area-${docId}`);
            const list = document.getElementById(`photo-staging-list-${docId}`);
            if(!area || !list) return;

            if(stagedPhotos.length === 0) { area.style.display = 'none'; return; }
            area.style.display = 'block';
            
            const tpOptions = ['D00','D0','D2','W1','W2','W3','W4','W5','W6','W7','W8','W9','W10','W11','W12'].map(v=>`<option value="${v}">${v}</option>`).join('');
            
            // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¸íŒ…
            const todayStr = new Date().toISOString().split('T')[0];
            
            let html = '';
            stagedPhotos.forEach(p => {
                html += `
                <div style="display:flex; gap:10px; align-items:center; background:#f1f3f5; padding:10px; border-radius:6px; border:1px solid #ccc;">
                    <img src="${p.url}" style="width:70px; height:70px; object-fit:cover; border-radius:6px; border:1px solid #aaa;">
                    <div style="flex:1; display:flex; flex-direction:column; gap:8px;">
                        <span style="font-size:0.85rem; font-weight:bold; color:#333; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:200px;">${p.file.name}</span>
                        <div style="display:flex; gap:8px; flex-wrap:wrap;">
                            <input type="date" id="stage-date-${p.id}" value="${todayStr}" style="width:125px; padding:6px; font-size:0.85rem; border-radius:4px; border:1px solid #bbb;">
                            <select id="stage-tp-${p.id}" style="width:120px; padding:6px; font-size:0.85rem; border-radius:4px; border:1px solid #bbb;">
                                <option value="none">ì‹œì (ì„ íƒì•ˆí•¨)</option>
                                ${tpOptions}
                            </select>
                            <select id="stage-rmark-${p.id}" style="width:110px; padding:6px; font-size:0.85rem; border-radius:4px; border:1px solid #bbb;">
                                <option value="none">R ë§ˆí¬ (X)</option>
                                <option value="right">â–¶ ì˜¤ë¥¸ìª½ (R)</option>
                                <option value="left">â—€ ì™¼ìª½ (R)</option>
                                <option value="top">â–² ìœ„ìª½ (R)</option>
                                <option value="bottom">â–¼ ì•„ë˜ìª½ (R)</option>
                            </select>
                            <input type="text" id="stage-memo-${p.id}" placeholder="ê°œë³„ ë©”ëª¨ (ì˜ˆ: ì¡°ì§ ì±„ì·¨ì‹œ ì†ìƒ)" style="flex:1; min-width:150px; padding:6px; font-size:0.85rem; border-radius:4px; border:1px solid #bbb;">
                        </div>
                    </div>
                    <button class="btn-red" onclick="removeStagedPhoto('${p.id}', '${docId}')" style="padding:6px 12px; font-weight:bold; font-size:1.1rem;">âœ–</button>
                </div>
                `;
            });
            list.innerHTML = html;
        }

        async function uploadAllStagedPhotos(docId) {
            if(stagedPhotos.length === 0) return;
            const btn = document.getElementById(`photo-upload-all-btn-${docId}`);
            btn.innerText = `ì—…ë¡œë“œ ì¤‘... (0 / ${stagedPhotos.length})`;
            btn.disabled = true;

            let successCount = 0; const newPhotos = [];

            try {
                for(let i = 0; i < stagedPhotos.length; i++) {
                    const p = stagedPhotos[i];
                    const memoVal = document.getElementById(`stage-memo-${p.id}`).value.trim();
                    const rMarkVal = document.getElementById(`stage-rmark-${p.id}`).value;
                    const tpVal = document.getElementById(`stage-tp-${p.id}`).value;
                    const dateVal = document.getElementById(`stage-date-${p.id}`).value; // ë‚ ì§œ ì¶”ì¶œ

                    btn.innerText = `ì••ì¶• ë° ì—…ë¡œë“œ ì¤‘... (${i + 1} / ${stagedPhotos.length})`;

                    const compressedBlob = await compressImage(p.file, rMarkVal);
                    const filename = `rats_photos/${docId}/${Date.now()}_${i}_${p.file.name}.jpg`;
                    const storageRef = firebase.storage().ref().child(filename);
                    
                    const snapshot = await storageRef.put(compressedBlob);
                    const downloadURL = await snapshot.ref.getDownloadURL();

                    newPhotos.push({
                        url: downloadURL,
                        memo: memoVal,
                        rMark: rMarkVal,
                        timepoint: tpVal,
                        photoDate: dateVal, // DBì— ë‚ ì§œ ì €ì¥
                        timestamp: new Date().toISOString(),
                        filename: filename
                    });
                    successCount++;
                }

                btn.innerText = `ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ì¤‘...`;
                for (let np of newPhotos) {
                    await db.collection('rats').doc(docId).update({ photos: firebase.firestore.FieldValue.arrayUnion(np) });
                }

                alert(`${successCount}ì¥ì˜ ì‚¬ì§„ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                stagedPhotos = []; 
                clearRatsCache();
                await loadDetailData();

            } catch(e) {
                console.error(e); alert("ì˜¤ë¥˜ ë°œìƒ: " + e.message);
                btn.innerText = "ğŸš€ ì¤€ë¹„ëœ ì‚¬ì§„ ëª¨ë‘ ì—…ë¡œë“œ"; btn.disabled = false;
            }
        }

        async function deletePhoto(docId, photoObjStr) {
            if(!confirm("ì´ ì‚¬ì§„ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const photoObj = JSON.parse(decodeURIComponent(photoObjStr));
            try {
                await firebase.storage().ref().child(photoObj.filename).delete().catch(e=>console.warn(e));
                await db.collection('rats').doc(docId).update({ photos: firebase.firestore.FieldValue.arrayRemove(photoObj) });
                alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."); clearRatsCache(); loadDetailData();
            } catch(e) { console.error(e); alert("ì‚­ì œ ì‹¤íŒ¨"); }
        }

        let pvScale = 1, pvTransX = 0, pvTransY = 0, pvDragging = false, pvStartX = 0, pvStartY = 0;
        function openPhotoViewer(url, memo) {
            const modal = document.getElementById('photo-viewer-modal');
            const img = document.getElementById('photo-viewer-img');
            document.getElementById('photo-viewer-memo').innerText = memo || 'ë©”ëª¨ ì—†ìŒ';
            img.src = url;
            pvScale = 1; pvTransX = 0; pvTransY = 0;
            img.style.transform = `translate(0px, 0px) scale(1)`;
            modal.style.display = 'flex';
        }
        function closePhotoViewer() { document.getElementById('photo-viewer-modal').style.display = 'none'; }

        window.addEventListener('DOMContentLoaded', () => {
            const img = document.getElementById('photo-viewer-img');
            if(!img) return;
            img.addEventListener('wheel', (e) => { e.preventDefault(); pvScale += e.deltaY < 0 ? 0.15 : -0.15; if(pvScale < 0.5) pvScale = 0.5; if(pvScale > 5) pvScale = 5; img.style.transform = `translate(${pvTransX}px, ${pvTransY}px) scale(${pvScale})`; });
            img.addEventListener('mousedown', (e) => { e.preventDefault(); pvDragging = true; pvStartX = e.clientX - pvTransX; pvStartY = e.clientY - pvTransY; img.style.cursor = 'grabbing'; });
            window.addEventListener('mouseup', () => { pvDragging = false; if(img) img.style.cursor = 'grab'; });
            window.addEventListener('mousemove', (e) => { if(!pvDragging) return; pvTransX = e.clientX - pvStartX; pvTransY = e.clientY - pvStartY; img.style.transform = `translate(${pvTransX}px, ${pvTransY}px) scale(${pvScale})`; });
        });

        window.addEventListener('DOMContentLoaded', () => {
            const img = document.getElementById('photo-viewer-img');
            if(!img) return;

            img.addEventListener('wheel', (e) => {
                e.preventDefault();
                pvScale += e.deltaY < 0 ? 0.15 : -0.15;
                if(pvScale < 0.5) pvScale = 0.5;
                if(pvScale > 5) pvScale = 5;
                img.style.transform = `translate(${pvTransX}px, ${pvTransY}px) scale(${pvScale})`;
            });

            // [ì¤‘ìš” ìˆ˜ì •] e.preventDefault() ë¥¼ ì¶”ê°€í•´ ì‚¬ì§„ ë“œë˜ê·¸(ë³µì‚¬) ì”ìƒ í˜„ìƒì„ ì™„ë²½íˆ ì°¨ë‹¨
            img.addEventListener('mousedown', (e) => {
                e.preventDefault(); 
                pvDragging = true;
                pvStartX = e.clientX - pvTransX;
                pvStartY = e.clientY - pvTransY;
                img.style.cursor = 'grabbing';
            });

            window.addEventListener('mouseup', () => {
                pvDragging = false;
                if(img) img.style.cursor = 'grab';
            });

            window.addEventListener('mousemove', (e) => {
                if(!pvDragging) return;
                pvTransX = e.clientX - pvStartX;
                pvTransY = e.clientY - pvStartY;
                img.style.transform = `translate(${pvTransX}px, ${pvTransY}px) scale(${pvScale})`;
            });
        });

        // ì´ˆê¸° ë¡œë“œ ì‹œ ë·°ì–´ ì´ë²¤íŠ¸ ë°”ì¸ë”© (1íšŒ)
        window.addEventListener('DOMContentLoaded', () => {
            const img = document.getElementById('photo-viewer-img');
            if(!img) return;

            img.addEventListener('wheel', (e) => {
                e.preventDefault();
                pvScale += e.deltaY < 0 ? 0.15 : -0.15;
                if(pvScale < 0.5) pvScale = 0.5;
                if(pvScale > 5) pvScale = 5;
                img.style.transform = `translate(${pvTransX}px, ${pvTransY}px) scale(${pvScale})`;
            });

            img.addEventListener('mousedown', (e) => {
                pvDragging = true;
                pvStartX = e.clientX - pvTransX;
                pvStartY = e.clientY - pvTransY;
                img.style.cursor = 'grabbing';
            });

            window.addEventListener('mouseup', () => {
                pvDragging = false;
                if(img) img.style.cursor = 'grab';
            });

            window.addEventListener('mousemove', (e) => {
                if(!pvDragging) return;
                pvTransX = e.clientX - pvStartX;
                pvTransY = e.clientY - pvStartY;
                img.style.transform = `translate(${pvTransX}px, ${pvTransY}px) scale(${pvScale})`;
            });
        });

        // ==========================================
        //  PPT í”„ë ˆì  í…Œì´ì…˜ ëª¨ë“œ ì—”ì§„ (ì™„ë²½ í†µí•©ë³¸)
        // ==========================================
        let pptSlides = [];
        let currentPptIndex = 0;
        let pptChart = null; // ì˜¤ì§ ì´ ë³€ìˆ˜ í•˜ë‚˜ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.

        function openPptSetup() {
            const modal = document.getElementById('ppt-setup-modal');
            const sel = document.getElementById('ppt-cohort-sel');
            modal.style.display = 'flex';
            sel.innerHTML = '<option value="">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</option>';

            getRatsWithCache().then(ratsData => {
                const cohorts = new Set();
                ratsData.forEach(d => { if (d.cohort) cohorts.add(d.cohort); });
                const sorted = Array.from(cohorts).sort((a, b) => Number(b) - Number(a));
                
                if (sorted.length === 0) {
                    sel.innerHTML = '<option value="">ë°ì´í„° ì—†ìŒ</option>';
                } else {
                    sel.innerHTML = '<option value="">-- ì½”í˜¸íŠ¸ ì„ íƒ --</option>' + 
                                    sorted.map(c => `<option value="${c}">Cohort ${c}</option>`).join('');
                }
            }).catch(e => {
                console.error(e);
                sel.innerHTML = '<option value="">ì˜¤ë¥˜ ë°œìƒ</option>';
            });
        }

        async function startPpt() {
            const cohort = document.getElementById('ppt-cohort-sel').value;
            if(!cohort) return alert("ì½”í˜¸íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
            
            const btn = document.querySelector('#ppt-setup-modal .btn-blue');
            btn.innerText = "ë°ì´í„° ë° ì‚¬ì§„ ë¯¸ë¦¬ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
            btn.disabled = true;

            try {
                const rSnap = await db.collection("rats").where("cohort", "==", cohort).get();
                if(rSnap.empty) { throw new Error("í•´ë‹¹ ì½”í˜¸íŠ¸ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); }
                
                let rats = [];
                rSnap.forEach(d => rats.push(d.data()));
                rats.sort((a, b) => a.ratId.localeCompare(b.ratId));

                rats.forEach(r => {
                    if(r.photos) {
                        r.photos.forEach(p => {
                            if(p.url) { const img = new Image(); img.src = p.url; }
                        });
                    }
                });

                const promises = rats.map(r => db.collection("measurements").where("ratId", "==", r.ratId).get());
                const measSnaps = await Promise.all(promises);
                
                const ratMeasData = {}; 
                measSnaps.forEach((snap, idx) => {
                    const r = rats[idx];
                    ratMeasData[r.ratId] = [];
                    snap.forEach(doc => {
                        const d = doc.data();
                        ratMeasData[r.ratId].push({
                            date: d.date,
                            label: d.timepoint || d.date,
                            sbp: d.sbp || null,
                            wt: d.weight || null
                        });
                    });
                    ratMeasData[r.ratId].sort((a,b) => new Date(a.date) - new Date(b.date));
                });

                pptSlides = [];
                pptSlides.push({ type: 'title', title: `Cohort ${cohort}<br>í”„ë ˆì  í…Œì´ì…˜` });
                pptSlides.push({ type: 'summary', rats: rats });

                const tpWeight = { 'D00':-1, 'D0':0, 'D2':2, 'W1':7, 'W2':14, 'W3':21, 'W4':28, 'W5':35, 'W6':42, 'W7':49, 'W8':56, 'W9':63, 'W10':70, 'W11':77, 'W12':84, 'none':9999 };
                
                rats.forEach(r => {
                    const codStr = r.cod || (r.codFull ? extractLegacyCod(r.codFull) : 'ë¯¸ê¸°ë¡');
                    const headerText = `${r.ratId} <span style="font-weight:400; font-size:1.2rem; color:#ffb74d; margin-left:15px;">| ì‚¬ë§ì›ì¸: ${codStr}</span>`;

                    let photos = r.photos || [];
                    
                    // --- ë‚ ì§œìˆœ ìµœìš°ì„  ì •ë ¬ ---
                    photos.sort((a,b) => {
                        if (a.photoDate && b.photoDate && a.photoDate !== b.photoDate) {
                            return new Date(a.photoDate) - new Date(b.photoDate);
                        }
                        const wA = (a.timepoint && tpWeight[a.timepoint] !== undefined) ? tpWeight[a.timepoint] : 9999;
                        const wB = (b.timepoint && tpWeight[b.timepoint] !== undefined) ? tpWeight[b.timepoint] : 9999;
                        if(wA !== wB) return wA - wB;
                        return new Date(a.timestamp||0) - new Date(b.timestamp||0);
                    });

                    for(let i=0; i<photos.length; i+=2) {
                        pptSlides.push({ type: 'photos', header: headerText, photos: photos.slice(i, i+2) });
                    }
                    pptSlides.push({ type: 'charts', header: headerText, ratId: r.ratId, data: ratMeasData[r.ratId] });
                });

                let totalN = rats.length;
                let surgFailN = 0, areO = 0, areX = 0, areMicro = 0, areMacro = 0, areUnk = 0;
                let sahN = 0, infarctN = 0, vasoN = 0, sacN = 0;
                let survivalN = 0;

                rats.forEach(r => {
                    if(r.status === 'ìƒì¡´') survivalN++;
                    
                    const cod = r.cod || (r.codFull ? extractLegacyCod(r.codFull) : '');
                    if (cod === 'Surgical Failure') surgFailN++;
                    if (cod === 'SAH') sahN++;
                    if (cod === 'Infarction') infarctN++;
                    if (cod === 'Vasospasm') vasoN++;
                    if (cod === 'Sacrifice') sacN++;

                    if (r.are) {
                        if (r.are.startsWith('O')) {
                            areO++;
                            if(r.are.includes('micro')) areMicro++;
                            else if(r.are.includes('macro')) areMacro++;
                            else areUnk++;
                        } else if (r.are === 'X') {
                            areX++;
                        }
                    }
                });

                pptSlides.push({ 
                    type: 'final-summary', 
                    stats: { totalN, surgFailN, areO, areX, areMicro, areMacro, areUnk, sahN, infarctN, vasoN, sacN, survivalN } 
                });

                pptSlides.push({ type: 'end' });

                document.getElementById('ppt-setup-modal').style.display = 'none';
                document.getElementById('ppt-main-modal').style.display = 'flex';
                
                window.addEventListener('keydown', handlePptKeys);
                
                currentPptIndex = 0;
                renderCurrentSlide();

            } catch(e) {
                console.error(e);
                alert("ì˜¤ë¥˜: " + e.message);
            } finally {
                btn.innerText = "ì‹œì‘í•˜ê¸°";
                btn.disabled = false;
            }
        }

        function renderCurrentSlide() {
            const container = document.getElementById('ppt-slide-container');
            const headerInfo = document.getElementById('ppt-header-info');
            const progress = document.getElementById('ppt-progress');
            
            const slide = pptSlides[currentPptIndex];
            progress.innerText = `${currentPptIndex + 1} / ${pptSlides.length}`;

            if(pptChart) { pptChart.destroy(); pptChart = null; }

            if(slide.type === 'title') {
                headerInfo.innerHTML = 'Presentation Start';
                container.innerHTML = `<div style="text-align:center;"><h1 style="font-size:4rem; color:var(--navy); margin-bottom:20px;">${slide.title}</h1><p style="font-size:1.5rem; color:#666;">ë°©í–¥í‚¤(â—€ â–¶)ë¥¼ ëˆŒëŸ¬ ì´ë™í•˜ì„¸ìš”</p></div>`;
            } 
            else if(slide.type === 'summary') {
                headerInfo.innerHTML = 'ğŸ“‹ ì „ì²´ ì½”í˜¸íŠ¸ ìš”ì•½ ë°ì´í„°';
                
                const codCounts = {};
                const areCounts = { 'O': 0, 'X': 0, 'micro': 0, 'macro': 0, 'ë¯¸í™•ì¸': 0 };
                
                slide.rats.forEach(r => {
                    if(r.status === 'ì‚¬ë§') {
                        const cod = r.cod || (r.codFull ? extractLegacyCod(r.codFull) : 'ë¯¸ê¸°ë¡');
                        codCounts[cod] = (codCounts[cod] || 0) + 1;
                        if(r.are) {
                            if(r.are.startsWith('O')) {
                                areCounts['O']++;
                                if(r.are.includes('micro')) areCounts['micro']++;
                                else if(r.are.includes('macro')) areCounts['macro']++;
                                else areCounts['ë¯¸í™•ì¸']++;
                            } else if(r.are === 'X') {
                                areCounts['X']++;
                            }
                        }
                    }
                });

                const codStatHtml = Object.entries(codCounts).map(([k,v]) => `<span style="background:#e3f2fd; color:var(--navy); padding:4px 10px; border-radius:6px; font-size:0.9rem; font-weight:bold;">${k}: ${v}ë§ˆë¦¬</span>`).join('');
                const areStatHtml = `
                    <span style="background:#ffebee; color:var(--red); padding:4px 10px; border-radius:6px; font-size:0.9rem; font-weight:bold;">ARE(O): ${areCounts['O']}ë§ˆë¦¬ (micro ${areCounts['micro']}, macro ${areCounts['macro']}, ë¯¸í™•ì¸ ${areCounts['ë¯¸í™•ì¸']})</span>
                    <span style="background:#e8f5e9; color:var(--green); padding:4px 10px; border-radius:6px; font-size:0.9rem; font-weight:bold;">ARE(X): ${areCounts['X']}ë§ˆë¦¬</span>
                `;

                const rowCount = slide.rats.length || 1;
                const fontSizeRem = Math.max(0.7, 1.2 - Math.max(0, rowCount - 5) * 0.035);
                const paddingPx = Math.max(2, 12 - Math.max(0, rowCount - 5) * 0.6);

                let tbody = '';
                slide.rats.forEach(r => {
                    const arrAge = r.arrivalAge ? Number(r.arrivalAge) : 6;
                    let surgAgeStr = '-', deathAgeStr = '-', smpAgeStr = '-';
                    
                    if(r.arrivalDate && r.surgeryDate) {
                        const surgAge = arrAge + ((new Date(r.surgeryDate) - new Date(r.arrivalDate))/(1000*60*60*24*7));
                        surgAgeStr = `${r.surgeryDate} <span style="color:#666; font-size:0.85em;">(${surgAge.toFixed(1)}ì£¼)</span>`;
                    }
                    if(r.arrivalDate && r.deathDate && r.status === 'ì‚¬ë§') {
                        const deathAge = arrAge + ((new Date(r.deathDate) - new Date(r.arrivalDate))/(1000*60*60*24*7));
                        deathAgeStr = `${r.deathDate} <span style="color:var(--red); font-size:0.85em;">(${deathAge.toFixed(1)}ì£¼)</span>`;
                    } else if(r.status === 'ìƒì¡´') { deathAgeStr = '<span style="color:green; font-weight:bold;">ìƒì¡´</span>'; }
                    
                    if(r.sampleDate && r.arrivalDate) {
                        const smpAge = arrAge + ((new Date(r.sampleDate) - new Date(r.arrivalDate))/(1000*60*60*24*7));
                        smpAgeStr = `${r.sampleDate} <span style="color:var(--navy); font-size:0.85em;">(${smpAge.toFixed(1)}ì£¼)</span>`;
                    }

                    const codStr = r.cod || (r.codFull ? extractLegacyCod(r.codFull) : '-');
                    const areStr = r.are || '-';

                    tbody += `
                        <tr style="border-bottom:1px solid #ddd; text-align:center;">
                            <td style="padding:${paddingPx}px; font-weight:bold; color:var(--navy);">${r.ratId}</td>
                            <td style="padding:${paddingPx}px;">${arrAge}ì£¼</td>
                            <td style="padding:${paddingPx}px;">${surgAgeStr}</td>
                            <td style="padding:${paddingPx}px;">${deathAgeStr}</td>
                            <td style="padding:${paddingPx}px; font-weight:bold; color:#d32f2f;">${codStr} <span style="font-size:0.8rem; color:#666; font-weight:normal;">(ARE: ${areStr})</span></td>
                            <td style="padding:${paddingPx}px;">${r.sampleType||'-'} ${smpAgeStr==='-'?'':smpAgeStr}</td>
                        </tr>
                    `;
                });

                container.innerHTML = `
                <div style="width:95%; max-width:1400px; height:85vh; display:flex; flex-direction:column; gap:15px;">
                    <div style="background:white; border-radius:12px; box-shadow:0 5px 15px rgba(0,0,0,0.1); padding:15px 20px; flex-shrink:0;">
                        <h4 style="margin:0 0 10px 0; color:var(--navy);">ğŸ“Š ì‚¬ë§ ì›ì¸ ë° ARE ë°œìƒ ìš”ì•½</h4>
                        <div style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:10px; align-items:center;">
                            <b style="color:#555; font-size:0.95rem; width:80px;">ì‚¬ë§ì›ì¸:</b> ${codStatHtml || '<span style="color:#888;">ì‚¬ë§ ê°œì²´ ì—†ìŒ</span>'}
                        </div>
                        <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
                            <b style="color:#555; font-size:0.95rem; width:80px;">ARE í†µê³„:</b> ${areCounts['O']+areCounts['X'] > 0 ? areStatHtml : '<span style="color:#888;">ê¸°ë¡ ì—†ìŒ</span>'}
                        </div>
                    </div>
                    <div style="flex:1; background:white; border-radius:12px; box-shadow:0 5px 15px rgba(0,0,0,0.1); padding:10px 20px; overflow:hidden; display:flex; flex-direction:column;">
                        <table style="width:100%; border-collapse:collapse; font-size:${fontSizeRem}rem; height:100%;">
                            <thead style="background:#f1f3f5; color:#333; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                                <tr>
                                    <th style="padding:10px; border-bottom:2px solid #ccc;">Rat ID</th>
                                    <th style="border-bottom:2px solid #ccc;">ë°˜ì…ì£¼ë ¹</th>
                                    <th style="border-bottom:2px solid #ccc;">ìˆ˜ìˆ ì¼ì (ì£¼ë ¹)</th>
                                    <th style="border-bottom:2px solid #ccc;">ì‚¬ë§ì¼ì (ì£¼ë ¹)</th>
                                    <th style="border-bottom:2px solid #ccc;">ì‚¬ë§ì›ì¸</th>
                                    <th style="border-bottom:2px solid #ccc;">ì–»ì€ ìƒ˜í”Œ (ë‚ ì§œ/ì£¼ë ¹)</th>
                                </tr>
                            </thead>
                            <tbody style="display:table-row-group;">${tbody}</tbody>
                        </table>
                    </div>
                </div>`;
            }
            else if(slide.type === 'photos') {
                headerInfo.innerHTML = slide.header;
                
                let photoHtml = '';
                slide.photos.forEach(p => {
                    // PPTì—ì„œë„ ë‚ ì§œì™€ ì‹œì  í‘œê¸°
                    let tpText = '';
                    if (p.photoDate) tpText += p.photoDate;
                    if (p.timepoint && p.timepoint !== 'none') tpText += (tpText ? ' ' : '') + `[${p.timepoint}]`;
                    if (!tpText) tpText = 'ì¼ì/ì‹œì  ë¯¸ì§€ì •';

                    photoHtml += `
                    <div style="flex:1; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px; box-sizing:border-box;">
                        <div style="flex:1; width:100%; display:flex; align-items:center; justify-content:center; background:#000; border-radius:12px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,0.3);">
                            <img src="${p.url}" style="max-width:100%; max-height:100%; object-fit:contain; cursor:pointer;" onclick="openPhotoViewer('${p.url}', '${p.memo||''}')">
                        </div>
                        <div style="margin-top:15px; text-align:center; font-size:1.3rem;">
                            <span style="background:var(--navy); color:white; padding:4px 12px; border-radius:6px; font-weight:bold; margin-right:10px;">${tpText}</span>
                            <span style="color:#333;">${p.memo || 'ë©”ëª¨ ì—†ìŒ'}</span>
                        </div>
                    </div>`;
                });

                container.innerHTML = `<div style="display:flex; width:100%; height:85vh; gap:30px; justify-content:center;">${photoHtml}</div>`;
            }
            else if(slide.type === 'charts') {
                headerInfo.innerHTML = slide.header;
                
                container.innerHTML = `
                <div style="width:90%; height:85vh; display:flex; flex-direction:column; background:white; border-radius:12px; padding:20px; box-shadow:0 5px 20px rgba(0,0,0,0.1);">
                    <div style="display:flex; justify-content:center; align-items:center; gap:15px; margin-bottom:10px; background:#f8f9fa; padding:8px; border-radius:8px;">
                        <span style="font-weight:bold; color:var(--red);">â–  í˜ˆì•• (SBP)</span>
                        <span style="font-weight:bold; color:var(--green);">â–  ì²´ì¤‘ (Weight)</span>
                    </div>
                    <div style="position:relative; flex:1; width:100%;"><canvas id="ppt-canvas-bp"></canvas></div>
                </div>`;

                setTimeout(() => {
                    const ctx = document.getElementById('ppt-canvas-bp');
                    const dArr = slide.data; 

                    const showSbp = dArr.some(d => d.sbp !== null);
                    const showWt = dArr.some(d => d.wt !== null);

                    const datasets = [];
                    if (showSbp) { datasets.push({ label: 'SBP', data: dArr.map(d => d.sbp), borderColor: '#d32f2f', yAxisID: 'y', spanGaps: true }); }
                    if (showWt) { datasets.push({ label: 'WT', data: dArr.map(d => d.wt), borderColor: '#00c853', yAxisID: 'y1', spanGaps: true }); }

                    pptChart = new Chart(ctx, {
                        type: 'line',
                        data: { 
                            labels: dArr.map(d => (d.label && d.label !== d.date) ? `${d.date} (${d.label})` : d.date), 
                            datasets: datasets 
                        },
                        options: { 
                            maintainAspectRatio: false, 
                            animation: false, 
                            interaction: { mode: 'index', intersect: false }, 
                            scales: { 
                                y: { position: 'left', display: showSbp }, 
                                y1: { position: 'right', display: showWt, grid: { drawOnChartArea: false } } 
                            } 
                        }
                    });
                }, 50);
            }
            else if(slide.type === 'final-summary') {
                headerInfo.innerHTML = 'ğŸ¯ Final Conclusion';
                
                const { totalN, surgFailN, areO, areX, areMicro, areMacro, areUnk, sahN, infarctN, vasoN, sacN, survivalN } = slide.stats;
                const validN = totalN - surgFailN;
                const rateValid = validN > 0 ? ((areO / validN) * 100).toFixed(1) : 0;

                container.innerHTML = `
                <div style="width:90%; display:flex; flex-direction:column; justify-content:center; gap:40px;">
                    <h2 style="color:var(--navy); text-align:center; font-size:3rem; margin:0; text-shadow:2px 2px 5px rgba(0,0,0,0.1);">ğŸ“Š Cohort Final Summary</h2>
                    
                    <div style="display:flex; justify-content:center; gap:30px; flex-wrap:wrap;">
                        <div style="background:#fff; border-radius:15px; padding:30px; box-shadow:0 10px 30px rgba(0,0,0,0.1); flex:1; min-width:250px; text-align:center; border-top:8px solid var(--navy);">
                            <h3 style="color:#555; margin-top:0; font-size:1.5rem;">ì´ ê°œì²´ ìˆ˜</h3>
                            <div style="font-size:4rem; font-weight:900; color:var(--navy); line-height:1;">${totalN}<span style="font-size:1.5rem; font-weight:bold;"> ë§ˆë¦¬</span></div>
                            <div style="font-size:1.1rem; color:#888; margin-top:15px; font-weight:bold;">(Surgical Failure ì œì™¸ ìœ íš¨ N = ${validN})</div>
                        </div>

                        <div style="background:#fff; border-radius:15px; padding:30px; box-shadow:0 15px 40px rgba(211, 47, 47, 0.2); flex:1.2; min-width:300px; text-align:center; border:4px solid var(--red); transform:scale(1.05);">
                            <h3 style="color:var(--red); margin-top:0; font-size:1.6rem;">ğŸ¯ ARE ë°œìƒë¥  (ìœ íš¨ N ê¸°ì¤€)</h3>
                            <div style="font-size:5rem; font-weight:900; color:var(--red); line-height:1; margin:10px 0;">${rateValid}<span style="font-size:2.5rem; font-weight:bold;"> %</span></div>
                            <div style="font-size:1.4rem; color:#333; font-weight:bold;">${areO} / ${validN} ë§ˆë¦¬</div>
                            <div style="font-size:1rem; color:#666; margin-top:10px; background:#ffebee; padding:5px 10px; border-radius:8px; display:inline-block;">
                                <b>micro:</b> ${areMicro} &nbsp;|&nbsp; <b>macro:</b> ${areMacro} &nbsp;|&nbsp; <b>ë¯¸í™•ì¸:</b> ${areUnk}
                            </div>
                        </div>

                        <div style="background:#fff; border-radius:15px; padding:30px; box-shadow:0 10px 30px rgba(0,0,0,0.1); flex:1; min-width:250px; text-align:center; border-top:8px solid #00c853;">
                            <h3 style="color:#555; margin-top:0; font-size:1.5rem;">ì£¼ìš” ê²°ê³¼ ë¶„í¬</h3>
                            <div style="display:flex; flex-direction:column; gap:10px; text-align:left; display:inline-flex; width:100%; max-width:200px; font-size:1.2rem;">
                                <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding-bottom:5px;"><b>SAH:</b> <span><b style="color:var(--navy);">${sahN}</b> ë§ˆë¦¬</span></div>
                                <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding-bottom:5px;"><b>Infarction:</b> <span><b style="color:var(--navy);">${infarctN}</b> ë§ˆë¦¬</span></div>
                                <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding-bottom:5px;"><b>Vasospasm:</b> <span><b style="color:var(--navy);">${vasoN}</b> ë§ˆë¦¬</span></div>
                                <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding-bottom:5px;"><b>Sacrifice:</b> <span><b style="color:var(--navy);">${sacN}</b> ë§ˆë¦¬</span></div>
                                <div style="display:flex; justify-content:space-between; padding-bottom:5px;"><b>ìƒì¡´:</b> <span><b style="color:var(--green);">${survivalN}</b> ë§ˆë¦¬</span></div>
                            </div>
                        </div>
                    </div>
                </div>`;
            }
            else if(slide.type === 'end') {
                headerInfo.innerHTML = 'Presentation End';
                container.innerHTML = `
                <div style="text-align:center;">
                    <h1 style="font-size:4rem; color:var(--navy); margin-bottom:20px;">í”„ë ˆì  í…Œì´ì…˜ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</h1>
                    <button class="btn btn-red" onclick="closePpt()" style="font-size:1.5rem; padding:15px 40px; border-radius:30px;">ë‚˜ê°€ê¸° (ESC)</button>
                </div>`;
            }
        }

        function nextPptSlide() {
            if(currentPptIndex < pptSlides.length - 1) {
                currentPptIndex++;
                renderCurrentSlide();
            }
        }

        function prevPptSlide() {
            if(currentPptIndex > 0) {
                currentPptIndex--;
                renderCurrentSlide();
            }
        }

        function handlePptKeys(e) {
            const viewer = document.getElementById('photo-viewer-modal');
            if(viewer && viewer.style.display === 'flex') {
                if(e.key === 'Escape') closePhotoViewer();
                return; 
            }

            if(e.key === 'ArrowRight' || e.key === ' ') { nextPptSlide(); }
            else if(e.key === 'ArrowLeft') { prevPptSlide(); }
            else if(e.key === 'Escape') { closePpt(); }
        }

        function closePpt() {
            document.getElementById('ppt-main-modal').style.display = 'none';
            window.removeEventListener('keydown', handlePptKeys);
            
            // ë‹«ì„ ë•Œë„ í™•ì‹¤í•˜ê²Œ íŒŒê´´
            if(pptChart) { 
                pptChart.destroy(); 
                pptChart = null; 
            }
            pptSlides = [];
        }

        // ============================================================
        //  ëŒ€ëŸ‰ ë°ì´í„° CSV ì¼ê´„ ì—…ë¡œë“œ ë¡œì§
        // ============================================================
        let csvUploadData = [];

        function parseRatUploadCSV(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                const text = event.target.result;
                // ë§¥/ìœˆë„ìš° ì¤„ë°”ê¿ˆ í˜¸í™˜ ì²˜ë¦¬
                const rows = text.trim().split(/\r?\n/);
                if (rows.length < 2) return alert("ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");

                const headers = rows[0].split(',').map(h => h.trim());
                const idIdx = headers.indexOf('Rat_ID');
                if (idIdx === -1) return alert("ì—‘ì…€ ì²« ì¤„ì— 'Rat_ID' ì—´ì´ ë°˜ë“œì‹œ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.");

                csvUploadData = [];
                let previewHtml = '<table style="width:100%; border-collapse:collapse; white-space:nowrap;"><thead><tr style="background:#f1f3f5;">';
                headers.forEach(h => previewHtml += `<th style="border:1px solid #ddd; padding:5px;">${h}</th>`);
                previewHtml += '</tr></thead><tbody>';

                for (let i = 1; i < rows.length; i++) {
                    const cols = rows[i].split(',');
                    if (cols.length < headers.length) continue; // ë¹ˆ ì¤„ ë¬´ì‹œ

                    let rowData = {};
                    previewHtml += '<tr>';
                    headers.forEach((h, idx) => {
                        const val = cols[idx] ? cols[idx].trim() : '';
                        rowData[h] = val;
                        previewHtml += `<td style="border:1px solid #eee; padding:5px;">${val}</td>`;
                    });
                    previewHtml += '</tr>';
                    csvUploadData.push(rowData);
                }
                previewHtml += '</tbody></table>';
                
                document.getElementById('csv-preview-area').innerHTML = 
                    `<p style="color:var(--navy); font-weight:bold; font-size:1rem; margin-bottom:10px;">
                        âœ… ì´ ${csvUploadData.length}ë§ˆë¦¬ì˜ ë°ì´í„°ê°€ ì¸ì‹ë˜ì—ˆìŠµë‹ˆë‹¤. í‘œë¥¼ í™•ì¸í•˜ì‹œê³  ì´ìƒì´ ì—†ìœ¼ë©´ ì•„ë˜ ì €ì¥ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.
                    </p>` + previewHtml;
                
                document.getElementById('btn-save-csv').style.display = 'block';
            };
            // UTF-8ë¡œ ì½ì–´ì„œ í•œê¸€ ê¹¨ì§ ë°©ì§€
            reader.readAsText(file, "UTF-8"); 
        }

        async function saveCsvToDB() {
            if (!csvUploadData.length) return;
            if (!confirm(`ì´ ${csvUploadData.length}ë§ˆë¦¬ì˜ ë°ì´í„°ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì—…ë°ì´íŠ¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê¸°ì¡´ ë°ì´í„°ì— ë®ì–´ì”Œì›Œì§€ë©° ë¹ˆ ì¹¸ì€ ì•ˆì „í•˜ê²Œ ë¬´ì‹œë©ë‹ˆë‹¤.)`)) return;

            const btn = document.getElementById('btn-save-csv');
            btn.innerText = "ë°ì´í„° ì €ì¥ ì¤‘... í™”ë©´ì„ ë„ì§€ ë§ˆì„¸ìš”!";
            btn.disabled = true;

            let successCount = 0;
            let failCount = 0;

            try {
                // ì§ë ¬í™” ì²˜ë¦¬ (ì•ˆì •ì„±ì„ ìœ„í•´ í•œ ë§ˆë¦¬ì”© ìˆœì°¨ ì—…ë°ì´íŠ¸)
                for (const row of csvUploadData) {
                    const ratId = row['Rat_ID'];
                    if (!ratId) continue;

                    const rSnap = await db.collection("rats").where("ratId", "==", ratId).get();
                    if (rSnap.empty) {
                        console.warn(`[${ratId}] í•´ë‹¹ ì¥ë¥¼ DBì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                        failCount++;
                        continue;
                    }
                    
                    const docRef = rSnap.docs[0].ref;
                    const existingData = rSnap.docs[0].data();
                    let updates = {};

                    // 1. ë‹¨ì¼ ë°ì´í„° ë§¤í•‘
                    if (row['Death_Date']) { updates.deathDate = row['Death_Date']; updates.status = 'ì‚¬ë§'; }
                    if (row['OVX_Date']) updates.ovxDate = row['OVX_Date'];
                    if (row['Sample_Type']) updates.sampleType = row['Sample_Type'];
                    if (row['Sample_Date']) updates.sampleDate = row['Sample_Date'];
                    if (row['Sample_Memo']) updates.sampleMemo = row['Sample_Memo'];

                    // 2. ì‚¬ë§ ì›ì¸(COD) ë° ARE ë…¼ë¦¬ ë§¤í•‘
                    const cod = row['COD'];
                    const areMain = row['ARE_Main'];
                    const areSub = row['ARE_Sub'];
                    
                    let finalCod = cod || existingData.cod;
                    let finalAreStr = existingData.are; 

                    if (areMain === 'O') finalAreStr = `O (${areSub || 'ë¯¸í™•ì¸'})`;
                    else if (areMain === 'X') finalAreStr = 'X';

                    if (cod || areMain) {
                        if (finalCod) updates.cod = finalCod;
                        if (finalAreStr) updates.are = finalAreStr;
                        // í˜¸í™˜ì„±ì„ ìœ„í•œ codFull í†µí•© ì €ì¥
                        if (finalCod && finalAreStr) updates.codFull = `${finalCod} / ARE: ${finalAreStr}`;
                        else if (finalCod) updates.codFull = finalCod;
                    }

                    // 3. MR ì´¬ì˜ ì‹œì  ë§¤í•‘ (ê¸°ì¡´ ë°°ì—´ê³¼ ë³‘í•©)
                    let mrArr = existingData.mrDates || [];
                    let hasNewMr = false;

                    Object.keys(row).forEach(key => {
                        if (key.startsWith('MR_') && row[key]) {
                            hasNewMr = true;
                            const timepoint = key.replace('MR_', '');
                            const newDate = row[key];
                            
                            // ê¸°ì¡´ ë°°ì—´ì— í•´ë‹¹ ì‹œì ì´ ì´ë¯¸ ìˆë‹¤ë©´ ë‚ ì§œë§Œ ë®ì–´ì“°ê³ , ì—†ë‹¤ë©´ ìƒˆë¡œ ë°€ì–´ë„£ìŒ
                            const existingIdx = mrArr.findIndex(m => m.timepoint === timepoint);
                            if (existingIdx > -1) {
                                mrArr[existingIdx].date = newDate;
                            } else {
                                mrArr.push({ timepoint: timepoint, date: newDate });
                            }
                        }
                    });

                    if (hasNewMr) {
                        // ì‹œê°„ ìˆœì„œëŒ€ë¡œ ì˜ˆì˜ê²Œ ì •ë ¬ í›„ ì—…ë°ì´íŠ¸
                        mrArr.sort((a,b) => new Date(a.date) - new Date(b.date));
                        updates.mrDates = mrArr;
                    }

                    // ì—…ë°ì´íŠ¸ í•  ë‚´ìš©ì´ í•˜ë‚˜ë¼ë„ ìˆë‹¤ë©´ DB ì „ì†¡
                    if (Object.keys(updates).length > 0) {
                        await docRef.update(updates);
                        successCount++;
                    }
                }

                // ì™„ë£Œ í›„ ìºì‹œ ë¹„ìš°ê³  ì•Œë¦¼
                clearRatsCache();
                alert(`âœ¨ ëŒ€ëŸ‰ ì—…ë°ì´íŠ¸ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\n- ì„±ê³µ: ${successCount}ê±´\n- ì‹¤íŒ¨(ì—†ëŠ” ID ë“±): ${failCount}ê±´`);
                
                // UI ì´ˆê¸°í™”
                document.getElementById('csv-preview-area').innerHTML = '';
                btn.style.display = 'none';
                document.getElementById('csv-upload-input').value = '';

            } catch (e) {
                console.error(e);
                alert("ì €ì¥ ì¤‘ ì‹œìŠ¤í…œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
            } finally {
                btn.innerText = "ğŸš€ ê²€í†  ì™„ë£Œ: ë°ì´í„°ë² ì´ìŠ¤ì— ë®ì–´ì“°ê¸°";
                btn.disabled = false;
            }
        }

        // ============================================================
        //  AI ë…¼ë¬¸ ì‘ì„±ìš© í’€-ì»¨í…ìŠ¤íŠ¸ êµ¬ì¡°í™” ë°ì´í„° ì¶”ì¶œ ë¡œì§
        // ============================================================
        async function exportForAI() {
            const btn = document.getElementById('btn-extract-ai');
            const statusText = document.getElementById('ai-extract-status');
            
            if(!confirm("ëª¨ë“  ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ AIê°€ ì½ê¸° ì¢‹ì€ í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ì¶”ì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në°ì´í„° ì–‘ì— ë”°ë¼ ìˆ˜ ì´ˆê°€ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")) return;

            btn.disabled = true;
            btn.style.background = '#ccc';
            statusText.innerHTML = '<div class="loader"></div> ë°ì´í„°ë¥¼ êµ¬ì¡°í™”í•˜ëŠ” ì¤‘...';

            try {
                // 1. ëª¨ë“  ê´€ë ¨ ë°ì´í„° í•œ ë²ˆì— ê°€ì ¸ì˜¤ê¸°
                const [rSnap, mSnap, cSnap] = await Promise.all([
                    db.collection("rats").get(),
                    db.collection("measurements").get(),
                    db.collection("cohortNotes").get()
                ]);

                // 2. ì½”í˜¸íŠ¸ ë©”ëª¨ ì •ë¦¬ (ì¡°ê±´)
                const cohortInfo = {};
                cSnap.forEach(doc => { cohortInfo[doc.id] = doc.data().memo || "ì¡°ê±´ ë¯¸ê¸°ì¬"; });

                // 3. í˜ˆì••/ì²´ì¤‘ ë°ì´í„° ì •ë¦¬ (Rat ID ê¸°ì¤€ìœ¼ë¡œ ë¬¶ê¸°)
                const measData = {};
                mSnap.forEach(doc => {
                    const d = doc.data();
                    if (!measData[d.ratId]) measData[d.ratId] = [];
                    measData[d.ratId].push(d);
                });

                // 4. êµ¬ì¡°í™”ëœ í…ìŠ¤íŠ¸ ìƒì„± ì‹œì‘
                let aiText = `[SYSTEM PROMPT & CONTEXT]\n`;
                aiText += `ë‹¹ì‹ ì€ ìµœê³  ìˆ˜ì¤€ì˜ ì‹ ê²½ì™¸ê³¼ ë° ê¸°ì´ˆì˜í•™ ì—°êµ¬ì›ì…ë‹ˆë‹¤. ì•„ë˜ ì œê³µë˜ëŠ” ë°ì´í„°ëŠ” ë‡Œë™ë§¥ë¥˜(Cerebral Aneurysm, ARE) ë™ë¬¼ ëª¨ë¸(Rat)ì˜ Raw Dataì…ë‹ˆë‹¤.\n`;
                aiText += `ê° ì½”í˜¸íŠ¸ë³„ ì‹¤í—˜ ì¡°ê±´, ê°œì²´ë³„ ìƒì¡´ ì—¬ë¶€, ì‚¬ë§ ì›ì¸(COD), ë™ë§¥ë¥˜ ìœ ë¬´(ARE), íƒ€ì„ë¼ì¸(ìˆ˜ìˆ ì¼, ì‚¬ë§ì¼, MR ì´¬ì˜ì¼, ìƒ˜í”Œ ì±„ì·¨ì¼), ìƒë¦¬ì  ìˆ˜ì¹˜(í˜ˆì••, ì²´ì¤‘)ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\n`;
                aiText += `ë°ì´í„°ë¥¼ ë©´ë°€íˆ ë¶„ì„í•˜ì—¬, ì‹œì ë³„(ì˜ˆ: MR ì´¬ì˜ ì‹œì ê³¼ ìƒ˜í”Œ íšë“ ì‹œì ì˜ ë§¤ì¹­) ë¹„êµ, ì‹¤í—˜êµ° ê°„ì˜ ë³‘íƒœìƒë¦¬í•™ì  ì°¨ì´ ë“±ì„ íŒŒì•…í•˜ê³  SCIê¸‰ ë…¼ë¬¸ ì£¼ì œ ë„ì¶œ ë° ì´ˆì•ˆ ì‘ì„±ì— í™œìš©í•˜ì‹­ì‹œì˜¤.\n\n`;
                aiText += `=================================================\n\n`;
                
                aiText += `[1. COHORT EXPERIMENTAL CONDITIONS (ì½”í˜¸íŠ¸ë³„ ì‹¤í—˜ ì¡°ê±´)]\n`;
                
                // ë«ë“œë¥¼ ì½”í˜¸íŠ¸ë³„ë¡œ ë¶„ë¥˜
                const ratsByCohort = {};
                rSnap.forEach(doc => {
                    const r = doc.data();
                    if (!ratsByCohort[r.cohort]) ratsByCohort[r.cohort] = [];
                    ratsByCohort[r.cohort].push(r);
                });

                // ì½”í˜¸íŠ¸ ë²ˆí˜¸ìˆœ ì •ë ¬
                const sortedCohorts = Object.keys(ratsByCohort).sort((a,b) => Number(a) - Number(b));

                sortedCohorts.forEach(c => {
                    aiText += `- Cohort ${c}: ${cohortInfo[c] || 'ë©”ëª¨ ì—†ìŒ'}\n`;
                });
                aiText += `\n=================================================\n\n`;

                aiText += `[2. RAT TIMELINES & OUTCOMES (ê°œì²´ë³„ íƒ€ì„ë¼ì¸ ë° ê²°ê³¼)]\n`;

                sortedCohorts.forEach(c => {
                    aiText += `\n### COHORT ${c} ###\n`;
                    const rats = ratsByCohort[c].sort((a, b) => a.ratId.localeCompare(b.ratId));

                    rats.forEach(r => {
                        aiText += `\nâ–¶ Rat ID: ${r.ratId}\n`;
                        
                        // ì‚¬ë§ ë° ARE ì •ë³´
                        const cod = r.cod || (r.codFull ? extractLegacyCod(r.codFull) : '-');
                        aiText += `  - Status: ${r.status} ${r.deathDate ? `(Death Date: ${r.deathDate})` : ''}\n`;
                        aiText += `  - Cause of Death (COD): ${cod}\n`;
                        aiText += `  - Aneurysm (ARE): ${r.are || '-'}\n`;

                        // íƒ€ì„ë¼ì¸ ê³„ì‚° (POD: ìˆ˜ìˆ  í›„ ê²½ê³¼ì¼)
                        aiText += `  - Timeline Events:\n`;
                        aiText += `    * Arrival: ${r.arrivalDate || '-'} (Age: ${r.arrivalAge || 6} weeks)\n`;
                        if (r.ovxDate) aiText += `    * OVX Surgery: ${r.ovxDate}\n`;
                        aiText += `    * Ligation Surgery (Day 0): ${r.surgeryDate || '-'}\n`;
                        
                        // MR ë°ì´í„°
                        if (r.mrDates && r.mrDates.length > 0) {
                            const mrStr = r.mrDates.sort((a,b) => new Date(a.date) - new Date(b.date))
                                          .map(m => `${m.timepoint}(${m.date})`).join(', ');
                            aiText += `    * MR Scans: ${mrStr}\n`;
                        } else {
                            aiText += `    * MR Scans: None\n`;
                        }

                        // ìƒ˜í”Œ ë°ì´í„°
                        if (r.sampleType && r.sampleType !== 'Fail') {
                            aiText += `    * Sample Acquired: ${r.sampleType} on ${r.sampleDate || '-'} (Memo: ${r.sampleMemo || 'None'})\n`;
                        } else if (r.sampleType === 'Fail') {
                            aiText += `    * Sample Acquired: Failed\n`;
                        }

                        // í˜ˆì••/ì²´ì¤‘ ë°ì´í„° (ì‹œì ë³„ ì •ë ¬)
                        const ratMeas = measData[r.ratId] || [];
                        if (ratMeas.length > 0) {
                            ratMeas.sort((a, b) => new Date(a.date) - new Date(b.date));
                            let measStrArr = ratMeas.map(m => {
                                const tp = m.timepoint || m.date;
                                let str = `[${tp}]`;
                                if (m.sbp) str += ` SBP:${m.sbp}`;
                                if (m.weight) str += ` WT:${m.weight}g`;
                                return str;
                            });
                            aiText += `  - Measurements (BP/WT): ${measStrArr.join(' | ')}\n`;
                        } else {
                            aiText += `  - Measurements: No data\n`;
                        }
                    });
                });

                // 5. ë‹¤ìš´ë¡œë“œ ì²˜ë¦¬
                const today = new Date();
                const dateStr = today.getFullYear() + String(today.getMonth()+1).padStart(2,'0') + String(today.getDate()).padStart(2,'0');
                const fileName = `AI_Research_Data_Cerebral_Aneurysm_${dateStr}.txt`;

                const blob = new Blob([aiText], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                statusText.innerHTML = `<span style="color:green;">âœ… ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ì¶œë˜ì–´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤! (íŒŒì¼ëª…: ${fileName})</span><br><span style="font-size:0.9rem; font-weight:normal; color:#555;">ì´ í…ìŠ¤íŠ¸ íŒŒì¼ì„ AI ì±—ë´‡ì— ì—…ë¡œë“œí•˜ê³  ì§€ì‹œë¥¼ ë‚´ë ¤ë³´ì„¸ìš”.</span>`;

            } catch (e) {
                console.error(e);
                statusText.innerHTML = `<span style="color:red;">âŒ ì˜¤ë¥˜ ë°œìƒ: ${e.message}</span>`;
            } finally {
                btn.disabled = false;
                btn.style.background = '#8e24aa';
            }
        }
    </script>

    <div id="bpBatchModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:white; padding:20px; border-radius:8px; width:90%; max-width:1200px; max-height:90vh; overflow-y:auto; box-shadow:0 4px 10px rgba(0,0,0,0.3);">
            <h3 style="margin-top:0;">ğŸ“Š ì„ íƒí•œ BP ë°ì´í„° DB ì €ì¥</h3>
            <p style="font-size:14px; color:#666;">ì„ íƒí•œ ë°ì´í„°ê°€ ì–´ë–¤ ê°œì²´ì™€ ì‹œì ì¸ì§€ í™•ì¸ í›„ ì €ì¥í•˜ì„¸ìš”.</p>
            
            <table style="width:100%; border-collapse:collapse; margin-bottom:20px;">
                <thead>
                    <tr style="background:#f5f5f5; border-bottom:2px solid #ddd; text-align:left;">
                        <th style="padding:8px;">Rat ID (ìë™ê°ì§€)</th>
                        <th style="padding:8px;">ì¸¡ì •ê°’ (SBP/Mean)</th>
                        <th style="padding:8px;">ì¸¡ì •ì¼ (Date)</th>
                        <th style="padding:8px; color:#d32f2f;">ì €ì¥í•  Rat ID (í•„ìˆ˜)</th>
                        <th style="padding:8px; color:#1a237e;">ì €ì¥í•  ì‹œì  (í•„ìˆ˜)</th>
                    </tr>
                </thead>
                <tbody id="bpBatchList">
                    </tbody>
            </table>

            <div style="text-align:right; margin-top:20px;">
                <button onclick="closeBatchModal()" style="padding:10px 20px; background:#9e9e9e; color:white; border:none; border-radius:4px; cursor:pointer;">ì·¨ì†Œ</button>
                <button onclick="saveBatchToDB()" style="padding:10px 20px; background:#1a237e; color:white; border:none; border-radius:4px; cursor:pointer; margin-left:10px;">ğŸ’¾ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥</button>
            </div>
        </div>
    </div>
    
    <div id="simple-cod-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; justify-content:center; align-items:center;">
        <div style="background:white; padding:20px; border-radius:12px; width:90%; max-width:400px; box-shadow:0 4px 20px rgba(0,0,0,0.2);">
            <h3 style="margin-top:0; color:var(--navy);">ì‚¬ë§ ì›ì¸ & ARE ê¸°ë¡</h3>
            <div class="input-group">
                <label>ì‚¬ë§ ì›ì¸ (COD)</label>
                <select id="modal-cod" style="width:100%; padding:8px; border-radius:4px; border:1px solid #ddd;">
                    <option value="">-</option>
                    <option value="SAH">SAH</option>
                    <option value="Infarction">Infarction</option>
                    <option value="Vasospasm">Vasospasm</option>
                    <option value="Sacrifice">Sacrifice</option>
                    <option value="Surgical Failure">Surgical Failure</option>
                    <option value="Unknown">Unknown</option>
                </select>
            </div>
            <div class="input-group" style="margin-top:10px;">
                <label>ARE ìœ ë¬´</label>
                <div style="display:flex; gap:10px;">
                    <select id="modal-are-main" style="flex:1; padding:8px; border-radius:4px; border:1px solid #ddd;" onchange="document.getElementById('modal-are-sub').style.display = this.value === 'O' ? 'block' : 'none';">
                        <option value="">-</option>
                        <option value="O">O</option>
                        <option value="X">X</option>
                    </select>
                    <select id="modal-are-sub" style="flex:1; padding:8px; border-radius:4px; border:1px solid #ddd; display:none;">
                        <option value="ë¯¸í™•ì¸">ë¯¸í™•ì¸</option>
                        <option value="micro">micro</option>
                        <option value="macro">macro</option>
                    </select>
                </div>
            </div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-blue" style="flex:1;" onclick="saveSimpleCod()">ì €ì¥</button>
                <button class="btn" style="flex:1; background:#eee; color:#333;" onclick="document.getElementById('simple-cod-modal').style.display='none'">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <div id="photo-viewer-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:12000; align-items:center; justify-content:center; overflow:hidden;">
        <button onclick="closePhotoViewer()" style="position:absolute; top:20px; right:20px; background:var(--red); color:white; border:none; padding:10px 15px; border-radius:8px; cursor:pointer; font-weight:bold; z-index:12001; font-size:1rem;">ë‹«ê¸° âœ–</button>
        <div id="photo-viewer-memo" style="position:absolute; bottom:30px; left:50%; transform:translateX(-50%); background:rgba(255,255,255,0.9); padding:10px 20px; border-radius:20px; z-index:12001; pointer-events:none; font-weight:bold; font-size:1.1rem; color:#333; max-width:80%; text-align:center;"></div>
        
        <div id="photo-viewer-rmark" style="display:none; position:absolute; font-size:3rem; font-weight:900; color:#ffeb3b; text-shadow:2px 2px 5px rgba(0,0,0,0.8); z-index:12001; pointer-events:none;">R</div>
        
        <img id="photo-viewer-img" draggable="false" style="max-width:90%; max-height:90%; transition: transform 0.1s; cursor:grab; user-select:none; -webkit-user-drag:none;" src="">
    </div>

    <div id="ppt-setup-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:10000; align-items:center; justify-content:center;">
        <div style="background:white; padding:20px; border-radius:12px; width:90%; max-width:400px; box-shadow:0 4px 20px rgba(0,0,0,0.2);">
            <h3 style="margin-top:0; color:var(--navy);">ğŸ“½ï¸ í”„ë ˆì  í…Œì´ì…˜ ëª¨ë“œ</h3>
            <p style="font-size:0.9rem; color:#666;">ë°œí‘œë¥¼ ì§„í–‰í•  ì½”í˜¸íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
            
            <select id="ppt-cohort-sel" style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #ccc; border-radius:6px; font-size:1rem;">
                <option value="">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</option>
            </select>

            <div style="display:flex; gap:10px;">
                <button class="btn btn-blue" style="flex:1;" onclick="startPpt()">ì‹œì‘í•˜ê¸°</button>
                <button class="btn" style="flex:1; background:#eee; color:#333;" onclick="document.getElementById('ppt-setup-modal').style.display='none'">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <div id="ppt-main-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#fff; z-index:11000; flex-direction:column;">
        
        <div style="display:flex; justify-content:space-between; align-items:center; padding:15px 30px; background:var(--navy); color:white; box-shadow:0 2px 10px rgba(0,0,0,0.2); z-index:11001;">
            <div id="ppt-header-info" style="font-size:1.5rem; font-weight:bold;">Cohort Presentation</div>
            <div style="display:flex; align-items:center; gap:20px;">
                <span id="ppt-progress" style="font-size:1.2rem; font-weight:bold; background:rgba(255,255,255,0.2); padding:5px 15px; border-radius:20px;">1 / 10</span>
                <button onclick="closePpt()" style="background:var(--red); color:white; border:none; padding:8px 15px; border-radius:6px; cursor:pointer; font-weight:bold; font-size:1rem;">âœ– ì¢…ë£Œ (ESC)</button>
            </div>
        </div>

        <div id="ppt-slide-container" style="flex:1; position:relative; overflow:hidden; display:flex; align-items:center; justify-content:center; padding:20px; background:#f4f6f9;">
            </div>

        <button onclick="prevPptSlide()" style="position:absolute; top:50%; left:20px; transform:translateY(-50%); background:rgba(0,0,0,0.3); color:white; border:none; width:60px; height:60px; border-radius:50%; font-size:2rem; cursor:pointer; z-index:11001; transition:0.3s;" onmouseover="this.style.background='rgba(0,0,0,0.7)'" onmouseout="this.style.background='rgba(0,0,0,0.3)'">â—€</button>
        <button onclick="nextPptSlide()" style="position:absolute; top:50%; right:20px; transform:translateY(-50%); background:rgba(0,0,0,0.3); color:white; border:none; width:60px; height:60px; border-radius:50%; font-size:2rem; cursor:pointer; z-index:11001; transition:0.3s;" onmouseover="this.style.background='rgba(0,0,0,0.7)'" onmouseout="this.style.background='rgba(0,0,0,0.3)'">â–¶</button>
    </div>
</body>
</html>

