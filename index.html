<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Rat Lab Manager Pro</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { 
            --navy: #1a237e; --green: #00c853; --red: #d32f2f; 
            --orange: #f57c00; --blue: #2c7be5; --gray: #9e9e9e;
            --bg: #f5f7fa; --white: #ffffff; 
        }
        body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg); color: #333; -webkit-tap-highlight-color: transparent; }
        
        #login-screen { display: flex; justify-content: center; align-items: center; height: 100vh; background: var(--navy); position: fixed; width: 100%; top: 0; z-index: 9999; }
        .login-box { background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 320px; text-align: center; }
        
        #main-app { display: none; }
        header { background: white; height: 60px; display: flex; align-items: center; padding: 0 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: fixed; width: 100%; top: 0; z-index: 100; box-sizing: border-box; }
        
        .menu-btn-box {
            display: flex; align-items: center; cursor: pointer; 
            background: #e8eaf6; padding: 8px 12px; border-radius: 8px; 
            margin-right: 10px; transition: 0.2s;
        }
        .menu-btn-box:active { background: #c5cae9; }
        .menu-btn-text { font-weight: bold; color: var(--navy); font-size: 0.9rem; margin-left: 5px; }

        nav { width: 260px; height: 100vh; background: var(--navy); position: fixed; top: 0; left: -260px; transition: 0.3s; z-index: 200; padding-top: 60px; }
        nav.open { left: 0; }
        .nav-item { display: flex; align-items: center; padding: 1rem 1.5rem; color: rgba(255,255,255,0.7); cursor: pointer; text-decoration: none; }
        .nav-item i { margin-right: 10px; }
        #overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 150; }

        main { padding: 80px 1rem 2rem; max-width: 1000px; margin: 0 auto; transition: max-width 0.3s; }
        .card { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 1rem; }
        
        .input-group { margin-bottom: 1rem; }
        .input-group label { display: block; font-size: 0.85rem; font-weight: bold; margin-bottom: 5px; color: var(--navy); }
        input, select, textarea { width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        .btn { width: 100%; padding: 1rem; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; color: white; transition: 0.2s; }
        .btn-green { background: var(--green); }
        .btn-blue { background: var(--blue); }
        .btn-red { background: var(--red); }
        .btn-small { width: auto; padding: 0.5rem 1rem; font-size: 0.9rem; }

        .rating-box { display: flex; gap: 5px; margin-top: 5px; }
        .rate-btn { flex: 1; padding: 12px 0; border: 1px solid #eee; background: white; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .rate-btn.active { background-color: var(--navy) !important; color: white !important; border-color: var(--navy) !important; }

        .cohort-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .d-day-badge { background: var(--blue); color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; white-space: nowrap; }
        
        .rat-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 10px; }
        
        .rat-badge { 
            display: flex; justify-content: center; align-items: center; 
            height: 40px; width: 40px; border-radius: 50%; font-weight: bold; font-size: 0.9rem; 
            cursor: pointer; transition: transform 0.1s; 
            background: white; border: 3px solid #eee; 
        }
        .status-normal { border-color: var(--green); color: var(--green); background: #e8f5e9; }
        .status-mild { border-color: var(--orange); color: var(--orange); background: #fff3e0; }
        .status-severe { border-color: var(--red); color: var(--red); background: #ffebee; }
        .status-dead { border-color: var(--gray); background: #eeeeee; color: var(--gray); text-decoration: line-through; }

        .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        .info-item { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; }
        .info-val { font-size: 1.2rem; font-weight: bold; color: var(--navy); }
        .chart-area { position: relative; height: 350px; width: 100%; margin-top: 20px; } /* Ï∞®Ìä∏ ÏòÅÏó≠ ÎÜíÏù¥ Ï¶ùÍ∞Ä */
        .section-title { font-size: 1.1rem; font-weight: bold; color: var(--navy); margin-bottom: 15px; border-left: 4px solid var(--green); padding-left: 10px; }

        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-top: 10px; white-space: nowrap; }
        th, td { border: 1px solid #eee; padding: 8px; text-align: center; }
        th { background: #f8f9fa; }
        
        #dose-res { margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; border-left: 5px solid var(--blue); }
        #dose-list { list-style: none; padding: 0; margin: 10px 0; font-size: 0.9rem; }
        #dose-list li { margin-bottom: 5px; border-bottom: 1px solid #eee; padding-bottom: 5px; display: flex; justify-content: space-between; }

        .tab-container { display: flex; margin-bottom: 15px; border-bottom: 1px solid #ddd; }
        .tab { padding: 10px 20px; cursor: pointer; color: #666; }
        .tab.active { border-bottom: 3px solid var(--navy); color: var(--navy); font-weight: bold; }
        .edit-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; }
        .edit-row span { flex: 1; }

        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid var(--navy); width: 20px; height: 20px; -webkit-animation: spin 2s linear infinite; animation: spin 2s linear infinite; display: inline-block; vertical-align: middle; margin-right: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .edit-table input { border: 1px solid #ddd; border-radius: 4px; padding: 5px; font-size: 0.85rem; width: 100%; box-sizing: border-box; }
        .edit-table td { padding: 5px; }
        .deleted-row { background-color: #ffebee !important; opacity: 0.5; text-decoration: line-through; }
        .del-btn { background: var(--red); color: white; border: none; border-radius: 4px; padding: 3px 8px; cursor: pointer; font-size: 0.7rem; }
        .add-row-btn { background: var(--navy); color: white; border: none; border-radius: 4px; padding: 5px 15px; margin-top: 5px; cursor: pointer; font-size: 0.8rem; display: inline-flex; align-items: center; }
        
        .co-memo-box { display: inline-flex; align-items: center; margin-left: 10px; font-size: 0.9rem; color: #555; font-weight: normal; }
        .co-memo-input { border: 1px solid #ccc; border-radius: 4px; padding: 4px 5px; width: 160px; font-size: 0.85rem; }
        .edit-icon { font-size: 1.1rem; cursor: pointer; color: var(--blue); margin-left: 8px; vertical-align: middle; padding: 5px; }
        .edit-icon:hover { color: var(--navy); background: #eee; border-radius: 50%; }
        .memo-text { font-style: italic; color: #666; margin-left: 5px; font-size: 0.85rem; }
        
        .mr-check-group { display: flex; align-items: center; flex-wrap: wrap; gap: 6px; margin-left: 20px; font-size: 0.8rem; background: #f1f3f5; padding: 4px 8px; border-radius: 6px; }
        .mr-check-group label { display: flex; align-items: center; cursor: pointer; margin-bottom: 0; color: #495057; font-weight: normal; }
        .mr-check-group input[type="checkbox"] { width: auto; margin: 0 3px 0 0; padding: 0; transform: scale(0.9); }

        .bp-rat-box {
            background: white; border: none; border-radius: 12px; padding: 20px;
            margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 6px solid #3498db;
        }
        .bp-rat-title {
            font-size: 18px; color: #3498db; border-bottom: 1px solid #eee;
            padding-bottom: 10px; margin-bottom: 15px; font-weight: bold;
        }
        .bp-toggle-btn {
            background: #3498db; color: white; border: none; padding: 5px 12px;
            border-radius: 4px; font-size: 12px; cursor: pointer; transition: background 0.2s;
        }
        .bp-toggle-btn:hover { background: #2980b9; }
        .bp-log-table {
            margin: 10px 0; font-size: 13px; background: #f9fafb !important;
            border: 1px solid #e2e8f0; width: 100%;
        }
        .bp-log-table th { background: #edf2f7; color: #4a5568; }
        .bp-controls label { font-weight: bold; margin-right: 15px; cursor: pointer; }

        .comp-grid { display: flex; gap: 10px; width: 100%; }
        .comp-col { flex: 1; min-width: 0; border: 1px solid #ddd; padding: 10px; border-radius: 8px; background: #fdfdfd; }

        /* COD Modal Styles */
        #cod-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; justify-content:center; align-items:center; }
        .cod-box { background:white; padding:20px; border-radius:12px; width:90%; max-width:400px; text-align:center; box-shadow:0 4px 20px rgba(0,0,0,0.2); }
        .cod-btn { width:100%; margin-bottom:10px; padding:12px; border-radius:8px; border:1px solid #eee; background:#f8f9fa; font-weight:bold; cursor:pointer; font-size:1rem; }
        .cod-btn:hover { background:#e3f2fd; color:var(--navy); }
        .cod-title { font-weight:bold; font-size:1.1rem; margin-bottom:15px; color:var(--navy); }
        .cod-step-container { display:none; }
        .cod-step-container.active { display:block; }

        /* ÏàòÏ†ïÎêú ÌÜµÌï© Ìé∏Ïßë ÌÖåÏù¥Î∏î Ïä§ÌÉÄÏùº */
        .edit-container { background: #fff; padding: 20px; border-radius: 8px; border: 1px solid #ddd; margin-top: 15px; }
        .edit-section-title { font-size: 1rem; font-weight: bold; color: var(--navy); margin: 20px 0 10px; border-bottom: 2px solid #eee; padding-bottom: 5px; }

        .full-edit-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 0.9rem; }
        .full-edit-table th, .full-edit-table td { border: 1px solid #ddd; padding: 4px; text-align: center; }
        .full-edit-table th { background: #f1f3f5; color: #495057; }
        .full-edit-table input, .full-edit-table select, .full-edit-table textarea { 
            width: 100%; border: 1px solid transparent; background: transparent; 
            text-align: center; font-size: 0.9rem; padding: 5px; box-sizing: border-box; 
        }
        .full-edit-table input:focus, .full-edit-table select:focus, .full-edit-table textarea:focus { 
            border: 1px solid var(--blue); background: #fff; outline: none; 
        }
        .row-del { background-color: #ffebee !important; }
        .row-del input { text-decoration: line-through; color: #aaa; }

        .float-save-btn {
            position: fixed; bottom: 20px; right: 20px; width: auto; 
            padding: 15px 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
            z-index: 999; font-size: 1.1rem;
        }

        /* COD Checkbox Grid */
        .cod-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: left; margin-bottom: 15px; }
        .cod-option { display: flex; align-items: center; background: #f8f9fa; padding: 10px; border-radius: 6px; border: 1px solid #eee; cursor: pointer; }
        .cod-option input { width: auto; margin-right: 8px; transform: scale(1.2); }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="color:var(--navy)">LAB MANAGER</h2>
            <input type="text" id="uid" placeholder="ID" style="margin-bottom:10px">
            <input type="password" id="upw" placeholder="PW" style="margin-bottom:20px" onkeypress="if(event.key==='Enter') login()">
            <button class="btn btn-green" onclick="login()">LOGIN</button>
        </div>
    </div>

    <div id="main-app">
        <header>
            <div class="menu-btn-box" onclick="toggleMenu()">
                <i class="material-icons" style="color:var(--navy)">menu</i>
                <span class="menu-btn-text">MENU</span>
            </div>
            <span style="font-weight:700; color:var(--navy); font-size:1.1rem;">RAT LAB MANAGER</span>
        </header>
        <div id="overlay" onclick="toggleMenu()"></div>

        <nav id="sidebar">
            <div class="nav-item" onclick="go('dash')"><i class="material-icons">dashboard</i>ÎåÄÏãúÎ≥¥Îìú</div>
            <div class="nav-item" onclick="go('detail')"><i class="material-icons">search</i>Îû´Îìú ÏÉÅÏÑ∏Î≥¥Í∏∞</div>
            <div class="nav-item" onclick="go('cohort')"><i class="material-icons">bar_chart</i>ÏΩîÌò∏Ìä∏ Î∂ÑÏÑù</div>
            <div class="nav-item" onclick="go('compare')"><i class="material-icons">compare_arrows</i>ÏΩîÌò∏Ìä∏ ÎπÑÍµê</div>
            <div class="nav-item" onclick="go('daily')"><i class="material-icons">edit_note</i>Îç∞ÏùºÎ¶¨ Ï≤¥ÌÅ¨</div>
            <div class="nav-item" onclick="go('add')"><i class="material-icons">add_circle</i>Ïã†Í∑ú Îì±Î°ù</div>
            <div class="nav-item" onclick="go('dose')"><i class="material-icons">science</i>Ìà¨ÏïΩ Í≥ÑÏÇ∞Í∏∞</div>
            <div class="nav-item" onclick="go('rec')"><i class="material-icons">monitor_weight</i>ÌòàÏïï/Ï≤¥Ï§ë Í∏∞Î°ù</div>
            <div class="nav-item" onclick="go('bp')"><i class="material-icons">analytics</i>BP Í≥ÑÏÇ∞Í∏∞</div>
            <div class="nav-item" onclick="go('admin')"><i class="material-icons">admin_panel_settings</i>Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨</div>
            <div class="nav-item" onclick="location.reload()" style="margin-top:auto"><i class="material-icons">logout</i>Î°úÍ∑∏ÏïÑÏõÉ</div>
        </nav>

        <main id="content"></main>
    </div>

    <div id="cod-modal">
        <div class="cod-box">
            
            <div id="cod-step-1" class="cod-step-container">
                <div class="cod-title">ÏÇ¨Îßù ÏõêÏù∏ Î∂ÑÎ•ò (1/3)</div>
                <button class="cod-btn" onclick="selectCodType('Neurological')">Neurological</button>
                <button class="cod-btn" onclick="selectCodType('Non-Neurological')">Non-Neurological</button>
                <button class="cod-btn" style="background:#ffebee; color:var(--red)" onclick="closeCod()">Ï∑®ÏÜå</button>
            </div>

            <div id="cod-step-2-neuro" class="cod-step-container">
                <div class="cod-title">Aneurysm Ïó¨Î∂Ä (2/3)</div>
                <button class="cod-btn" onclick="selectCodAn('Aneurysm(O)')">Aneurysm (O)</button>
                <button class="cod-btn" onclick="selectCodAn('Aneurysm(X)')">Aneurysm (X)</button>
                <button class="cod-btn" style="background:#eee;" onclick="codBack(1)">Ïù¥Ï†Ñ</button>
            </div>

            <div id="cod-step-2-non-neuro" class="cod-step-container">
                <div class="cod-title">Non-Neurological ÏõêÏù∏ (2/3)</div>
                <button class="cod-btn" onclick="selectCodNonNeuroCause('Unknown')">Unknown</button>
                <button class="cod-btn" onclick="selectCodNonNeuroCause('Surgical Failure')">Surgical Failure</button>
                <button class="cod-btn" style="background:#eee;" onclick="codBack(1)">Ïù¥Ï†Ñ</button>
            </div>

            <div id="cod-step-3" class="cod-step-container">
                <div class="cod-title">ÏÑ∏Î∂Ä ÏõêÏù∏ ÏÑ†ÌÉù (3/3)<br><span style="font-size:0.8rem; font-weight:normal;">Ï§ëÎ≥µ ÏÑ†ÌÉù Í∞ÄÎä•</span></div>
                <div class="cod-grid" style="margin-bottom:20px;">
                    <label class="cod-option"><input type="checkbox" name="cod-check" value="SAH"> SAH</label>
                    <label class="cod-option"><input type="checkbox" name="cod-check" value="Infarction"> Infarction</label>
                    <label class="cod-option"><input type="checkbox" name="cod-check" value="Vasospasm"> Vasospasm</label>
                    <label class="cod-option"><input type="checkbox" name="cod-check" value="Unknown"> Unknown</label>
                </div>
                
                <button class="cod-btn btn-blue" onclick="saveCodFinal()">ÏµúÏ¢Ö Ï†ÄÏû•</button>
                <button class="cod-btn" style="background:#eee;" onclick="codBack('neuro-2')">Ïù¥Ï†Ñ</button>
            </div>

        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCOrTBAQZ4WgFTT5Qk96k0Z_aTTVjKKQeI",
            authDomain: "nidd-lab.firebaseapp.com",
            projectId: "nidd-lab",
            storageBucket: "nidd-lab.firebasestorage.app",
            messagingSenderId: "959472997584",
            appId: "1:959472997584:web:d749f452f2cfc25e3d3ad5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentScores = { act: 0, fur: 0, eye: 0 };
        let allBPData = [];
        let bpChartInstance = null; 
        let globalBpData = [];
        let allRatsForDetail = [];
        
        // COD Global States
        let codTargetDocId = null;  // For Detail Page (Direct DB Save)
        let codTargetInputId = null; // For Admin Page (Input Update only)
        let codTempData = { type: '', secondary: '', causes: [] };

        function login() {
            const id = document.getElementById('uid').value;
            const pw = document.getElementById('upw').value;
            if(id.toLowerCase() === 'nidd' && pw === '1234') {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                setTimeout(() => go('dash'), 50);
            } else alert('Î°úÍ∑∏Ïù∏ Ïã§Ìå®');
        }

        function getTodayStr() {
            const now = new Date();
            const offset = now.getTimezoneOffset() * 60000;
            const kstDate = new Date(now.getTime() - offset);
            return kstDate.toISOString().split('T')[0];
        }

        function toggleMenu() {
            const nav = document.getElementById('sidebar');
            const ol = document.getElementById('overlay');
            nav.classList.toggle('open');
            ol.style.display = nav.classList.contains('open') ? 'block' : 'none';
        }

        async function go(view, targetId = null) {
            const main = document.getElementById('content');
            if(document.getElementById('sidebar').classList.contains('open')) toggleMenu();

            if (view === 'compare') {
                main.style.maxWidth = '95%';
            } else {
                main.style.maxWidth = '1000px';
            }

            if(view === 'admin') {
                const pw = prompt("Í¥ÄÎ¶¨Ïûê ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî");
                if(pw !== '1234') { alert("ÎπÑÎ∞ÄÎ≤àÌò∏ Ïò§Î•ò"); return; }
                
                main.innerHTML = `
                <div class="card">
                    <h3>üõ† Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨</h3>
                    <div class="tab-container">
                        <div id="adm-del" class="tab active" onclick="admTab('del')">Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú</div>
                        <div id="adm-edit" class="tab" onclick="admTab('edit')">Îç∞Ïù¥ÌÑ∞ ÏàòÏ†ï</div>
                        <div id="adm-imp" class="tab" onclick="admTab('imp')">ÏùºÍ¥Ñ Îì±Î°ù</div>
                    </div>
                    
                    <div id="tab-del">
                        <div class="input-group">
                            <label>Í∞úÎ≥Ñ Îû´Îìú ÏÇ≠Ï†ú</label>
                            <div style="display:flex; gap:10px;"><input type="text" id="del-id" placeholder="C1101"><button class="btn btn-red btn-small" onclick="deleteRat()">ÏÇ≠Ï†ú</button></div>
                        </div>
                        <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
                        <div class="input-group">
                            <label>ÏΩîÌò∏Ìä∏ Ï†ÑÏ≤¥ ÏÇ≠Ï†ú</label>
                            <div style="display:flex; gap:10px;"><input type="number" id="del-cohort" placeholder="11"><button class="btn btn-red btn-small" onclick="deleteCohort()">Ï†ÑÏ≤¥ ÏÇ≠Ï†ú</button></div>
                        </div>
                    </div>

                    <div id="tab-edit" style="display:none;">
                        <div class="input-group">
                            <label>Îû´Îìú ID Í≤ÄÏÉâ (Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ ÏàòÏ†ï/Ï∂îÍ∞Ä/ÏÇ≠Ï†ú)</label>
                            <div style="display:flex; gap:10px;"><input type="text" id="edit-id" placeholder="C1101"><button class="btn btn-blue btn-small" onclick="searchForEdit()">Í≤ÄÏÉâ</button></div>
                        </div>
                        <div id="edit-result"></div>
                    </div>

                    <div id="tab-imp" style="display:none;">
                        <input type="file" id="daily-csv" accept=".csv" style="margin-bottom:10px;">
                        <button class="btn btn-green" onclick="uploadDailyLogs()">Îç∞ÏùºÎ¶¨ Î°úÍ∑∏ ÏóÖÎ°úÎìú ÏãúÏûë</button>
                    </div>
                </div>`;
                return;
            }

            if(view === 'cohort') {
                main.innerHTML = `
                <div class="card">
                    <h3>üìä ÏΩîÌò∏Ìä∏ Î∂ÑÏÑù (ÌÜµÌï© Î≥¥Í∏∞)</h3>
                    <div id="co-check-list" style="display:flex; flex-wrap:wrap; gap:15px; margin-bottom:15px; padding:15px; background:#f8f9fa; border-radius:8px; border:1px solid #eee; max-height:150px; overflow-y:auto;">
                        Î°úÎî© Ï§ë...
                    </div>
                    <label style="display:block; margin-bottom:15px; font-weight:bold; color:var(--navy); cursor:pointer;">
                        <input type="checkbox" id="show-all-tp" style="width:auto; margin-right:5px; transform:scale(1.2);"> Ï†ÑÏ≤¥ ÌÉÄÏûÑÎùºÏù∏ Î≥¥Í∏∞
                    </label>
                    <button class="btn btn-blue" onclick="loadCohortDetail()">Î∂ÑÏÑù ÏãúÏûë</button>
                </div>
                <div id="cohort-res"></div>`;
                await renderCohortCheckboxes('co-check-list');
                return;
            }
            
            if (view === 'compare') {
                main.innerHTML = `
                <div class="card">
                    <h3>üîÑ ÏΩîÌò∏Ìä∏ ÎπÑÍµê (ÏµúÎåÄ 3Í∞ú Î∂ÑÌï†)</h3>
                    <div id="comp-check-list" style="display:flex; flex-wrap:wrap; gap:15px; margin-bottom:15px; padding:15px; background:#f8f9fa; border-radius:8px; border:1px solid #eee; max-height:150px; overflow-y:auto;">
                        Î°úÎî© Ï§ë...
                    </div>
                    <label style="display:block; margin-bottom:15px; font-weight:bold; color:var(--navy); cursor:pointer;">
                        <input type="checkbox" id="comp-show-all-tp" style="width:auto; margin-right:5px; transform:scale(1.2);"> Ï†ÑÏ≤¥ ÌÉÄÏûÑÎùºÏù∏ Î≥¥Í∏∞
                    </label>
                    <button class="btn btn-blue" onclick="loadCohortComparison()">ÎπÑÍµê ÏãúÏûë</button>
                </div>
                <div id="comp-res-area" class="comp-grid"></div>`;
                await renderCohortCheckboxes('comp-check-list');
                return;
            }

            if(view === 'dash') { main.innerHTML = `<div id="dash-container">Î°úÎî© Ï§ë...</div>`; loadDashboard(); }
            else if(view === 'detail') { 
                main.innerHTML = `
                <div class="card">
                    <h3>Îû´Îìú ÏÉÅÏÑ∏</h3>
                    <div style="display:flex; gap:10px;">
                        <div style="flex:1;">
                            <label style="font-size:0.85rem; font-weight:bold; color:var(--navy);">ÏΩîÌò∏Ìä∏ ÏÑ†ÌÉù</label>
                            <select id="dt-cohort-sel" onchange="updateRatList()" style="width:100%; padding:10px;">
                                <option value="">Î°úÎî© Ï§ë...</option>
                            </select>
                        </div>
                        <div style="flex:1;">
                            <label style="font-size:0.85rem; font-weight:bold; color:var(--navy);">Î≤àÌò∏(ID) ÏÑ†ÌÉù</label>
                            <select id="dt-rat-sel" onchange="loadDetailData()" style="width:100%; padding:10px;">
                                <option value="">-</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="detail-view"></div>`; 
                await initDetailSelectors(targetId);
            }
            else if(view === 'daily') {
                currentScores = { act: 0, fur: 0, eye: 0 };
                main.innerHTML = `<div class="card"><h3>Îç∞ÏùºÎ¶¨ Ï≤¥ÌÅ¨</h3><div style="display:flex; gap:10px; margin-bottom:10px"><input type="number" id="dc-c" placeholder="C" oninput="mkId('dc')"><input type="number" id="dc-r" placeholder="N" oninput="mkId('dc')"></div><input type="text" id="dc-id" readonly style="background:#eee; margin-bottom:15px"><div class="input-group"><label>ÎÇ†Ïßú</label><input type="date" id="dc-date"></div>${['act','fur','eye'].map(k => `<div class="input-group"><label>${k.toUpperCase()}</label><div class="rating-box">${[1,2,3,4,5].map(n => `<button class="rate-btn" onclick="score('${k}', ${n}, this)">${n}</button>`).join('')}</div></div>`).join('')}<div id="score-res" class="status-box">ÏÑ†ÌÉù ÌïÑÏöî</div><textarea id="dc-note" rows="2" placeholder="Î©îÎ™®" style="margin-top:10px;"></textarea><div style="margin-top:10px;"><input type="checkbox" id="is-dead" style="width:auto;"> <label style="display:inline; color:var(--red);">ÏÇ¨Îßù Ïãú Ï≤¥ÌÅ¨</label></div><button class="btn btn-green" onclick="saveDaily()" style="margin-top:15px;">Ï†ÄÏû•</button></div>`;
                document.getElementById('dc-date').value = getTodayStr();
            }
            else if(view === 'add') { 
                main.innerHTML = `<div class="card"><h3>ÎåÄÎüâ Îì±Î°ù</h3><div class="input-group"><label>ÏΩîÌò∏Ìä∏</label><input type="number" id="add-c"></div><div style="display:flex; gap:10px;"><input type="number" id="add-s" placeholder="ÏãúÏûë"><input type="number" id="add-e" placeholder="ÎÅù"></div><div class="input-group" style="margin-top:10px;"><label>Î∞òÏûÖÏùº</label><input type="date" id="add-d"></div><button class="btn btn-green" onclick="saveBulk()">Îì±Î°ù</button></div>`; 
                document.getElementById('add-d').value = getTodayStr(); 
            }
            else if(view === 'dose') { main.innerHTML = `<div class="card"><h3>Ìà¨ÏïΩ Í≥ÑÏÇ∞Í∏∞</h3><input type="number" id="ds-c" placeholder="ÏΩîÌò∏Ìä∏" oninput="upDose()" style="margin-bottom:10px;"><table><thead><tr><th>Î≤à</th><th>WT(g)</th><th>ID</th></tr></thead><tbody>${Array.from({length:12},(_,i)=>`<tr><td><input type="number" class="dn" oninput="upDose()"></td><td><input type="number" class="dw"></td><td class="di">-</td></tr>`).join('')}</tbody></table><button class="btn btn-blue" onclick="saveDose()" style="margin-top:15px;">Í≥ÑÏÇ∞ Î∞è Ï†ÄÏû•</button><div id="dose-res" style="display:none;"></div></div>`; }
            else if(view === 'rec') { 
                main.innerHTML = `<div class="card"><h3>ÌòàÏïï/Ï≤¥Ï§ë Í∏∞Î°ù</h3><div style="display:flex; gap:10px;"><input type="number" id="re-c" placeholder="C" oninput="mkId('re')"><input type="number" id="re-r" placeholder="N" oninput="mkId('re')"></div><input type="text" id="re-id" readonly style="background:#eee; margin:10px 0;"><select id="re-tp"><option>Manual</option><option>D00</option><option>D0</option><option>D2</option><option>W1</option><option>W4</option><option>W8</option><option>W12</option><option>W20</option></select><input type="date" id="re-date" style="margin-top:10px;"><div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;"><input type="number" id="re-s" placeholder="SBP" oninput="calM()"><input type="number" id="re-d" placeholder="DBP" oninput="calM()"></div><input type="number" id="re-m" placeholder="Mean" readonly style="background:#eee; margin-top:10px;"><input type="number" id="re-w" placeholder="WT(g)" step="0.1" style="margin-top:10px;"><button class="btn btn-green" onclick="saveRec()" style="margin-top:15px;">Ï†ÄÏû•</button></div>`; 
                document.getElementById('re-date').value = getTodayStr(); 
            }
            else if(view === 'bp') { 
                main.innerHTML = `<div class="card"><h3>BP Analyzer (PC Ver.)</h3><div class="bp-controls" style="background:#f8f9fa; padding:15px; border-radius:8px; border:1px solid #eee;"><label><input type="radio" name="bp-mode" value="control" checked> Control</label><label style="margin-left:20px;"><input type="radio" name="bp-mode" value="induction"> Induction</label><br><input type="file" id="bp-file-input" accept=".csv" multiple style="margin-top:15px; width:100%; border:2px dashed #cbd5e0; padding:10px; box-sizing:border-box;"></div><div id="bp-output" style="margin-top:20px;"></div></div>`; 
                document.getElementById('bp-file-input').addEventListener('change', loadBPFiles); 
            }
        }

        async function renderCohortCheckboxes(containerId) {
            const snap = await db.collection("rats").get();
            const cohorts = new Set();
            snap.forEach(d => cohorts.add(d.data().cohort));
            const sorted = Array.from(cohorts).sort((a,b)=>Number(b)-Number(a));
            
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            if(sorted.length === 0) {
                container.innerHTML = 'Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå';
            } else {
                sorted.forEach(c => {
                    const wrapper = document.createElement('div');
                    wrapper.innerHTML = `<label style="cursor:pointer; font-weight:bold; color:var(--navy); display:flex; align-items:center;"><input type="checkbox" class="co-checkbox" value="${c}" style="width:auto; margin-right:8px; transform:scale(1.2);">Cohort ${c}</label>`;
                    container.appendChild(wrapper);
                });
            }
        }

        async function initDetailSelectors(targetId) {
            try {
                const snap = await db.collection('rats').orderBy('ratId').get();
                allRatsForDetail = [];
                snap.forEach(doc => allRatsForDetail.push(doc.data()));
                const cohorts = new Set(allRatsForDetail.map(r => r.cohort));
                const sortedCohorts = Array.from(cohorts).sort((a,b) => Number(b) - Number(a));
                const cSel = document.getElementById('dt-cohort-sel');
                cSel.innerHTML = '<option value="">-- ÏΩîÌò∏Ìä∏ ÏÑ†ÌÉù --</option>' + sortedCohorts.map(c => `<option value="${c}">Cohort ${c}</option>`).join('');
                if(targetId) {
                    const targetRat = allRatsForDetail.find(r => r.ratId === targetId);
                    if(targetRat) {
                        cSel.value = targetRat.cohort;
                        updateRatList(targetId);
                    }
                }
            } catch(e) { console.error(e); }
        }

        function updateRatList(preSelectId = null) {
            const cVal = document.getElementById('dt-cohort-sel').value;
            const rSel = document.getElementById('dt-rat-sel');
            if(!cVal) { rSel.innerHTML = '<option value="">-</option>'; return; }
            const filtered = allRatsForDetail.filter(r => r.cohort === cVal).sort((a,b) => a.ratId.localeCompare(b.ratId));
            rSel.innerHTML = '<option value="">-- Î≤àÌò∏ ÏÑ†ÌÉù --</option>' + filtered.map(r => {
                const deadMark = r.status === 'ÏÇ¨Îßù' ? ' (ÏÇ¨Îßù)' : '';
                return `<option value="${r.ratId}">${r.ratId}${deadMark}</option>`;
            }).join('');
            if(preSelectId) { rSel.value = preSelectId; loadDetailData(); }
        }

        // =========================================================
        //  COHORT ANALYSIS & CHART GENERATION (Hierarchical Pie)
        // =========================================================
        async function runCohortAnalysis(targetCohorts, targetDivId, uniqueSuffix = '', fixedOptions = null) {
            const showAll = document.getElementById('show-all-tp')?.checked || document.getElementById('comp-show-all-tp')?.checked;
            const resDiv = document.getElementById(targetDivId);
            resDiv.innerHTML = `<div class="loader"></div> Î°úÎî© Ï§ë... (${targetCohorts.join(', ')})`;

            try {
                const ratPromises = targetCohorts.map(c => db.collection("rats").where("cohort", "==", c).get());
                const ratSnaps = await Promise.all(ratPromises);
                let rats = [];
                const ratInfoMap = {}; 

                ratSnaps.forEach(snap => {
                    snap.forEach(d => {
                        const r = d.data();
                        rats.push(r);
                        ratInfoMap[r.ratId] = r;
                    });
                });

                if(rats.length === 0) { resDiv.innerHTML = "Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå"; return; }

                const deadRats = rats.filter(r => r.status === "ÏÇ¨Îßù");
                rats.sort((a,b) => a.ratId.localeCompare(b.ratId)); 
                const ratIds = rats.map(r => r.ratId);

                const promises = ratIds.map(rid => db.collection("measurements").where("ratId", "==", rid).get());
                const snapshots = await Promise.all(promises);

                let targetTimepoints = [];
                const stdPodMap = { "D00": -999, "D0": -500, "D2": -300, "W1": 7, "W4": 28, "W8": 56, "W12": 84, "W20": 140 };

                if (fixedOptions && fixedOptions.labels) {
                    targetTimepoints = fixedOptions.labels;
                } else {
                    let columns = []; 
                    const seenLabels = new Set();
                    Object.keys(stdPodMap).forEach(key => { columns.push({ label: key, sortVal: stdPodMap[key] }); seenLabels.add(key); });
                    if (showAll) {
                        snapshots.forEach((snap, idx) => {
                            const rid = ratIds[idx];
                            const rInfo = ratInfoMap[rid];
                            snap.forEach(doc => {
                                const d = doc.data();
                                if (d.timepoint && stdPodMap.hasOwnProperty(d.timepoint)) return;
                                if (d.date && rInfo.surgeryDate) {
                                    const diff = new Date(d.date) - new Date(rInfo.surgeryDate);
                                    const pod = Math.floor(diff / (1000 * 60 * 60 * 24));
                                    const label = d.date;
                                    if (!seenLabels.has(label)) { columns.push({ label: label, sortVal: pod }); seenLabels.add(label); }
                                }
                            });
                        });
                    }
                    columns.sort((a,b) => a.sortVal - b.sortVal);
                    targetTimepoints = columns.map(c => c.label);
                }

                const matrix = {}; 
                ratIds.forEach(id => { matrix[id] = {}; targetTimepoints.forEach(tp => matrix[id][tp] = { sbp: null, wt: null }); });
                snapshots.forEach((snap, idx) => {
                    const rid = ratIds[idx];
                    snap.forEach(doc => {
                        const d = doc.data();
                        let label = null;
                        if (d.timepoint && stdPodMap.hasOwnProperty(d.timepoint)) label = d.timepoint;
                        else if (showAll && d.date) label = d.date;
                        if (label && matrix[rid][label] !== undefined) { matrix[rid][label] = { sbp: d.sbp, wt: d.weight }; }
                    });
                });

                const avgs = {}; 
                targetTimepoints.forEach(tp => avgs[tp] = { sCnt:0, sSum:0, wCnt:0, wSum:0 });
                ratIds.forEach(id => {
                    targetTimepoints.forEach(tp => {
                        const cell = matrix[id][tp];
                        if (cell) {
                            if(cell.sbp) { avgs[tp].sSum += cell.sbp; avgs[tp].sCnt++; }
                            if(cell.wt) { avgs[tp].wSum += cell.wt; avgs[tp].wCnt++; }
                        }
                    });
                });

                let html = '';
                const sChartId = `survChart${uniqueSuffix}`;
                const bpChartId = `coChartSbp${uniqueSuffix}`;
                const wtChartId = `coChartWt${uniqueSuffix}`;
                const codChartId = `codChart${uniqueSuffix}`;

                if(deadRats.length > 0) {
                    html += `<div class="card" style="border-left:5px solid var(--red)"><h4>‚ö∞Ô∏è ÏÇ¨Îßù Î∂ÑÏÑù (${deadRats.length}ÎßàÎ¶¨)</h4>
                    <table><tr><th>ID</th><th>ÏÇ¨ÎßùÏùº</th><th>ÏãúÏ†ê</th></tr>`;
                    
                    const deathByPod = {};
                    let maxPod = 0;
                    
                    deadRats.forEach(r => {
                        const pod = r.surgeryDate && r.deathDate ? Math.floor((new Date(r.deathDate) - new Date(r.surgeryDate))/(1000*60*60*24)) : '?';
                        const cause = r.codFull || 'ÎØ∏Í∏∞Î°ù';
                        html += `<tr><td>${r.ratId}</td><td>${r.deathDate||'-'}</td><td>POD ${pod}<br><span style="font-size:0.8em; color:gray">${cause}</span></td></tr>`;
                        if(typeof pod === 'number') {
                            if(!deathByPod[pod]) deathByPod[pod] = 0;
                            deathByPod[pod]++;
                            if(pod > maxPod) maxPod = pod;
                        }
                    });
                    html += `</table><div class="chart-area"><canvas id="${sChartId}"></canvas></div></div>`;
                    
                    // Add COD Nested Chart Area
                    html += `<div class="card"><h4>üíÄ ÏÇ¨Îßù ÏõêÏù∏ Í≥ÑÏ∏µ Íµ¨Ï°∞ (1Ï∞®>2Ï∞®>3Ï∞®)</h4><div class="chart-area" style="height:350px;"><canvas id="${codChartId}"></canvas></div></div>`;

                    var survLabels = [];
                    var survData = [];
                    let currentAlive = rats.length;
                    
                    let loopEnd = maxPod;
                    if(fixedOptions && typeof fixedOptions.maxPod === 'number') {
                        loopEnd = fixedOptions.maxPod;
                    }

                    for(let i=0; i<=loopEnd; i++) {
                        if(deathByPod[i]) currentAlive -= deathByPod[i];
                        survLabels.push(`POD ${i}`);
                        survData.push((currentAlive / rats.length) * 100);
                    }

                    // --- Hierarchical Data Processing for Chart.js (Count-based Aggregation) ---
                    setTimeout(() => {
                        if(document.getElementById(codChartId)) {
                            // 1. Data Structure Aggregation (Count based on 3rd level occurrences)
                            const hierarchy = {}; // { Type: { Secondary: { Cause: Count } } }

                            deadRats.forEach(r => {
                                // Parse COD string
                                const fullStr = r.codFull || "Unknown";
                                let type = "Unknown";
                                let secondary = "Unknown";
                                let causes = [];

                                // Format 1: "Neurological (Aneurysm(O)) - SAH, Infarction"
                                // Format 2: "Non-Neurological (Unknown)" -> (If Non-Neuro, secondary is in parens)
                                
                                if(fullStr.startsWith("Neurological")) {
                                    // Parse Neuro
                                    type = "Neurological";
                                    const parts = fullStr.split('-');
                                    const prefix = parts[0].trim(); // "Neurological (Aneurysm(O))"
                                    const suffix = parts.length > 1 ? parts[1].trim() : ""; // "SAH, Infarction"

                                    // Extract Secondary (Aneurysm Status)
                                    const match = prefix.match(/\(([^)]+)\)/);
                                    secondary = match ? match[1].trim() : "Unknown";

                                    // Extract Causes
                                    if(suffix) {
                                        causes = suffix.split(',').map(c => c.trim()).filter(c=>c);
                                    } else {
                                        causes = ["Unknown"];
                                    }

                                } else if (fullStr.startsWith("Non-Neurological")) {
                                    // Parse Non-Neuro
                                    type = "Non-Neurological";
                                    // Format: "Non-Neurological (Unknown)" or "Non-Neurological (Surgical Failure)"
                                    const match = fullStr.match(/\(([^)]+)\)/);
                                    secondary = match ? match[1].trim() : "Unknown";
                                    causes = ["None"]; // 3Ï∞® Î∂ÑÎ•ò ÏóÜÏùå

                                } else {
                                    // Fallback for custom or old data
                                    type = "Unknown";
                                    secondary = "Unknown";
                                    causes = [fullStr];
                                }

                                // Accumulate
                                if (!hierarchy[type]) hierarchy[type] = {};
                                if (!hierarchy[type][secondary]) hierarchy[type][secondary] = {};
                                
                                // **Ï§ëÏöî**: 3Ï∞® ÏõêÏù∏Ïù¥ Ïó¨Îü¨ Í∞úÎ©¥, ÏÉÅÏúÑ Ïπ¥ÌÖåÍ≥†Î¶¨ÎèÑ Í∑∏ÎßåÌÅº Ï§ëÎ≥µ Ïπ¥Ïö¥Ìä∏Îê® (ÏãúÍ∞ÅÏ†Å Ï†ïÌï©ÏÑ±ÏùÑ ÏúÑÌï¥)
                                causes.forEach(c => {
                                    if (!hierarchy[type][secondary][c]) hierarchy[type][secondary][c] = 0;
                                    hierarchy[type][secondary][c]++;
                                });
                            });

                            // 2. Flatten for Chart.js (3 Datasets)
                            const dataL1 = []; // Type
                            const dataL2 = []; // Secondary
                            const dataL3 = []; // Cause
                            const bgL1 = [], bgL2 = [], bgL3 = [];
                            const labelsL1 = [], labelsL2 = [], labelsL3 = [];

                            // Color Palette
                            const colors = {
                                "Neurological": { base: [54, 162, 235] }, // Blue
                                "Non-Neurological": { base: [255, 99, 132] }, // Red
                                "Unknown": { base: [201, 203, 207] } // Gray
                            };

                            Object.keys(hierarchy).forEach(type => {
                                let typeTotal = 0;
                                const subTree = hierarchy[type];
                                const cBase = colors[type] ? colors[type].base : [200,200,200];
                                
                                Object.keys(subTree).forEach(sec => {
                                    let secTotal = 0;
                                    const causeTree = subTree[sec];

                                    Object.keys(causeTree).forEach(cause => {
                                        const count = causeTree[cause];
                                        dataL3.push(count);
                                        
                                        // 3Ï∞® Î∂ÑÎ•òÍ∞Ä 'None'Ïù∏ Í≤ΩÏö∞ (Non-Neuro) ÎùºÎ≤®ÏùÑ ÎπÑÏõÄ
                                        labelsL3.push(cause === "None" ? "" : cause);
                                        secTotal += count;
                                        
                                        // Level 3 Colors (Lightest)
                                        // ÎßåÏïΩ 'None'Ïù¥Î©¥ Ìà¨Î™ÖÌïòÍ≤å Ìï† ÏàòÎèÑ ÏûàÏßÄÎßå, 
                                        // ÎîîÏûêÏù∏ÏÉÅ 2Ï∞® Î∂ÑÎ•ò ÏÉâÏÉÅÏùÑ Îî∞ÎùºÍ∞ÄÍ≤å ÌïòÎäî Í≤ÉÏù¥ ÍπîÎÅîÌï® (Ïó¨Í∏∞ÏÑ† Lightest)
                                        bgL3.push(`rgba(${cBase[0]}, ${cBase[1]}, ${cBase[2]}, 0.3)`);
                                    });

                                    dataL2.push(secTotal);
                                    labelsL2.push(sec);
                                    typeTotal += secTotal;

                                    // Level 2 Colors (Medium)
                                    bgL2.push(`rgba(${cBase[0]}, ${cBase[1]}, ${cBase[2]}, 0.6)`);
                                });

                                dataL1.push(typeTotal);
                                labelsL1.push(type);

                                // Level 1 Colors (Darkest)
                                bgL1.push(`rgba(${cBase[0]}, ${cBase[1]}, ${cBase[2]}, 1.0)`);
                            });

                            // 3. Render Multi-Dataset Doughnut
                            new Chart(document.getElementById(codChartId), {
                                type: 'doughnut',
                                data: {
                                    labels: labelsL3, 
                                    datasets: [
                                        {
                                            label: '1Ï∞® Î∂ÑÎ•ò',
                                            data: dataL1,
                                            backgroundColor: bgL1,
                                            weight: 2
                                        },
                                        {
                                            label: '2Ï∞® Î∂ÑÎ•ò',
                                            data: dataL2,
                                            backgroundColor: bgL2,
                                            weight: 1.5
                                        },
                                        {
                                            label: '3Ï∞® Î∂ÑÎ•ò',
                                            data: dataL3,
                                            backgroundColor: bgL3,
                                            weight: 1
                                        }
                                    ]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { display: true, position: 'right' },
                                        tooltip: {
                                            callbacks: {
                                                label: function(context) {
                                                    const dsIndex = context.datasetIndex;
                                                    let label = '';
                                                    if(dsIndex === 0) label = labelsL1[context.dataIndex];
                                                    else if(dsIndex === 1) label = labelsL2[context.dataIndex];
                                                    else label = labelsL3[context.dataIndex];
                                                    
                                                    if(!label) return null; // Îπà ÎùºÎ≤® Ïà®ÍπÄ
                                                    return `${label}: ${context.raw}`;
                                                }
                                            }
                                        }
                                    }
                                }
                            });
                        }
                    }, 500);
                }

                html += `<div class="card"><h4>ü©∏ ÌòàÏïï(SBP) ÌÉÄÏûÑÎùºÏù∏</h4><div style="overflow-x:auto;"><table><tr><th>ID</th>${targetTimepoints.map(t=>`<th>${t}</th>`).join('')}</tr>`;
                ratIds.forEach(id => {
                    const statusIcon = ratInfoMap[id].status === 'ÏÇ¨Îßù' ? 'üíÄ' : 'üü¢';
                    html += `<tr><td>${statusIcon} ${id}</td>`;
                    targetTimepoints.forEach(tp => { html += `<td>${matrix[id][tp]?.sbp || '-'}</td>`; });
                    html += `</tr>`;
                });
                html += `<tr style="background:#e3f2fd; font-weight:bold;"><td>AVG</td>`;
                const avgSbpData = [];
                targetTimepoints.forEach(tp => {
                    const avg = avgs[tp].sCnt ? Math.round(avgs[tp].sSum / avgs[tp].sCnt) : null;
                    avgSbpData.push(avg);
                    html += `<td>${avg||'-'}</td>`;
                });
                html += `</tr></table></div><div class="chart-area"><canvas id="${bpChartId}"></canvas></div></div>`;

                html += `<div class="card"><h4>‚öñÔ∏è Ï≤¥Ï§ë(Weight) ÌÉÄÏûÑÎùºÏù∏</h4><div style="overflow-x:auto;"><table><tr><th>ID</th>${targetTimepoints.map(t=>`<th>${t}</th>`).join('')}</tr>`;
                ratIds.forEach(id => {
                    const statusIcon = ratInfoMap[id].status === 'ÏÇ¨Îßù' ? 'üíÄ' : 'üü¢';
                    html += `<tr><td>${statusIcon} ${id}</td>`;
                    targetTimepoints.forEach(tp => { html += `<td>${matrix[id][tp]?.wt || '-'}</td>`; });
                    html += `</tr>`;
                });
                html += `<tr style="background:#e8f5e9; font-weight:bold;"><td>AVG</td>`;
                const avgWtData = [];
                targetTimepoints.forEach(tp => {
                    const avg = avgs[tp].wCnt ? (avgs[tp].wSum / avgs[tp].wCnt).toFixed(1) : null;
                    avgWtData.push(avg);
                    html += `<td>${avg||'-'}</td>`;
                });
                html += `</tr></table></div><div class="chart-area"><canvas id="${wtChartId}"></canvas></div></div>`;

                resDiv.innerHTML = html;

                if(deadRats.length > 0 && typeof survLabels !== 'undefined') {
                    new Chart(document.getElementById(sChartId), {
                        type: 'line',
                        data: { labels: survLabels, datasets: [{ label: 'Survival Rate (%)', data: survData, borderColor: '#333', backgroundColor:'rgba(0,0,0,0.1)', fill: true, stepper: true }] },
                        options: { maintainAspectRatio: false, scales: { y: { min: 0, max: 100 } } }
                    });
                }

                const sbpChartOpts = { maintainAspectRatio: false };
                const wtChartOpts = { maintainAspectRatio: false };

                if(fixedOptions) {
                    if(fixedOptions.maxSbp) sbpChartOpts.scales = { y: { min: 0, max: fixedOptions.maxSbp + 20 } };
                    if(fixedOptions.maxWt) wtChartOpts.scales = { y: { min: 0, max: fixedOptions.maxWt + 50 } };
                }

                new Chart(document.getElementById(bpChartId), {
                    type: 'line', data: { labels: targetTimepoints, datasets: [{ label: 'Avg SBP', data: avgSbpData, borderColor: '#d32f2f', tension: 0.1, spanGaps: true }] },
                    options: sbpChartOpts
                });
                new Chart(document.getElementById(wtChartId), {
                    type: 'line', data: { labels: targetTimepoints, datasets: [{ label: 'Avg Weight', data: avgWtData, borderColor: '#00c853', tension: 0.1, spanGaps: true }] },
                    options: wtChartOpts
                });

            } catch(e) { console.error(e); resDiv.innerHTML = `<p style="color:red">Ïò§Î•ò: ${e.message}</p>`; }
        }

        async function loadCohortDetail() {
            const checkboxes = document.querySelectorAll('#co-check-list .co-checkbox:checked');
            if(checkboxes.length === 0) return alert("Î∂ÑÏÑùÌï† ÏΩîÌò∏Ìä∏Î•º ÌïòÎÇò Ïù¥ÏÉÅ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.");
            const selectedCohorts = Array.from(checkboxes).map(cb => cb.value);
            await runCohortAnalysis(selectedCohorts, 'cohort-res', '_main');
        }

        async function loadCohortComparison() {
            const checkboxes = document.querySelectorAll('#comp-check-list .co-checkbox:checked');
            const selectedCohorts = Array.from(checkboxes).map(cb => cb.value);

            if(selectedCohorts.length < 2 || selectedCohorts.length > 3) {
                return alert("ÎπÑÍµêÌï† ÏΩîÌò∏Ìä∏Î•º 2Í∞ú ÎòêÎäî 3Í∞ú ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
            }

            const container = document.getElementById('comp-res-area');
            container.innerHTML = '<div class="loader"></div> Î≤îÏúÑ Í≥ÑÏÇ∞ Ï§ë...'; 

            let globalLabels = [];
            let globalMaxSbp = 0;
            let globalMaxWt = 0;
            let globalMaxPod = 0;
            
            try {
                const ratSnaps = await Promise.all(selectedCohorts.map(c => db.collection("rats").where("cohort", "==", c).get()));
                let allRatIds = [];
                let surgeryMap = {}; 

                ratSnaps.forEach(snap => {
                    snap.forEach(d => {
                        const r = d.data();
                        allRatIds.push(r.ratId);
                        if(r.surgeryDate) surgeryMap[r.ratId] = r.surgeryDate;
                        if(r.surgeryDate && r.deathDate) {
                            const p = Math.floor((new Date(r.deathDate) - new Date(r.surgeryDate))/(1000*60*60*24));
                            if(p > globalMaxPod) globalMaxPod = p;
                        }
                    });
                });
                
                const measPromises = allRatIds.map(rid => db.collection("measurements").where("ratId", "==", rid).get());
                const measSnaps = await Promise.all(measPromises);

                const stdPodMap = { "D00": -999, "D0": -500, "D2": -300, "W1": 7, "W4": 28, "W8": 56, "W12": 84, "W20": 140 };
                const labelSet = new Set(Object.keys(stdPodMap)); 
                const tempColumns = [];

                Object.keys(stdPodMap).forEach(key => { tempColumns.push({ label: key, sortVal: stdPodMap[key] }); });

                const showAll = document.getElementById('comp-show-all-tp')?.checked;

                measSnaps.forEach((snap, idx) => {
                    const rid = allRatIds[idx];
                    const surgDate = surgeryMap[rid];

                    snap.forEach(doc => {
                        const d = doc.data();
                        if(d.sbp && d.sbp > globalMaxSbp) globalMaxSbp = d.sbp;
                        if(d.weight && d.weight > globalMaxWt) globalMaxWt = d.weight;
                        if (showAll && d.date && surgDate && !stdPodMap[d.timepoint]) {
                            if (!labelSet.has(d.date)) {
                                const diff = new Date(d.date) - new Date(surgDate);
                                const pod = Math.floor(diff / (1000 * 60 * 60 * 24));
                                labelSet.add(d.date);
                                tempColumns.push({ label: d.date, sortVal: pod });
                            }
                        }
                    });
                });

                tempColumns.sort((a,b) => a.sortVal - b.sortVal);
                const uniqueCols = [];
                const seen = new Set();
                tempColumns.forEach(c => { if(!seen.has(c.label)) { seen.add(c.label); uniqueCols.push(c); } });
                globalLabels = uniqueCols.map(c => c.label);

            } catch(e) { console.error("Scale calc error", e); }

            container.innerHTML = ''; 
            for(let i=0; i<selectedCohorts.length; i++) {
                const c = selectedCohorts[i];
                const colDiv = document.createElement('div');
                colDiv.className = 'comp-col';
                colDiv.id = `comp-res-${c}`;
                colDiv.innerHTML = `<h4>Cohort ${c}</h4><div class="loader"></div>`;
                container.appendChild(colDiv);
                await runCohortAnalysis([c], `comp-res-${c}`, `_comp_${c}`, {
                    labels: globalLabels,
                    maxSbp: globalMaxSbp,
                    maxWt: globalMaxWt,
                    maxPod: globalMaxPod
                });
            }
        }

        async function loadDetailData() {
            const id = document.getElementById('dt-rat-sel').value;
            const view = document.getElementById('detail-view');
            if(!id) return; 
            view.innerHTML = "Î°úÎî© Ï§ë...";
            try {
                const rSnap = await db.collection("rats").where("ratId", "==", id).get();
                if(rSnap.empty) { view.innerHTML = "Îì±Î°ùÎêòÏßÄ ÏïäÏùå"; return; }
                const rat = rSnap.docs[0].data();
                const docId = rSnap.docs[0].id;
                
                let baseDate = new Date();
                if(rat.status === 'ÏÇ¨Îßù' && rat.deathDate) { baseDate = new Date(rat.deathDate); }
                const dPlus = rat.arrivalDate ? Math.floor((baseDate - new Date(rat.arrivalDate))/(1000*60*60*24)) : '-';
                const pod = rat.surgeryDate ? Math.floor((baseDate - new Date(rat.surgeryDate))/(1000*60*60*24)) : '-';
                
                let deathInfo = '';
                if(rat.status === 'ÏÇ¨Îßù') {
                    const codText = rat.codFull ? `<br><span style="font-size:0.9rem; color:#d32f2f;">${rat.codFull}</span>` : '';
                    deathInfo = `<div class="info-item" style="grid-column: span 2; color:var(--red); border:1px solid var(--red); background:#ffebee;">
                        <b>ÏÇ¨Îßù: ${rat.deathDate||'ÎÇ†ÏßúÎØ∏ÏÉÅ'} (POD ${pod})</b>
                        <button class="btn btn-red btn-small" style="float:right; padding:2px 8px;" onclick="openCodFlow('${docId}')">ÏõêÏù∏ Í∏∞Î°ù</button>
                        ${codText}
                    </div>`;
                }

                let doseInfo = '';
                if(rat.doseStartDate) {
                    const doseDay = Math.floor((baseDate - new Date(rat.doseStartDate))/(1000*60*60*24));
                    doseInfo = `<div class="info-item"><b>Day ${doseDay}</b><br>Ìà¨ÏïΩ ÏãúÏûë(${rat.doseStartDate})</div>`;
                } else { doseInfo = `<div class="info-item" style="color:#ccc;">-</div>`; }

                view.innerHTML = `
                    <div class="card"><div style="display:flex; justify-content:space-between;"><h3>${id}</h3><span style="color:${rat.status==='ÏÉùÏ°¥'?'green':'red'}">${rat.status}</span></div>
                    <div class="info-grid">
                        <div class="info-item"><b>D+${dPlus}</b><br>Î∞òÏûÖ ÌõÑ</div>
                        <div class="info-item"><b>POD ${pod}</b><br>ÏàòÏà† ÌõÑ</div>
                        ${deathInfo}
                        ${doseInfo}
                    </div>
                    <div style="text-align:right;">
                        <div style="margin-bottom:5px;">
                            <label style="font-size:0.8rem; margin-right:5px;">ÏàòÏà†ÏùºÏûê</label><input type="date" id="surg-d" value="${rat.surgeryDate||''}"><button class="btn-small" onclick="upSurg('${docId}')">Ï†ÄÏû•</button>
                        </div>
                        <div>
                            <label style="font-size:0.8rem; margin-right:5px;">Ìà¨ÏïΩÏãúÏûë</label><input type="date" id="dose-start-d" value="${rat.doseStartDate||''}"><button class="btn-small" onclick="upDoseStart('${docId}')">Ï†ÄÏû•</button>
                        </div>
                    </div></div>
                    <div class="card"><h4>Îç∞ÏùºÎ¶¨</h4><div class="chart-area"><canvas id="dailyChart"></canvas></div>
                    <div style="margin-top:10px; text-align:center;"><button class="btn btn-blue btn-small" onclick="toggleDailyLog()">Detail ‚ñº</button></div>
                    <div id="daily-detail-table" style="display:none; margin-top:10px;"></div></div>
                    
                    <div class="card">
                        <h4>ÌòàÏïï/Ï≤¥Ï§ë</h4>
                        <div style="display:flex; justify-content:center; align-items:center; gap:15px; margin-bottom:10px; background:#f8f9fa; padding:8px; border-radius:8px;">
                            <label style="cursor:pointer; display:flex; align-items:center; font-weight:bold; color:var(--red);"><input type="checkbox" id="chk-sbp" checked onchange="renderBpChart()" style="margin-right:5px; width:auto; transform:scale(1.2);"> SBP</label>
                            <label style="cursor:pointer; display:flex; align-items:center; font-weight:bold; color:var(--green);"><input type="checkbox" id="chk-wt" checked onchange="renderBpChart()" style="margin-right:5px; width:auto; transform:scale(1.2);"> Weight</label>
                        </div>
                        <div class="chart-area"><canvas id="bpChart"></canvas></div>
                        <div style="margin-top:10px; text-align:center;"><button class="btn btn-blue btn-small" onclick="toggleBpLog()">Detail ‚ñº</button></div>
                        <div id="bp-detail-table" style="display:none; margin-top:10px;"></div>
                    </div>

                    <div class="card"><h4>Ìà¨ÏïΩ Ïù¥Î†•</h4><div id="dose-logs"></div></div>
                    <div class="card"><h4>Í∏∞Î°ù Î°úÍ∑∏</h4><div id="rec-logs"></div></div>`;

                const logs = await db.collection("dailyLogs").where("ratId", "==", id).get();
                let processedLogs = [];
                logs.forEach(doc => {
                    let v = doc.data();
                    let dStr = v.date.trim();
                    if(dStr.includes('.')) { const parts = dStr.split('.').map(s => s.trim()); if(parts.length >= 3) dStr = `${parts[0]}-${parts[1].padStart(2,'0')}-${parts[2].padStart(2,'0')}`; }
                    v.cleanDate = dStr;
                    processedLogs.push(v);
                });
                processedLogs.sort((a, b) => new Date(a.cleanDate) - new Date(b.cleanDate));
                
                const uniqueMap = {};
                processedLogs.forEach(log => { uniqueMap[log.cleanDate] = log; });
                const finalLogs = Object.values(uniqueMap).sort((a, b) => new Date(a.cleanDate) - new Date(b.cleanDate));
                const dLab=[], dVal=[], dNotes=[], pStyles=[], pSizes=[], pColors=[];
                let tableHtml = `<table><tr><th>ÎÇ†Ïßú</th><th>ÏãúÍ∞Ñ</th><th>Act</th><th>Fur</th><th>Eye</th><th>Ï¥ùÏ†ê</th><th>Î©îÎ™®</th></tr>`;
                finalLogs.forEach(v => { 
                    dLab.push(v.cleanDate); dVal.push(v.totalScore); 
                    if(v.note && v.note.trim()) { dNotes.push(v.note); pStyles.push('rectRot'); pSizes.push(8); pColors.push('#fdd835'); } 
                    else { dNotes.push(null); pStyles.push('circle'); pSizes.push(3); pColors.push('#1a237e'); }
                    tableHtml += `<tr><td>${v.cleanDate}</td><td>${v.timestamp || '-'}</td><td>${v.scores.activity}</td><td>${v.scores.fur}</td><td>${v.scores.eye}</td><td>${v.totalScore}</td><td style="text-align:left; max-width:200px; white-space:normal;">${v.note || ''}</td></tr>`;
                });
                tableHtml += `</table>`;
                document.getElementById('daily-detail-table').innerHTML = tableHtml;
                if(dVal.length) new Chart(document.getElementById('dailyChart'), { 
                    type:'line', 
                    data:{ labels: dLab, datasets:[{ label:'Score', data: dVal, borderColor:'#1a237e', pointStyle: pStyles, pointRadius: pSizes, pointBackgroundColor: pColors, pointBorderColor: pColors }] }, 
                    options:{ maintainAspectRatio:false, scales: { y: { min: 0, max: 17, ticks: { stepSize: 1 } } }, plugins:{ tooltip:{ callbacks:{ footer: (ti) => { const n = dNotes[ti[0].dataIndex]; if(!n) return ''; return ['üìù Î©îÎ™®:', ...n.match(/.{1,20}/g)]; } } } } } 
                });

                const ms = await db.collection("measurements").where("ratId", "==", id).get();
                const ds = await db.collection("doseLogs").where("ratId", "==", id).get();
                const dataMap = {};
                ms.forEach(doc => {
                    const v = doc.data();
                    const date = v.date;
                    if (!dataMap[date]) dataMap[date] = { date: date, label: v.timepoint || date, sbp: null, dbp: null, mean: null, wt: null };
                    if (v.sbp) dataMap[date].sbp = v.sbp;
                    if (v.dbp) dataMap[date].dbp = v.dbp;
                    if (v.mean) dataMap[date].mean = v.mean;
                    if (v.weight) dataMap[date].wt = v.weight;
                    if (v.timepoint && !dataMap[date].label.includes('W') && v.timepoint.includes('W')) dataMap[date].label = v.timepoint; 
                });
                ds.forEach(doc => {
                    const v = doc.data();
                    const date = v.date;
                    if (!dataMap[date]) dataMap[date] = { date: date, label: date, sbp: null, dbp: null, mean: null, wt: null };
                    if (v.weight) dataMap[date].wt = v.weight;
                });
                globalBpData = Object.values(dataMap).sort((a,b) => new Date(a.date) - new Date(b.date));
                renderBpChart(); 

                let bpTable = '<table><tr><th>ÎÇ†Ïßú</th><th>ÏãúÏ†ê</th><th>SBP</th><th>DBP</th><th>Mean</th><th>WT</th></tr>';
                [...globalBpData].reverse().forEach(v => { bpTable += `<tr><td>${v.date}</td><td>${v.label}</td><td>${v.sbp||'-'}</td><td>${v.dbp||'-'}</td><td>${v.mean||'-'}</td><td>${v.wt||'-'}</td></tr>`; });
                bpTable += '</table>';
                document.getElementById('bp-detail-table').innerHTML = bpTable;

                let dHtml='<table><tr><th>ÎÇ†Ïßú</th><th>WT(g)</th><th>Drug(mg)</th><th>Vol(ml)</th></tr>';
                const revDs = ds.docs.sort((a,b)=>new Date(b.data().date)-new Date(a.data().date));
                if(revDs.length) { revDs.slice(0,5).forEach(d=>{const v=d.data(); const mg=v.doseMg?v.doseMg:((v.weight/1000)*4*1.15).toFixed(3); dHtml+=`<tr><td>${v.date}</td><td>${v.weight}</td><td>${Number(mg).toFixed(2)}</td><td>${v.volMl.toFixed(2)}</td></tr>`;}); document.getElementById('dose-logs').innerHTML=dHtml+'</table>'; }
                else document.getElementById('dose-logs').innerHTML='Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå';

                let rHtml='<table><tr><th>ÎÇ†Ïßú</th><th>ÏãúÏ†ê</th><th>SBP</th><th>WT</th></tr>';
                const sortedMs = ms.docs.map(d=>d.data()).sort((a,b)=>new Date(b.date)-new Date(a.date));
                sortedMs.slice(0,5).forEach(v=>{rHtml+=`<tr><td>${v.date}</td><td>${v.timepoint||'-'}</td><td>${v.sbp||'-'}</td><td>${v.weight||'-'}</td></tr>`;});
                document.getElementById('rec-logs').innerHTML = rHtml+'</table>';
            } catch(e) { console.error(e); }
        }

        function renderBpChart() {
            if (bpChartInstance) bpChartInstance.destroy();
            const showSbp = document.getElementById('chk-sbp').checked;
            const showWt = document.getElementById('chk-wt').checked;
            const ctx = document.getElementById('bpChart');
            const datasets = [];
            if (showSbp) { datasets.push({ label: 'SBP', data: globalBpData.map(d => d.sbp), borderColor: '#d32f2f', yAxisID: 'y', spanGaps: true }); }
            if (showWt) { datasets.push({ label: 'WT', data: globalBpData.map(d => d.wt), borderColor: '#00c853', yAxisID: 'y1', spanGaps: true }); }

            bpChartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: globalBpData.map(d => (d.label && d.label !== d.date) ? `${d.date} (${d.label})` : d.date), datasets: datasets },
                options: { maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, scales: { y: { position: 'left', display: showSbp }, y1: { position: 'right', display: showWt, grid: { drawOnChartArea: false } } } }
            });
        }

        async function checkRatValid(id) {
            try {
                const s = await db.collection("rats").where("ratId", "==", id).get();
                if (s.empty) { alert(`[${id}] Îì±Î°ùÎêòÏßÄ ÏïäÏùÄ Îû´ÎìúÏûÖÎãàÎã§.`); return null; }
                const data = s.docs[0].data();
                if (data.status === 'ÏÇ¨Îßù') { alert(`[${id}] Ïù¥ÎØ∏ ÏÇ¨ÎßùÌïú Í∞úÏ≤¥ÏûÖÎãàÎã§. Îç∞Ïù¥ÌÑ∞Î•º Ï∂îÍ∞Ä/ÏàòÏ†ïÌï† Ïàò ÏóÜÏäµÎãàÎã§.`); return null; }
                return s.docs[0];
            } catch(e) { console.error(e); alert("Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏ Ï§ë Ïò§Î•ò Î∞úÏÉù"); return null; }
        }

        async function upDoseStart(did) {
            const doc = await db.collection("rats").doc(did).get();
            if(doc.exists) { const ratId = doc.data().ratId; if(!(await checkRatValid(ratId))) return; }
            await db.collection("rats").doc(did).update({ doseStartDate: document.getElementById('dose-start-d').value });
            alert("Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§."); loadDetailData();
        }
        
        async function upSurg(did) { 
            const doc = await db.collection("rats").doc(did).get();
            if(doc.exists) { const ratId = doc.data().ratId; if(!(await checkRatValid(ratId))) return; }
            await db.collection("rats").doc(did).update({ surgeryDate: document.getElementById('surg-d').value }); 
            alert("Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§."); loadDetailData(); 
        }

        function toggleDailyLog() { const t = document.getElementById('daily-detail-table'); t.style.display = t.style.display === 'none' ? 'block' : 'none'; }
        function toggleBpLog() { const t = document.getElementById('bp-detail-table'); t.style.display = t.style.display === 'none' ? 'block' : 'none'; }

        async function loadDashboard() { 
            try { 
                const snap = await db.collection("rats").orderBy("ratId").get(); 
                if(snap.empty) { document.getElementById('dash-container').innerHTML = "<p>Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</p>"; return; } 
                
                const memoSnap = await db.collection("cohortNotes").get();
                const noteData = {};
                memoSnap.forEach(d => noteData[d.id] = d.data());

                const grp = {}; 
                snap.forEach(doc => { 
                    const d = doc.data(); 
                    if(!grp[d.cohort]) grp[d.cohort] = { rats: [], surg: d.surgeryDate || null }; 
                    grp[d.cohort].rats.push(d); 
                }); 
                
                let html = '<div style="width:100%; text-align:right; color:#666; font-size:0.85rem; margin-bottom:10px;"><i class="material-icons" style="font-size:1rem; vertical-align:text-bottom;">touch_app</i> ÏßÑÌñâÏ§ëÏù∏ ÏΩîÌò∏Ìä∏-ratÎ≤àÌò∏Î•º ÎàÑÎ•¥ÏãúÎ©¥ ÏÉÅÏÑ∏Î≥¥Í∏∞Î°ú ÎÑòÏñ¥Í∞ëÎãàÎã§.</div>'; 
                
                Object.keys(grp).sort((a,b)=>Number(b)-Number(a)).forEach(c => { 
                    let podTag = `<span style="font-size:0.8rem; color:#888;">ÏàòÏà†Ï†Ñ</span>`; 
                    if(grp[c].surg) { 
                        const pod = Math.floor((new Date() - new Date(grp[c].surg))/(1000*60*60*24)); 
                        const w = Math.floor(pod/7), d=pod%7; 
                        podTag = `<span class="d-day-badge">W${w}+${d} (POD ${pod})</span>`; 
                    } 
                    const cData = noteData[c] || {};
                    const currentMemo = cData.memo || "";
                    const mrChecks = cData.mrChecks || {}; 
                    const memoHtml = `<div class="co-memo-box"><i class="material-icons edit-icon" onclick="toggleCoMemo('${c}')">edit</i><span id="memo-txt-${c}" class="memo-text">${currentMemo || ''}</span><div id="memo-edit-area-${c}" style="display:none;"><input type="text" id="memo-inp-${c}" class="co-memo-input" value="${currentMemo}"><button class="btn-small btn-blue" style="padding:2px 8px; margin-left:5px;" onclick="saveCoMemo('${c}')">OK</button></div></div>`;
                    
                    const timepoints = ['D0','D2','W1','W4','W8','W12','W20'];
                    let mrHtml = `<div class="mr-check-group"><span style="font-weight:bold; color:var(--navy); margin-right:4px;">MR:</span>`;
                    timepoints.forEach(tp => {
                        const isChecked = mrChecks[tp] ? 'checked' : '';
                        mrHtml += `<label><input type="checkbox" onclick="toggleMr(event, '${c}', '${tp}')" ${isChecked}>${tp}</label>`;
                    });
                    mrHtml += `</div>`;
                    html += `<div class="card"><div class="cohort-header"><div style="display:flex; align-items:center; flex-wrap:wrap; gap:5px;"><span style="font-weight:bold; font-size:1.1rem; color:var(--navy);">Cohort ${c}</span>${memoHtml}${mrHtml}</div>${podTag}</div><div class="rat-grid">`; 
                    grp[c].rats.forEach(r => { 
                        let statusClass = 'rat-badge'; 
                        if(r.status === 'ÏÇ¨Îßù') statusClass += ' status-dead'; 
                        else if(r.lastScore) { if(r.lastScore >= 13) statusClass += ' status-normal'; else if(r.lastScore >= 9) statusClass += ' status-mild'; else statusClass += ' status-severe'; } 
                        html += `<div class="${statusClass}" onclick="goToDetail('${r.ratId}')">${r.num}</div>`; 
                    }); 
                    html += `</div></div>`; 
                }); 
                document.getElementById('dash-container').innerHTML = html; 
            } catch(e) { document.getElementById('dash-container').innerHTML = `<p style="color:red">${e.message}</p>`; } 
        }

        async function toggleMr(e, c, tp) {
            e.stopPropagation(); 
            if(!confirm(`[Cohort ${c}] ${tp} ÏãúÏ†êÏùò MR Ï¥¨ÏòÅ Ïó¨Î∂ÄÎ•º Î≥ÄÍ≤ΩÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) { e.preventDefault(); return; }
            const val = e.target.checked;
            try { await db.collection("cohortNotes").doc(c).set({ mrChecks: { [tp]: val } }, { merge: true }); } catch(err) { console.error(err); alert("Ï†ÄÏû• Ïã§Ìå®"); e.preventDefault(); }
        }

        function toggleCoMemo(c) {
            const txt = document.getElementById(`memo-txt-${c}`);
            const area = document.getElementById(`memo-edit-area-${c}`);
            if(area.style.display === 'none') { area.style.display = 'inline-block'; txt.style.display = 'none'; } else { area.style.display = 'none'; txt.style.display = 'inline-block'; }
        }

        async function saveCoMemo(c) {
            const val = document.getElementById(`memo-inp-${c}`).value;
            await db.collection("cohortNotes").doc(c).set({ memo: val }, { merge: true }); 
            document.getElementById(`memo-txt-${c}`).innerText = val;
            toggleCoMemo(c);
        }

        async function deleteRat() { const id=document.getElementById('del-id').value; if(!id||!confirm("ÏÇ≠Ï†ú?"))return; (await db.collection("rats").where("ratId","==",id).get()).forEach(d=>d.ref.delete()); ["dailyLogs","doseLogs","measurements"].forEach(async c=>(await db.collection(c).where("ratId","==",id).get()).forEach(d=>d.ref.delete())); alert("ÏÇ≠Ï†úÎê®"); }
        async function deleteCohort() { const c=document.getElementById('del-cohort').value; if(!c||!confirm("Ï†ÑÏ≤¥ÏÇ≠Ï†ú?"))return; (await db.collection("rats").where("cohort","==",c).get()).forEach(d=>d.ref.delete()); alert("ÏÇ≠Ï†úÎê®(Î°úÍ∑∏Ï†úÏô∏)"); } 
        function goToDetail(ratId) { go('detail', ratId); }
        function score(k, n, btn) { btn.parentElement.querySelectorAll('.rate-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); currentScores[k] = n; const t = currentScores.act+currentScores.fur+currentScores.eye; document.getElementById('score-res').innerText=`Ï¥ùÏ†ê: ${t}Ï†ê`; }
        function mkId(p) { const c=document.getElementById(`${p}-c`).value, r=document.getElementById(`${p}-r`).value; if(c&&r) document.getElementById(`${p}-id`).value = `C${c.padStart(2,'0')}${r.padStart(2,'0')}`; }
        function calM() { const s=Number(document.getElementById('re-s').value), d=Number(document.getElementById('re-d').value); if(s&&d) document.getElementById('re-m').value = Math.round(d+(s-d)/3); }
        async function saveBulk() { const c=document.getElementById('add-c').value, s=Number(document.getElementById('add-s').value), e=Number(document.getElementById('add-e').value), d=document.getElementById('add-d').value; for(let i=s; i<=e; i++) { await db.collection("rats").add({ratId:`C${c.padStart(2,'0')}${String(i).padStart(2,'0')}`, cohort:c, num:String(i), arrivalDate:d, status:'ÏÉùÏ°¥'}); } alert("ÏôÑÎ£å"); }
        function upDose() { const ns=document.getElementsByClassName('dn'), c=document.getElementById('ds-c').value; for(let i=0; i<ns.length; i++) document.getElementsByClassName('di')[i].innerText = (c&&ns[i].value)?`C${c.padStart(2,'0')}${ns[i].value.padStart(2,'0')}`:'-'; }
        
        async function saveDaily() {
            const id = document.getElementById('dc-id').value;
            const date = document.getElementById('dc-date').value;
            if(!id || !date) return alert("IDÏôÄ ÎÇ†ÏßúÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî");
            
            if(!(await checkRatValid(id))) return;
            const note = document.getElementById('dc-note').value;
            const dead = document.getElementById('is-dead').checked;
            const total = currentScores.act + currentScores.fur + currentScores.eye;

            if (!dead && (currentScores.act === 0 || currentScores.fur === 0 || currentScores.eye === 0)) { alert("Activity, Fur, Eye Ï†êÏàòÎ•º Î™®Îëê ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî."); return; }
            try {
                await db.collection("dailyLogs").add({ ratId: id, date: date, timestamp: new Date().toLocaleTimeString(), scores: { ...currentScores }, totalScore: total, note: note, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                const rSnap = await db.collection("rats").where("ratId", "==", id).get();
                if(!rSnap.empty) { if(dead) { await rSnap.docs[0].ref.update({ status: 'ÏÇ¨Îßù', deathDate: date }); } else { await rSnap.docs[0].ref.update({ lastScore: total }); } }
                alert("Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.");
                document.getElementById('dc-note').value = '';
                document.getElementById('is-dead').checked = false;
            } catch(e) { console.error(e); alert("ÏóêÎü¨: " + e.message); }
        }

        async function saveDose() { 
            const c = document.getElementById('ds-c').value;
            const ws = document.getElementsByClassName('dw');
            const is = document.getElementsByClassName('di');
            
            let cnt = 0; let indivList = ''; let tMg = 0; let tVol = 0;
            try {
                for(let i=0; i<ws.length; i++) { 
                    if(ws[i].value && is[i].innerText!=='-') { 
                        const ratId = is[i].innerText;
                        if(!(await checkRatValid(ratId))) continue; 
                        const w = Number(ws[i].value); const mg = (w/1000)*4*1.15; const vol = mg/2.5;        
                        tMg += mg; tVol += vol; cnt++;
                        indivList += `<div style="padding:4px 0; border-bottom:1px solid #eee; display:flex; justify-content:space-between;"><span>${ratId}</span><span style="font-weight:bold;">${vol.toFixed(2)} ml</span></div>`;
                        await db.collection("doseLogs").add({ ratId:ratId, cohort:c, weight:w, doseMg:mg, volMl:vol, date:new Date().toISOString().split('T')[0] }); 
                    } 
                }
                if(cnt) {
                    const resBox = document.getElementById('dose-res');
                    resBox.style.display = 'block'; 
                    resBox.innerHTML = `<div style="margin-bottom:20px;"><h4 style="color:var(--navy); margin-bottom:10px;">üìä Ïò§Îäò ÏÜåÎ∂Ñ Ïö©Îüâ</h4><div style="background:white; padding:10px; border-radius:8px; border:1px solid #eee;">${indivList}</div></div><div style="background:#e8f5e9; padding:15px; border-radius:8px; border:1px solid #c8e6c9;"><h4 style="color:#2e7d32; margin:0 0 10px 0;">üß™ Ïò§Îäò Ï§ÄÎπÑÎüâ</h4><div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>ÏïΩÎ¨º Ï¥ùÎüâ:</span><b>${tMg.toFixed(2)} mg</b></div><div style="display:flex; justify-content:space-between;"><span>Ïö©Ïï° Ï¥ùÎüâ:</span><b>${tVol.toFixed(2)} ml</b></div></div>`;
                    alert("Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.");
                } else { alert("Ïú†Ìö®Ìïú ÏûÖÎ†• Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§."); }
            } catch(e) { console.error(e); alert("Ï†ÄÏû• Ï§ë Ïò§Î•ò Î∞úÏÉù: " + e.message); }
        }
        
        async function saveRec() { 
            const id=document.getElementById('re-id').value; 
            if(!(await checkRatValid(id))) return;
            const sbp = Number(document.getElementById('re-s').value); const dbp = Number(document.getElementById('re-d').value); const mean = Number(document.getElementById('re-m').value); const wt = Number(document.getElementById('re-w').value);
            await db.collection("measurements").add({ ratId:id, sbp: sbp, dbp: dbp, mean: mean, weight: wt, date:document.getElementById('re-date').value, timepoint:document.getElementById('re-tp').value }); 
            alert("Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§."); 
        }

        let bpAllData = [];
        function loadBPFiles(e) {
            bpAllData = [];
            const files = Array.from(e.target.files);
            const mode = document.querySelector('input[name="bp-mode"]:checked').value;
            let loaded = 0;
            files.forEach(file => { const reader = new FileReader(); reader.onload = () => { parseBPCSV(reader.result, file.name); loaded++; if (loaded === files.length) analyzeBP(mode); }; reader.readAsText(file); });
        }

        function parseBPCSV(text, filename) {
            const rows = text.trim().split("\n").map(r => r.split(","));
            const header = rows.shift();
            const idx = n => header.indexOf(n);
            rows.forEach(r => {
                if (r.length < 5) return; 
                bpAllData.push({ file: filename, time: r[idx("Time")], specimen: r[idx("Specimen Name")], regular: r[idx("Regular Cycle")] === "True", accepted: r[idx("Accepted")] === "True", sbp: Number(r[idx("Systolic")]), dbp: Number(r[idx("Diastolic")]), mean: Number(r[idx("Mean")]), volume: Number(r[12]) });
            });
        }

        function analyzeBP(mode) {
            const output = document.getElementById("bp-output");
            output.innerHTML = "";
            const grouped = {};
            bpAllData.forEach(r => {
                const match = r.specimen.match(/\(([^)]+)\)/);
                const ratId = match ? match[1].trim() : r.specimen.trim();
                if (!grouped[ratId]) grouped[ratId] = {};
                if (!grouped[ratId][r.file]) grouped[ratId][r.file] = [];
                grouped[ratId][r.file].push(r);
            });

            Object.keys(grouped).sort().forEach(ratId => {
                const box = document.createElement("div");
                box.className = "bp-rat-box";
                box.innerHTML = `<div class="bp-rat-title">üêÄ Í∞úÏ≤¥ ID: ${ratId}</div>`;
                const table = document.createElement("table");
                table.innerHTML = `<tr><th>File</th><th>n</th><th>SBP</th><th>DBP</th><th>Mean</th><th>Volume</th><th>Í≤ÄÏ¶ù</th></tr>`;

                Object.entries(grouped[ratId]).forEach(([file, rows], idx) => {
                    const valid = rows.filter(r => r.regular && r.accepted);
                    if (valid.length === 0) return;
                    const sbps = valid.map(r => r.sbp);
                    const maxSBP = Math.max(...sbps);
                    const minSBP = Math.min(...sbps);
                    const judged = rows.map(r => {
                        let reason = "‚úÖ Accepted";
                        if (!r.regular || !r.accepted) { reason = "‚ùå Regular/Accepted"; } 
                        else if (r.sbp === maxSBP) { reason = "‚ùå SBP = MAX (set)"; } 
                        else if (r.sbp === minSBP) { reason = "‚ùå SBP = MIN (set)"; } 
                        else {
                            const diff = r.sbp - r.dbp;
                            if (mode === "control" && (diff < 20 || diff > 60)) reason = "‚ùå Pulse diff";
                            if (mode === "induction" && (diff < 25 || diff > 80)) reason = "‚ùå Pulse diff";
                        }
                        return { ...r, reason };
                    });
                    const passed = judged.filter(r => r.reason === "‚úÖ Accepted");
                    if (passed.length === 0) return;
                    const avgFloor = key => Math.floor(passed.reduce((s, r) => s + r[key], 0) / passed.length);
                    const logId = `bp_log_${ratId.replace(/[^a-z0-9]/gi, '_')}_${idx}`;
                    table.innerHTML += `<tr><td style="color:#e67e22; font-weight:500;">${file}</td><td>${passed.length}</td><td>${avgFloor("sbp")}</td><td>${avgFloor("dbp")}</td><td>${avgFloor("mean")}</td><td>${avgFloor("volume")}</td><td><button class="bp-toggle-btn" onclick="toggleBPLog('${logId}')">ÏÇ¨Ïù¥ÌÅ¥ Î°úÍ∑∏</button></td></tr><tr id="${logId}" style="display:none;"><td colspan="7"><table class="bp-log-table"><tr><th>Time</th><th>SBP</th><th>DBP</th><th>Mean</th><th>Volume</th><th>ÌåêÏ†ï</th></tr>${judged.map(r => `<tr><td>${r.time}</td><td>${r.sbp}</td><td>${r.dbp}</td><td>${r.mean}</td><td>${r.volume}</td><td>${r.reason}</td></tr>`).join("")}</table></td></tr>`;
                });
                box.appendChild(table);
                output.appendChild(box);
            });
        }
        function toggleBPLog(id) { const el = document.getElementById(id); el.style.display = el.style.display === "none" ? "table-row" : "none"; }

        function admTab(mode) {
            document.querySelectorAll('.tab-container .tab').forEach(t => t.classList.remove('active'));
            const btn = document.getElementById('adm-' + mode);
            if(btn) btn.classList.add('active');
            ['del', 'edit', 'imp'].forEach(m => {
                const el = document.getElementById('tab-' + m);
                if(el) el.style.display = (m === mode) ? 'block' : 'none';
            });
        }

        function uploadDailyLogs() {
            alert("CSV ÏóÖÎ°úÎìú Í∏∞Îä•ÏùÄ ÌòÑÏû¨ Ï§ÄÎπÑÏ§ëÏûÖÎãàÎã§.");
        }

        // ==============================================================
        //  ÌÜµÌï© Îç∞Ïù¥ÌÑ∞ ÏàòÏ†ï Í∏∞Îä• (ADMIN - EDIT)
        // ==============================================================
        
        async function searchForEdit() {
            const id = document.getElementById('edit-id').value.trim();
            if(!id) return alert("IDÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî");
            
            const resDiv = document.getElementById('edit-result');
            resDiv.innerHTML = '<div class="loader"></div> Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...';

            try {
                // 1. Î™®Îì† Í¥ÄÎ†® Îç∞Ïù¥ÌÑ∞ Î≥ëÎ†¨ Ï°∞Ìöå
                const ratQ = db.collection("rats").where("ratId", "==", id).get();
                const dailyQ = db.collection("dailyLogs").where("ratId", "==", id).orderBy("date").get();
                const measQ = db.collection("measurements").where("ratId", "==", id).orderBy("date").get();
                
                const [rSnap, dSnap, mSnap] = await Promise.all([ratQ, dailyQ, measQ]);

                if(rSnap.empty) { resDiv.innerHTML = "Ìï¥Îãπ IDÏùò Îû´ÎìúÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§."; return; }
                
                const ratDoc = rSnap.docs[0];
                const rData = ratDoc.data();
                
                // HTML ÌÖúÌîåÎ¶ø Íµ¨ÏÑ±
                let html = `
                <div class="edit-container">
                    <h3 style="color:var(--navy); border-bottom:2px solid var(--navy); padding-bottom:10px;">
                        üìù ÌÜµÌï© Îç∞Ïù¥ÌÑ∞ ÏàòÏ†ï (${rData.ratId})
                    </h3>
                    
                    <div class="edit-section-title">Í∏∞Î≥∏ Ï†ïÎ≥¥</div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div class="input-group">
                            <label>ÏÉÅÌÉú (Status)</label>
                            <select id="ed-status" style="padding:5px;">
                                <option value="ÏÉùÏ°¥" ${rData.status==='ÏÉùÏ°¥'?'selected':''}>ÏÉùÏ°¥</option>
                                <option value="ÏÇ¨Îßù" ${rData.status==='ÏÇ¨Îßù'?'selected':''}>ÏÇ¨Îßù</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>ÏÇ¨Îßù ÏõêÏù∏ (COD)</label>
                            <div style="display:flex; gap:5px;">
                                <input type="text" id="ed-cod-display" value="${rData.codFull || ''}" readonly style="background:#f1f3f5;">
                                <button class="btn btn-blue btn-small" onclick="openCodFlow(null, 'ed-cod-display')">ÏÑ†ÌÉù</button>
                            </div>
                        </div>
                        <div class="input-group"><label>Î∞òÏûÖÏùº</label><input type="date" id="ed-arrival" value="${rData.arrivalDate||''}"></div>
                        <div class="input-group"><label>ÏàòÏà†Ïùº</label><input type="date" id="ed-surgery" value="${rData.surgeryDate||''}"></div>
                        <div class="input-group"><label>Ìà¨ÏïΩÏãúÏûëÏùº</label><input type="date" id="ed-dose-start" value="${rData.doseStartDate||''}"></div>
                        <div class="input-group"><label>ÏÇ¨ÎßùÏùº</label><input type="date" id="ed-death" value="${rData.deathDate||''}"></div>
                    </div>

                    <div class="edit-section-title">
                        ÌòàÏïï Î∞è Ï≤¥Ï§ë Í∏∞Î°ù (Measurements) 
                        <button class="btn btn-blue btn-small" style="float:right;" onclick="addTableRow('meas-tbody')">+ Ìñâ Ï∂îÍ∞Ä</button>
                    </div>
                    <table class="full-edit-table">
                        <thead><tr><th>ÎÇ†Ïßú</th><th>ÏãúÏ†ê</th><th>SBP</th><th>WT(g)</th><th>ÏÇ≠Ï†ú</th></tr></thead>
                        <tbody id="meas-tbody">`;
                
                mSnap.forEach(doc => {
                    const d = doc.data();
                    html += `<tr data-id="${doc.id}" data-coll="measurements">
                        <td><input type="date" class="row-date" value="${d.date}"></td>
                        <td><input type="text" class="row-tp" value="${d.timepoint||''}"></td>
                        <td><input type="number" class="row-sbp" value="${d.sbp||''}"></td>
                        <td><input type="number" class="row-wt" value="${d.weight||''}"></td>
                        <td><button class="del-btn" onclick="markRowDel(this)">ÏÇ≠Ï†ú</button></td>
                    </tr>`;
                });
                html += `</tbody></table>

                    <div class="edit-section-title">
                        Îç∞ÏùºÎ¶¨ Ï≤¥ÌÅ¨ (Daily Logs)
                        <button class="btn btn-blue btn-small" style="float:right;" onclick="addTableRow('daily-tbody')">+ Ìñâ Ï∂îÍ∞Ä</button>
                    </div>
                    <table class="full-edit-table">
                        <thead><tr><th>ÎÇ†Ïßú</th><th>Act</th><th>Fur</th><th>Eye</th><th>Memo</th><th>ÏÇ≠Ï†ú</th></tr></thead>
                        <tbody id="daily-tbody">`;
                
                dSnap.forEach(doc => {
                    const d = doc.data();
                    html += `<tr data-id="${doc.id}" data-coll="dailyLogs">
                        <td><input type="date" class="row-date" value="${d.date}"></td>
                        <td><input type="number" class="row-act" value="${d.scores?.activity||0}" style="width:40px"></td>
                        <td><input type="number" class="row-fur" value="${d.scores?.fur||0}" style="width:40px"></td>
                        <td><input type="number" class="row-eye" value="${d.scores?.eye||0}" style="width:40px"></td>
                        <td><input type="text" class="row-note" value="${d.note||''}"></td>
                        <td><button class="del-btn" onclick="markRowDel(this)">ÏÇ≠Ï†ú</button></td>
                    </tr>`;
                });
                html += `</tbody></table>
                    
                    <div style="height:60px;"></div> <button class="btn btn-green float-save-btn" onclick="saveTotalEdit('${ratDoc.id}')">üíæ Ï†ÑÏ≤¥ Ï†ÄÏû• (Save All)</button>
                </div>`;

                resDiv.innerHTML = html;

            } catch(e) {
                console.error(e);
                resDiv.innerHTML = `<p style="color:red">Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ï§ë Ïò§Î•ò: ${e.message}</p>`;
            }
        }

        // Ìñâ ÏÇ≠Ï†ú ÌëúÏãú Ìï®Ïàò
        function markRowDel(btn) {
            const row = btn.closest('tr');
            if(row.classList.contains('row-del')) {
                row.classList.remove('row-del');
                btn.innerText = 'ÏÇ≠Ï†ú';
                btn.style.background = 'var(--red)';
            } else {
                row.classList.add('row-del');
                btn.innerText = 'Î≥µÍµ¨';
                btn.style.background = 'gray';
            }
        }

        // Ìñâ Ï∂îÍ∞Ä Ìï®Ïàò
        function addTableRow(tbodyId) {
            const tbody = document.getElementById(tbodyId);
            const tr = document.createElement('tr');
            tr.dataset.isNew = "true"; // Ïã†Í∑ú Ìñâ ÌëúÏãú
            
            if(tbodyId === 'meas-tbody') {
                tr.dataset.coll = "measurements";
                tr.innerHTML = `
                    <td><input type="date" class="row-date" value="${getTodayStr()}"></td>
                    <td><input type="text" class="row-tp" placeholder="W1.."></td>
                    <td><input type="number" class="row-sbp" placeholder="SBP"></td>
                    <td><input type="number" class="row-wt" placeholder="WT"></td>
                    <td><button class="del-btn" onclick="this.closest('tr').remove()">Ï∑®ÏÜå</button></td>`;
            } else if(tbodyId === 'daily-tbody') {
                tr.dataset.coll = "dailyLogs";
                tr.innerHTML = `
                    <td><input type="date" class="row-date" value="${getTodayStr()}"></td>
                    <td><input type="number" class="row-act" value="0"></td>
                    <td><input type="number" class="row-fur" value="0"></td>
                    <td><input type="number" class="row-eye" value="0"></td>
                    <td><input type="text" class="row-note" placeholder="Î©îÎ™®"></td>
                    <td><button class="del-btn" onclick="this.closest('tr').remove()">Ï∑®ÏÜå</button></td>`;
            }
            tbody.insertBefore(tr, tbody.firstChild);
        }

        async function saveTotalEdit(ratDocId) {
            if(!confirm("Î™®Îì† Î≥ÄÍ≤ΩÏÇ¨Ìï≠ÏùÑ Ï†ÄÏû•ÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) return;
            
            const batch = db.batch();
            const ratRef = db.collection("rats").doc(ratDocId);
            
            // 1. Í∏∞Î≥∏ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
            const codVal = document.getElementById('ed-cod-display').value;

            batch.update(ratRef, {
                status: document.getElementById('ed-status').value,
                codFull: codVal,
                arrivalDate: document.getElementById('ed-arrival').value,
                surgeryDate: document.getElementById('ed-surgery').value,
                doseStartDate: document.getElementById('ed-dose-start').value,
                deathDate: document.getElementById('ed-death').value
            });

            // 2. ÌÖåÏù¥Î∏î Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨ (Measurements & DailyLogs)
            const tables = ['meas-tbody', 'daily-tbody'];
            const ratIdStr = document.getElementById('edit-id').value; // ÌôîÎ©¥ ÏÉÅÎã® Í≤ÄÏÉâÏ∞ΩÏùò ID ÏÇ¨Ïö©

            tables.forEach(tbodyId => {
                const rows = document.querySelectorAll(`#${tbodyId} tr`);
                rows.forEach(row => {
                    const coll = row.dataset.coll;
                    const docId = row.dataset.id;
                    const isDel = row.classList.contains('row-del');
                    const isNew = row.dataset.isNew === "true";

                    // Í≥µÌÜµ ÌïÑÎìú
                    const date = row.querySelector('.row-date').value;

                    if (isDel && !isNew) {
                        // Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú
                        const ref = db.collection(coll).doc(docId);
                        batch.delete(ref);
                    } else if (!isDel) {
                        // Îç∞Ïù¥ÌÑ∞ Íµ¨ÏÑ±
                        let data = {};
                        if (coll === 'measurements') {
                            const sbp = row.querySelector('.row-sbp').value;
                            const wt = row.querySelector('.row-wt').value;
                            const tp = row.querySelector('.row-tp').value;
                            if(!date) return; // ÎÇ†Ïßú ÏóÜÏúºÎ©¥ Ïä§ÌÇµ
                            data = {
                                ratId: ratIdStr, date: date, timepoint: tp,
                                sbp: sbp ? Number(sbp) : null,
                                weight: wt ? Number(wt) : null
                            };
                        } else if (coll === 'dailyLogs') {
                            const act = Number(row.querySelector('.row-act').value);
                            const fur = Number(row.querySelector('.row-fur').value);
                            const eye = Number(row.querySelector('.row-eye').value);
                            const note = row.querySelector('.row-note').value;
                            if(!date) return;
                            data = {
                                ratId: ratIdStr, date: date,
                                scores: { activity: act, fur: fur, eye: eye },
                                totalScore: act + fur + eye,
                                note: note
                            };
                        }

                        if (isNew) {
                            // Ïã†Í∑ú ÏÉùÏÑ±
                            const newRef = db.collection(coll).doc();
                            batch.set(newRef, data);
                        } else {
                            // Í∏∞Ï°¥ ÏóÖÎç∞Ïù¥Ìä∏
                            const ref = db.collection(coll).doc(docId);
                            batch.update(ref, data);
                        }
                    }
                });
            });

            try {
                await batch.commit();
                alert("ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.");
                searchForEdit(); // ÌôîÎ©¥ Í∞±Ïã†
            } catch(e) {
                console.error(e);
                alert("Ï†ÄÏû• Ï§ë Ïò§Î•ò Î∞úÏÉù: " + e.message);
            }
        }

        // ==============================================================
        //  COD Flow (3-Step Hierarchical Selection)
        // ==============================================================

        function openCodFlow(docId, inputId = null) {
            // Reset state
            codTargetDocId = docId;
            codTargetInputId = inputId;
            codTempData = { type: '', secondary: '', causes: [] };
            
            // Clear checks
            document.querySelectorAll('input[name="cod-check"]').forEach(cb => cb.checked = false);

            document.getElementById('cod-modal').style.display = 'flex';
            showCodStep(1);
        }

        function closeCod() {
            document.getElementById('cod-modal').style.display = 'none';
        }

        function showCodStep(step) {
            document.querySelectorAll('.cod-step-container').forEach(el => el.classList.remove('active'));
            // step can be '1', '2-neuro', '2-non-neuro', '3'
            document.getElementById(`cod-step-${step}`).classList.add('active');
        }

        function selectCodType(type) {
            codTempData.type = type;
            if(type === 'Neurological') {
                showCodStep('2-neuro');
            } else {
                showCodStep('2-non-neuro');
            }
        }

        // Neuro Path
        function selectCodAn(anStatus) {
            codTempData.secondary = anStatus;
            showCodStep(3);
        }

        // Non-Neuro Path
        function selectCodNonNeuroCause(cause) {
            // For Non-Neuro, secondary is the cause (Unknown or Surgical Failure)
            codTempData.secondary = cause;
            // No Step 3. Save immediately.
            codTempData.causes = []; // Empty causes means no 3rd level
            saveCodFinal();
        }

        function codBack(toStep) {
            // toStep: 1, 'neuro-2', etc.
            if(toStep === 1) showCodStep(1);
            else if(toStep === 'neuro-2') showCodStep('2-neuro');
        }

        async function saveCodFinal() {
            // If Neuro path, collect checkboxes
            if(codTempData.type === 'Neurological') {
                const checkedBoxes = document.querySelectorAll('input[name="cod-check"]:checked');
                if(checkedBoxes.length === 0) return alert("ÌïòÎÇò Ïù¥ÏÉÅÏùò ÏÑ∏Î∂Ä ÏõêÏù∏ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
                codTempData.causes = Array.from(checkedBoxes).map(cb => cb.value);
            }

            // Construct Final String
            let finalStr = `${codTempData.type}`;
            
            // Format: Type (Secondary) - Causes...
            if(codTempData.secondary) {
                finalStr += ` (${codTempData.secondary})`;
            }
            
            if(codTempData.causes.length > 0) {
                finalStr += ' - ' + codTempData.causes.join(', ');
            }

            // Save Logic
            if(codTargetInputId) {
                document.getElementById(codTargetInputId).value = finalStr;
                closeCod();
            } else if(codTargetDocId) {
                try {
                    await db.collection("rats").doc(codTargetDocId).update({ 
                        codFull: finalStr,
                        status: 'ÏÇ¨Îßù', 
                        deathDate: getTodayStr() 
                    });
                    alert(`Ï†ÄÏû•Îê®: ${finalStr}`);
                    closeCod();
                    loadDetailData(); 
                } catch(e) {
                    console.error(e);
                    alert("Ï†ÄÏû• Ïã§Ìå®");
                }
            }
        }
    </script>
</body>
</html>
